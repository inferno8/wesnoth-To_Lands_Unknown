#textdomain wesnoth-help

#define MORNING_TLU
    [time]
        id=morning_tlu
        name= _ "Morning"
        image=misc/time-schedules/after-the-fall/2morning1.png
        lawful_bonus=25
    [/time]
#enddef

#textdomain wesnoth-To_Lands_Unknown

#Collar--------------------------------------------------------------
#define COLLAR_OVERLAY_REMOVE IMAGE
    [remove_unit_overlay]
        [filter_wml]
            [status]
                collar=yes
            [/status]
        [/filter_wml]
        image="misc/blank-hex.png~BLIT({IMAGE},$collar_slot,0)"
    [/remove_unit_overlay]
#enddef
#define COLLAR_OVERLAY_ADD IMAGE
    [unit_overlay]
        [filter_wml]
            [status]
                collar=yes
            [/status]
        [/filter_wml]
        image="misc/blank-hex.png~BLIT({IMAGE},$collar_slot,0)"
    [/unit_overlay]
#enddef

#define COLLAR_EVENT
    [event]
        name=die
        first_time_only=no
        [filter]
            [filter_wml]
                [status]
                    collar=yes
                [/status]
            [/filter_wml]
        [/filter]
        [if]
            [variable]
                name=unit.status.firstrecall
                equals=yes
            [/variable]
            [then]
                {VARIABLE unit.status.firstrecall no}
                {RECALL_ACTION}
                {COLLAR_OVERLAY_REMOVE misc/artifact-icon-collar3.png}
                {COLLAR_OVERLAY_ADD misc/artifact-icon-collar2.png}
            [/then]
            [else]
                [if]
                    [variable]
                        name=unit.status.secondrecall
                        equals=yes
                    [/variable]
                    [then]
                        {VARIABLE unit.status.secondrecall no}
                        {RECALL_ACTION}
                        {COLLAR_OVERLAY_REMOVE misc/artifact-icon-collar2.png}
                        {COLLAR_OVERLAY_ADD misc/artifact-icon-collar1.png}
                    [/then]
                    [else]
                        [if]
                            [variable]
                                name=unit.status.thirdrecall
                                equals=yes
                            [/variable]
                            [then]
                                {VARIABLE unit.status.thirdrecall no}
                                {RECALL_ACTION}
                                {COLLAR_OVERLAY_REMOVE misc/artifact-icon-collar1.png}
                            [/then]
                            [else]
                            [/else]
                        [/if]
                    [/else]
                [/if]
            [/else]
        [/if]
    [/event]
#enddef

#define RECALL_ACTION
    [store_unit]
        [filter]
            canrecruit=yes
            side=$unit.side
        [/filter]
        variable=summonerleader
    [/store_unit]
    [unstore_unit]
        variable=unit
        x,y=$summonerleader.x,$summonerleader.y
        find_vacant=yes
        text= _ "Recalled..."
        fire_event=yes
        {COLOR_HEAL}
    [/unstore_unit]
    [animate_unit]
        flag=flash
        [filter]
            [not]
                x,y=$x1,$y1
            [/not]
            [filter_wml]
                [status]
                    collar=yes
                [/status]
            [/filter_wml]
        [/filter]
    [/animate_unit]
    {CLEAR_VARIABLE summonerleader}
    {FULL_HEAL (
        [not]
            x,y=$x1,$y1
        [/not]
        [filter_wml]
            [status]
                collar=yes
            [/status]
        [/filter_wml]
    )}
#enddef

#define DGATES_PAY2LVL UNIT_FILTER RESTRICTION
    [event]
        name=recall
        first_time_only=no

        [filter]
            find_in={UNIT_FILTER}
            type=EoMa_Dimensional_Gate,EoMa_Dimensional_Gate_II
        [/filter]

        [store_side]
            side=$unit.side
            variable=myside
        [/store_side]

        {VARIABLE restriction {RESTRICTION}}
        {IF_VAR restriction equals heat (
            [then]
                [if]
                    [have_unit]
                        type=EoMa_Fire_God,EoMa_Fire_Avatar,EoMa_Fire_Elemental
                        count=3-999
                        #note: Dharma'Rashti summons low-level Fire Elementals
                    [/have_unit]
                    [then]
                        {VARIABLE fire_elementals_locked yes}
                    [/then]
                [/if]
            [/then]
        )}

        {IF_VAR myside.gold greater_than_equal_to 6 (
            [then]
                [message]
                    speaker=narrator
                    image=portraits/narrator.webp
                    message= _ "Do you want to spend 6g to instantly level up the Dimensional Gate?"
                    [option]
                        label= _ "Yes"
                        [command]
                            [gold]
                                side=1
                                amount=-6
                            [/gold]
                            #fire elem limit
                            [remove_object]
                                id=$unit.id
                                object_id=eoma_delete_advancement
                            [/remove_object]
                            [store_unit]
                                variable=unit
                                [filter]
                                    id=$unit.id
                                [/filter]
                            [/store_unit]
                            {IF_VAR fire_elementals_locked equals yes (
                                [then]
                                    {IF_VAR unit.type equals EoMa_Dimensional_Gate (
                                        [then]
                                            {VARIABLE unit.variables.advances_to_list "EoMa_Rhami,EoMa_Water_Elemental,EoMa_Air_Elemental,EoMa_Earth_Elemental,EoMa_Jinni"}
                                        [/then]
                                        [else]
                                            {VARIABLE unit.variables.advances_to_list "EoMa_Rhami_kai,EoMa_Rhami_datu,EoMa_Water_Avatar,EoMa_Air_Avatar,EoMa_Earth_Avatar,EoMa_Great_Jinni,EoMa_Efreeti"}
                                        [/else]
                                    )}
                                [/then]
                                [else]
                                    {IF_VAR unit.type equals EoMa_Dimensional_Gate (
                                        [then]
                                            {VARIABLE unit.variables.advances_to_list "EoMa_Rhami,EoMa_Fire_Elemental,EoMa_Water_Elemental,EoMa_Air_Elemental,EoMa_Earth_Elemental,EoMa_Jinni"}
                                        [/then]
                                        [else]
                                            {VARIABLE unit.variables.advances_to_list "EoMa_Rhami_kai,EoMa_Rhami_datu,EoMa_Fire_Avatar,EoMa_Water_Avatar,EoMa_Air_Avatar,EoMa_Earth_Avatar,EoMa_Great_Jinni,EoMa_Efreeti"}
                                        [/else]
                                    )}
                                [/else]
                            )}
                            [unstore_unit]
                                variable=unit
                                find_vacant=no
                            [/unstore_unit]
                            {MODIFY_UNIT find_in=unit advances_to $unit.variables.advances_to_list}
                            {ADVANCE_UNIT find_in=unit ()}
                            {MODIFY_UNIT find_in=unit upkeep loyal}
                        [/command]
                    [/option]
                    [option]
                        label= _ "No"
                        [command]
                        [/command]
                    [/option]
                [/message]
            [/then]
        )}

        {CLEAR_VARIABLE restriction}
        {CLEAR_VARIABLE fire_elementals_locked}

        # Cannot undo recall of unit that advanced or changed type.
    [/event]
#enddef

#define CORRECT_RECALL_COST
    [event]
        name = start
        [store_unit]
            [filter]
                side = 1
                x,y = recall,recall
            [/filter]
            variable = recall_to_correct
        [/store_unit]
        [foreach]
            array = recall_to_correct
            [do]
                [store_unit_type]
                    type = $this_item.type
                    variable = owned_unit_type
                [/store_unit_type]
                [if]
                    [have_unit]
                        id=$this_item.id
                        type=EoMa_Dimensional_Gate_II
                        search_recall_list=yes
                    [/have_unit]
                    [then]
                        {MODIFY_UNIT find_in=this_item recall_cost 14}
                    [/then]
                    [else]
                        [if]
                            [have_unit]
                                id=$this_item.id
                                type=EoMa_Jinni,EoMa_Great_Jinni,EoMa_Mystical_Jinni,EoMa_Wonderful_Jinni,EoMa_Efreeti,EoMa_Great_Efreeti
                                search_recall_list=yes
                            [/have_unit]
                            [then]
                                {MODIFY_UNIT find_in=this_item recall_cost "$(ceil(4*sqrt($owned_unit_type.cost))+8)"}
                            [/then]
                            [else]
                                {MODIFY_UNIT find_in=this_item recall_cost "$(ceil(4*sqrt($owned_unit_type.cost)))"}
                            [/else]
                        [/if]
                    [/else]
                [/if]
                {CLEAR_VARIABLE owned_unit_type}
            [/do]
        [/foreach]

        {CLEAR_VARIABLE recall_to_correct}
    [/event]
#enddef

#LockActions-----------------------------------------------------
#define JINN_LOCK
    [event]
        name=post advance
        [filter]
            type=EoMa_Neutral_Summoner
        [/filter]
        [if]
            {VARIABLE_CONDITIONAL jinnlock1 equals 1}
            [else]
                [message]
                    speaker=narrator
                    image=portraits/narrator.webp
                    second_image=portraits/summoners/wonderfuljinn.webp
                    second_mirror=yes
                    message= _ "Note: Your unit has become a Neutral Summoner. He can now summon friendly Jinn to aid your cause. Jinn, while incredibly useful, are rare and very expensive to maintain. This means recalling them in the next scenarios will be costly."
                [/message]
                {VARIABLE jinnlock1 1}
            [/else]
        [/if]
    [/event]
#enddef

#define SUMMONER_LOCK
    [event]
        name=recall,recruit,post advance
        first_time_only=no
        [filter]
            type=EoMa_Summoner
        [/filter]
        {VARIABLE unit.advances_to (EoMa_Grand_Summoner_lock,EoMa_Neutral_Summoner,EoMa_Heavy_Summoner)}
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
        [allow_undo]
        [/allow_undo]
    [/event]
    [event]
        name=post advance
        first_time_only=no
        [filter]
            type=EoMa_Grand_Summoner_lock
        [/filter]

        [if]
            {VARIABLE_CONDITIONAL summonerlock equals 1}
            [else]
                [message]
                    speaker=narrator
                    image=portraits/narrator.webp
                    message= _ "Note: Grand Summoners can't advance now, but if one gets an AMLA, they'll become Summons Masters when Mehir recalls them while being a Summons Master himself."
                [/message]
                {VARIABLE summonerlock 1}
            [/else]
        [/if]

        [if]
            [have_unit]
                id=$unit.id
                find_in=noamlayet
            [/have_unit]
            [then]
                [store_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    variable=summonscandidates
                    mode=append
                [/store_unit]
            [/then]
            [else]
                [store_unit]
                    [filter]
                        id=$unit.id
                    [/filter]
                    variable=noamlayet
                    mode=append
                [/store_unit]
            [/else]
        [/if]
    [/event]
#enddef

#define SUMMONER_UNLOCK
    [event]
        name=recall
        first_time_only=no
        [filter]
            type=EoMa_Grand_Summoner_lock
        [/filter]

        [if]
            [have_unit]
                id=$unit.id
                find_in=summonscandidates
            [/have_unit]
            [then]
                {VARIABLE storexp $unit.experience}
                {ADVANCE_UNIT id=$unit.id (EoMa_Summons_Master)}
                {MODIFY_UNIT id=$unit.id experience $storexp}
                {CLEAR_VARIABLE storexp}
            [/then]
            [else]
                [object]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    [effect]
                        apply_to=type
                        name=EoMa_Grand_Summoner
                    [/effect]
                    silent=yes
                [/object]
            [/else]
        [/if]
    [/event]

    # Cannot undo recall of unit that advanced or changed type.
#enddef

#Badass mode--------------------------------------------------------------
#define SECRET_EVENTS
    [event]
        name=start

        [set_menu_item]
            id=badass_mode_toggle
            description=_"Toggle Badass Mode"
            [show_if]
                [variable]
                    name=badass_mode_unlocked
                    equals=yes
                [/variable]
                [and]
                    [have_unit]
                        id=Mehir
                        type=TLU_Mehir_Leader
                        x=$x1
                        y=$y1
                    [/have_unit]
                    [or]
                        [have_unit]
                            type=TLU_True_Rashti
                            x=$x1
                            y=$y1
                        [/have_unit]
                    [/or]
                [/and]
            [/show_if]

            [command]
                [if]
                    [variable]
                        name=badass_mode_active
                        equals=yes
                    [/variable]
                    [then]
                        [object]
                            silent=yes
                            duration=forever
                            [filter]
                                id=Mehir
                            [/filter]
                            [effect]
                                apply_to=variation
                                name=
                            [/effect]
                        [/object]
                        {MODIFY_UNIT id=Mehir profile "portraits/mehir-leader.webp"}
                        [object]
                            silent=yes
                            duration=forever
                            [filter]
                                type=TLU_True_Rashti
                            [/filter]
                            [effect]
                                apply_to=variation
                                name=
                            [/effect]
                        [/object]
                        {MODIFY_UNIT type=TLU_True_Rashti profile "portraits/truerashti.webp"}
                        [set_variable]
                            name=badass_mode_active
                            value=no
                        [/set_variable]
                    [/then]
                    [else]
                        [object]
                            silent=yes
                            duration=forever
                            [filter]
                                id=Mehir
                            [/filter]
                            [effect]
                                apply_to=variation
                                name=badass
                            [/effect]
                        [/object]
                        {MODIFY_UNIT id=Mehir profile "portraits/mehir-leader.webp~BLIT(misc/sunglasses.png)"}
                        [object]
                            silent=yes
                            duration=forever
                            [filter]
                                type=TLU_True_Rashti
                            [/filter]
                            [effect]
                                apply_to=variation
                                name=badass
                            [/effect]
                        [/object]
                        {MODIFY_UNIT type=TLU_True_Rashti profile "portraits/truerashti.webp~BLIT(misc/truerashti-sunglasses.png)"}
                        [set_variable]
                            name=badass_mode_active
                            value=yes
                        [/set_variable]
                    [/else]
                [/if]
            [/command]
        [/set_menu_item]
        [set_menu_item]
            id=badass_mode_toggle_last
            description=_"Toggle Badass Mode"
            [show_if]
                [variable]
                    name=badass_mode_unlocked
                    equals=yes
                [/variable]
                [and]
                    [have_unit]
                        id=Mehir
                        type=TLU_Last_Summoner
                        x=$x1
                        y=$y1
                    [/have_unit]
                [/and]
            [/show_if]
            [command]
                [if]
                    [variable]
                        name=badass_mode_active
                        equals=yes
                    [/variable]
                    [then]
                        [object]
                            silent=yes
                            duration=forever
                            [filter]
                                id=Mehir
                            [/filter]
                            [effect]
                                apply_to=variation
                                name=
                            [/effect]
                        [/object]
                        {MODIFY_UNIT id=Mehir profile "portraits/mehir-last.webp"}
                        [object]
                            silent=yes
                            duration=forever
                            [filter]
                                type=TLU_True_Rashti
                            [/filter]
                            [effect]
                                apply_to=variation
                                name=
                            [/effect]
                        [/object]
                        {MODIFY_UNIT type=TLU_True_Rashti profile "portraits/truerashti.webp"}
                        [set_variable]
                            name=badass_mode_active
                            value=no
                        [/set_variable]
                    [/then]
                    [else]
                        [object]
                            silent=yes
                            duration=forever
                            [filter]
                                id=Mehir
                            [/filter]
                            [effect]
                                apply_to=variation
                                name=badass
                            [/effect]
                        [/object]
                        {MODIFY_UNIT id=Mehir profile "portraits/mehir-last.webp~BLIT(misc/sunglasses.png)"}
                        [object]
                            silent=yes
                            duration=forever
                            [filter]
                                type=TLU_True_Rashti
                            [/filter]
                            [effect]
                                apply_to=variation
                                name=badass
                            [/effect]
                        [/object]
                        {MODIFY_UNIT type=TLU_True_Rashti profile "portraits/truerashti.webp~BLIT(misc/truerashti-sunglasses.png)"}
                        [set_variable]
                            name=badass_mode_active
                            value=yes
                        [/set_variable]
                    [/else]
                [/if]
            [/command]
        [/set_menu_item]
    [/event]

#enddef

#define SUNGLASSES_FIX1
    {VARIABLE portrait_sunglasses misc/sunglasses.png}
    [fire_event]
        name=portraits
    [/fire_event]
#enddef
#define SUNGLASSES_FIX2
    {VARIABLE portrait_sunglasses misc/blank-hex.png}
    [fire_event]
        name=portraits
    [/fire_event]
#enddef
#define BADASS_MODE_CHANGE NEW OLD
    {IF_VAR badass_mode_active equals yes (
        [then]
            {SUNGLASSES_FIX1}
            {NEW}
            {SUNGLASSES_FIX2}
        [/then]
        [else]
            {OLD}
        [/else]
    )}
#enddef

#define SUNGLASSES_OFF ACTION_WML
    {SUNGLASSES_FIX2}
    {ACTION_WML}
    {SUNGLASSES_FIX1}
#enddef

#Rashti--------------------------------------------------------------
#define RASHTI_SIDES SIDE_DHARMA SIDE_HO
    #dharma
    [side]
        side={SIDE_DHARMA}
        controller=ai
        team_name=rashti
        user_team_name= _ "team_name^DharmaRashti"
        no_leader=yes
        color=black
        hidden=yes

        [ai]
            aggression=1.0
            caution=0.0
        [/ai]
    [/side]

    #ho
    [side]
        side={SIDE_HO}
        controller=ai
        team_name=mehirteam
        user_team_name= _ "team_name^HoRashti"
        no_leader=yes
        color=white
        hidden=yes

        [ai]
            aggression=1.0
            caution=0.0
        [/ai]
    [/side]

    [event]
        name=prestart
        id=dharma_ai

        #Dharma'rashti chases Mehir
        [micro_ai]
            side={SIDE_DHARMA}
            ai_type=goto
            action=add
            ca_id=dharma_chase_mehir

            [filter]
                type=TLU_DharmaRashti
            [/filter]
            [filter_location]
                [filter]
                    id=Mehir
                [/filter]
            [/filter_location]
            ca_score=300000
            remove_movement=no
            use_straight_line=yes
        [/micro_ai]
        [micro_ai]
            side={SIDE_DHARMA}
            ai_type=simple_attack
            action=add
            ca_id=dharma_attack_mehir

            ca_score=110000
            [filter]
                type=TLU_DharmaRashti
            [/filter]
            [filter_second]
                id=Mehir
            [/filter_second]
        [/micro_ai]
        #Fire Elementals chase Ho'rashti
        [micro_ai]
            side={SIDE_DHARMA}
            ai_type=simple_attack
            action=add
            ca_id=elementals_attack_ho

            ca_score=110001
            [filter]
                type=EoMa_Fire_Elemental
            [/filter]
            [filter_second]
                type=TLU_HoRashti
            [/filter_second]
        [/micro_ai]
    [/event]

    [event]
        name=prestart
        id=ho_ai

        #Ho'rashti chases Dharma'rashti
        [micro_ai]
            side={SIDE_HO}
            ai_type=goto
            action=add
            ca_id=ho_chase_dharma

            [filter]
                type=TLU_HoRashti
            [/filter]
            [filter_location]
                [filter]
                    type=TLU_DharmaRashti
                [/filter]
            [/filter_location]
            ca_score=300000
            remove_movement=no
            use_straight_line=yes
        [/micro_ai]
        [micro_ai]
            side={SIDE_HO}
            ai_type=simple_attack
            action=add
            ca_id=ho_attack_dharma

            ca_score=110000
            [filter]
                type=TLU_HoRashti
            [/filter]
            [filter_second]
                type=TLU_DharmaRashti
            [/filter_second]
        [/micro_ai]
    [/event]

    #change dharma side parameters for badass
    [event]
        name=side 1 turn
        first_time_only=no

        {BADASS_MODE_CHANGE (
            [modify_side]
                side={SIDE_DHARMA}
                team_name=rashti
            [/modify_side]

            [micro_ai]
                side={SIDE_DHARMA}
                ai_type=simple_attack
                action=delete
                ca_id=dharma_chase_mehir
            [/micro_ai]
            [micro_ai]
                side={SIDE_DHARMA}
                ai_type=simple_attack
                action=delete
                ca_id=dharma_attack_mehir
            [/micro_ai]
        ) ()}
    [/event]

    [event]
        name=side {SIDE_DHARMA} turn
        first_time_only=no

        {BADASS_MODE_CHANGE (
            [modify_side]
                side={SIDE_DHARMA}
                team_name=mehirteam
            [/modify_side]
        ) ()}
    [/event]

    [event]
        name=side {SIDE_HO} turn
        first_time_only=no

        {BADASS_MODE_CHANGE (
            [modify_side]
                side={SIDE_DHARMA}
                team_name=rashti
            [/modify_side]
        ) ()}
    [/event]

    #transformations
    [event]
        name=last breath
        id=rashtitransformations_event
        first_time_only=no

        [filter]
            type=TLU_True_Rashti
        [/filter]

        {IF_VAR lock_truerashti equals yes (
            [then]
                #heal rashti
                [heal_unit]
                    [filter]
                        type=TLU_True_Rashti
                    [/filter]
                    amount=full
                    animate=no
                    restore_statuses=yes
                [/heal_unit]
                {VARIABLE exp $second_unit.experience}
                {VARIABLE_OP exp add -32}
                [store_unit]
                    [filter]
                        id=$second_unit.id
                    [/filter]
                    variable=noexp
                [/store_unit]
                {VARIABLE noexp.experience $exp}
                [unstore_unit]
                    variable=noexp
                    find_vacant=no
                [/unstore_unit]
                {CLEAR_VARIABLE noexp}
                {CLEAR_VARIABLE exp}
            [/then]
            [else]
                [store_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    variable=rashti
                    kill=yes
                [/store_unit]
                {UNIT ({SIDE_HO}) (TLU_True_Rashti) $x1 $y1 (placement,passable=map,yes)}
                {ADVANCE_UNIT (x,y=$x1,$y1) "TLU_Rashti"}
                {ADVANCE_UNIT (x,y=$x1,$y1) "TLU_HoRashti"}
                {UNIT ({SIDE_DHARMA}) (TLU_DharmaRashti) $x1 $y1 (placement,passable=map,yes)}
                {VARIABLE dharma_turns 0}
                {VARIABLE ho_turns 0}
                {VARIABLE dharma_return yes}
                [store_unit]
                    [filter]
                        type=TLU_DharmaRashti
                    [/filter]
                    variable=dharmarashti_loc
                    kill=no
                [/store_unit]
                [store_unit]
                    [filter]
                        type=TLU_HoRashti
                    [/filter]
                    variable=horashti_loc
                    kill=no
                [/store_unit]
                {IF_VAR dharma_ruins equals yes (
                    [then]
                        {UNIT {SIDE_DHARMA} (EoMa_Efreeti) $dharmarashti_loc.x $dharmarashti_loc.y (placement,passable,animate=map,yes,yes)}
                        {UNIT {SIDE_DHARMA} (EoMa_Rhami_datu) $dharmarashti_loc.x $dharmarashti_loc.y (placement,passable,animate=map,yes,yes)}
                    [/then]
                    [else]
                        {UNIT {SIDE_DHARMA} (EoMa_Fire_Elemental) $dharmarashti_loc.x $dharmarashti_loc.y (placement,passable,animate=map,yes,yes)}
                        {UNIT {SIDE_DHARMA} (EoMa_Fire_Elemental) $dharmarashti_loc.x $dharmarashti_loc.y (placement,passable,animate=map,yes,yes)}
                    [/else]
                )}
                {UNIT {SIDE_HO} (EoMa_Water_Elemental) $horashti_loc.x $horashti_loc.y (placement,passable,animate=map,yes,yes)}
                {UNIT {SIDE_HO} (EoMa_Water_Elemental) $horashti_loc.x $horashti_loc.y (placement,passable,animate=map,yes,yes)}
                [modify_unit]
                    [filter]
                        side={SIDE_DHARMA}
                        type=EoMa_Fire_Elemental,EoMa_Fire_Avatar,EoMa_Fire_God #I put the advancements in case an enemy fire elemental somehow advances
                    [/filter]
                    goto_x=$horashti_loc.x
                    goto_y=$horashti_loc.y
                [/modify_unit]
                [fire_event]
                    name=split
                [/fire_event]
            [/else]
        )}
    [/event]

    [event]
        name=last breath
        id=rashti_onkill_event1
        first_time_only=no

        [filter]
            type=TLU_DharmaRashti,TLU_HoRashti
        [/filter]
        [filter_second]
            [not]
                type=TLU_DharmaRashti,TLU_HoRashti
            [/not]
        [/filter_second]

        [heal_unit]
            [filter]
                type=TLU_DharmaRashti,TLU_HoRashti
            [/filter]
            amount=full
            animate=no
            restore_statuses=yes
        [/heal_unit]
        {VARIABLE exp $second_unit.experience}
        {VARIABLE_OP exp add -24}
        [store_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            variable=noexp
        [/store_unit]
        {VARIABLE noexp.experience $exp}
        [unstore_unit]
            variable=noexp
            find_vacant=no
        [/unstore_unit]
        {CLEAR_VARIABLE noexp}
        {CLEAR_VARIABLE exp}
    [/event]

    #dharmarashti spawns fire elementals to delay horashti:
    [event]
        name=side {SIDE_DHARMA} turn
        id=spawn_fire
        first_time_only=no
        [if]
            [have_unit]
                type=TLU_DharmaRashti
            [/have_unit]
            [then]
                [store_unit]
                    [filter]
                        type=TLU_DharmaRashti
                    [/filter]
                    variable=dharmarashti_loc
                    kill=no
                [/store_unit]
                [store_unit]
                    [filter]
                        type=TLU_HoRashti
                    [/filter]
                    variable=horashti_loc
                    kill=no
                [/store_unit]
                [switch]
                    variable=dharma_turns
                    [case]
                        value=1,3,5,9
                        {IF_VAR dharma_ruins equals yes (
                            [then]
                                {UNIT {SIDE_DHARMA} (EoMa_Efreeti) $dharmarashti_loc.x $dharmarashti_loc.y (placement,passable,animate=map,yes,yes)}
                                {UNIT {SIDE_DHARMA} (EoMa_Rhami_datu) $dharmarashti_loc.x $dharmarashti_loc.y (placement,passable,animate=map,yes,yes)}
                            [/then]
                            [else]
                                {UNIT {SIDE_DHARMA} (EoMa_Fire_Elemental) $dharmarashti_loc.x $dharmarashti_loc.y (placement,passable,animate=map,yes,yes)}
                                {UNIT {SIDE_DHARMA} (EoMa_Fire_Elemental) $dharmarashti_loc.x $dharmarashti_loc.y (placement,passable,animate=map,yes,yes)}
                            [/else]
                        )}
                    [/case]
                    [case]
                        value=7
                        {UNIT {SIDE_DHARMA} (EoMa_Fire_Avatar) $dharmarashti_loc.x $dharmarashti_loc.y (placement,passable,animate=map,yes,yes)}
                        {UNIT {SIDE_DHARMA} (EoMa_Fire_Elemental) $dharmarashti_loc.x $dharmarashti_loc.y (placement,passable,animate=map,yes,yes)}
                    [/case]
                    [case]
                        value=11
                        {UNIT {SIDE_DHARMA} (EoMa_Fire_Elemental) $dharmarashti_loc.x $dharmarashti_loc.y (placement,passable,animate=map,yes,yes)}
                        {UNIT {SIDE_DHARMA} (EoMa_Fire_Elemental) $dharmarashti_loc.x $dharmarashti_loc.y (placement,passable,animate=map,yes,yes)}
                        {UNIT {SIDE_DHARMA} (EoMa_Fire_Elemental) $dharmarashti_loc.x $dharmarashti_loc.y (placement,passable,animate=map,yes,yes)}
                    [/case]
                [/switch]
                {VARIABLE_OP dharma_turns add 1}
                [modify_unit]
                    [filter]
                        side={SIDE_DHARMA}
                        type=EoMa_Fire_Elemental,EoMa_Fire_Avatar,EoMa_Fire_God #I put the advancements in case an enemy fire elemental somehow advances
                    [/filter]
                    goto_x=$horashti_loc.x
                    goto_y=$horashti_loc.y
                [/modify_unit]
            [/then]
        [/if]
#ifndef EASY
        [if]
            [have_unit]
                type=TLU_DharmaRashti
            [/have_unit]
            [and]
                [variable]
                    name=dharma_return
                    equals=yes
                [/variable]
            [/and]
            [then]
                [switch]
                    variable=dharma_turns
                    [case]
                        value=1,5,9
                        {UNIT {SIDE_DHARMA} (EoMa_Efreeti) $dharmarashti_loc.x $dharmarashti_loc.y (placement,passable,animate=map,yes,yes)}
                    [/case]
                    [case]
                        value=3,7,11
                        {UNIT {SIDE_DHARMA} (EoMa_Rhami_datu) $dharmarashti_loc.x $dharmarashti_loc.y (placement,passable,animate=map,yes,yes)}
                    [/case]
                [/switch]
                [modify_unit]
                    [filter]
                        side={SIDE_DHARMA}
                        type=EoMa_Fire_Elemental,EoMa_Fire_Avatar,EoMa_Fire_God #I put the advancements in case an enemy fire elemental somehow advances
                    [/filter]
                    goto_x=$horashti_loc.x
                    goto_y=$horashti_loc.y
                [/modify_unit]
            [/then]
        [/if]
#endif
    [/event]

    #horashti spawns water elementals instead:
    [event]
        name=side {SIDE_HO} turn
        id=spawn_water
        first_time_only=no
        [if]
            [have_unit]
                type=TLU_HoRashti
            [/have_unit]
            [then]
                [store_unit]
                    [filter]
                        type=TLU_HoRashti
                    [/filter]
                    variable=horashti_loc
                    kill=no
                [/store_unit]
                [store_unit]
                    [filter]
                        type=TLU_DharmaRashti
                    [/filter]
                    variable=dharmarashti_loc
                    kill=no
                [/store_unit]
                [switch]
                    variable=ho_turns
                    [case]
                        value=1,3
                        {UNIT {SIDE_HO} (EoMa_Water_Elemental) $horashti_loc.x $horashti_loc.y (placement,passable,animate=map,yes,yes)}
                        {UNIT {SIDE_HO} (EoMa_Water_Elemental) $horashti_loc.x $horashti_loc.y (placement,passable,animate=map,yes,yes)}
                    [/case]
                    [case]
                        value=5,7
                        {UNIT {SIDE_HO} (EoMa_Water_Avatar) $horashti_loc.x $horashti_loc.y (placement,passable,animate=map,yes,yes)}
                        {UNIT {SIDE_HO} (EoMa_Water_Elemental) $horashti_loc.x $horashti_loc.y (placement,passable,animate=map,yes,yes)}
                    [/case]
                    [case]
                        value=9,11
                        {UNIT {SIDE_HO} (EoMa_Water_Elemental) $horashti_loc.x $horashti_loc.y (placement,passable,animate=map,yes,yes)}
                        {UNIT {SIDE_HO} (EoMa_Water_Avatar) $horashti_loc.x $horashti_loc.y (placement,passable,animate=map,yes,yes)}
                        {UNIT {SIDE_HO} (EoMa_Air_Elemental) $horashti_loc.x $horashti_loc.y (placement,passable,animate=map,yes,yes)}
                        {UNIT {SIDE_HO} (EoMa_Air_Avatar) $horashti_loc.x $horashti_loc.y (placement,passable,animate=map,yes,yes)}
                    [/case]
                [/switch]
                {VARIABLE_OP ho_turns add 1}
            [/then]
        [/if]
    [/event]

    [event]
        name=die
        first_time_only=no
        id=rashti_onkill_event2
        [filter]
            type=TLU_HoRashti
        [/filter]

        [heal_unit]
            [filter]
                type=TLU_DharmaRashti,TLU_HoRashti
            [/filter]
            amount=full
            animate=no
            restore_statuses=yes
        [/heal_unit]
    [/event]

    [event]
        name=last breath,force unite
        id=rashti_onkill_event3
        first_time_only=no
        [filter]
            type=TLU_DharmaRashti,TLU_HoRashti
        [/filter]
        [filter_second]
            type=TLU_DharmaRashti,TLU_HoRashti
        [/filter_second]
        [fire_event]
            name=pre unified
            [primary_unit]
                id=$unit.id
            [/primary_unit]
            [secondary_unit]
                id=$second_unit.id
            [/secondary_unit]
        [/fire_event]
        {FLASH_WHITE (
            [sound]
                name=lightning-miss.ogg
            [/sound]

            [hide_unit]
                x,y=$x1,$y1
            [/hide_unit]
            [move_unit_fake]
                type=$unit.type
                side=$unit.side
                x=$x1,$x2
                y=$y1,$y2
            [/move_unit_fake]
            {IF_VAR rashti.id equals Rashti (
                [then]
                    [unstore_unit]
                        variable=rashti
                        x,y=$x2,$y2
                        find_vacant=no
                        animate=no
                    [/unstore_unit]
                [/then]
            )}
            [kill]
                x,y=$x1,$y1
            [/kill]
            {VARIABLE oldexp $rashti.experience}
            {ADVANCE_UNIT (x,y=$x2,$y2) "TLU_Rashti2"}
            {ADVANCE_UNIT (x,y=$x2,$y2) "TLU_True_Rashti"}
            {MODIFY_UNIT (x,y=$x2,$y2) upkeep loyal}
            {MODIFY_UNIT (x,y=$x2,$y2) experience $oldexp}
            {MODIFY_UNIT (side={SIDE_DHARMA},{SIDE_HO}) upkeep loyal}
            {MODIFY_UNIT (side={SIDE_DHARMA},{SIDE_HO}) side 1}
            [heal_unit]
                [filter]
                    id=Rashti
                [/filter]
                amount=full
                animate=no
                restore_statuses=yes
            [/heal_unit]

            {CLEAR_VARIABLE oldexp}
            {CLEAR_VARIABLE dharma_turns}
            {CLEAR_VARIABLE ho_turns}
            {CLEAR_VARIABLE dharmarashti_loc}
            {CLEAR_VARIABLE horashti_loc}
            {CLEAR_VARIABLE rashti}
        )}
        [fire_event]
            name=unified
            [primary_unit]
                type=TLU_True_Rashti
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=split
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "It looks like Rashti has lost her balance once again!"
            [/message]
            [message]
                type=TLU_DharmaRashti
                message= _ "Heyy, long time no see, Mehir dear! Got unshackled from my blue half again! So, wanna have a date? Just me, you, standing atop piles of enemy corpses and rivers of blood!"
            [/message]
            [message]
                speaker=Mehir
                message= _ "Well, a date does sound good, but corpses and blood doesn't exactly set the right mood..."
            [/message]
            [message]
                type=TLU_HoRashti
                message= _ "Master, don't trust her! She is evil! (to Dharma'rashti) *sigh* Look, now is really not the time for flirting. Besides, is THAT what you consider a date?"
            [/message]
            [message]
                type=TLU_DharmaRashti
                message= _ "Well, there are two things I love - needless bloodshed and Mehir, but mostly needless bloodshed, might as well combine the two."
            [/message]
            [message]
                type=TLU_HoRashti
                message= _ "I order you to stop immediately at once, unify with me and get back to fighting!"
            [/message]
            [message]
                type=TLU_DharmaRashti
                message= _ "Just shut your mouth and return to your books! It's because of your rules and commands that I can't ever do anything fun."
            [/message]
            [message]
                type=TLU_HoRashti
                message= _ "Seems I'll have to beat some sense into you again."
            [/message]
            [message]
                speaker=Mehir
                image="portraits/mehir-leader-angry.webp{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "Now is not the time for infighting! We're in the middle of an important battle for Nomolas's sake!"
            [/message]
            [message]
                type=TLU_DharmaRashti
                message= _ "Any time is a good time for infighting. Now, be a good boy and don't get in the way, or I can't exactly guarantee you'll keep all of your limbs, got it?"
            [/message]
            [message]
                speaker=Mehir
                message= _ "*gulp*"
            [/message]

            #rashti attacks Mehir's units only in retaliation
            [modify_ai]
                side={SIDE_DHARMA}
                action=add
                path=aspect[attacks].facet[]
                [facet]
                    invalidate_on_gamestate_change=yes
                    [filter_own]
                    [/filter_own]
                    [filter_enemy]
                        [not]
                            side=1,5,6
                        [/not]
                    [/filter_enemy]
                [/facet]
            [/modify_ai]
        ) (
            [message]
                speaker=Mehir
                message= _ "Oh no! Rashti has lost her balance once again!"
            [/message]
            [message]
                type=TLU_DharmaRashti
                message= _ "Long time no see, Mehir. I'm back and I am gonna RIP YOUR THROAT OUT!!!"
            [/message]
            [message]
                type=TLU_HoRashti
                message= _ "Fear not, Master! She is mine!"
            [/message])}
        [/event]
#enddef

#define ENSURE_TRUE_RASHTI
    # Ensure Rashti is in the right state if the scenario is skipped with :n
    [if]
        [have_unit]
            id=Rashti
            type=TLU_Rashti
        [/have_unit]
        [then]
            {ADVANCE_UNIT id=Rashti ("TLU_True_Rashti")}
        [/then]
        [else]
            [if]
                [have_unit]
                    type=TLU_DharmaRashti,TLU_HoRashti
                [/have_unit]
                [then]
                    [fire_event]
                        name=force unite
                        [primary_unit]
                            type=TLU_DharmaRashti
                        [/primary_unit]
                        [secondary_unit]
                            type=TLU_HoRashti
                        [/secondary_unit]
                    [/fire_event]
                [/then]
            [/if]
        [/else]
    [/if]
    [if]
        [have_unit]
            id=Rashti
            [not]
                side=1
            [/not]
        [/have_unit]
        [then]
            {MODIFY_UNIT id=Rashti side 1}
        [/then]
    [/if]
#enddef

#define RECALL_RASHTI
    # Ensure Rashti is in the right state if the scenario was reached with :cl
    [if]
        [have_unit]
            side=1
            id=Rashti
            x,y=recall,recall
        [/have_unit]
        [then]
            [recall]
                id=Rashti
            [/recall]
        [/then]
        [else]
            # If Rashti already existed, but not in our side, this macro may
            # simply unstore it, rather than creating a TLU_Rashti.
            {UNIT 1 TLU_Rashti () () (
                placement=leader
                id=Rashti
                name= _ "Rashti"
                gender=female
                animate=yes
                #make Rashti upkeepless, but without using the loyal trait due to her unique personality/personalities
                [modifications]
                    [object]
                        duration=forever
                        [effect]
                            apply_to=loyal
                        [/effect]
                    [/object]
                [/modifications]
                {IS_HERO}
                unrenamable=yes
            )}
        [/else]
    [/if]
#enddef

#define RECALL_RASHTI_AT X Y
    # Ensure Rashti is in the right state if the scenario was reached with :cl
    [if]
        [have_unit]
            side=1
            id=Rashti
            x,y=recall,recall
        [/have_unit]
        [then]
            [recall]
                id=Rashti
                x={X}
                y={Y}
            [/recall]
        [/then]
        [else]
            # If Rashti already existed, but not in our side, this macro may
            # simply unstore it, rather than creating a TLU_Rashti.
            {UNIT 1 TLU_Rashti {X} {Y} (
                id=Rashti
                name= _ "Rashti"
                gender=female
                animate=yes
                #make Rashti upkeepless, but without using the loyal trait due to her unique personality/personalities
                [modifications]
                    [object]
                        duration=forever
                        [effect]
                            apply_to=loyal
                        [/effect]
                    [/object]
                [/modifications]
                {IS_HERO}
                unrenamable=yes
            )}
        [/else]
    [/if]
#enddef

#define RECALL_TRUE_RASHTI
    # Ensure Rashti is in the right state if the scenario was reached with :cl
    [if]
        [have_unit]
            side=1
            id=Rashti
            x,y=recall,recall
        [/have_unit]
        [then]
            [recall]
                id=Rashti
            [/recall]
        [/then]
        [else]
            # If Rashti already existed, but not in our side, this macro may
            # simply unstore it, rather than creating a TLU_True_Rashti.
            {UNIT 1 TLU_True_Rashti () () (
                placement=leader
                id=Rashti
                name= _ "Rashti"
                gender=female
                animate=yes
                #make Rashti upkeepless, but without using the loyal trait due to her unique personality/personalities
                [modifications]
                    [object]
                        duration=forever
                        [effect]
                            apply_to=loyal
                        [/effect]
                    [/object]
                [/modifications]
                {IS_HERO}
                unrenamable=yes
            )}
        [/else]
    [/if]
    [if]
        [have_unit]
            id=Rashti
            type=TLU_Rashti
        [/have_unit]
        [then]
            {ADVANCE_UNIT id=Rashti ("TLU_True_Rashti")}
        [/then]
    [/if]
#enddef

#wmllint: who RECALL_RASHTI is Rashti
#wmllint: who RECALL_RASHTI_AT is Rashti
#wmllint: who RECALL_TRUE_RASHTI is Rashti

#define RASHTICIRCLE COLOR DURATION
    circle_start_time=-400
    particle_start_time=-400
    [particle_frame]
        duration={DURATION}
        image="halo/particle-anims/particles-a-[01~96].png"
        image_mod="~SCALE(100,100)"
        auto_vflip=false
        layer=30
        alpha=0~1:150,1:700,1~0:150
        offset=0.0
    [/particle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 15 {COLOR}}
        image_mod="~SCALE(1,2)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 16 {COLOR}}
        image_mod="~SCALE(10,7)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 17 {COLOR}}
        image_mod="~SCALE(19,12)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 18 {COLOR}}
        image_mod="~SCALE(28,17)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 18 {COLOR}}
        image_mod="~SCALE(37,22)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 19 {COLOR}}
        image_mod="~SCALE(45,27)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 20 {COLOR}}
        image_mod="~SCALE(54,32)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 21 {COLOR}}
        image_mod="~SCALE(63,37)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 22 {COLOR}}
        image_mod="~SCALE(72,42)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 23 {COLOR}}
        image_mod="~SCALE(81,47)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 23 {COLOR}}
        image_mod="~SCALE(101,59)"
    [/circle_frame]
    [circle_frame]
        duration={DURATION}
        image=halo/ucircle-frames/ucircle-c-[01~23].png#~(640,480,)
        image_mod="~SCALE(101,59){COLOR}"
        auto_vflip=false
        layer=0
        y=17
        alpha=1
        offset=0.0
        layer=0
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 01 {COLOR}}
        image_mod="~SCALE(101,59)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 01 {COLOR}}
        image_mod="~SCALE(81,47)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 02 {COLOR}}
        image_mod="~SCALE(72,42)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 03 {COLOR}}
        image_mod="~SCALE(63,37)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 04 {COLOR}}
        image_mod="~SCALE(54,32)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 05 {COLOR}}
        image_mod="~SCALE(45,27)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 06 {COLOR}}
        image_mod="~SCALE(37,22)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 07 {COLOR}}
        image_mod="~SCALE(28,17)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 08 {COLOR}}
        image_mod="~SCALE(19,12)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 09 {COLOR}}
        image_mod="~SCALE(10,7)"
    [/circle_frame]
    [circle_frame]
        {CIRCLE_RECRUIT 10 {COLOR}}
        image_mod="~SCALE(1,2)"
    [/circle_frame]
#enddef

#define TLU_SMOOTH_REPLACE_MUSIC NEW_TRACK FADE_OUT_TIME FADE_IN_TIME

    {VARIABLE tmp_smooth_volume 100}
    {VARIABLE tmp_smooth_delay_time "$({FADE_OUT_TIME} / 10)"}

    {REPEAT 10 (
        {VARIABLE_OP tmp_smooth_volume sub 10}
        [volume]
            music=$tmp_smooth_volume
        [/volume]
        [delay]
            time=$tmp_smooth_delay_time
        [/delay]
    )}

    [volume]
        music=0
    [/volume]

    {REPLACE_SCENARIO_MUSIC {NEW_TRACK}}

    {VARIABLE tmp_smooth_delay_time "$({FADE_IN_TIME} / 10)"}

    {REPEAT 10 (
        {VARIABLE_OP tmp_smooth_volume add 10}
        [volume]
            music=$tmp_smooth_volume
        [/volume]
        [delay]
            time=$tmp_smooth_delay_time
        [/delay]
    )}

    [volume]
        music=100
    [/volume]

    {CLEAR_VARIABLE tmp_smooth_volume}
    {CLEAR_VARIABLE tmp_smooth_delay_time}
#enddef
