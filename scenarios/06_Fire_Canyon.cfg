#textdomain wesnoth-To_Lands_Unknown
[scenario]
    id=06_Fire_Canyon
    next_scenario=07_Dome_of_Elements

    name= _ "Fire Canyon"
    map_data="{~add-ons/To_Lands_Unknown/maps/06_FireCanyon.map}"
    {TURNS 44 39 34}
    victory_when_enemies_defeated=no

    {DUSK}

    {SCENARIO_MUSIC siege_of_laurelmor.ogg}

    {STORYTXT_FIRE_CANYON}

    [side]
        side=1
        controller=human
        team_name=mehirteam
        user_team_name= _ "team_name^Mehir"

        type=EoMa_Summoner
        id=Mehir
        name= _ "Mehir"
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Novice_Summoner,EoMa_Camel_Rider,EoMa_Carpet_Rider,EoMa_Water_Elemental

        {GOLD 295 230 170}
        {INCOME 10 8 6}
    [/side]

    [side]
        side=2
        controller=ai
        team_name=barbarians
        user_team_name= _ "team_name^Barbarians"
        color=orange
        {FLAG_VARIANT6 ragged}

        type=EoMa_Ancient_Cyclops
        id=BLeader
        image_icon=portraits/barbarians/ancientcyclops.png~CROP(175,5,140,140)~SCALE(72,72)
        generate_name=yes
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Cyclops,EoMa_Goblin_Runt,EoMa_Goblin_Kamikaze,EoMa_Goblin_Archer,EoMa_Troll_Sorcerer,EoMa_Barbarian_Berserker

        {GOLD 0 0 0}
        {INCOME 8 10 12}

        [ai]
            [avoid]
                x,y=32,4
            [/avoid]
        [/ai]
    [/side]

    [side]
        side=3
        controller=ai
        team_name=barbarians
        user_team_name= _ "team_name^Barbarians"
        color=brown
        {FLAG_VARIANT6 ragged}

        type=EoMa_Goblin_Warbanner
        id=GLeader
        image_icon=portraits/barbarians/transparent/goblinwarbanner.png~CROP(130,95,140,140)~SCALE(72,72)
        generate_name=yes
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Cyclops,EoMa_Goblin_Runt,EoMa_Goblin_Kamikaze,EoMa_Goblin_Archer,EoMa_Troll_Sorcerer,EoMa_Barbarian_Berserker

        {GOLD 0 0 0}
        {INCOME 4 8 12}

        [ai]
            [avoid]
                x,y=32,4
            [/avoid]
        [/ai]
    [/side]

    #prisoner side
    [side]
        side=4
        controller=null
        team_name=mehirteam,barbarians
        hidden=yes
        no_leader=yes
        color=green
        recruit=
        {GOLD 0 0 0}
        {INCOME 0 0 0}
        {UNIT 4 (EoMa_Corrupted_Shaman) 28 26 (role,hitpoints,upkeep=prisoner,9,loyal
        {IS_HERO})}
        {UNIT 4 (EoMa_Mystic) 28 25 (role,hitpoints,upkeep=prisoner,21,loyal
        {IS_HERO})}
        {UNIT 4 (EoMa_Blue_Salamander) 30 25 (role,hitpoints,upkeep=prisoner,15,loyal
        {IS_HERO})}
    [/side]

    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 "EoMa_Goblin_Kamikaze" 3}

    #prestart
    [event]
        name=prestart

        {BADASS_MODE_CHANGE (
            {UNIT 2 (EoMa_Troll_Fire_Wizard) 18 21 (generate_name=yes
            random_traits=yes
            upkeep=loyal)}
            {UNIT 2 (EoMa_Troll_Fire_Wizard) 20 20 (generate_name=yes
            random_traits=yes
            upkeep=loyal)}
            {UNIT 2 (EoMa_Cyclops_Breaker) 27 24 (generate_name=yes
            random_traits=yes
            id=breaker
            upkeep=loyal)}
            {UNIT 2 (EoMa_Blood_Warrior) 25 26 (generate_name=yes
            random_traits=yes
            upkeep=loyal)}
            {UNIT 2 (EoMa_Cyclops_Breaker) 13 13 (generate_name=yes
            random_traits=yes)}
            {UNIT 2 (EoMa_Mighty_Cyclops) 11 16 (generate_name=yes
            random_traits=yes)}
            {UNIT 2 (EoMa_Mighty_Cyclops) 10 11 (generate_name=yes
            random_traits=yes)}
            {UNIT 2 (EoMa_Goblin_Raider) 30 24 (generate_name=yes
            random_traits=yes
            upkeep=loyal)}
        ) (
            {UNIT 2 (EoMa_Troll_Fire_Wizard) 18 21 (generate_name=yes
            moves=0
            max_moves=0
            random_traits=yes
            upkeep=loyal)}
            {UNIT 2 (EoMa_Troll_Fire_Wizard) 20 20 (generate_name=yes
            moves=0
            max_moves=0
            random_traits=yes
            upkeep=loyal)}
            {UNIT 2 (EoMa_Cyclops_Breaker) 27 24 (generate_name=yes
            ai_special=guardian
            random_traits=yes
            id=breaker
            upkeep=loyal)}
            {UNIT 2 (EoMa_Blood_Warrior) 25 26 (generate_name=yes
            ai_special=guardian
            random_traits=yes
            upkeep=loyal)}
            {UNIT 2 (EoMa_Cyclops_Breaker) 13 13 (generate_name=yes
            ai_special=guardian
            random_traits=yes)}
            {UNIT 2 (EoMa_Mighty_Cyclops) 11 16 (generate_name=yes
            ai_special=guardian
            random_traits=yes)}
            {UNIT 2 (EoMa_Mighty_Cyclops) 10 11 (generate_name=yes
            ai_special=guardian
            random_traits=yes)}
            {UNIT 2 (EoMa_Goblin_Raider) 30 24 (generate_name=yes
            ai_special=guardian
            random_traits=yes
            upkeep=loyal)}
        )}
        {CAPTURE_VILLAGES 1 35 2 6}
        {CAPTURE_VILLAGES 2 7 14 8}
        {CAPTURE_VILLAGES 3 22 10 5}
        {PLACE_HALO items/cage.png 30 25}
        {PLACE_HALO items/cage.png 28 25}
        {PLACE_HALO items/cage.png 28 26}
        {VARIABLE outpost_captured 0}
        {VARIABLE prisoners 0}

        [objectives]
            side=1
            [objective]
                description= _ "Seize the post on the other hill"
                condition=win
                [show_if]
                    [variable]
                        name=outpost_captured
                        numerical_equals=0
                    [/variable]
                [/show_if]
            [/objective]
            [objective]
                description= _ "Release the lizards"
                condition=win
                [show_if]
                    {VARIABLE_CONDITIONAL prisoners equals 0}
                [/show_if]
            [/objective]
            [objective]
                description= _ "Death of any lizard"
                condition=lose
            [/objective]
            [objective]
                description= _ "Defeat the barbarians"
                condition=win
                [show_if]
                    [have_unit]
                        side=2
                    [/have_unit]
                [/show_if]
            [/objective]
            [objective]
                description= _ "A fire elemental moves on a wooden bridge"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Mehir"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
        [object]
            silent=yes
            [effect]
                apply_to=remove_ability
                [abilities]
                    {ABILITY_EOMA_REGENERATES}
                [/abilities]
            [/effect]
            [effect]
                apply_to=remove_ability
                [abilities]
                    {ABILITY_EOMA_CURES}
                [/abilities]
            [/effect]
            [filter]
                type=EoMa_Mystic
            [/filter]
        [/object]
        [object]
            silent=yes
            [effect]
                apply_to=remove_ability
                [abilities]
                    {ABILITY_EOMA_REGENERATES6}
                [/abilities]
            [/effect]
            [filter]
                type=EoMa_Corrupted_Shaman
            [/filter]
        [/object]
    [/event]

#define RECALL_FIRECANYON LVL
    {REPEAT 6 (
        [if]
            [have_unit]
                side=1
                count=7
            [/have_unit]
            [else]
                [if]
                    [have_unit]
                        side=1
                        level={LVL}
                        search_recall_list=yes
                    [/have_unit]
                    [then]
                        [recall]
                            level={LVL}
                        [/recall]
                    [/then]
                [/if]
            [/else]
        [/if]
    )}
#enddef

    #turn 1
    [event]
        name=turn 1
        {VARIABLE cage 0}
        {VARIABLE cx 28}
        {VARIABLE cy 25}
#ifdef EASY
        [heal_unit]
            [filter]
                role=prisoner
            [/filter]
            amount=full
            animate=no
            restore_statuses=yes
        [/heal_unit]
        [kill]
            x,y=25,26
            animate=no
            fire_event=no
        [/kill]
#endif
        [message]
            speaker=Mehir
            message= _ "Thatâ€™s the place. I can see cages with the captured lizards inside..."
        [/message]
        {SCROLL_TO 28 25}
        [delay]
            time=1000
        [/delay]
        {SCROLL_TO 7 14}
        [delay]
            time=500
        [/delay]
        {SCROLL_TO 23 10}
        [delay]
            time=250
        [/delay]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "Theoretically we should attack the fortress ahead in order to reach them..."
            [/message]
            [message]
                speaker=Mehir
                message= _ "...but I have a better idea..."
            [/message]
            {RECALL_FIRECANYON 3}
            {RECALL_FIRECANYON 2}
            {RECALL_FIRECANYON 1}
            {REPEAT 6 (
                [if]
                    [have_unit]
                        side=1
                        count=7
                    [/have_unit]
                    [else]
                        {UNIT 1 (EoMa_Camel_Rider) 34 2 (generate_name=yes
                        random_traits=yes)}
                    [/else]
                [/if]
            )}
            {MOVE_UNIT id=Mehir 30 5}
            [message]
                speaker=GLeader
                message= _ "Huh? Weâ€™re under attack!"
            [/message]
            [message]
                speaker=BLeader
                message= _ "Is it the green bastards again? What is it, the third time this week?"
            [/message]
            [message]
                speaker=Mehir
                message= _ "(to the goblin) Hey, you, midget! Calm down, I mean you no harm. Go to your chief and tell him I'm here to make a deal."
            [/message]
            {MOVE_UNIT id=GLeader 19 11}
            [message]
                speaker=GLeader
                message= _ "Master! Human says he wants talk. A deal, he says!"
            [/message]
            [message]
                speaker=BLeader
                message= _ "A human? Here? Interesting... Let him pass."
            [/message]
            {MOVE_UNIT id=GLeader 22 10}
            {MOVE_UNIT id=Mehir 16 13}
            [message]
                speaker=Mehir
                message= _ "So you must be the one in charge here. Look, I am here for those lizards you captured not so long go."
            [/message]
            [message]
                speaker=BLeader
                message= _ "You're with the Darkblooded?!"
            [/message]
            {MOVE_UNIT x,y=13,13 14 13}
            {MOVE_UNIT x,y=11,16 12 15}
            {MOVE_UNIT x,y=10,11 11 12}
            [message]
                speaker=Mehir
                message= _ "Not quite. It's more along the lines of them forcing me to do this by taking my friend hostage."
            [/message]
            [message]
                speaker=BLeader
                message= _ "Hmpff... Fine, so what are you willing to offer for those scumbags' freedom?"
            [/message]
            [message]
                speaker=Mehir
                message= _ "You seem to be a strong man. I challenge you to a drinking contest! Whoever loses consciousness first, loses the bet. If I win, you will free the lizards."
            [/message]
            [message]
                speaker=BLeader
                message= _ "Ha! No one here can beat me at drinking! But proving it in your face is certainly a good idea. But what when YOU lose?"
            [/message]
            [message]
                speaker=Mehir
                message= _ "I will teach you... magic."
            [/message]
            [message]
                speaker=BLeader
                message= _ "Magic? I don't trust your weird magic, with that weird glowy things under your feet. I rather burn stuff with my eye."
            [/message]
            [message]
                speaker=Mehir
                message= _ "Geez, so much for intellect... What do you say about this: I'll teach you the basics of our magic *and* then you will kill me!"
            [/message]
            [message]
                speaker=BLeader
                message= _ "Now we're talking! Bring the booze!"
            [/message]
            {FADE_TO_BLACK}
            {TELEPORT_UNIT id=Mehir 18 15}
            {MODIFY_UNIT id=Mehir facing sw}
            {TELEPORT_UNIT id=BLeader 17 16}
            [store_unit]
                variable=barbarian
                [filter]
                    side=2,3
                    [not]
                        id=BLeader
                    [/not]
                [/filter]
                kill=yes
            [/store_unit]

            [foreach]
                array=barbarian
                [do]
                    [unstore_unit]
                        variable=this_item
                        x,y=16,17
                        find_vacant=yes
                    [/unstore_unit]
                [/do]
            [/foreach]
            {CLEAR_VARIABLE barbarian}
            [store_unit]
                variable=troops
                [filter]
                    side=1
                    [not]
                        id=Mehir
                    [/not]
                [/filter]
                kill=yes
            [/store_unit]

            [foreach]
                array=troops
                [do]
                    [unstore_unit]
                        variable=this_item
                        x,y=20,14
                        find_vacant=yes
                    [/unstore_unit]
                [/do]
            [/foreach]

            {FADE_IN}
            [message]
                type=EoMa_Mighty_Cyclops
                message= _ "GO MASTER! DRINK! DRINK! DRINK!"
            [/message]
            [message]
                race=orc
                message= _ "Yeah, you can do this!"
            [/message]
            [message]
                race=eoma_summoner
                [not]
                    id=Mehir
                [/not]
                message= _ "My liege, you're doing well! One more shot!"
            [/message]
            {UNIT 1 (EoMa_Carpet_Rider) 36 27 (id=carpet1)}
            {UNIT 1 (EoMa_Carpet_Rider) 36 27 (id=carpet2)}
            {UNIT 1 (EoMa_Carpet_Rider) 36 27 (id=carpet3)}
            {MOVE_UNIT id=carpet1 30 25}
            {MOVE_UNIT id=carpet2 28 25}
            {MOVE_UNIT id=carpet3 28 26}
            [kill]
                side=4
                fire_event=no
                animate=no
            [/kill]
            [object]
                silent=yes
                duration=forever
                [filter]
                    id=carpet1
                [/filter]
                [effect]
                    #blit does not work in this particular case
                    apply_to=halo
                    halo="units/darkblood-salamanders/bluesalamander.png"
                [/effect]
            [/object]
            [object]
                silent=yes
                duration=forever
                [filter]
                    id=carpet2
                [/filter]
                [effect]
                    apply_to=image_mod
                    add="~BLIT(units/darkblood-saurians/mystic.png)"
                [/effect]
            [/object]
            [object]
                silent=yes
                duration=forever
                [filter]
                    id=carpet3
                [/filter]
                [effect]
                    apply_to=image_mod
                    add="~BLIT(units/darkblood-saurians/darkshaman.png)"
                [/effect]
            [/object]
            {MOVE_UNIT id=carpet1 34 2}
            {MOVE_UNIT id=carpet2 34 2}
            {MOVE_UNIT id=carpet3 34 2}
            [kill]
                id=carpet1
                animate=no
            [/kill]
            [kill]
                id=carpet2
                animate=no
            [/kill]
            [kill]
                id=carpet3
                animate=no
            [/kill]
            #quick swap
            {UNIT 1 (EoMa_Carpet_Rider) 34 2 (generate_name,random_traits,id=yes,yes,carpet1)}
            {UNIT 1 (EoMa_Carpet_Rider) 34 2 (generate_name,random_traits,id=yes,yes,carpet2)}
            {UNIT 1 (EoMa_Carpet_Rider) 34 2 (generate_name,random_traits,id=yes,yes,carpet3)}
            {MOVE_UNIT id=carpet1 24 6}
            {MOVE_UNIT id=carpet2 26 7}
            {MOVE_UNIT id=carpet3 28 8}
            [message]
                type=EoMa_Blood_Warrior
                message= _ "CHIEF NO SLEEP! WAKE UP! DRINK!"
            [/message]
            [message]
                speaker=BLeader
                image="portraits/ancientcyclops-drunk.png"
                message= _ "I... can't..."
            [/message]
            {MOVE_UNIT id=GLeader 16 15}
            [message]
                speaker=GLeader
                message= _ "Noooo! Master! Wake up!"
            [/message]
            [message]
                speaker=BLeader
                image="portraits/ancientcyclops-drunk.png"
                message= _ "Zzzzz..."
            [/message]
            [kill]
                id=BLeader
                fire_event=no
                animate=yes
            [/kill]
            {PLACE_IMAGE "units/ancientcyclops-drunk.png" 17 16}
            {MODIFY_TERRAIN Dd^Qov 17 16}
            [message]
                speaker=Mehir
                message= _ "*visibly drunk* I... *hic* won..."
            [/message]
            [message]
                speaker=GLeader
                message= _ "Damn human! Stronger head than Master! Give him lizards!"
            [/message]
            {MOVE_UNIT type=EoMa_Blood_Warrior 26 24}
            [message]
                type=EoMa_Blood_Warrior
                message= _ "Uh... Lizards gone! EMPTY!"
            [/message]
            [message]
                speaker=Mehir
                message= _ "Of course they are gone... *hic* That was the plan B in case I would lose. *hic* I think I'll go now..."
            [/message]
            {REPLACE_SCENARIO_MUSIC tribal_war_song_shortened.ogg}
            [message]
                type=EoMa_Mighty_Cyclops
                message= _ "Humans no better than lizards! No honor! KILL HUMANS!"
            [/message]
            {MOVE_UNIT id=GLeader 7 14}
            [gold]
                side=3
                {QUANTITY amount 100 150 185}
            [/gold]
            {MODIFY_UNIT side=2,3 ai_special ("")}
            {PLACE_IMAGE "items/gohere.png" 34 2}
            {HIGHLIGHT_IMAGE 34 2 "items/gohere.png" ()}
            [object]
                name=""
                duration=scenario
                description= _ "Mehir is drunk. His movement is decreased by 3 (this effect only lasts until the end of the scenario)"
                [filter]
                    id=Mehir
                [/filter]
                [effect]
                    apply_to=movement
                    increase=-3
                [/effect]
            [/object]
            [objectives]
                side=1
                [objective]
                    description= _ "Mehir escapes to the camp"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Death of Mehir"
                    condition=lose
                [/objective]
                {TURNS_RUN_OUT}
                [gold_carryover]
                    bonus=no
                    carryover_percentage=40
                [/gold_carryover]
            [/objectives]
        ) (
            [message]
                speaker=Mehir
                message= _ "We'll have to attack the fortress ahead in order to reach them..."
            [/message]
            [message]
                speaker=Mehir
                message= _ "...And we're going to deploy firepower! I don't care if it scares the hell out of those lizards. They don't look like they can last much longer, so we have to hurry. I better not lead any fire elementals down the wooden path, though... they'd burn it, and we would get stuck. Alright, let's cross this bridge first. Soldiers, hurry up, we don't have much time!"
            [/message]
        )}
    [/event]

    #bridge destruction
    [event]
        name=moveto
        [filter]
            side=1
            x=31,30,29,28,27,26,20,21,22,23,24,25
            y=5,5,6,6,7,7,21,22,22,23,23,24
            type=EoMa_Fire_Elemental,EoMa_Fire_Avatar,EoMa_Fire_God
        [/filter]

        {BADASS_MODE_CHANGE () (
            [sound]
                name=fire.wav
            [/sound]
            [message]
                speaker=Mehir
                image=portraits/mehir-angry.png
                message= _ "Oh no! The bridge is on fire!"
            [/message]
            [endlevel]
                result=defeat
            [/endlevel]
        )}
    [/event]

    #moved to the bridge
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x,y=22,10
                radius=10
            [/filter_location]
            [or]
                [filter_location]
                    x,y=32,20
                    radius=10
                [/filter_location]
            [/or]
        [/filter]

        [if]
            #a fire elemental triggers the alarm by moving directly to a bridge, then do not show the alarm dialogue
            [have_unit]
                side=1
                x=31,30,29,28,27,26,20,21,22,23,24,25
                y=5,5,6,6,7,7,21,22,22,23,23,24
                type=EoMa_Fire_Elemental,EoMa_Fire_Avatar,EoMa_Fire_God
            [/have_unit]
            [else]
                {BADASS_MODE_CHANGE () (
                    {REPLACE_SCENARIO_MUSIC tribal_war_song_shortened.ogg}
                    [message]
                        speaker=GLeader
                        message= _ "Weâ€™re under attack!"
                    [/message]
                    [message]
                        speaker=BLeader
                        message= _ "Is it the green bastards again? What is it, the third time this week? Never mind... KILL THEM!!!"
                    [/message]
                    [message]
                        speaker=Mehir
                        image=portraits/mehir-angry.png
                        message= _ "Quick! We must seize this post â€” we can safely summon our Elementals from there."
                    [/message]
                    {PLACE_IMAGE "items/gohere.png" 22 10}

                    {HIGHLIGHT_IMAGE 22 10 "items/gohere.png" ()}
                    [gold]
                        side=2
                        {QUANTITY amount 200 300 375}
                    [/gold]
                    [gold]
                        side=3
                        {QUANTITY amount 100 150 150}
                    [/gold]

#ifdef HARD
                    {UNIT 3 (EoMa_Goblin_Runt) 25 10 (generate_name=yes
                    ai_special=guardian
                    animate=yes
                    random_traits=yes)}
                    {UNIT 3 (EoMa_Goblin_Runt) 22 8 (generate_name=yes
                    ai_special=guardian
                    animate=yes
                    random_traits=yes)}
#endif
                )}
            [/else]
        [/if]
    [/event]

    #outpost captured
    [event]
        name=moveto
        [filter]
            id=Mehir
            x,y=22,10
        [/filter]

        {BADASS_MODE_CHANGE () (
            {REMOVE_IMAGE 22 10}
            [message]
                speaker=Mehir
                image=portraits/mehir-angry.png
                message= _ "Taste the fires of the Abyss, savages!"
            [/message]
            {UNIT 1 (EoMa_Fire_Elemental) 22 10 (animate=yes)}
            {UNIT 1 (EoMa_Fire_Elemental) 22 10 (animate=yes)}
            {UNIT 1 (EoMa_Fire_Elemental) 22 10 (animate=yes)}
            [gold]
                side=1
                amount=30
            [/gold]
            [message]
                speaker=BLeader
                message= _ "What the hell?! Is that a walking bonfire?!"
            [/message]
            [delay]
                time=1000
            [/delay]
            [message]
                speaker=BLeader
                message= _ "Wait a minute, lizards don't have crap like this! So these must be the very humans who killed Brogh'ur!!! Everyone, grab your weapons!!! Bring me their leader's skull!!!"
            [/message]
            [allow_recruit]
                side=1
                type=EoMa_Fire_Elemental
            [/allow_recruit]
            {VARIABLE outpost_captured 1}
            {SCROLL_TO 22 10}
            [message]
                speaker=narrator
                image=portraits/narrator.png
                message= _ "Note: Placing a fire elemental or its advancements on a wooden bridge will set it aflame resulting in a defeat."
            [/message]

            [show_objectives]
            [/show_objectives]
        )}
    [/event]

#define RESCUE_DIALOG
    [message]
        type=EoMa_Mystic
        message= _ "Freedom, at lassst! I am eternally grateful to you. Who are you, my sssavior?"
    [/message]
    [message]
        speaker=Mehir
        message= _ "I'm Mehir, but more importantly, The Keeper sent us to rescue you, so that we can earn his trust."
    [/message]
    [message]
        type=EoMa_Mystic
        message= _ "I believe you. Pleassse, take usss from thiss place. This cursssed desssert almossst dried usss to death."
    [/message]
#enddef

#define RESCUE_ACTION
    {VARIABLE_OP prisoners add 1}
    {IF_VAR prisoners equals 1 (
        [then]
            {RESCUE_DIALOG}
        [/then]
    )}
#enddef

    #saurians are freed
    [event]
        name=moveto
        [filter]
            side=1
            [filter_adjacent]
                side=4
            [/filter_adjacent]
        [/filter]

        {BADASS_MODE_CHANGE () (
            {REMOVE_IMAGE 30 25}
            {REMOVE_IMAGE 28 26}
            {REMOVE_IMAGE 28 25}
            {REMOVE_IMAGE $cx $cy}

            {MODIFY_UNIT side=4 side 1}
            [object]
                silent=yes
                [effect]
                    apply_to=movement_costs
                    replace=yes
                    [movement_costs]
                        sand=1
                    [/movement_costs]
                [/effect]
                [filter]
                    type=EoMa_Blue_Salamander
                [/filter]
            [/object]

            {RESCUE_ACTION}
            {RESCUE_ACTION}
            {RESCUE_ACTION}
            [fire_event]
                name=rescue_check
            [/fire_event]
        )}
    [/event]

    #rescue check
    [event]
        name=rescue check
        first_time_only=no

        {IF_VAR prisoners equals 3 (
            [then]
                [if]
                    [have_unit]
                        side=2
                    [/have_unit]
                    [then]
                        [message]
                            speaker=Mehir
                            message= _ "Thatâ€™s all the lizards. Letâ€™s defeat the remaining barbarians and get out of here."
                        [/message]
                        [remove_event]
                            id=cage_event
                        [/remove_event]
                        [show_objectives]
                        [/show_objectives]
                    [/then]
                    [else]
                        {MODIFY_UNIT (race=saurian) side 4}
                        {MODIFY_UNIT (race=eoma_salamander) side 4}
                        [endlevel]
                            result=victory
                            {NEW_GOLD_CARRYOVER 40}
                            bonus=no
                            carryover_report=yes
                        [/endlevel]
                    [/else]
                [/if]
            [/then]
        )}
    [/event]

    #a lizard dies = game over
    [event]
        name=die
        [filter]
            race=lizard
        [/filter]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]
    [event]
        name=die
        [filter]
            race=eoma_salamander
        [/filter]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    #player kills all barbarians first
    [event]
        name=die
        first_time_only=no
        [filter]
            side=2
        [/filter]

        {BADASS_MODE_CHANGE () (
            [if]
                [have_unit]
                    side=2
                    count=0
                [/have_unit]
                [then]
                    [if]
                        [have_unit]
                            race=lizard
                            side=1
                        [/have_unit]
                        [then]
                            {MODIFY_UNIT race=lizard side 4}
                            {MODIFY_UNIT (race=eoma_salamander) side 4}
                            [endlevel]
                                result=victory
                                {NEW_GOLD_CARRYOVER 40}
                                bonus=no
                                carryover_report=yes
                            [/endlevel]
                        [/then]
                        [else]
                            [message]
                                speaker=Mehir
                                message= _ "Time to rescue the lizards."
                            [/message]
                        [/else]
                    [/if]
                [/then]
            [/if]
        )}
    [/event]

    #Barbarian leader in danger
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x,y=7,14
                radius=5
            [/filter_location]
        [/filter]

        {BADASS_MODE_CHANGE () (
            [if]
                [have_unit]
                    type=EoMa_Troll_Fire_Wizard
                    side=2
                [/have_unit]
                [then]
                    [message]
                        speaker=BLeader
                        message= _ "These desert wizards are breaking through! They're probably here for the green savages. NEVER! TROLLS, GET THEM!!!"
                    [/message]
                    [store_unit]
                        [filter]
                            type=EoMa_Troll_Fire_Wizard
                        [/filter]
                        variable=trolls
                    [/store_unit]

                    [foreach]
                        array=trolls
                        [do]
                            {VARIABLE this_item.max_moves 5}
                            {VARIABLE this_item.moves 5}
                            [unstore_unit]
                                variable=this_item
                                find_vacant=no
                            [/unstore_unit]
                        [/do]
                    [/foreach]
                [/then]
            [/if]
        )}
    [/event]

    #on last breath Barbarian Leader orders to push cages to chasm
    [event]
        name=last breath
        [filter]
            id=BLeader
        [/filter]

        [fire_event]
            name=cage
        [/fire_event]
    [/event]
    [event]
        name=cage

        [if]
            [have_unit]
                id=breaker
            [/have_unit]
            [and]
                [have_unit]
                    race=lizard
                    side=1
                    count=0
                [/have_unit]
            [/and]
            [then]
                [message]
                    speaker=BLeader
                    message= _ "You will never rescue them! NEVER! KNOCK THEM OFF!"
                [/message]
                [store_unit]
                    [filter]
                        type=EoMa_Cyclops_Breaker
                    [/filter]
                    variable=breaker
                    kill=no
                [/store_unit]
                [message]
                    type=EoMa_Cyclops_Breaker
                    message="<b>$breaker.name|</b>"+_"<b> do it!</b>" #translated like "Krog do it!"
                [/message]
                {CLEAR_VARIABLE breaker}
#ifndef EASY
                {MOVE_UNIT (type=EoMa_Blood_Warrior) 25 24}
                [message]
                    type=EoMa_Blood_Warrior
                    message= _ "And I defend the bridge!"
                [/message]
#endif
                [message]
                    speaker=Mehir
                    image=portraits/mehir-angry.png
                    message= _ "We must hurry!"
                [/message]
                {VARIABLE cage 1}
            [/then]
            [else]
            [/else]
        [/if]
    [/event]

    #cage pushing event
    [event]
        name=side 2 turn
        first_time_only=no
        id=cage_event

        [switch]
            variable=cage
            [case]
                value=1
                [if]
                    [have_unit]
                        id=breaker
                        [not]
                            x,y=27,25
                        [/not]
                    [/have_unit]
                    [then]
                        {MOVE_UNIT id=breaker 27 25}
                        {MODIFY_UNIT id=breaker max_moves 0}
                        {MODIFY_UNIT id=breaker attacks_left 0}
                        {MODIFY_UNIT id=breaker facing se}
                        {VARIABLE cage 2}
                    [/then]
                [/if]
            [/case]
            [case]
                value=2
                [if]
                    [have_unit]
                        id=breaker
                        x,y=27,25
                    [/have_unit]
                    [then]
                        {SCROLL_TO 29 26}
                        {REMOVE_IMAGE 28 25}
                        [teleport]
                            [filter]
                                type=EoMa_Mystic
                            [/filter]
                            x=29
                            y=26
                        [/teleport]
                        {PLACE_HALO items/cage.png 29 26}
                        {VARIABLE cx 29}
                        {VARIABLE cy 26}
                        {VARIABLE cage 3}
                    [/then]
                [/if]
            [/case]
            [case]
                value=3
                {MOVE_UNIT id=breaker 28 25}
                {MODIFY_UNIT id=breaker moves 0}
                {MODIFY_UNIT id=breaker attacks_left 0}
                {VARIABLE cage 4}
            [/case]
            [case]
                value=4
                [if]
                    [have_unit]
                        id=breaker
                        x,y=28,25
                    [/have_unit]
                    [then]
                        {SCROLL_TO 30 26}
                        {REMOVE_IMAGE 29 26}
                        [teleport]
                            [filter]
                                type=EoMa_Mystic
                            [/filter]
                            x=30
                            y=26
                        [/teleport]
                        {PLACE_HALO items/cage.png 30 26}
                        {VARIABLE cx 30}
                        {VARIABLE cy 26}
                        {VARIABLE cage 5}
                    [/then]
                [/if]
            [/case]
            [case]
                value=5
                {MOVE_UNIT id=breaker 29 26}
                {MODIFY_UNIT id=breaker moves 0}
                {MODIFY_UNIT id=breaker attacks_left 0}
                {VARIABLE cage 6}
            [/case]
            [case]
                value=6
                [if]
                    [have_unit]
                        id=breaker
                        x,y=29,26
                    [/have_unit]
                    [then]
                        {SCROLL_TO 30 26}
                        {REMOVE_IMAGE 30 26}
                        [kill]
                            type=EoMa_Mystic
                            animate=no
                            fire_event=no
                        [/kill]
                        {FAKE_UNIT_MOVE 30 31 26 27 1 (EoMa_Mystic) ()}
                        [sound]
                            name=hiss-die.wav
                        [/sound]
                        [delay]
                            time=500
                        [/delay]
                        [endlevel]
                            result=defeat
                        [/endlevel]
                    [/then]
                [/if]
            [/case]
        [/switch]
    [/event]

#define FLAMES_BRIDGE X Y
    [item]
        x,y={X},{Y}
        halo=scenery/flames[01~15].png:50
    [/item]
    [delay]
        time=500
    [/delay]
    [kill]
        x,y={X},{Y}
        animate=yes
    [/kill]
#enddef

    #badass victory
    [event]
        name=badass_victory

        [store_unit]
            variable=troops
            [filter]
                side=1
                [not]
                    id=Mehir
                [/not]
            [/filter]
        [/store_unit]

        [foreach]
            array=troops
            [do]
                {MOVE_UNIT id=$this_item.id 34 2}
            [/do]
        [/foreach]

        {CLEAR_VARIABLE troops}
        {MOVE_UNIT id=Mehir 32 3}
        #if somehow one of our units is still on the bridge, put him to our recall list
        [put_to_recall_list]
            side=1
            x=32,31,30,29,28,27,26
            y=4,5,5,6,6,7,7
        [/put_to_recall_list]
        [message]
            speaker=Mehir
            message=_ "*to goblin leader* Hey, you, yes you, little moron! *hic* Is this bridge the only way out?"
        [/message]
        [message]
            speaker=GLeader
            message=_ "Yeah. Why human ask?"
        [/message]
        [message]
            speaker=Mehir
            message=_ "Oh, nevermind. Hehe..."
        [/message]
        {UNIT 1 (EoMa_Fire_Elemental) 32 4 (animate=yes)}
        {FLAMES_BRIDGE 32 4}
        {FLAMES_BRIDGE 31 5}
        {FLAMES_BRIDGE 30 5}
        {FLAMES_BRIDGE 29 6}
        {FLAMES_BRIDGE 28 6}
        {FLAMES_BRIDGE 27 7}
        {FLAMES_BRIDGE 26 7}
        #is the goblin leader the only survivor?
        [store_unit]
            variable=troops
            [filter]
                side=2,3
                [not]
                    id=GLeader
                [/not]
                [not]
                    type=EoMa_Goblin_Kamikaze
                [/not]
            [/filter]
        [/store_unit]
        {IF_VAR troops.length greater_than 0 (
            [then]
                [message]
                    side=2,3
                    [not]
                        id=GLeader
                    [/not]
                    message=_ "NOO! We trap here now! Goblin to blame. KILL GOBLIN!"
                [/message]

                [message]
                    id=GLeader
                    message=_ "AAAAAH!"
                [/message]
                [store_unit]
                    variable=gleaderloc
                    [filter]
                        id=GLeader
                    [/filter]
                [/store_unit]

                [foreach]
                    array=troops
                    [do]
                        {MOVE_UNIT id=$this_item.id $gleaderloc.x $gleaderloc.y}
                        [if]
                            [have_unit]
                                [filter_adjacent]
                                    id=GLeader
                                [/filter_adjacent]
                                count=6
                            [/have_unit]
                            [then]
                                [fire_event]
                                    name=execution
                                [/fire_event]
                            [/then]
                        [/if]
                    [/do]
                [/foreach]

                [fire_event]
                    name=execution
                [/fire_event]
            [/then]
            [else]
                [message]
                    id=GLeader
                    message=_ "Me not impressed. Drunk human think I am trapped? Rocs will rescue me!"
                [/message]
                [message]
                    id=Mehir
                    message=_ "Good. You're going to live to tell the tale. Now excuse me... *pukes*"
                [/message]
                [endlevel]
                    result=victory
                    {NEW_GOLD_CARRYOVER 40}
                    bonus=no
                    carryover_report=yes
                [/endlevel]
            [/else]
        )}
    [/event]

    #trapped barbarians kill Goblin Leader
    [event]
        name=execution

        {CLEAR_VARIABLE gleaderloc}
        [modify_side]
            side=3
            team_name=moron
        [/modify_side]
        [store_unit]
            variable=troops
            [filter]
                [filter_adjacent]
                    id=GLeader
                [/filter_adjacent]
            [/filter]
        [/store_unit]

        [foreach]
            array=troops
            [do]
                [harm_unit]
                    [filter]
                        id=GLeader
                    [/filter]
                    [filter_second]
                        id=$this_item.id
                    [/filter_second]
                    amount=$this_item.attack[0].damage
                    alignment=$this_item.alignment
                    [primary_attack]
                        damage=$this_item.attack[0].damage
                    [/primary_attack]
                    kill=yes
                    fire_event=yes
                    animate=yes
                [/harm_unit]
            [/do]
        [/foreach]
        {CLEAR_VARIABLE troops}
        [remove_event]
            id=badass_victory
        [/remove_event]
    [/event]

    #badass - Goblin Leader dies = immediate victory
    [event]
        name=die
        [filter]
            id=GLeader
        [/filter]

        {BADASS_MODE_CHANGE (
            [endlevel]
                result=victory
                {NEW_GOLD_CARRYOVER 40}
                bonus=no
                carryover_report=yes
            [/endlevel]
        ) ()}
    [/event]

    #victory
    [event]
        name=victory

        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message=_ "At least the booze was really good *hic*"
            [/message]
        ) (
            [message]
                speaker=Mehir
                message=_ "The lizards are safe now. And so is our project on their territory. Letâ€™s get back to the jungle. I hope those forest folks havenâ€™t made a soup of Jaffar yet..."
            [/message]
        )}
        {CLEAR_VARIABLE cage}
        {CLEAR_VARIABLE cx}
        {CLEAR_VARIABLE cy}
        {CLEAR_VARIABLE outpost_captured}
        {CLEAR_VARIABLE prisoners}
        {CLEAR_VARIABLE trolls}
    [/event]

    #if attacked, Trolls start moving
    [event]
        name=attack

        [filter_second]
            type=EoMa_Troll_Fire_Wizard
        [/filter_second]

        [store_unit]
            [filter]
                type=EoMa_Troll_Fire_Wizard
            [/filter]
            variable=trolls
        [/store_unit]

        [foreach]
            array=trolls
            [do]
                {VARIABLE this_item.max_moves 5}
                {VARIABLE this_item.moves 5}
                [unstore_unit]
                    variable=this_item
                    find_vacant=no
                [/unstore_unit]
            [/do]
        [/foreach]
    [/event]

    #if carpets get too close to the cages, rocs arrive
    [event]
        name=enter hex
        first_time_only=yes
        [filter]
            side=1
            [filter_location]
                x=28-36
                y=17-21
            [/filter_location]
        [/filter]
        {BADASS_MODE_CHANGE () (
            {UNIT 2 (EoMa_Roc_Rider) 29 20 (facing,animate=ne,yes)}
            {UNIT 2 (EoMa_Roc_Rider) 34 20 (facing,animate=nw,yes)}
            [message]
                speaker=Mehir
                image=portraits/mehir-angry.png
                message= _ "Damn it!"
            [/message]
        )}
    [/event]

    #turn 14 - rocs arrive
    [event]
        name=turn 14
        {UNIT 2 (EoMa_Roc_Rider) 3 3 (facing,animate=se,yes)}
        {UNIT 2 (EoMa_Roc_Rider) 5 2 (facing,animate=se,yes)}
        {UNIT 2 (EoMa_Roc_Rider) 8 1 (facing,animate=se,yes)}
    [/event]

    #badass - Mehir reaches camp = victory
    [event]
        name=moveto
        [filter]
            id=Mehir
            [filter_location]
                x,y=34,2
            [/filter_location]
        [/filter]
        {BADASS_MODE_CHANGE (
            [fire_event]
                name=badass_victory
            [/fire_event]
        ) ()}
    [/event]

    {CORRECT_RECALL_COST}
    {SUMMONER_LOCK}
    {JINN_LOCK}
    {DEATH_MEHIR}
    {TLU_S06_TERRAIN}
[/scenario]
