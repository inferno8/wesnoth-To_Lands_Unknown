#textdomain wesnoth-To_Lands_Unknown
[scenario]
    id=10_Chaos
    next_scenario=11_Message
    name= _ "Chaos"
    map_data="{~add-ons/To_Lands_Unknown/maps/10_Chaos.map}"
    turns=-1
    victory_when_enemies_defeated=no

    [time]
        id=underground_kagatta
        name= _ "Lit caverns"
        image=misc/time-schedules/schedule-underground-illum.png
        lawful_bonus=0
    [/time]

    {SCENARIO_MUSIC New_Wesnoth_Battle_Music.ogg}

    [side]
        side=1
        controller=human
        team_name=mehirteam
        user_team_name= _ "team_name^Mehir"

        type=EoMa_Grand_Summoner
        id=Mehir
        name= _ "Mehir"
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Novice_Summoner,EoMa_Camel_Rider,EoMa_Carpet_Rider,EoMa_Water_Elemental,EoMa_Summoner,EoMa_Rhami,EoMa_Fire_Elemental

        {GOLD 500 400 300}
        {INCOME 30 26 22}
    [/side]

    [side]
        side=2
        controller=ai
        team_name=aerius
        user_team_name= _ "team_name^Aerius"

        type=EoMa_Master_of_Air
        id=Aerius
        name= _ "Aerius"
        unrenamable=yes
        canrecruit=yes
        image_icon="portraits/sky_kingdom/masterofair.png~CROP(160,70,180,180)~SCALE(72,72)"

        [ai]
            passive_leader=yes
            grouping=defensive
            aggression=0.8
        [/ai]

        recruit=EoMa_Golem,EoMa_Mu,EoMa_Mystic_Warrior,EoMa_Golem_Boss,EoMa_Battle_Eye,EoMa_Air_Elemental

        {GOLD 230 330 430}
        {INCOME 15 18 22}

        {UNIT 2 (EoMa_Mystic_Warrior) 23 21 (facing=sw)}
        {UNIT 2 (EoMa_Mystic_Warrior) 26 22 (facing=sw)}
        {UNIT 2 (EoMa_Mystic_Warrior) 21 22 (facing=sw)}
        {UNIT 2 (EoMa_Mystic_Warrior) 24 23 (facing=sw)}
        {UNIT 2 (EoMa_Mystic_Warrior) 18 23 (facing=sw)}
        {UNIT 2 (EoMa_Mystic_Warrior) 21 25 (facing=sw)}
        {UNIT 2 (EoMa_Golem_Boss) 20 20 (facing=sw)}
        {UNIT 2 (EoMa_Golem) 27 24 (facing=sw)}
        {UNIT 2 (EoMa_Golem) 15 23 (facing=sw)}
        {UNIT 2 (EoMa_Golem) 22 26 (facing=sw)}
        {UNIT 2 (EoMa_Shadowmage) 22 2 (ai=guardian)}
        {UNIT 2 (EoMa_Subversive_Mage) 22 29 ()}
        {UNIT 2 (EoMa_Subversive_Mage) 26 27 ()}
        {UNIT 2 (EoMa_Elementalist) 30 27 ()}
        {UNIT 2 (EoMa_Mu) 27 27 ()}
    [/side]
#ifdef EASY
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (EoMa_Air_Elemental) 3}
#endif
#ifdef NORMAL
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (EoMa_Air_Elemental) 4}
#endif
#ifdef HARD
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (EoMa_Air_Elemental) 5}
#endif

    [side]
        side=3
        controller=ai
        team_name=redabyss
        user_team_name= _ "team_name^Abyss"
        hidden=yes
        no_leader=yes
        color=orange

        gold=0
        income=0
    [/side]

    [side]
        side=4
        controller=ai
        team_name=animhack
        user_team_name= _ "team_name^."
        hidden=yes
        no_leader=yes
        color=black

        gold=0
        income=0
    [/side]

#define REDPORTAL_CLOSE
    {IF_VAR abyss equals 1 (
        [then]
            {IF_VAR closed not_equals yes (
                [then]
                    {VARIABLE closed yes}
                    {VARIABLE abyss 0}
                    {SCROLL_TO 32 13}
                    {FLASH_WHITE (
                        {REMOVE_IMAGE 30 14}
                        [remove_sound_source]
                            id=abyss
                        [/remove_sound_source]
                        [sound]
                            name=lightning-miss.ogg
                        [/sound]
                        [kill]
                            side=2,3
                            [filter_location]
                                terrain=Ql
                            [/filter_location]
                            animate=no
                        [/kill]
                        [store_unit]
                            [filter]
                                side=1
                                [filter_location]
                                    terrain=Ql
                                [/filter_location]
                            [/filter]
                            variable=safety
                            kill=yes
                        [/store_unit]
                        [store_locations]
                            terrain=Ql
                            variable=portal
                        [/store_locations]

                        [foreach]
                            array=portal
                            [do]
                                [terrain]
                                    terrain=Xv
                                    x,y=$this_item.x,$this_item.y
                                [/terrain]
                            [/do]
                        [/foreach]
                        {CLEAR_VARIABLE portal}

                        [foreach]
                            array=safety
                            [do]
                                [unstore_unit]
                                    variable=this_item
                                    find_vacant=yes
                                    animate=no
                                [/unstore_unit]
                            [/do]
                        [/foreach]
                        {CLEAR_VARIABLE safety}
                        [terrain]
                            x,y=1,1
                            terrain=Xv^Yzzy
                        [/terrain]
                        [terrain]
                            x,y=26,7
                            terrain=Xv
                        [/terrain]
                        [kill]
                            type=TLU_animhack
                            animate=no
                        [/kill]
                        [redraw]
                        [/redraw]
                    )}
                    [delay]
                        time=500
                    [/delay]
                [/then]
            )}
        [/then]
    )}
#enddef

    #prestart
    [event]
        name=prestart

        {VARIABLE abyss 0}

        [recall]
            id=Rashti
        [/recall]

        {BADASS_MODE_CHANGE (
            {UNIT 2 (EoMa_Sorcerer) 29 21 (id,facing,canrecruit=Mage,sw,yes)}
        ) ()}
    [/event]

    #start
    [event]
        name=start
        {SCROLL_TO 28 19}
        {BADASS_MODE_CHANGE (
            [kill]
                type=EoMa_Shadowmage
                animate=no
            [/kill]
            [message]
                speaker=Mehir
                message= _ "So here's our little coward. Ready to join your comrades in eternal life?"
            [/message]
            [message]
                speaker=Mage
                message= _ "M-master Aerius! Th-this is him! Please, do something!"
            [/message]
            [message]
                speaker=Aerius
                message= _ "*to the mage* Stop shaking! And wipe the tears from your eyes. You look pathetic!"
            [/message]
            [delay]
                time=500#new
            [/delay]
        ) (
            [message]
                speaker=Mehir
                image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "You again?!"
            [/message]
        )}
        [message]
            speaker=Aerius
            message= _ "Ah, welcome, summoner, you look familiar. It appears my little visit to al-Kamija helped you get a promotion... heh, you can thank me later. Let me guess, you have come for one of your leaders, right? He is... well, how do I put it... not exactly here anymore."
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "You killed Tashkar, didn't you?! That damn grin on your face just screams it!"
        [/message]
        [message]
            speaker=Aerius
            message= _ "It's nothing major, he and his troops are merely behind this huge red circle."
        [/message]
        {SCROLL_TO 32 13}
        [delay]
            time=500
        [/delay]
        [message]
            speaker=Mehir
            image="portraits/mehir-commander-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "<b>...WHAT?!</b>"
        [/message]
        [message]
            speaker=Rashti
            message= _ "He is telling the truth. I can no longer sense my master in this world."
        [/message]
        [message]
            speaker=Aerius
            message=_ "I do not now how much you were told, summoner, but this Tash... no matter what was his name... He set out to disturb our research site. That insolent buffoon ordered us to go away. We're not magical entities to be treated as such. It was very insulting..."
        [/message]
        [message]
            speaker=Aerius
            message=_ "Anyway, you see, when we refused to ‘go away’, he attacked our peaceful expedition. We were not well prepared for an all-out fight, and he did not listen to us, so we decided to activate this gate. It sucked his whole squad into the Red Abyss."
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-commander-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message=_ "...the Red Abyss?! The place of ultimate chaos? The home of all Efreet and Dharma’rhamis? The most dangerous part of the entire dimension?"
        [/message]
        [message]
            speaker=Rashti
            image="portraits/rashti-ho.png"
            message=_ "My master is dead..."
        [/message]
        [message]
            speaker=Aerius
            message=_ "Come on, it's not a big deal. He's just stuck there for eternity, with his body completely incinerated, and likely separated from his soul..."
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message=_ "...I... <b>I can’t believe this! You attacked our capital, tried to steal a holy relic of ours, and then you broke into our catacombs and murdered one of our leaders in cold blood like it's nobody's business! Just who on earth are you?!!!</b>"
        [/message]
        [message]
            speaker=Aerius
            message=_ "I don't feel like explaining all that; you would not understand anyway. Look, we just need about a week to finish our research here, and then we will ‘go away’. You have a choice: you can quietly return from where you came, or fight, and share his fate."
        [/message]
        [message]
            speaker=Rashti
            message=_ "My master is dead..."
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Now, listen! I don’t give a damn about who you people are, this has gone way too far, and you will pay dearly for this. Everyone, we shall avenge Tashkar's death. <b>CHAAARGE!!!</b>"
        [/message]
        [message]
            speaker=Rashti
            image="portraits/rashti-dharma.png"
            message= _ "MY MASTER IS DEAD!!! I WILL HOLLOW YOUR EYES OUT!!!"
        [/message]
        [message]
            speaker=Aerius
            message=_ "Well, I guess you're not changing your mind anytime soon. Seems like I'll have to do this the old-fashioned way."
        [/message]
        {MOVE_UNIT id=Aerius 26 19}
        [message]
            speaker=narrator
            image=portraits/narrator.png
            message= _ "Hexes with carpets on them act like keeps. Use them to recruit your troops."
        [/message]
        [message]
            speaker=narrator
            image=portraits/narrator.png
            message= _ "When standing on the blue circles, your units recover 12 hitpoints per turn (does not cancel the healing provided by other factors, such regeneration, rest, etc.)."
        [/message]
        [objectives]
            side=1
            [objective]
                description= _ "Kill Aerius"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Mehir"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Rashti"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]

#define REDPORTAL
    {VARIABLE abyss 1}
    {SCROLL_TO 32 13}
    [delay]
        time=500
    [/delay]
    [sound]
        name=fire.wav
    [/sound]

    [unit]
        type=TLU_animhack
        variation=redabyss-activation
        side=3
        x=31
        y=13
        facing=se
        placement,overwrite=map,yes
        animate=yes
    [/unit]
    {PLACE_HALO "scenery/white.png" 31 13}

    [sound]
        name=lightning-miss.ogg
    [/sound]
    [sound_source]
        id=abyss
        x,y=33,16
        sounds="abyss.ogg"
        delay=0
        chance=100
        full_range=15
        fade_range=10
        loop=-1
    [/sound_source]
    [delay]
        time=500
    [/delay]
    [terrain]
        terrain=Ql
        x=26
        y=8-13
    [/terrain]
    [terrain]
        terrain=Ql
        x=27
        y=8-15
    [/terrain]
    [terrain]
        terrain=Ql
        x=28
        y=7-15
    [/terrain]
    [terrain]
        terrain=Ql
        x=29
        y=8-16
    [/terrain]
    [terrain]
        terrain=Ql
        x=30
        y=7-17
    [/terrain]
    [terrain]
        terrain=Ql
        x=31
        y=8-18
    [/terrain]
    [terrain]
        terrain=Ql
        x=32
        y=8-18
    [/terrain]
    [terrain]
        terrain=Ql
        x=33
        y=9-19
    [/terrain]
    [terrain]
        terrain=Ql
        x=34
        y=9-18
    [/terrain]
    [terrain]
        terrain=Ql
        x=35
        y=11-19
    [/terrain]
    [terrain]
        terrain=Ql
        x=36
        y=11-19
    [/terrain]
    [terrain]
        terrain=Ql
        x=37
        y=13-19
    [/terrain]
    [terrain]
        terrain=Ql
        x=38
        y=15-18
    [/terrain]
    {TLU_SMOOTH_REPLACE_MUSIC In_the_Land_of_Madness.ogg 1500 0}
    [kill]
        x,y=31,13
    [/kill]
    [terrain]
        x,y=1,1
        terrain=Xv^Yyyz
        layer=both
    [/terrain]
    #portal
    [terrain]
        x,y=26,7
        terrain=Xv^Yzzz
        layer=both
    [/terrain]

    {FADE_STEP 225 50}
    {REMOVE_IMAGE 31 13}
    {FADE_STEP 192 5}
    {FADE_STEP 160 5}
    {FADE_STEP 128 5}
    {FADE_STEP 96 5}
    {FADE_STEP 64 5}
    {FADE_STEP 32 5}
    {FADE_STEP 0 5}
    [delay]
        time=1000
    [/delay]
#enddef

#define SEQUENCE_PHYSICS
    #physics
    [terrain]
        x,y=1,1
        terrain=Xv^Yyzz
        layer=both
    [/terrain]
    {SCROLL_TO 32 15}
    [unit]
        type=TLU_animhack
        variation=redabyss-physics
        side=3
        x=30
        y=14
        facing=se
        placement,overwrite=map,yes
    [/unit]
    [animate_unit]
        flag=force
        [filter]
            x,y=30,14
        [/filter]
    [/animate_unit]
    [kill]
        x,y=30,14
        animate=no
    [/kill]
    [terrain]
        terrain=Ur
        x,y=25,19
        radius=2
        [filter_radius]
            [not]
                terrain=Qxu^Qov
            [/not]
        [/filter_radius]
        layer=both
    [/terrain]
    [terrain]
        terrain=Ur
        x,y=30,21
        radius=2
        [filter_radius]
            [not]
                terrain=Qxu^Qov
            [/not]
        [/filter_radius]
        layer=both
    [/terrain]
    {UNIT 4 (TLU_animhack) 39 14 (facing,variation=ne,redabyss1)}
    {UNIT 4 (TLU_animhack) 40 13 (facing,variation=ne,redabyss2)}
    {UNIT 4 (TLU_animhack) 40 14 (facing,variation=ne,redabyss3)}
#enddef

#define UNIT_SUCKED_IN_ANIM X Y ANIM
    [object]
        silent=yes
        duration=forever
        [filter]
            x,y={X},{Y}
        [/filter]
        [effect]
            apply_to=new_animation
            [animation]
                apply_to=sucked
                {ANIM}
            [/animation]
        [/effect]
    [/object]
    [animate_unit]
        flag=sucked
        [filter]
            x,y={X},{Y}
        [/filter]
    [/animate_unit]
    [kill]
        x,y={X},{Y}
        fire_event=yes
    [/kill]
#enddef

    #badass - on turn 4 Mehir has a brilliant idea
    [event]
        name=turn 4

        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message=_ "*looks around the chamber* Your Highness, I think I have an idea... Do you know how to activate that giant red circle?"
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-ho.png"
                message= _ "Yes, why are you asking?"
            [/message]
            [message]
                speaker=Mehir
                message=_ "We can make them fall into the Red Abyss! Could you say the activation spell?"
            [/message]
            [message]
                speaker=Aerius
                message=_ "Wait, are you trying to..."
            [/message]
            [message]
                speaker=Rashti
                message=_ "Of course. Great idea!"
            [/message]
            [message]
                speaker=Aerius
                message=_ "No! Don't do this! That was supposed to be part of <b>my</b> plan!"
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-dharma.png"
                message=_ "Shakataraja Ramidajana Katarajan"
            [/message]
            {REDPORTAL}
            [message]
                speaker=Mage
                message=_ "Master Aerius! We are DOOMED!"
            [/message]
            [message]
                speaker=Aerius
                message=_ "You don't saaaaaaAAAAAA...!!!"
            [/message]
            {VARIABLE activation_ai_turn_skip yes}
            {MOVE_UNIT id=Aerius 26 19}
            {MODIFY_UNIT id=Aerius facing sw}
            {UNIT_SUCKED_IN_ANIM 26 19 (
                [frame]
                    duration=2000
                    alpha=1.0~0.0
                    offset=0.0~-10.0
                [/frame]
            )}
            {MOVE_UNIT id=Mage 29 21}
            {MODIFY_UNIT id=Mage facing sw}
            {UNIT_SUCKED_IN_ANIM 29 21 (
                [frame]
                    duration=1600
                    alpha=1.0~0.0
                    offset=0.0~-8.0
                [/frame]
            )}
            {SEQUENCE_PHYSICS}
            [end_turn]
            [/end_turn]
        ) ()}
    [/event]

    #badass - skip turn when portal opens
    [event]
        name=side 2 turn
        first_time_only=no

        {IF_VAR activation_ai_turn_skip equals yes (
            [then]
                {CLEAR_VARIABLE activation_ai_turn_skip}
                [end_turn]
                [/end_turn]
            [/then]
        )}
    [/event]

    #badass - the portal is opened, new objective
    [event]
        name=side 3 turn 4

        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message=_ "Serves him right... but it seems like we created another problem for ourselves. We need to close this portal otherwise it will suck us in!"
            [/message]
            [message]
                speaker=Rashti
                message=_ "I can try to close it from afar, but it may take some time."
            [/message]
            [message]
                speaker=Mehir
                message=_ "Do whatever you have to do, Your Highness. My troops will cover you!"
            [/message]
            [modify_turns]
                value=15
            [/modify_turns]
            [objectives]
                side=1
                [objective]
                    description= _ "Survive until turns run out"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Death of Mehir"
                    condition=lose
                [/objective]
                [objective]
                    description= _ "Death of Rashti"
                    condition=lose
                [/objective]
                [gold_carryover]
                    bonus=no
                    carryover_percentage=40
                [/gold_carryover]
                note=_"Unlike in most scenarios, running out turns counts as a victory."
            [/objectives]
        ) ()}
    [/event]

    #Magi talk on turn 3
    [event]
        name=side 2 turn 3

        {BADASS_MODE_CHANGE () (
            [message]
                type=EoMa_Mystic_Warrior
                message=_ "Sir, we have already gathered all the information we needed. We need not suffer more losses. Guru did not give us the permission."
            [/message]
            [message]
                speaker=Aerius
                message=_ "Come on, Guru is not here."
            [/message]
            [message]
                type=EoMa_Mystic_Warrior
                message=_ "The Council of Masters will be very dissatisfied with the outcome of this expedition."
            [/message]
            [message]
                speaker=Aerius
                message=_ "The Council does not care about the collateral damage. The means are justified by the end."
            [/message]
        )}
    [/event]

    #turn 7 - Aerius provokes Rashti to open the portal
    [event]
        name=turn 6#7
        {BADASS_MODE_CHANGE () (
            [store_unit]
                [filter]
                    id=Aerius
                [/filter]
                variable=aer
                kill=no
            [/store_unit]
            {SCROLL_TO $aer.x $aer.y}
            [kill]
                id=Aerius
                animate=no
                fire_event=no
            [/kill]
            [sound]
                name=gust.wav
            [/sound]
            {FAKE_SCENERY_ANIM scenery/master-of-air-camp1 11 $aer.x $aer.y 100}
            {SCROLL_TO 32 6}
            {REVERSE_SCENERY_ANIM scenery/master-of-air-camp1 11 32 6 100}
            [unstore_unit]
                variable=aer
                find_vacant=no
                x,y=32,6
            [/unstore_unit]
            {CLEAR_VARIABLE aer}
            [message]
                speaker=Aerius
                message= _ "Rashti. Do you remember the first time you came here with your master? When you were fighting, I asked you to read the inscription on that big circle. I assume that you would not do that again, would you?"
            [/message]
            [message]
                speaker=Rashti
                message=_ "..."
            [/message]
            [message]
                speaker=Mehir
                image="portraits/mehir-commander-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message=_ "Wait a... Rashti, did you say the activation spell?!"
            [/message]
            [message]
                speaker=Aerius
                message= _ "Yes, summoner, it was she who opened the portal that sucked her master in, and yet apparently all the blame goes to me. How's that fair?"
            [/message]
            [message]
                speaker=Mehir
                image="portraits/mehir-commander-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message=_ "(to Rashti) Did you actually do that?!"
            [/message]
            [message]
                speaker=Rashti
                message=_ "..."
            [/message]
            [message]
                speaker=Rashti
                message=_ "Yes..."
            [/message]
            [message]
                speaker=Aerius
                message= _ "She did not witness the death of her master. I blew her out of this place, a few days of walking from here."
            [/message]
            [message]
                speaker=Aerius
                message=_ "Rashti, you will not make the same mistake again. You will not read the spell. But I wonder whether you... remember it."
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-dharma.png"
                message=_ "BLOODY HELL, OF COURSE I REMEMBER, YOU AIRHEADED BASTARD!!! I am an ABYSSAL being for Nomolas's sake, we NEVER forget!"
            [/message]
            [message]
                speaker=Aerius
                message=_ "Oh, really? I don't believe you. If you truly remember the spell, prove it."
            [/message]
            [message]
                speaker=Mehir
                message= _ "Don’t do th..."
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-dharma.png"
                message= _ "PROVE IT? You want me to PROVE IT? OH I'M GONNA PROVE IT ALL RIGHT!!! SHAKATARAJA RAMIDAJANA KATARAJAN!!!"
            [/message]
            {REDPORTAL}
            {SEQUENCE_PHYSICS}
            [message]
                speaker=Aerius
                message= _ "*to himself* <i>Meh... that was too easy. I love naïveté of abysmal beings. I can barely believe that she just fell for the oldest trick in the book...</i>"
            [/message]
            [message]
                speaker=Mehir
                image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "Rashti, what have you done?! It’s pulling us in!!!"
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-dharma.png"
                message= _ "Argh, I can't believe it, I fell for it again, I am a failure..."
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-ho.png"
                message= _ "You can reflect on your mistake later. What matters now is killing the true culprit - the human."
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-dharma.png"
                message= _ "Yes... you're right."
            [/message]
            [message]
                speaker=Rashti
                message= _ "Mehir, I must climb to where he stands, and RIP HIM TO SHREDS!!!"
            [/message]
            {SCROLL_TO 15 23}
            [delay]
                time=500
            [/delay]
            {SCROLL_TO 11 19}
            [delay]
                time=500
            [/delay]
            [message]
                speaker=Mehir
                image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "You better hurry up before we get sucked into this hell!"
            [/message]
            {PLACE_HALO "halo/ring[6~8].png:100" 32 6}
            {HIGHLIGHT_IMAGE 15 22 "items/gohere.png" ()}
            {VARIABLE abyss 1}
            [store_unit]
                [filter]
                    id=Rashti
                [/filter]
                variable=rashti
                kill=no
            [/store_unit]
            {SCROLL_TO $rashti.x $rashti.y}
            {CLEAR_VARIABLE rashti}
            [object]
                name=""
                image="portraits/rashti.png~CROP(157,78,87,87)~SCALE(72,72)"
                duration=scenario
                description= _ "Rashti's determination to kill Aerius allows her to ignore enemy ZoC, and her movement is increased by 1. (this bonus only lasts until the end of the scenario)"
                [filter]
                    id=Rashti
                [/filter]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        {ABILITY_SKIRMISHER}
                    [/abilities]
                [/effect]
                [effect]
                    apply_to=movement
                    increase=1
                [/effect]
            [/object]
            [modify_unit]
                [filter]
                    id=Rashti
                [/filter]
                moves=7
            [/modify_unit]
        )}
        {BADASS_MODE_CHANGE () (
            [modify_turns]
                value=40
            [/modify_turns]
        )}
    [/event]

    #Rashti jumps onto the platform
    [event]
        name=moveto
        first_time_only=no

        [filter]
            x,y=15,22
            id=Rashti
        [/filter]

        {BADASS_MODE_CHANGE () (
            [if]
                [variable]
                    name=abyss
                    equals=1
                [/variable]
                [then]
                    {SCROLL_TO 13 21}
                    {REMOVE_IMAGE 15 22}
                    [store_unit]
                        [filter]
                            x,y=15,22
                        [/filter]
                        variable=jumping
                        kill=yes
                    [/store_unit]
                    [redraw]
                    [/redraw]
                    {FAKE_SCENERY_ANIM scenery/jump 19 13 20 75}
                    {PLACE_HALO "scenery/jump-19.png" 13 20}
                    [unstore_unit]
                        variable=jumping
                        x,y=11,18
                    [/unstore_unit]
                    [delay]
                        time=500
                    [/delay]
                    [message]
                        speaker=Mehir
                        image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                        message= _ "Run, Rashti, run. You're our only hope!"
                    [/message]
                    {PLACE_IMAGE "items/gohere.png" 23 3}
                    {HIGHLIGHT_IMAGE 23 3 "items/gohere.png" ()}
                    {REMOVE_IMAGE 13 20}
                [/then]
            [/if]
        )}
    [/event]

    #Shadow Mage amushes Rashti
    [event]
        name=sighted
        [filter]
            type=EoMa_Shadowmage
        [/filter]

        [message]
            speaker=unit
            message= _ "Stop right there!"
        [/message]
        [message]
            speaker=Rashti
            image="portraits/rashti-dharma.png"
            message= _ "HELL NO!!! NOW GET OUT OF MY WAY!!! I'VE GOT UNIFINISHED BUSINESS TO ATTEND TO!!!"
        [/message]
        [message]
            speaker=unit
            message= _ "Over my dead body!"
        [/message]
        [message]
            speaker=Rashti
            image="portraits/rashti-ho.png"
            message= _ "We can arrange that..."
        [/message]
    [/event]

    #Rashti kills Aerius
    [event]
        name=moveto
        first_time_only=no

        [filter]
            x,y=23,3
            id=Rashti
        [/filter]
        {REMOVE_IMAGE 23 3}
        {SCROLL_TO 31 7}
        [store_unit]
            [filter]
                x,y=23,3
            [/filter]
            variable=running
            kill=yes
        [/store_unit]
        [redraw]
        [/redraw]
        {FAKE_SCENERY_ANIM scenery/run 18 31 12 50}
        {REMOVE_IMAGE 32 6}
        [sound]
            name={SOUND_LIST:SWORD_SWISH}
        [/sound]
        [harm_unit]
            [filter]
                id=Aerius
            [/filter]
            amount=100
            fire_event=no
            animate=yes
            delay=0
            kill=no
        [/harm_unit]
        [message]
            speaker=Aerius
            message= _ "Argh!... I'm...too...young...to...die..."
        [/message]
        [sound]
            name=human-die-1.ogg
        [/sound]
        [kill]
            id=Aerius
            fire_event=yes
        [/kill]
        [redraw]
        [/redraw]
        {FAKE_SCENERY_ANIM scenery/fall 7 32 7 100}
        [unstore_unit]
            variable=running
            x,y=33,20
            find_vacant=no
        [/unstore_unit]
        [redraw]
        [/redraw]
        [delay]
            time=1000
        [/delay]
        {SCROLL_TO 33 20}
        [delay]
            time=500
        [/delay]
        [message]
            speaker=Mehir
            message= _ "Serves him right..."
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Rashti! Get away from there! We must close the portal!"
        [/message]
        [message]
            speaker=Rashti
            message= _ "..."
        [/message]
        {REDPORTAL_CLOSE}
        [message]
            speaker=Mehir
            message=_ "Wow... how did you pull this off?"
        [/message]
        [message]
            speaker=Rashti
            message= _ "I used that scumbag's soul to close the gate, to ensure he won't return ever again."
        [/message]
        [if]
            [have_unit]
                side=2
                [or]
                    side=3
                [/or]
            [/have_unit]
            [then]
                {TLU_SMOOTH_REPLACE_MUSIC New_Wesnoth_Battle_Music.ogg 2000 0}
                [message]
                    speaker=Rashti
                    message= _ "And now..."
                [/message]
                [message]
                    speaker=Rashti
                    image=portraits/rashti-dharma.png
                    message= _ "KILL THE REST!!! SHOW NO MERCY TO THESE SCUM!!!"
                [/message]
            [/then]
            [else]
                [endlevel]
                    result=victory
                    carryover_report=yes
                    {NEW_GOLD_CARRYOVER 40}
                    bonus=no
                [/endlevel]
            [/else]
        [/if]
        {VARIABLE abyss 0}
    [/event]

    #enemies defeated = victory
    [event]
        name=die
        first_time_only=no
        [filter]
            side=2
            [or]
                side=3
            [/or]
        [/filter]
        [if]
            [have_unit]
                side=2
                [or]
                    side=3
                [/or]
            [/have_unit]
            [else]
                {IF_VAR closed equals yes (
                    [then]
                        {REDPORTAL_CLOSE}
                        {VARIABLE closed yes}
                        [endlevel]
                            result=victory
                            carryover_report=yes
                            {NEW_GOLD_CARRYOVER 40}
                            bonus=no
                        [/endlevel]
                    [/then]
                )}
            [/else]
        [/if]
    [/event]

    #time over
    [event]
        name=time over
        first_time_only=no

        {BADASS_MODE_CHANGE (
            {REDPORTAL_CLOSE}
            {VARIABLE closed yes}
            [if]
                [have_unit]
                    side=2
                    [or]
                        side=3
                    [/or]
                [/have_unit]
                [then]
                    {TLU_SMOOTH_REPLACE_MUSIC New_Wesnoth_Battle_Music.ogg 2000 0}
                    [message]
                        speaker=Rashti
                        message= _ "The portal has been closed! Let’s defeat the rest!"
                    [/message]
                    [modify_turns]
                        value=-1
                    [/modify_turns]
                [/then]
                [else]
                    [endlevel]
                        result=victory
                        carryover_report=yes
                        {NEW_GOLD_CARRYOVER 40}
                        bonus=no
                    [/endlevel]
                [/else]
            [/if]
        ) (
            {MOVE_UNIT (id=Rashti) 23 3}
            [fire_event]
                name=moveto
                [primary_unit]
                    x,y=23,3
                    id=Rashti
                [/primary_unit]
            [/fire_event]
            [endlevel]
                result=victory
                carryover_report=yes
                {NEW_GOLD_CARRYOVER 40}
                bonus=no
            [/endlevel]
        )}
    [/event]

    #victory
    [event]
        name=victory
        {TLU_SMOOTH_REPLACE_MUSIC zhaytee_tragedy.ogg 3000 0}
        [message]
            speaker=Mehir
            message=_ "That’s the last of them. We must bring the sad news to al-Kamija. Tashkar has been killed..."
        [/message]
        [message]
            speaker=Rashti
            image="portraits/rashti-ho.png"
            message= _ "Mehir... please... be my new master."
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-commander-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message=_ "What?! Me?! But..."
        [/message]
        [message]
            speaker=Rashti
            message=_ "You are worthy."
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "Finally a female abysmal likes me! But..."
            [/message]
        ) ()}
        [message]
            speaker=Mehir
            message= _ "I... I think that is up to the High Council to decide. Besides, I’m not one of three city leaders. They are the only ones that are allowed to have Ultimate Beings as servants, you know."
        [/message]
        [message]
            speaker=Rashti
            message= _ "So be it. Let the High Council decide."
        [/message]
        {CLEAR_VARIABLE abyss}
        {CLEAR_VARIABLE closed}
        {CLEAR_VARIABLE start_x}
        {CLEAR_VARIABLE start_y}
        {CLEAR_VARIABLE test_x}
        {CLEAR_VARIABLE jumping}
        {CLEAR_VARIABLE redbeings}
        {CLEAR_VARIABLE running}
    [/event]

    #vortex spawns enemies
    [event]
        name=side 3 turn
        first_time_only=no

        [if]
            [variable]
                name=abyss
                equals=1
            [/variable]
            [then]
                #spawn enemies
                {RANDOM 1..2}
                [switch]
                    variable=random
                    [case]
                        value=1
                        {UNIT 3 (EoMa_Efreet) 33 17 (facing,animate=sw,yes)}
                    [/case]
                    [else]
                        {UNIT 3 (EoMa_DharmaRhami) 31 19 (facing,animate=sw,yes)}
                    [/else]
                [/switch]
                [store_unit]
                    [filter]
                        side=3
                    [/filter]
                    kill=no
                    variable=redbeings
                [/store_unit]
                {BADASS_MODE_CHANGE (
                    {IF_VAR redbeings.length less_than 6 (
                        [then]
                            {RANDOM 1..3}
                            [switch]
                                variable=random
                                [case]
                                    value=2
                                    {UNIT 3 (EoMa_DharmaRhami) 31 19 (facing,animate=sw,yes)}
                                [/case]
                                [else]
                                    {UNIT 3 (EoMa_Efreet) 33 17 (facing,animate=sw,yes)}
                                [/else]
                            [/switch]
                        [/then]
                    )}
                ) ()}
            [/then]
        [/if]
    [/event]

    #Mehir remarks on red beings arriving
    [event]
        name=moveto
        [filter]
            side=3
        [/filter]

        [message]
            speaker=Mehir
            image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Oh no... The dwellers of the Red Abyss are flooding into our realm! If we do not close the portal soon, this will be the end of the world!"
        [/message]
    [/event]

    #red beings attack - speech
    [event]
        name=attack
        [filter]
            side=3
        [/filter]
        [filter_second]
            [not]
                id=Rashti
            [/not]
        [/filter_second]

        [message]
            speaker=unit
            message= _ "A world of MORTALS! How nice! It's time to lay it to RUIN!"
        [/message]
    [/event]

#define TLU_CHAOS_RASHTI_LINES
    [message]
        speaker=Rashti
        image="portraits/rashti-dharma.png"
        message= _ "Well well, yet another pathetic rebellion in the Red Abyss? Seems it is time for me to take out the trash yet again."
    [/message]
    [message]
        speaker=Mehir
        message= _ "You sound... calmer than usual for your half, Your Highness."
    [/message]
    [message]
        speaker=Rashti
        image="portraits/rashti-dharma.png"
        message= _ "Hehe, I gotta set a good example in front of my subjects, you know, even if they are unruly thugs like these."
    [/message]
    [message]
        speaker=Rashti
        image="portraits/rashti-dharma.png"
        message= _ "Anyway, formal politeness aside, I WILL SHRED YOU INTO TINY BITS AND TURN YOU INSIDE OUT YOU, PATHETIC REBEL SCUM!!!"
    [/message]
    {VARIABLE chaos_rasthi_lines yes}
#enddef

    #red beings attack Rashti - speech
    [event]
        name=attack
        [filter]
            side=3
        [/filter]
        [filter_second]
            id=Rashti
        [/filter_second]
        [filter_condition]
            {VARIABLE_CONDITIONAL chaos_rasthi_lines not_equals yes}
        [/filter_condition]

        [message]
            speaker=unit
            message= _ "Ah, look who it is. The tyrant queen and bootlicker of humans, Rashti'rhami herself! Everyone, now's our chance, she is weaker in the mortal world! Get her!"
        [/message]
        {TLU_CHAOS_RASHTI_LINES}
    [/event]

    #Rashti attacks red beings  - speech
    [event]
        name=attack
        [filter]
            id=Rashti
        [/filter]
        [filter_second]
            side=3
        [/filter_second]
        [filter_condition]
            {VARIABLE_CONDITIONAL chaos_rasthi_lines not_equals yes}
        [/filter_condition]

        [message]
            speaker=second_unit
            message= _ "Ah, look who it is. The tyrant queen and bootlicker of humans, Rashti'rhami herself! Everyone, now's our chance, she is weaker in the mortal world! Get her!"
        [/message]
        {TLU_CHAOS_RASHTI_LINES}
    [/event]

    #vortex action
    [event]
        name=side 1 turn,side 2 turn,move
        id=move
        first_time_only=no

        [if]
            [variable]
                name=abyss
                equals=1
            [/variable]
            [then]
                {VARIABLE start_x 28}
                {VARIABLE start_y 16}
                {VARIABLE x 28}
                {VARIABLE y 16}
                {VARIABLE i 0} #width
                {VARIABLE j 0} #length

                #35,21
                [if]
                    [have_unit]
                        x,y=35,21
                        [not]
                            side=3
                        [/not]
                        [not]
                            ability=soul_catcher
                        [/not]
                    [/have_unit]
                    [then]
                        {MODIFY_UNIT x,y=35,21 facing n}
                        {UNIT_SUCKED_IN_ANIM 35 21 (
                            [frame]
                                duration=800
                                alpha=1.0~0.0
                                offset=0.0~4.0
                            [/frame]
                        )}
                    [/then]
                [/if]

                [while]
                    [variable]
                        name=j
                        less_than=32
                    [/variable]
                    [do]
                        [while]
                            [variable]
                                name=i
                                less_than=8
                            [/variable]
                            [do]
                                [if]
                                    [have_unit]
                                        x,y=$x,$y
                                        [not]
                                            side=3
                                        [/not]
                                        [not]
                                            ability=soul_catcher
                                        [/not]
                                    [/have_unit]
                                    [variable]
                                        #this works around problem with off-map coordinates sometimes seeming to have a unit
                                        name=x
                                        greater_than=0
                                    [/variable]
                                    [then]
                                        {IF_VAR j less_than 3 (
                                            [then]
                                                #suck in
                                                {MODIFY_UNIT x,y=$x,$y facing ne}
                                                {IF_VAR i equals 6 (
                                                    [then]
                                                        {UNIT_SUCKED_IN_ANIM $x $y (
                                                            [frame]
                                                                duration=800
                                                                alpha=1.0~0.0
                                                                offset=0.0~4.0
                                                                y=0~-72
                                                            [/frame]
                                                        )}
                                                    [/then]
                                                    [else]
                                                        {IF_VAR i equals 7 (
                                                            [then]
                                                                {UNIT_SUCKED_IN_ANIM $x $y (
                                                                    [frame]
                                                                        duration=800
                                                                        alpha=1.0~0.0
                                                                        offset=0.0~2.0
                                                                        y=0~-216
                                                                    [/frame]
                                                                )}
                                                            [/then]
                                                            [else]
                                                                #standard anim
                                                                {UNIT_SUCKED_IN_ANIM $x $y (
                                                                    [frame]
                                                                        duration=800
                                                                        alpha=1.0~0.0
                                                                        offset=0.0~4.0
                                                                    [/frame]
                                                                )}
                                                            [/else]
                                                        )}
                                                    [/else]
                                                )}
                                            [/then]
                                            [else]
                                                [move_unit]
                                                    x,y=$x,$y
                                                    dir=ne,ne
                                                [/move_unit]
                                            [/else]
                                        )}
                                    [/then]
                                [/if]

                                #jump to the next hex in line
                                {VARIABLE test_x $x}
                                {VARIABLE_OP test_x modulo 2}
                                {VARIABLE_OP x add 1}
                                [if]
                                    [variable]
                                        name=test_x
                                        greater_than=0
                                    [/variable]
                                    [then]
                                    [/then]
                                    [else]
                                        {VARIABLE_OP y add 1}
                                    [/else]
                                [/if]

                                {VARIABLE_OP i add 1}
                            [/do]
                        [/while]
                        {VARIABLE i 0}

                        {VARIABLE test_x $start_x}
                        {VARIABLE_OP start_x sub 1}
                        {VARIABLE x $start_x}
                        {VARIABLE_OP test_x modulo 2}
                        [if]
                            [variable]
                                name=test_x
                                greater_than=0
                            [/variable]
                            [then]
                                {VARIABLE y $start_y}
                            [/then]
                            [else]
                                {VARIABLE_OP start_y add 1}
                                {VARIABLE y $start_y}
                            [/else]
                        [/if]

                        {VARIABLE_OP j add 1}
                    [/do]
                [/while]
                {VARIABLE j 0}
            [/then]
        [/if]
    [/event]

#define HEALING_CIRCLE X Y AMOUNT
    [heal_unit]
        [filter]
            x,y={X},{Y}
        [/filter]
        amount={AMOUNT}
        animate=yes
    [/heal_unit]
#enddef

    #healing
    [event]
        name=new turn
        first_time_only=no

        {HEALING_CIRCLE 10 24 12}
        {HEALING_CIRCLE 15 22 12}
        {HEALING_CIRCLE 20 19 12}
        {HEALING_CIRCLE 19 29 12}
        {HEALING_CIRCLE 24 26 12}
        {HEALING_CIRCLE 29 24 12}
    [/event]

    #debug events
    [event]
        name=open
        first_time_only=no

        [unit]
            type=TLU_animhack
            variation=redabyss-activation
            side=3
            x=31
            y=13
            facing=se
            placement,overwrite=map,yes
            animate=yes
        [/unit]
        {PLACE_HALO "scenery/white.png" 31 13}
        [fire_event]
            name=open2
        [/fire_event]
    [/event]
    [event]
        name=open2
        first_time_only=no

        {VARIABLE abyss 1}
        [kill]
            x,y=31,13
        [/kill]
        [terrain]
            x,y=1,1
            terrain=Xv^Yyyz
            layer=both
        [/terrain]
        #portal
        [terrain]
            x,y=26,7
            terrain=Xv^Yzzz
            layer=both
        [/terrain]

        {FADE_STEP 225 50}
        {REMOVE_IMAGE 31 13}
        {FADE_STEP 192 5}
        {FADE_STEP 160 5}
        {FADE_STEP 128 5}
        {FADE_STEP 96 5}
        {FADE_STEP 64 5}
        {FADE_STEP 32 5}
        {FADE_STEP 0 5}
    [/event]
    [event]
        name=anim
        first_time_only=no

        [terrain]
            x,y=1,1
            terrain=Xv^Yyzz
            layer=both
        [/terrain]
        [unit]
            type=TLU_animhack
            variation=redabyss-physics
            side=3
            x=30
            y=14
            facing=se
            placement,overwrite=map,yes
        [/unit]
        [animate_unit]
            flag=force
            [filter]
                type=TLU_animhack
            [/filter]
        [/animate_unit]
        [kill]
            x,y=30,14
            animate=no
        [/kill]
    [/event]
    [event]
        name=badass

        {VARIABLE badass_mode_active yes}
        {UNIT 2 (EoMa_Sorcerer) 29 21 (id,facing,canrecruit=Mage,sw,yes)}
        [fire_event]
            name=turn 4
        [/fire_event]
    [/event]

    {ITEM_APPLIER}
    {SUMMONER_LOCK}
    {JINN_LOCK}
    {COLLAR_EVENT}
    {DEATH_MEHIR}
    {DEATH_RASHTI}
    {TLU_S10_TERRAIN}
[/scenario]
