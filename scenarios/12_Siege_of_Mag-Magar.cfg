#textdomain wesnoth-To_Lands_Unknown
[scenario]
    id=12_Siege_of_Mag-Magar
    next_scenario=13_A_New_Leader
    name= _ "Siege of Mag-Magar"
    map_data="{~add-ons/To_Lands_Unknown/maps/12_Siege_of_Mag-Magar.map}"
    turns=39
    victory_when_enemies_defeated=no

    {STORYTXT_MAG_MAGAR}

    [time]
        id=first_watch_magmagar
        name= _ "First Watch"
        image=misc/time-schedules/after-the-fall/14longdark3.png
        lawful_bonus=-25
    [/time]
    {SCENARIO_MUSIC leave_none_alive.ogg}
    {EXTRA_SCENARIO_MUSIC siege_of_laurelmor.ogg}
    {EXTRA_SCENARIO_MUSIC vengeful.ogg}

    [side]
        side=1
        controller=human
        team_name=mehirteam
        user_team_name= _ "team_name^Mehir"

        type=EoMa_Grand_Summoner
        id=Mehir
        name= _ "Mehir"
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Novice_Summoner,EoMa_Camel_Rider,EoMa_Carpet_Rider,EoMa_Water_Elemental,EoMa_Summoner,EoMa_Rhami,EoMa_Fire_Elemental

        {GOLD 500 375 320}
        {INCOME 30 25 20}
    [/side]

    [side]
        side=2
        controller=ai
        team_name=tharis
        user_team_name= _ "team_name^Unknown"
        color=brown

        type=EoMa_Matriarch_of_Emptiness
        id=Matriarch1
        name=_"Teryth"
        image_icon=portraits/tharis/matriarchofemptiness.png~CROP(150,70,100,100)~SCALE(72,72)
        generate_name=yes
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Disciple,EoMa_Witch,EoMa_Dark_Warrior,EoMa_Hydra,EoMa_Dark_Hunter,EoMa_Bladedancer,EoMa_Dark_Wizard,EoMa_Great_Witch,EoMa_Commander,EoMa_Dark_Slayer,EoMa_Raging_Hydra,EoMa_Great_Hunter,EoMa_Dark_Assassin,EoMa_Sworddancer,EoMa_Bladefury,EoMa_Pain_Mistress

        [ai]
            passive_leader=yes
            aggression=1.0
        [/ai]

        {GOLD 170 270 350}
        {INCOME 15 25 35}

        {UNIT 2 (EoMa_Bladedancer) 38 17 (facing,placement,passable=sw,map,yes)}
        {UNIT 2 (EoMa_Dark_Wizard) 40 18 (facing,placement,passable=sw,map,yes)}
        {UNIT 2 (EoMa_Great_Witch) 44 16 (facing,placement,passable=sw,map,yes)}
        {UNIT 2 (EoMa_Disciple) 32 18 (facing,placement,passable=sw,map,yes)}
        {UNIT 2 (EoMa_Witch) 30 17 (facing,placement,passable=sw,map,yes)}
        {UNIT 2 (EoMa_Dark_Warrior) 27 18 (facing,placement,passable=sw,map,yes)}
        {UNIT 2 (EoMa_Dark_Executioner) 38 24 (facing,placement,passable=se,map,yes)}
        {UNIT 2 (EoMa_Dark_Executioner) 37 26 (facing,placement,passable=se,map,yes)}
        {UNIT 2 (EoMa_Dark_Executioner) 39 23 (facing,placement,passable=se,map,yes)}
    [/side]

    [side]
        side=3
        controller=ai
        team_name=tharis
        user_team_name= _ "team_name^Unknown"
        color=purple

        type=EoMa_Cold_Matriarch
        id=Matriarch2
        name=_"Anaraclya"
        image_icon=portraits/tharis/coldmatriarch.png~CROP(180,50,90,90)~SCALE(72,72)
        generate_name=yes
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Disciple,EoMa_Witch,EoMa_Dark_Warrior,EoMa_Hydra,EoMa_Dark_Hunter,EoMa_Bladedancer,EoMa_Dark_Wizard,EoMa_Great_Witch,EoMa_Commander,EoMa_Dark_Slayer,EoMa_Raging_Hydra,EoMa_Great_Hunter,EoMa_Dark_Assassin,EoMa_Sworddancer,EoMa_Bladefury,EoMa_Pain_Mistress

        [ai]
            passive_leader=yes
            aggression=1.0
        [/ai]

        {GOLD 120 220 300}
        {INCOME 0 5 7}
        {UNIT 3 (EoMa_Commander) 13 7 (placement,passable=map,yes)}
        {UNIT 3 (EoMa_Commander) 11 11 (placement,passable=map,yes)}
        {UNIT 3 (EoMa_Dark_Slayer) 19 16 (placement,passable=map,yes)}
        {UNIT 3 (EoMa_Hydra) 22 17 (placement,passable=map,yes)}
        {UNIT 3 (EoMa_Bladedancer) 25 16 (facing,placement,passable=sw,map,yes)}
        {UNIT 3 (EoMa_Dark_Hunter) 22 14 (facing,placement,passable=sw,map,yes)}

        {UNIT 3 (EoMa_Dark_Executioner) 9 24 (placement,passable,upkeep=map,yes,loyal)}
        {UNIT 3 (EoMa_Dark_Executioner) 5 25 (placement,passable,upkeep=map,yes,loyal)}
        {UNIT 3 (EoMa_Dark_Executioner) 6 22 (placement,passable,upkeep=map,yes,loyal)}
    [/side]

    [side]
        side=4
        controller=ai
        team_name=tharis
        user_team_name= _ "team_name^Unknown"
        color=black

        type=EoMa_Matriarch_of_Darkness
        id=Matriarch3
        name=_"Fiothiel"
        image_icon=portraits/tharis/matriarchofdarkness.png~CROP(150,30,90,90)~SCALE(72,72)
        generate_name=yes
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Disciple,EoMa_Witch,EoMa_Dark_Warrior,EoMa_Hydra,EoMa_Dark_Hunter,EoMa_Bladedancer,EoMa_Dark_Wizard,EoMa_Great_Witch,EoMa_Commander,EoMa_Dark_Slayer,EoMa_Raging_Hydra,EoMa_Great_Hunter,EoMa_Dark_Assassin,EoMa_Sworddancer,EoMa_Bladefury,EoMa_Pain_Mistress

        [ai]
            passive_leader=yes
            aggression=1.0
        [/ai]

        {GOLD 120 220 300}
        {INCOME 2 8 9}
        {UNIT 4 (EoMa_Raging_Hydra) 36 12 (placement,passable=map,yes)}
        {UNIT 4 (EoMa_Great_Hunter) 39 13 (facing,placement,passable=sw,map,yes)}
        {UNIT 4 (EoMa_Dark_Assassin) 37 11 (placement,passable=map,yes)}
        {UNIT 4 (EoMa_Chaos_Hydra) 36 9 (facing,placement,passable=sw,map,yes)}
        {UNIT 4 (EoMa_General) 33 16 (facing,placement,passable=sw,map,yes)}
        {UNIT 4 (EoMa_Dark_Wizard) 41 14 (facing,placement,passable=sw,map,yes)}
    [/side]

    [side]
        side=5
        controller=ai
        team_name=mehirteam
        user_team_name= _ "team_name^Army of Mag-Magar"
        color=orange

        type=TLU_Malib
        id=Malib
        name=_"Malib"
        profile=portraits/malib.png
        image_icon=portraits/malib.png~CROP(150,50,130,130)~SCALE(72,72)
        unrenamable=yes
        canrecruit=yes

        [ai]
            caution=0.7
            leader_aggression=1.0
            leader_ignores_keep=yes
        [/ai]

        {GOLD 0 0 0}
        {INCOME 0 0 0}

        {UNIT 5 (EoMa_Dimensional_Gate_II) 40 23 (placement,passable=map,yes)}
        {UNIT 5 (EoMa_HoRhami) 40 25 (placement,passable=map,yes)}
        {UNIT 5 (EoMa_DharmaRhami) 42 22 (placement,passable=map,yes)}
        {UNIT 5 (EoMa_Dimensional_Gate_II) 44 23 (placement,passable=map,yes)}
        {UNIT 5 (EoMa_Dimensional_Gate_II) 42 26 (placement,passable=map,yes)}
        {UNIT 5 (EoMa_Mystical_Jinn) 44 25 (placement,passable=map,yes)}

        {UNIT 5 (EoMa_Dispeller) 28 18 (placement,passable=map,yes)}
        {UNIT 5 (EoMa_Dispeller) 30 18 (placement,passable=map,yes)}
        {UNIT 5 (EoMa_Novice_Summoner) 28 18 (placement,passable=map,yes)}
        {UNIT 5 (EoMa_Heavy_Summoner) 23 18 (placement,passable=map,yes)}
        {UNIT 5 (EoMa_Earth_Avatar) 26 16 (placement,passable=map,yes)}
    [/side]

    #citizens:
    [side]
        side=6
        controller=ai
        team_name=mehirteam
        user_team_name= _ "team_name^Citizens"
        color=orange
        hidden=yes
        no_leader=yes

        {GOLD 0 0 0}
        {INCOME 0 0 0}

        [ai]
            [avoid]
                x,y=42,24
                radius=3
            [/avoid]
        [/ai]
    [/side]

    #animhack
    [side]
        side=7
        controller=ai
        team_name=animhack
        user_team_name= _ "team_name^."
        hidden=yes
        no_leader=yes
        color=black

        gold=0
        income=0
    [/side]

    #Malib's Living Gate:
    {PLACE_IMAGE "scenery/lg-stationary-0.png" 42 24}
    {PLACE_IMAGE "scenery/lg-stationary-s.png" 42 25}
    {PLACE_IMAGE "scenery/lg-stationary-n.png" 42 23}
    {PLACE_IMAGE "scenery/lg-stationary-se.png" 43 25}
    {PLACE_IMAGE "scenery/lg-stationary-sw.png" 41 25}
    {PLACE_IMAGE "scenery/lg-stationary-ne.png" 43 24}
    {PLACE_IMAGE "scenery/lg-stationary-nw.png" 41 24}
    {PLACE_IMAGE "scenery/lg-stationary-1.png" 41 23}
    {PLACE_IMAGE "scenery/lg-stationary-2.png" 43 23}
    {PLACE_IMAGE "scenery/lg-stationary-3.png" 43 26}
    {PLACE_IMAGE "scenery/lg-stationary-4.png" 41 26}
    {PLACE_IMAGE "scenery/lg-stationary-5.png" 40 24}
    {PLACE_IMAGE "scenery/lg-stationary-6.png" 44 24}
    {PLACE_IMAGE "scenery/lg-stationary-7.png" 40 23}
    {PLACE_IMAGE "scenery/lg-stationary-8.png" 44 23}
    {PLACE_IMAGE "scenery/lg-stationary-9.png" 44 25}
    {PLACE_IMAGE "scenery/lg-stationary-10.png" 40 25}

    #prestart
    [event]
        name=prestart
        {SCATTER_UNITS 24 "TLU_Citizen1,TLU_Citizen2,TLU_Citizen3,TLU_Citizen4,TLU_Citizen5,TLU_Citizen6" 3 (
            terrain=Dd,Rd

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=6
            generate_name=yes
            random_traits=yes
        )}
        #removing any civilians who spawned near the enemy leaders:
        [kill]
            side=6
            [filter_location]
                x,y=35,7
                radius=5
            [/filter_location]
        [/kill]
        [kill]
            side=6
            [filter_location]
                x,y=45,13
                radius=5
            [/filter_location]
        [/kill]
        [kill]
            side=6
            [filter_location]
                x,y=4,6
                radius=5
            [/filter_location]
        [/kill]
        {RECALL_RASHTI}
        {PLACE_HALO "scenery/white.png" 25 21}
        [micro_ai]
            side=2
            ai_type=fast_ai
            action=add
            include_occupied_attack_hexes=yes
            skip_combat_ca=yes
        [/micro_ai]
        [micro_ai]
            side=3
            ai_type=fast_ai
            action=add
            include_occupied_attack_hexes=yes
            skip_combat_ca=yes
        [/micro_ai]
        [micro_ai]
            side=4
            ai_type=fast_ai
            action=add
            include_occupied_attack_hexes=yes
            skip_combat_ca=yes
        [/micro_ai]
        [micro_ai]
            side=5
            ai_type=fast_ai
            action=add
            include_occupied_attack_hexes=yes
            skip_combat_ca=yes
            [filter]
                [not]
                    type=EoMa_Mystical_Jinn
                [/not]
            [/filter]
        [/micro_ai]
        [micro_ai]
            side=6
            ai_type=coward
            action=add
            ca_id=civilian_flee
            [filter]
            [/filter]
            distance=5
            seek_x=48
            seek_y=25
        [/micro_ai]
        [micro_ai]
            side=5
            ai_type=assassin
            action=add

            [filter]
                type=EoMa_Mystical_Jinn
            [/filter]
            [filter_second]
                side=2
                canrecruit=yes
            [/filter_second]
            [prefer]
                terrain=Qxu
            [/prefer]
        [/micro_ai]

        [foreach]
            array=guardians
            [do]
                {VARIABLE this_item.side 5}
                [unstore_unit]
                    variable=this_item
                    find_vacant=yes
                    x,y=25,21
                [/unstore_unit]
            [/do]
        [/foreach]
        {PLACE_IMAGE "scenery/well-mag-magar.png" 23 15}
        {PLACE_IMAGE "scenery/well-mag-magar.png" 39 26}
        {PLACE_IMAGE "scenery/well-mag-magar.png" 12 18}
        {CLEAR_VARIABLE guardians}
    [/event]

    {FORCE_CHANCE_TO_HIT side=2,3,4 type=EoMa_Mystical_Jinn 30 (
        [variable]
            name=turn_number
            less_than=4
        [/variable]
    )}

    #turn 1
    [event]
        name=turn 1
        {FADE_STEP 225 50}
        {REMOVE_IMAGE 25 21}
        {FADE_STEP 192 5}
        {FADE_STEP 160 5}
        {FADE_STEP 128 5}
        {FADE_STEP 96 5}
        {FADE_STEP 64 5}
        {FADE_STEP 32 5}
        {FADE_STEP 0 5}

        [store_unit]
            [filter]
                id=Malib
            [/filter]
            variable=malibvar
        [/store_unit]
        {VARIABLE malibvar.max_moves 0}
        {VARIABLE malibvar.moves 0}
        [unstore_unit]
            variable=malibvar
            find_vacant=no
        [/unstore_unit]
        {CLEAR_VARIABLE malibvar}
        [message]
            speaker=Malib
            message= _ "Tashkar! You've finally came to our aid! Oh, what luck! I couldn't have held the city any longer. A dark breed is falling upon us like a swarm of locusts! Sheer horror! Wait, you're not Tashkar... what's your name, rank, and duty station? Also, why is the holy Rashti'rhami with you, and not with Tashkar?"
        [/message]
        [message]
            speaker=Mehir
            message= _ "Commander and summoner of the third degree, Mehir from Sud-Affar at your service, sir! Tashkar is, *ahem*... currently unavailable. My squad has been sent by the High Council as a vanguard, the armies of the Trinity should arrive soon. As for Rashti'rhami, Tashkar sent her alongside my troops to assist the defense of Mag-Magar."
        [/message]
        [message]
            speaker=Malib
            message= _ "Well, with Rashti'rhami, we might well live long enough to see the reinforcements. Do the best you can to assist her in defeating the invaders, soldier! Be aware that I can't risk fighting, the city mustn't lose it's leader."
        [/message]
        {SCROLL_TO 25 21}
        [message]
            speaker=narrator
            image=portraits/narrator.png
            message= _ "You can use the giant circle you are standing on in order to recruit or recall units. (can be done when standing on any of the circle's hexes)"
        [/message]
        [message]
            speaker=narrator
            image=portraits/narrator.png
            message= _ "There are wells in this scenario instead of villages. They can heal your units and cure them from poison. Since there are only few of them, you'll still have to rely on water elementals and regeneration for healings."
        [/message]
        [message]
            speaker=narrator
            image=portraits/narrator.png
            message= _ "If you find the upcoming battle too slow, you can increase game speed via settings."
        [/message]

        [objectives]
            side=1
            [objective]
                description= _ "Defeat the invaders"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Mehir"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Rashti"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Malib"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]

    #turn 5 - tower trigger dialog
    [event]
        name=turn 5

        [message]
            speaker=Matriarch2
            message= _ "Fiothiel, the prey are getting reinforcements quicker than I expected. This was supposed to just be a quick massacre, not a drawn out battle. We must do something, fast!"
        [/message]
        [message]
            speaker=Matriarch3
            message= _ "Don't wet your robes, Anaraclya, we still outnumber them."
        [/message]
        [message]
            speaker=Matriarch2
            message= _ "It's only a matter of time until more show up, we can't afford to lose this. Try destroying that blue circle with your spells, that should delay them enough."
        [/message]
        [message]
            speaker=Matriarch3
            message= _ "Alright, sister, here it goes..."
        [/message]
        [message]
            speaker=Matriarch3
            message=_ "<i>Ryvbüghdaz abgruz urzbaazäkhbäæz, ruẗhrup anrbzyv müzuguür gzÿv urzrüuz!</i>"#translated with Dugi's blackspeech generated from "Gods of darkness, turn this city to dust!"
            sound=witches-whispering1.ogg
        [/message]
        [object]
            silent=yes
            duration=forever
            [filter]
                id=Matriarch3
            [/filter]
            [effect]
                apply_to=new_animation
                [extra_anim]
                    flag=spell
                    [frame]
                        image="units/tharis-magi/shadowmatriarch-[attack1,magic1,magic2,magic1,attack1].png:[50,150,200,50*2]"
                        sound=magic-dark-big.ogg
                    [/frame]
                [/extra_anim]
            [/effect]
        [/object]

        [animate_unit]
            flag=spell
            [filter]
                id=Matriarch3
            [/filter]
        [/animate_unit]
        {QUAKE cave-in.ogg}
        [message]
            speaker=Mehir
            message= _ "Uhh... I don't like the sound of that..."
        [/message]
        {QUAKE cave-in.ogg}
        {QUAKE cave-in.ogg}
        [delay]
            time=1000
        [/delay]
        [message]
            speaker=Malib
            message= _ "Everyone! Run away from the circle!!! AAAaaa!!!"
        [/message]
        {SCROLL_TO 25 21}

        [fire_event]
            name=runaway
        [/fire_event]
    [/event]

    #post tower
    [event]
        name=post tower

        [message]
            speaker=Mehir
            image="portraits/mehir-commander-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Dear Nomolas! These spawns of darkness are throwing towers at us!"
        [/message]
        [message]
            speaker=Matriarch3
            message= _ "*cackling*"
        [/message]
        [message]
            speaker=Malib
            message= _ "Dear Nomolas, the circle has been destroyed! We’ve lost contact with the capital and reinforcements won't be able to arrive! We’re doomed..."
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Now every single blade is important. We need to kill those witches at all costs — it may be our only chance to stop this invasion."
        [/message]
        [message]
            speaker=Malib
            message= _ "I guess I don't have much of a choice. Waiting for reinforcements won't do me any good if we may not live to see them, so it is time to unleash the Living Gate! Time to show those spawns of darkness what we're made of!"
        [/message]
        [message]
            speaker=narrator
            image=portraits/narrator.png
            message= _ "Malib (and all of his remaining units including the mighty Living Gate) join your forces temporarily. Malib's troops won't cost you upkeep, but will not carry over to the next scenario."
        [/message]
        [modify_side]
            side=5
            [ai]
                aggression=1
                no_leader=yes
            [/ai]
        [/modify_side]

        {MODIFY_UNIT (id=Malib) moves 5}
        {MODIFY_UNIT (id=Malib) max_moves 5}

        {TRANSFORM_UNIT id=Malib EoMa_Summons_Master}

        {UNIT 1 TLU_Living_Gate 42 24 ({IS_HERO})}
        {MODIFY_UNIT (id=Malib) side 1}
        {MODIFY_UNIT (side=5) upkeep loyal}

        [modify_unit]
            [filter]
                side=5
                [not]
                    type=EoMa_Dimensional_Gate_II
                [/not]
            [/filter]
            {IS_LOYAL}
        [/modify_unit]

        [modify_unit]
            [filter]
                side=5
            [/filter]
            [object]
                silent=yes
                duration=forever
                [filter]
                    side=5
                    [not]
                        type=EoMa_Dimensional_Gate_II
                    [/not]
                [/filter]
                [then]
                [/then]
                [effect]
                    apply_to=new_ability
                    [abilities]
                        [dummy]
                            id=temp_ally
                        [/dummy]
                    [/abilities]
                [/effect]
            [/object]
        [/modify_unit]

        {MODIFY_UNIT (side=5
        [not]
            type=EoMa_Dimensional_Gate_II
        [/not]) side 1}

        #Malib's Living Gate:
        {REMOVE_IMAGE 42 24}
        {REMOVE_IMAGE 42 25}
        {REMOVE_IMAGE 42 23}
        {REMOVE_IMAGE 43 25}
        {REMOVE_IMAGE 41 25}
        {REMOVE_IMAGE 43 24}
        {REMOVE_IMAGE 41 24}
        {REMOVE_IMAGE 41 23}
        {REMOVE_IMAGE 43 23}
        {REMOVE_IMAGE 43 26}
        {REMOVE_IMAGE 41 26}
        {REMOVE_IMAGE 40 24}
        {REMOVE_IMAGE 44 24}
        {REMOVE_IMAGE 40 23}
        {REMOVE_IMAGE 44 23}
        {REMOVE_IMAGE 44 25}
        {REMOVE_IMAGE 40 25}

        [terrain]
            terrain=Rd
            x,y=42,24
            radius=1
        [/terrain]

        #stage 2 - give bonus gold to enemies
        [gold]
            side=2,3,4
            {QUANTITY amount 80 150 220}
        [/gold]

        [objectives]
            side=1
            [objective]
                description= _ "Defeat the invaders"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Mehir"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Rashti"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Malib"
                condition=lose
            [/objective]
            [objective]
                description= _ "Destruction of the Living Gate"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}
        [/objectives]
    [/event]

    #circle teleport effect
    [event]
        name=prerecruit, prerecall
        first_time_only=no

        [filter]
            side=1
        [/filter]

        [sound]
            name=magic-faeriefire.ogg
        [/sound]
        {REVERSE_SCENERY_ANIM scenery/circle-magmagar 5 25 21 2}
        {PLACE_HALO "scenery/circle-magmagar-1.png" 25 21}
        [allow_undo]
        [/allow_undo]
    [/event]
    [event]
        name=recruit, recall
        first_time_only=no

        [filter]
            side=1
        [/filter]

        {FAKE_SCENERY_ANIM scenery/circle-magmagar 5 25 21 2}
        [allow_undo]
        [/allow_undo]
    [/event]

    #Restore Mag-Magar's troops allegiance before death,
    #so that casualty statistics are properly tracked.
    [event]
        name=last breath
        first_time_only=no
        [filter]
            side=1
            ability=temp_ally
        [/filter]
        {MODIFY_UNIT (id=$unit.id) side 5}
    [/event]

    #Malib dies = defeat
    [event]
        name=die
        [filter]
            id=Malib
        [/filter]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    #Living Gate dies = defeat
    [event]
        name=die
        [filter]
            type=TLU_Living_Gate
        [/filter]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    #all enemies dead = victory
    [event]
        name=die
        first_time_only=no
        [filter]
            side=2,3,4
        [/filter]
        [if]
            [have_unit]
                side=2,3,4
            [/have_unit]
            [then]
            [/then]
            [else]
                [endlevel]
                    result=victory
                    {NEW_GOLD_CARRYOVER 40}
                    bonus=no
                    carryover_report=yes
                [/endlevel]
            [/else]
        [/if]
    [/event]
    #additional victory check
    [event]
        name=side 1 turn
        first_time_only=no

        [if]
            [have_unit]
                side=2,3,4
            [/have_unit]
            [then]
            [/then]
            [else]
                [endlevel]
                    result=victory
                    {NEW_GOLD_CARRYOVER 40}
                    bonus=no
                    carryover_report=yes
                [/endlevel]
            [/else]
        [/if]
    [/event]

    #victory
    [event]
        name=victory
        {TLU_SMOOTH_REPLACE_MUSIC exploration.ogg 3000 0}
        {MODIFY_UNIT (id=Malib) side 5}
        {MODIFY_UNIT (type=TLU_Living_Gate) side 5}
        {MODIFY_UNIT (ability=temp_ally
        [not]
            id=Rashti
            [or]
                canrecruit=yes
            [/or]
        [/not]) side 5}
        [message]
            speaker=Malib
            image=portraits/malib.png
            message= _ "WE DID IT!!! For a moment, I almost though we were as good as dead. Mehir, you’re my hero! I am infinitely grateful to you. Without your help..."
        [/message]
        [message]
            speaker=Mehir
            message= _ "I have a strange feeling your Living Gate could just swallow all their troops single-handedly..."
        [/message]
        [message]
            speaker=Malib
            image=portraits/malib.png
            message= _ "Perhaps so, but even an Ultimate Being is not invulnerable. If left unprotected it could still get overwhelmed by the witches' foul sorcery."
        [/message]
        [message]
            speaker=Malib
            image=portraits/malib.png
            message= _ "Still, I wonder - why exactly did Tashkar send Rashti'rhami herself with a subordinate of Sharif instead of one of his own men? Something just doesn't add up here."
        [/message]
        [message]
            speaker=Mehir
            message= _ "To tell the truth, sir, he is no longer with us. Remember the strange man who tried to steal the lamp of Nomolas not long ago? The same bastard caused Tashkar's death..."
        [/message]
        [message]
            speaker=Rashti
            message= _ "Indeed... at least I managed to avenge him. As for why I'm here, the choice to follow Mehir was of my own free will. I believe he is worthy of becoming my next master."
        [/message]
        [message]
            speaker=Malib
            image=portraits/malib.png
            message= _ "I see... As soon as the first carpets arrive from al-Kamija, I’ll go speak with the High Council. Your achievements shall be announced in the whole country, and I will make sure to repay my debt to you!"
        [/message]
        [store_unit]
            [filter]
                id=Malib
            [/filter]
            variable=malibvar
        [/store_unit]
        {CLEAR_VARIABLE lg}
        {CLEAR_VARIABLE lgloc}
    [/event]

    #badass - Matriarch1 dialog when she is attacked
    [event]
        name=attack
        [filter_second]
            id=Matriarch1
        [/filter_second]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=second_unit
                message= _ "(to Mehir) Ho ho ho, you look quite handsome for a human. Ditch your half-blue half-red girlfriend and I'll let you be my slave instead of killing you. We can do unspeakable things together every day!"
            [/message]
            [message]
                speaker=Mehir
                image="portraits/mehir-commander-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "..."
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-ho.png"
                message= _ "Firstly, I am not his girlfriend..."
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-dharma.png"
                message= _ "Secondly, only I can do unspeakable things with Mehir! GET THE HELL AWAY FROM HIM YOU FILTHY WITCH!!!"
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-ho.png"
                message= _ "..."
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-ho.png"
                message= _ "*facepalms*"
            [/message]
        ) ()}
    [/event]

    #Matriarch1 last breath
    [event]
        name=last breath
        [filter]
            id=Matriarch1
        [/filter]
        [filter_second]
            side=1,5
            [not]
                type=TLU_Living_Gate
            [/not]
        [/filter_second]

        [message]
            speaker=unit
            message= _ "Argh..."
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Rashti
                message= _ "Serves her right."
            [/message]
        ) (
        )}
    [/event]

    #Matriarch2 last breath
    [event]
        name=last breath
        [filter]
            id=Matriarch2
        [/filter]
        [message]
            speaker=unit
            message= _ "This mission is a complete disaster. I told Almathis many times that we should finish off the pathetic sun-lovers first, but that arrogant fool wouldn't listen to my advice..."
        [/message]
        [message]
            speaker=Mehir
            message= _ "Sun lovers?"
        [/message]
        [message]
            speaker=unit
            message= _ "I'm not going to tell you anything, sand dwelling worm! A thousand curses upon your nation! Argh..."
        [/message]
    [/event]

    #Matriarch3 last breath
    [event]
        name=last breath
        [filter]
            id=Matriarch3
        [/filter]
        [filter_second]
            side=1,5
            [not]
                type=TLU_Living_Gate
            [/not]
        [/filter_second]
        [message]
            speaker=Mehir
            image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "You have nowhere to run, witch. Now, tell us why you invaded us."
        [/message]

        {BADASS_MODE_CHANGE (
            [message]
                speaker=unit
                message= _ "I'm not going to tell you anything, filthy human!"
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-dharma.png"
                message= _ "Hey, can I torture her to get the information? Pleeeeease?"
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-ho.png"
                message= _ "Considering how many innocent people she and her underlings murdered in cold blood, fine, I'll permit it, but just this once."
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-dharma.png"
                message= _ "Yes! Thank you, thank you sis, you're the best! (to Fiothiel) As for you, witch, you have exactly one minute to give an answer, or it's gonna hurt, a lot, hehehe. *sharpens scimitar*"
            [/message]
            [message]
                speaker=unit
                message= _ "You won't get anything out of me! *impales herself with her spear*"
                sound=spear.ogg
            [/message]
        ) (
            [message]
                speaker=unit
                message= _ "Your futile resistance only delays the inevitable. Our gods will most certainly reward me for nearly razing this place to the ground..."
            [/message]
            [message]
                speaker=unit
                message= _ "*impales herself with her spear*"
                sound=spear.ogg
            [/message]
        )}
    [/event]

    #Matriarch3 dies
    [event]
        name=die
        [filter]
            id=Matriarch3
        [/filter]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Rashti
                image="portraits/rashti-dharma.png"
                message= _ "Aaaaand there goes my first chance in centuries to torture someone with Ho'rashti's permission... *sigh*"
            [/message]
        ) (
            [message]
                speaker=Mehir
                image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "Dammit, we didn't get anything out of her..."
            [/message]
        )}
    [/event]

    #Tharis walks onto the stationary Living Gate
    [event]
        name=attack
        [filter]
            formula=not self.flying
        [/filter]
        [filter_second]
            id=Malib
        [/filter_second]

        [fire_event]
            name=fall1
        [/fire_event]
    [/event]
    [event]
        name=attack end
        [filter]
            formula=not self.flying
        [/filter]
        [filter]
            canrecruit=no
        [/filter]
        [filter_second]
            type=TLU_Living_Gate
        [/filter_second]

        [fire_event]
            name=fall2
        [/fire_event]
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=2,3,4
            [filter_adjacent]
                type=TLU_Malib
            [/filter_adjacent]
        [/filter]

        {IF_VAR turn_number less_than 5 (
            [then]
                [kill]
                    id=$unit.id
                    animate=yes
                    fire_event=yes
                [/kill]

                [fire_event]
                    name=fall1
                [/fire_event]
            [/then]
        )}
    [/event]

    #Malib talks about Living Gate
    [event]
        name=fall1
        [message]
            speaker=Malib
            message= _ "You thought you could just walk here and kill me? What did you expect trying to walk over a horizontal portal? Have fun falling down, idiot!"
        [/message]
        [message]
            speaker=Mehir
            message= _ "So this is the famous Living Gate, huh? Quite spectacular..."
        [/message]
        [message]
            speaker=Malib
            message= _ "Why yes indeed!"
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-commander-happy.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Sweet! I always wanted to see it with my own eyes when I was younger! Looks amazing! Much better than in the pictures of it I've seen during my childhood."
        [/message]
        [message]
            speaker=Malib
            message= _ "Yeah, I agree with you about that. Ah, I just love it how the unbeknowing enemies just try to walk on the Living Gate and fall to their deaths... This never gets old!"
        [/message]
        [terrain]
            terrain=Rd^Qov
            x,y=42,24
            radius=1
        [/terrain]
        [terrain]
            terrain=Rd
            x,y=42,24
        [/terrain]
    [/event]

    #recruit anim for Tharis
    [event]
        name=recruit
        first_time_only=no

        [filter]
            side=2,3,4
        [/filter]

        [object]
            silent=yes
            duration=forever
            [filter]
                x,y=$x1,$y1
            [/filter]
            [effect]
                apply_to=new_animation
                [animation]
                    apply_to=flash

                    [frame]
                        duration=400
                        blend_color=0,0,0
                        blend_ratio=0~1,1~0
                    [/frame]
                    [flash_frame]
                        duration=400
                        image="projectiles/secrethit.png"
                        image_mod="~SCALE(100,56)~GS()~R(128)~B(255)"
                        alpha=1.0~0.0
                        y=-3
                        layer=99
                    [/flash_frame]
                [/animation]
            [/effect]
        [/object]
        [animate_unit]
            flag=flash
            [filter]
                x,y=$x1,$y1
            [/filter]
        [/animate_unit]
    [/event]

    #everybody runs away from the circle
    [event]
        name=runaway
        first_time_only=no

        [move_unit]
            side=1,5,6
            [filter_location]
                x=20,21,22,23,24,21,23,24,25,22,23,24,25,26,23,24,25,26,27,24,25,26,27,28,26,27,28,29,28,25,26,27,29,22,22
                y=21,22,23,23,21,21,22,22,23,20,21,21,22,22,20,20,21,21,22,19,20,20,21,21,19,20,20,21,19,19,18,19,20,21,22
            [/filter_location]
            to_x=33
            to_y=25
        [/move_unit]

        [move_unit]
            side=2,3,4
            [filter_location]
                x=20,21,22,23,24,21,23,24,25,22,23,24,25,26,23,24,25,26,27,24,25,26,27,28,26,27,28,29,28,25,26,27,29,22,22
                y=21,22,23,23,21,21,22,22,23,20,21,21,22,22,20,20,21,21,22,19,20,20,21,21,19,20,20,21,19,19,18,19,20,21,22
            [/filter_location]
            to_x=37
            to_y=19
        [/move_unit]

        [fire_event]
            name=tower
        [/fire_event]
    [/event]

    #tower falls
    [event]
        name=tower
        first_time_only=no

        {SCROLL_TO 25 21}

        [terrain]
            x,y=1,1
            terrain=Xv^Yyyy
            layer=both
        [/terrain]

        [terrain]
            x=20,21,22,23,24,21,23,24,25,22,23,24,25,26,23,24,25,26,27,24,25,26,27,28,26,27,28,29,28,25,29,22,22
            y=21,22,23,23,21,21,22,22,23,20,21,21,22,22,20,20,21,21,22,19,20,20,21,21,19,20,20,21,19,19,20,21,22
            terrain=Qxu
            layer=both
        [/terrain]

        [if]
            [have_unit]
                x,y=25,15
            [/have_unit]
            [then]
                [store_unit]
                    [filter]
                        x,y=25,15
                    [/filter]
                    kill=yes
                    animate=no
                    variable=animhackstore
                [/store_unit]
            [/then]
        [/if]

        [unit]
            type=TLU_animhack
            variation=tower
            side=7
            x=25
            y=15
            facing=se
            placement,overwrite=map,yes
            animate=yes
        [/unit]

        [terrain]
            x,y=1,1
            terrain=Xv^Yyyx
            layer=both
        [/terrain]

        [kill]
            x,y=25,15
            animate=no
        [/kill]

        {IF_VAR animhackstore.length greater_than 0 (
            [then]
                [unstore_unit]
                    variable=animhackstore
                    find_vacant=yes
                [/unstore_unit]
                {CLEAR_VARIABLE animhackstore}
            [/then]
        )}

        [fire_event]
            name=post tower
        [/fire_event]
    [/event]

    #additional recruit/recall fx for the circle
    [event]
        name=recruit,recall
        first_time_only=no

        [filter]
            side=1
        [/filter]

        [object]
            silent=yes
            duration=scenario
            [filter]
                id=$unit.id
            [/filter]
            [effect]
                apply_to=new_animation
                [animation]
                    apply_to=flash

                    [frame]
                        duration=400
                    [/frame]
                    [flash_frame]
                        duration=400
                        image="projectiles/secrethit.png"
                        alpha=1.0~0.0:400
                        y=-3
                        layer=99
                    [/flash_frame]
                [/animation]
            [/effect]
        [/object]

        [animate_unit]
            flag=flash
            [filter]
                x,y=$x1,$y1
            [/filter]
        [/animate_unit]

        [allow_undo]
        [/allow_undo]
    [/event]

    #jinni advice
    [event]
        name=recall,post advance
        id=jinn_advice
        first_time_only=yes
        [filter]
            type=EoMa_Wonderful_Jinn,EoMa_Mystical_Jinn
        [/filter]

        [if]
            [have_unit]
                id=$unit.id
                type=EoMa_Wonderful_Jinn
            [/have_unit]
            [then]
                [message]
                    speaker=Mehir
                    message= _ "Wonderful Jinni! Give me some advice!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Mehir
                    message= _ "Mystical Jinni! Give me some advice!"
                [/message]
            [/else]
        [/if]
        {IF_VAR turn_nunmber less_than 5 (
            [then]
                [message]
                    speaker=unit
                    message= _ "My Master, in my vision I am seeing an imminent destruction of the main city portal connecting Mag-Magar with al-Kamija!"
                [/message]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Oh no... This is bad. Without reinforcements from the capital, we might lose!"
                [/message]
                [message]
                    speaker=unit
                    message= _ "I suggest you hurry and bring as many troops as possible, while the circle is still intact. Summoners might be especially useful because they can summon reinforcements directly from the Abyss!"
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "Alright."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "My Master, I see the Living Gate is under your control. Use its unique abilities to quickly eliminate all enemy leaders one by one!"
                [/message]
            [/else]
        )}
    [/event]

    {CORRECT_RECALL_COST}
    {ITEM_APPLIER}
    {SUMMONER_LOCK}
    {JINN_LOCK}
    {COLLAR_EVENT}
    {DEATH_MEHIR}
    {DEATH_RASHTI}
    {TLU_S12_TERRAIN}
[/scenario]
