#textdomain wesnoth-To_Lands_Unknown
[scenario]
    id=17_Siege_of_Kharos
    next_scenario=18_The_City_of_Light
    name= _ "Siege of Kharos"
    map_data="{~add-ons/To_Lands_Unknown/maps/17_Siege_of_Kharos.map}"
    {TURNS 42 36 30}
    victory_when_enemies_defeated=no

    {SCENARIO_MUSIC Overlive.ogg}
    {EXTRA_SCENARIO_MUSIC frantic.ogg}
    {EXTRA_SCENARIO_MUSIC vengeful.ogg}
    {AFTERNOON}

    #preload
    [event]
        name = preload
        first_time_only = no
        [lua]
            code=<< main = wesnoth.dofile("~add-ons/To_Lands_Unknown/lua/animation.lua") >>
        [/lua]
    [/event]

    {STORYTXT_GATES_OF_KHAROS}

    {STARTING_VILLAGES 1 3}
    {STARTING_VILLAGES 2 8}
    {STARTING_VILLAGES 3 4}
    {STARTING_VILLAGES 4 4}
    {STARTING_VILLAGES 5 3}
    {STARTING_VILLAGES_AREA 4 37 25 2}

    [side]
        side=1
        controller=human
        team_name=mehirteam
        user_team_name= _ "team_name^Mehir"

        type=TLU_Mehir_Leader
        id=Mehir
        name= _ "Mehir"
        unrenamable=yes
        canrecruit=yes
        profile=portraits/mehir-leader.png

        recruit=EoMa_Novice_Summoner,EoMa_Camel_Rider,EoMa_Carpet_Rider,EoMa_Water_Elemental,EoMa_Summoner,EoMa_Rhami,EoMa_Fire_Elemental,EoMa_Dispeller

        {GOLD 600 400 300}
        {INCOME 30 25 20}

        {UNIT 1 (EoMa_Master_of_Sun) () () (placement=leader
        id=Atiros
        image_icon="portraits/kharos/masterofsun.png~CROP(180,50,130,130)~SCALE(72,72)"
        {IS_HERO}
        name=Atiros)}
    [/side]

    [side]
        side=2
        controller=ai
        team_name=tharis,rashti
        user_team_name= _ "team_name^Almathis"
        type=EoMa_Master_of_Darkness
        name= _ "Almathis"
        id=Master
        unrenamable=yes
        canrecruit=yes
        color=black
        {FLAG_VARIANT undead}
        image_icon="portraits/almathis.png~CROP(110,81,114,114)~SCALE(72,72)"
        profile="portraits/almathis.png"

        recruit=EoMa_Disciple,EoMa_Dark_Wizard,EoMa_Great_Witch,EoMa_Raging_Hydra,EoMa_Pain_Mistress,EoMa_Matriarch_of_Pain,EoMa_Chainlady

        [ai]
            aggression=1.0
            passive_leader=yes
        [/ai]

        {GOLD 250 300 380}
        {INCOME 25 32 40}

        {UNIT 2 (EoMa_Great_Warlock) 17 23 (ai_special,upkeep=guardian,loyal)}
        {UNIT 2 (EoMa_Great_Warlock) 21 23 (ai_special,upkeep=guardian,loyal)}
        {UNIT 2 (EoMa_General) 17 25 (ai_special,upkeep=guardian,loyal)}
        {UNIT 2 (EoMa_General) 21 25 (ai_special,upkeep=guardian,loyal)}
        {UNIT 2 (EoMa_Chaos_Hydra) 18 22 (ai_special,upkeep=guardian,loyal)}
        {UNIT 2 (EoMa_Chaos_Hydra) 20 22 (ai_special,upkeep=guardian,loyal)}
        {UNIT 2 (EoMa_Chaos_Hydra) 18 25 (ai_special,upkeep=guardian,loyal)}
        {UNIT 2 (EoMa_Chaos_Hydra) 20 25 (ai_special,upkeep=guardian,loyal)}
        {UNIT 2 (EoMa_Matriarch_of_Darkness) 14 23 (ai_special,upkeep=guardian,loyal)}
        {UNIT 2 (EoMa_Matriarch_of_Darkness) 24 23 (ai_special,upkeep=guardian,loyal)}
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (EoMa_Raging_Hydra) 4}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (EoMa_Dark_Wizard) 6}
    {LIMIT_CONTEMPORANEOUS_RECRUITS 2 (EoMa_Disciple) 3}

    [side]
        side=3
        controller=ai
        team_name=tharis,rashti
        user_team_name= _ "team_name^Amithrior"
        type=EoMa_Master_of_War
        name=_"Amithrior"
        image_icon="portraits/tharis/masterofwar.png~CROP(150,20,130,130)~SCALE(72,72)"
        unrenamable=yes
        canrecruit=yes
        color=purple
        {FLAG_VARIANT undead}

        recruit=EoMa_Dark_Warrior,EoMa_Hydra,EoMa_Black_Orb,EoMa_Dark_Observer,EoMa_Commander,EoMa_Dark_Slayer,EoMa_Bladefury,EoMa_Chainlady,EoMa_Frontliner,EoMa_Pain_Mistress

        [ai]
            aggression=1.0
            [aspect]
                id=attacks
                [facet]
                    invalidate_on_gamestate_change=yes
                    [filter_own]
                        side=3
                    [/filter_own]
                    [filter_enemy]
                        [not]
                            type=TLU_DharmaRashti,TLU_HoRashti
                        [/not]
                    [/filter_enemy]
                [/facet]
            [/aspect]
        [/ai]

        {GOLD 180 260 300}
        {INCOME 20 25 30}
    [/side]

    [side]
        side=4
        controller=ai
        team_name=tharis,rashti
        user_team_name= _ "team_name^Thrion"
        image_icon="portraits/tharis/masterofwar.png~CROP(150,20,130,130)~SCALE(72,72)"
        type=EoMa_Master_of_War
        name=_"Thrion"
        unrenamable=yes
        canrecruit=yes
        color=blue
        {FLAG_VARIANT undead}

        recruit=EoMa_Dark_Warrior,EoMa_Dark_Hunter,EoMa_Bladedancer,EoMa_Great_Hunter,EoMa_Dark_Assassin,EoMa_Sworddancer,EoMa_Bladefury,EoMa_Chainlady,EoMa_Frontliner,EoMa_Pain_Mistress

        [ai]
            aggression=1.0
            [aspect]
                id=attacks
                [facet]
                    invalidate_on_gamestate_change=yes
                    [filter_own]
                        side=4
                    [/filter_own]
                    [filter_enemy]
                        [not]
                            type=TLU_DharmaRashti,TLU_HoRashti
                        [/not]
                    [/filter_enemy]
                [/facet]
            [/aspect]
        [/ai]

        {GOLD 180 260 300}
        {INCOME 20 25 30}
    [/side]

    [side]
        side=5
        controller=ai
        team_name=mehirteam
        user_team_name= _ "team_name^Dedylos"

        type=EoMa_Platinum_Warrior
        id=Dedylos
        name= _ "Dedylos"
        unrenamable=yes
        canrecruit=yes
        color=white
        image_icon="portraits/dedylos.png~CROP(178,153,86,86)~SCALE(72,72)~FL(horiz)"
        profile="portraits/dedylos.png"

        recruit=EoMa_White_Warrior,EoMa_Protector,EoMa_Brown_Warrior,EoMa_Shielder,EoMa_Cavalry_Archer,EoMa_Sun_Follower

        [ai]
            aggression=1.0
            [avoid]
                x,y=19,9
            [/avoid]
        [/ai]
        {GOLD 400 300 200}
        {INCOME 30 25 20}
    [/side]

    [side]
        side=6
        controller=ai
        team_name=mehirteam
        user_team_name= _ "team_name^Kharos"

        type=EoMa_Prophet_of_Light
        id=Anthi
        name= _ "Anthi"
        unrenamable=yes
        canrecruit=yes
        color=white
        profile=portraits/anthi.png
        image_icon="portraits/anthi.png~CROP(140,10,180,180)~SCALE(72,72)"

        recruit=EoMa_White_Warrior,EoMa_Protector,EoMa_Brown_Warrior,EoMa_Shielder,EoMa_Cavalry_Archer,EoMa_Sun_Follower

        {GOLD 400 300 200}
        {INCOME 10 5 0}

        {UNIT 6 (EoMa_Kirios) 8 9 (name,id= _ "Bodyguard",Bodyguard
        unrenamable=yes)}

        {UNIT 6 (EoMa_Golden_Warrior) 10 9 (id=Advisor
        name= _ "Advisor")}

        {UNIT 6 (EoMa_Platinum_Warrior) 19 2 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Platinum_Warrior) 19 3 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Platinum_Warrior) 19 4 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Platinum_Warrior) 19 5 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Platinum_Warrior) 19 6 (moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Brown_Warrior) 18 2 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Brown_Warrior) 18 3 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Brown_Warrior) 18 4 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Brown_Warrior) 18 5 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Brown_Warrior) 18 6 (moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Brown_Warrior) 20 2 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Brown_Warrior) 20 3 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Brown_Warrior) 20 4 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Brown_Warrior) 20 5 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Brown_Warrior) 20 6 (moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Sun_Guardian) 21 2 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Sun_Guardian) 21 3 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Sun_Guardian) 21 4 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Sun_Guardian) 21 5 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Sun_Guardian) 21 6 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Sun_Guardian) 17 2 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Sun_Guardian) 17 3 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Sun_Guardian) 17 4 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Sun_Guardian) 17 5 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Sun_Guardian) 17 6 (moves,max_moves=0,0)}

        #new
        {UNIT 6 (EoMa_Silver_Warrior) 13 5 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Silver_Warrior) 13 2 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Silver_Warrior) 13 3 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Silver_Warrior) 13 4 (moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Silver_Warrior) 25 5 (facing=sw
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Silver_Warrior) 25 2 (facing=sw
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Silver_Warrior) 25 3 (facing=sw
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Silver_Warrior) 25 4 (facing=sw
        moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Protector) 14 2 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Protector) 14 3 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Protector) 14 4 (moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Protector) 24 2 (facing=sw
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Protector) 24 3 (facing=sw
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Protector) 24 4 (facing=sw
        moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Avenger) 12 2 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Avenger) 12 3 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Avenger) 12 4 (moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Avenger) 26 2 (facing=sw
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Avenger) 26 3 (facing=sw
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Avenger) 26 4 (facing=sw
        moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Sun_Follower) 11 5 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Sun_Follower) 11 2 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Sun_Follower) 11 3 (moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Sun_Follower) 11 4 (moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Sun_Follower) 27 5 (facing=sw
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Sun_Follower) 27 2 (facing=sw
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Sun_Follower) 27 3 (facing=sw
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Sun_Follower) 27 4 (facing=sw
        moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Shielder) 9 5 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_Shielder) 9 6 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_Shielder) 9 7 (moves,max_moves=0,0
        ai_special=guardian)}

        {UNIT 6 (EoMa_Shielder) 29 5 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Shielder) 29 6 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Shielder) 29 7 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Shielder) 8 4 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_Shielder) 8 5 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_Shielder) 8 6 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_Shielder) 8 7 (moves,max_moves=0,0
        ai_special=guardian)}

        {UNIT 6 (EoMa_Shielder) 30 4 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Shielder) 30 5 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Shielder) 30 6 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Shielder) 30 7 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}

        {UNIT 6 (EoMa_White_Warrior) 7 4 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_White_Warrior) 7 5 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_White_Warrior) 7 6 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_White_Warrior) 7 7 (moves,max_moves=0,0
        ai_special=guardian)}

        {UNIT 6 (EoMa_White_Warrior) 31 4 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_White_Warrior) 31 5 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_White_Warrior) 31 6 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_White_Warrior) 31 7 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Cleric) 5 4 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_Cleric) 5 5 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_Cleric) 5 6 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_Cleric) 5 7 (moves,max_moves=0,0
        ai_special=guardian)}

        {UNIT 6 (EoMa_Cleric) 33 4 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Cleric) 33 5 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Cleric) 33 6 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Cleric) 33 7 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Inspired) 4 4 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_Inspired) 4 5 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_Inspired) 4 6 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_Inspired) 4 7 (moves,max_moves=0,0
        ai_special=guardian)}

        {UNIT 6 (EoMa_Inspired) 34 4 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Inspired) 34 5 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Inspired) 34 6 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Inspired) 34 7 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Adept_of_Light) 3 4 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_Adept_of_Light) 3 5 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_Adept_of_Light) 3 6 (moves,max_moves=0,0
        ai_special=guardian)}
        {UNIT 6 (EoMa_Adept_of_Light) 3 7 (moves,max_moves=0,0
        ai_special=guardian)}

        {UNIT 6 (EoMa_Adept_of_Light) 35 4 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Adept_of_Light) 35 5 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Adept_of_Light) 35 6 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}
        {UNIT 6 (EoMa_Adept_of_Light) 35 7 (facing=sw
        ai_special=guardian
        moves,max_moves=0,0)}

        {UNIT 6 (EoMa_Kharosian_Javelineer) 33 10 (facing=sw
        ai_special=guardian)}
        {UNIT 6 (EoMa_Kharosian_Impaler) 34 9 (facing=sw
        ai_special=guardian)}
        {UNIT 6 (EoMa_Kharosian_Impaler) 36 9 (facing=sw
        ai_special=guardian)}
        {UNIT 6 (EoMa_Kharosian_Impaler) 2 9 (facing=sw
        ai_special=guardian)}
        {UNIT 6 (EoMa_Kharosian_Impaler) 4 9 (facing=sw
        ai_special=guardian)}
    [/side]

    {RASHTI_SIDES 7 8}

#define UNITS_TO_IMAGES FILTER
    #turn some units into images to reduce ai calculations
    [store_unit]
        [filter]
            {FILTER}
        [/filter]
        variable=army_to_image
        kill=yes
        animate=no
    [/store_unit]
    [foreach]
        array=army_to_image
        [do]
            {PLACE_IMAGE ("$this_item.image|~TC(6,magenta)") $this_item.x $this_item.y}
        [/do]
    [/foreach]
    {CLEAR_VARIABLE army_to_image}
#enddef

    #prestart
    [event]
        name=prestart
        [recall]
            id=Rashti
        [/recall]

        {MODIFY_UNIT id=Anthi max_moves 0}

        {UNITS_TO_IMAGES (
            side=6
            x=3-9
            y=4-7
            [or]
                x=29-35
                y=4-7
            [/or]
        )}
    [/event]

    #start
    [event]
        name=start

        [foreach]
            array=army
            [do]
                {VARIABLE this_item.moves 0}
                {VARIABLE this_item.max_moves 0}
                [unstore_unit]
                    variable=this_item
                    find_vacant=no
                [/unstore_unit]
            [/do]
        [/foreach]

        [message]
            speaker=Mehir
            message= _ "Seems we arrived just barely in time."
        [/message]
        {SCROLL_TO 19 24}
        [delay]
            time=500
        [/delay]
        {SCROLL_TO 19 4}
        [delay]
            time=500
        [/delay]
        [message]
            speaker=Anthi
            message= _ "There are too many of them. This day had to come..."
        [/message]
        [message]
            speaker=Advisor
            message= _ "Don’t lose hope, Anthi. These walls have protected our people for centuries; our gates are nearly indestructible."
        [/message]
        [message]
            speaker=Anthi
            message= _ "Atiros hasn’t returned yet..."
        [/message]
        [message]
            speaker=Advisor
            message= _ "I’m not sure whether he has returned or not, but I can see an army in the distance. They must be the troops from Saffaros, and those beside them... They don’t look like the warriors of Kharos, but they’re not of the invaders either..."
        [/message]
        [message]
            speaker=Anthi
            message= _ "Is this what I think it is? Seems the magi told the truth, our long-lost relatives really do exist! Now they are our only hope..."
        [/message]
        [message]
            speaker=Dedylos
            message=_ "Something's not right here. The spawns of darkness always attacked after dusk, but this time they decided to attack at noon."
        [/message]
        [message]
            speaker=Mehir
            message=_ "Don’t forget they are surrounded. If we attack them by surprise, they'll be at a disadvantage."
        [/message]
        [message]
            speaker=Dedylos
            message=_ "I'm not sure whether surrounded is a fitting term. After all, Anthi is unlikely to order the gates opened. This whole thing is more like us cornering a larger force..."
        [/message]
        [objectives]
            side=1
            [objective]
                description= _ "Defeat the invaders"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Mehir"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Rashti"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Atiros"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Dedylos"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]

    #side 2 turn 2 - the gate is destroyed
    [event]
        name=side 2 turn 2
        [message]
            canrecruit=yes
            side=4
            message= _ "Master, the human armies rounded us from the east. But the worst part is, the desert wizards are with them!"
        [/message]
        [message]
            speaker=Master
            message= _ "Seems the Three Sisters were too weak to handle a few sand-dwelling worms,<i>*to himself* just as planned, hehe</i>. On the bright side, with so much prey, we could make a literal mountain of bodies! Our gods shall be pleased.... time for a REAL BLOODBATH!!!"
        [/message]
        [message]
            speaker=Master
            image="portraits/almathis-magic.png"
            message= _ "...SIRAHT THES SORUTH..."
        [/message]
        [fire_event]
            name=gate1
        [/fire_event]
        [fire_event]
            name=gate2
        [/fire_event]

        {TLU_SMOOTH_REPLACE_MUSIC In_the_Land_of_Madness.ogg 1500 0}
        {APPEND_MUSIC frantic.ogg}

        {SCROLL_TO 19 4}
        [delay]
            time=1000
        [/delay]
        [message]
            speaker=Anthi
            message= _ "!!!"
        [/message]
        [message]
            speaker=Advisor
            message= _ "May the Sun save us! Our indestructible gates... Our finest soldiers..."
        [/message]
        [message]
            speaker=Dedylos
            message= _ "What are the limits of that hated voice, whose mere sound tears the thickest walls?!"
        [/message]
        [message]
            speaker=Mehir
            message= _ "Apparently there are none. Let's just hope they won’t throw more buildings at us..."
        [/message]
        [message]
            speaker=Dedylos
            message= _ "!"
        [/message]
        [message]
            speaker=Anthi
            message= _ "We can not afford those apostles of death entering the capital. Send half of our troops to the battlefield!"
        [/message]
        [store_unit]
            [filter]
                side=6
                x=11-27
                y=2-6
            [/filter]
            variable=army
        [/store_unit]

        [foreach]
            array=army
            [do]
                {VARIABLE this_item.moves 5}
                {VARIABLE this_item.max_moves 5}
                [unstore_unit]
                    variable=this_item
                    find_vacant=no
                [/unstore_unit]
            [/do]
        [/foreach]

        {CLEAR_VARIABLE army}
        [gold]
            side=2
            amount=180
        [/gold]
    [/event]

#ifdef EASY
    [event]
        name=side 2 turn 5
        #giving almathis some gold to fend off the northern kharos troops
        [gold]
            side=2
            amount=160
        [/gold]
    [/event]
#endif

    #Almathis blocks the path for Kharos troops
    [event]
#ifdef EASY
        #on easy, some kharos troops remain near the gates to distract Almathis's army
        name=side 2 turn 6
#endif
#ifndef EASY
        name=side 2 turn 5
#endif
        [message]
            speaker=Master
            image="portraits/almathis-magic.png"
            message= _ "The fools are coming... FALL!"
        [/message]

        {EARTHQUAKE ()}
        [fire_event]
            name=gate3
        [/fire_event]

        ## {UNITS_TO_IMAGES (
        ## side=6
        ## x=3-35
        ## y=4-15
        ## [not]
        ## id=Anthi
        ## [/not]
        ## [not]
        ## id=Advisor
        ## [/not]
        ## [not]
        ## id=Bodyguard
        ## [/not]
        ## [not]
        ## type=EoMa_Kharosian_Impaler,EoMa_Kharosian_Javelineer
        ## [/not]
        ## )}

        [unlock_view]
        [/unlock_view]
    [/event]

    #if player or ally gets too close, use gold reserves
    [event]
        name=moveto
        [filter]
            side=1,5
            [filter_location]
                x,y=31,24
                radius=5
            [/filter_location]
            [or]
                side=1,5
                [filter_location]
                    x,y=7,24
                    radius=5
                [/filter_location]
            [/or]
        [/filter]

        {IF_VAR gold_side equals yes (
            [else]
                [gold]
                    side=3
                    {QUANTITY amount 180 200 200}
                [/gold]
                [gold]
                    side=4
                    {QUANTITY amount 180 200 200}
                [/gold]
                {VARIABLE gold_side yes}
            [/else]
        )}
        [allow_undo]
        [/allow_undo]
        [on_undo]
            [gold]
                side=3
                {QUANTITY amount -180 -200 -200}
            [/gold]
            [gold]
                side=4
                {QUANTITY amount -180 -200 -200}
            [/gold]
            {VARIABLE gold_side no}
        [/on_undo]
        #throws "on_redo not supported" error message for 1.16 - disabling
        ## [on_redo]
        ## [gold]
        ## side=3
        ## {QUANTITY amount 180 200 200}
        ## [/gold]
        ## [gold]
        ## side=4
        ## {QUANTITY amount 180 200 200}
        ## [/gold]
        ## {VARIABLE gold_side yes}
        ## [/on_redo]
    [/event]

    #player attacks Almathis
    [event]
        name=attack

        [filter_second]
            id=Master
        [/filter_second]

        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "Well, well, well, we got you cornered now, weirdo! Time for you to taste some cold steel!"
            [/message]
        ) (
            [message]
                speaker=Mehir
                image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "Enough shenanigans already! We cut our way through your army and you are next!"
            [/message]
        )}
        [message]
            speaker=Master
            message= _ "Heh, I'd like to see you try!"
        [/message]
    [/event]

    #Almathis teleports on last breath
    [event]
        name=last breath

        [filter]
            id=Master
        [/filter]

        [message]
            speaker=Master
            image="portraits/almathis-magic.png"
            message= _ "You think you got me? MWAHAHAHAAAAAhaa!!! That's where you're wrong, desert mage..."
        [/message]

        #use gold reserves if any
        {IF_VAR gold_side equals yes (
            [else]
                [gold]
                    side=3
                    {QUANTITY amount 180 200 200}
                [/gold]
                [gold]
                    side=4
                    {QUANTITY amount 180 200 200}
                [/gold]
            [/else]
        )}
        {CLEAR_VARIABLE gold_side}

        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=mastervar
            kill=yes
        [/store_unit]
        {FLASH_WHITE (
            [sound]
                name=lightning-miss.ogg
            [/sound]
        )}
        [if]
            [variable]
                name=bat_event_triggered
                equals=yes
            [/variable]
            [then]
            [/then]
            [else]
                [unstore_unit]
                    variable=mastervar
                    x,y=25,6
                [/unstore_unit]
                [heal_unit]
                    [filter]
                        id=Master
                    [/filter]
                    amount=fully
                    animate=no
                    restore_statuses=yes
                [/heal_unit]
                {FULL_HEAL id=Master}
                {CLEAR_VARIABLE mastervar}
                {MODIFY_UNIT id=Master moves 0}
                {MODIFY_UNIT id=Master max_moves 0}
                {MODIFY_UNIT id=Master invulnerable yes}
                [message]
                    speaker=Master
                    message= _ "You can try to stop us, but all your efforts are futile. We are the new Destroyers. We know no mercy nor retreat."
                [/message]
                {BADASS_MODE_CHANGE (
                    [message]
                        speaker=Mehir
                        message= _ "Know no retreat, eh? Seems the irony of saying that the moment you teleport away from me is lost on you, coward."
                    [/message]
                    [message]
                        speaker=Master
                        message= _ "..."
                    [/message]
                    [message]
                        speaker=Master
                        message= _ "This was supposed to be my cool villain monologue, please don't interrupt it. Anyway, *ahem*, as I was about to say, pathetic human..."
                    [/message]
                ) ()}

                [message]
                    speaker=Master
                    message= _ "This is our holy mission given to us by the Eye of Darkness. Only by destruction can we prove that we are worth living. Upon their return, the old Destroyers shall spare us, and grant us power beyond that of any mortal. But until then, we will slaughter to the last."
                [/message]
                {BADASS_MODE_CHANGE (
                    [message]
                        speaker=Mehir
                        message= _ "Great, an entire nation of genocidal psychos... Rashti, any ideas on how to reach him?"
                    [/message]
                    [message]
                        speaker=Rashti
                        message= _ "I can climb the walls and kill that lunatic!"
                    [/message]
                    [message]
                        speaker=Mehir
                        message= _ "You sure? Who knows what he is up to... Folks like him are full of unpleasant surprises."
                    [/message]
                ) (
                    [message]
                        speaker=Mehir
                        image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                        message= _ "They want to fight against the entire world?! What kind of madness is this?!"
                    [/message]
                    [message]
                        speaker=Rashti
                        message= _ "Mehir, I <b>must</b> reach that lunatic and kill him!"
                    [/message]
                    [message]
                        speaker=Mehir
                        message= _ "But... but it's dangerous! Who knows what more tricks he has up his sleeve!"
                    [/message]
                )}
                [message]
                    speaker=Rashti
                    message= _ "I know what I'm doing, just clear the way for me."
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "*sigh* fine..."
                [/message]
                {PLACE_IMAGE "items/gohere.png" 19 19}
                {HIGHLIGHT_IMAGE 19 19 "items/gohere.png" ()}
                {VARIABLE bat_event_triggered yes}
            [/else]
        [/if]
    [/event]

    #Rashti climbs
    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Rashti
            x,y=19,19
        [/filter]

        [if]
            [have_unit]
                id=Master
                x,y=25,6
            [/have_unit]
            [then]
                {REMOVE_IMAGE 19 19}
                {SCROLL_TO 19 16}
                [store_unit]
                    [filter]
                        id=Rashti
                    [/filter]
                    kill=yes
                    variable=rashti
                [/store_unit]
                [redraw]
                [/redraw]
                [lock_view]
                [/lock_view]
                {FAKE_SCENERY_ANIM scenery/climb-a 14 19 16 75}
                {PLACE_HALO "scenery/climb-a-14.png" 19 16}
                {SCROLL_TO 19 11}
                {REMOVE_IMAGE 19 16}
                {FAKE_SCENERY_ANIM scenery/climb-b 16 19 11 75}
                {PLACE_HALO "scenery/climb-b-16.png" 19 11}
                {SCROLL_TO 19 7}
                {REMOVE_IMAGE 19 11}
                {FAKE_SCENERY_ANIM scenery/climb-c 8 19 7 75}
                {PLACE_HALO "scenery/climb-c-8.png" 19 7}
                {SCROLL_TO 22 7}
                {REMOVE_IMAGE 19 7}
                [animate_path]
                    x=-1175,200,600,1100
                    y=200,-60,-60,200
                    hex_x,hex_y=13,6
                    image=anim/climb-d.png
                    frames=20
                    frame_length=75
                    interpolation=bspline
                    linger=yes
                [/animate_path]
                [delay]
                    time=500
                [/delay]
                {REMOVE_IMAGE 19 10}
                #Master's time bubble
                {FADE_TO_BLACK}
                {TLU_SMOOTH_REPLACE_MUSIC silence.ogg 1500 0}
                [store_unit]
                    [filter]
                        [not]
                            id=Master
                        [/not]
                    [/filter]
                    variable=timefreeze
                    kill=yes
                [/store_unit]
                {REMOVE_IMAGE 19 2}
                [delay]
                    time=500
                [/delay]
                [message]
                    speaker=Master
                    message=_ "And now time stops..."
                [/message]
                {MOVE_UNIT id=Master 24 6}
                {MOVE_UNIT id=Master 23 6}
                [message]
                    speaker=Master
                    message=_ "A magical being. One quite very different from the rest present here on the battlefield."
                [/message]
                {MOVE_UNIT id=Master 24 5}
                [message]
                    speaker=Master
                    message=_ "You seem to be of dual personality. Your body is composed of two completely opposing energies. And one of them is familiar to me - it thirsts for blood..."
                [/message]
                {MOVE_UNIT id=Master 27 6}
                [message]
                    speaker=Master
                    message=_ "I wonder, what would happen if I separated both of you... It could unleash devastating power of your bloodthirsty half, no longer bound to the voice of reason, or..."
                [/message]
                [store_unit]
                    [filter]
                        id=Master
                    [/filter]
                    variable=master
                    kill=yes
                [/store_unit]
                [unstore_unit]
                    variable=master
                    x,y=25,6
                [/unstore_unit]
                {MODIFY_UNIT id=Master facing sw}
                [message]
                    speaker=Master
                    image="portraits/almathis-magic.png"
                    message=_ "...or you could just die. Time to test my theory!"
                [/message]
                [animate_unit]
                    flag=attack
                    [filter]
                        id=Master
                    [/filter]
                    [primary_attack]
                        name=scythe
                    [/primary_attack]
                    hits=yes
                    [facing]
                        [filter]
                            id=Anthi
                        [/filter]
                    [/facing]
                [/animate_unit]
                {REMOVE_IMAGE 24 5}
                {FAKE_SCENERY_ANIM scenery/climb-e 8 19 7 150}
                {PLACE_HALO "scenery/white.png" 19 7}
                {PLACE_HALO "scenery/dharmarashti-dead.png" 18 16}
                {PLACE_IMAGE "scenery/horashti-dead.png" 6 19}

                [foreach]
                    array=timefreeze
                    [do]
                        [unstore_unit]
                            variable=this_item
                            find_vacant=no
                        [/unstore_unit]
                    [/do]
                [/foreach]

                {CLEAR_VARIABLE timefreeze}
                {REMOVE_IMAGE 19 7}
                {REMOVE_IMAGE 24 5}
                {FADE_STEP 192 5}
                {FADE_STEP 160 5}
                {FADE_STEP 128 5}
                {FADE_STEP 96 5}
                {FADE_STEP 64 5}
                {FADE_STEP 32 5}
                {FADE_STEP 0 5}
                {PLACE_HALO "scenery/gate-top2.png" 19 10}
                [unlock_view]
                [/unlock_view]
                {TLU_SMOOTH_REPLACE_MUSIC zhaytee_tragedy.ogg 1500 0}
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Ra... Rashti? Rashti?!... <i>*nervously, to himself* No, no, no, it’s impossible. This is just in a dream. This can’t be happening...</i>"
                [/message]
                {SCROLL_TO 18 16}
                [delay]
                    time=1000
                [/delay]
                {SCROLL_TO 6 19}
                [delay]
                    time=1000
                [/delay]
                [message]
                    speaker=Master
                    message= _ "That's it? Quite disappointing, really. Well, at least I have one less foe to worry about..."
                [/message]
                [message]
                    speaker=Dedylos
                    message= _ "She’s dead. I’m sorry, Mehir..."
                [/message]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "A thousand curses in Nomolas's name! I let Rashti die! Any punishment the High Council could inflict upon me would be miniscule compared to what I deserve for this... Why the hell have I decided to get involved in this damn war?!"
                [/message]
                [fire_event]
                    name=resurrect
                [/fire_event]
            [/then]
        [/if]
    [/event]

    #Rashti halves
    [event]
        name=resurrect

        {TLU_SMOOTH_REPLACE_MUSIC silence.ogg 1000 0}

        {REMOVE_IMAGE 18 16}
        {REMOVE_IMAGE 6 19}
        {UNIT 7 (TLU_DharmaRashti) 16 19 ()}
        {UNIT 8 (TLU_HoRashti) 6 19 ()}
        {VARIABLE dharma_turns 1}

        {TLU_SMOOTH_REPLACE_MUSIC Trite_And_Wrong.ogg 1500 0}
        {APPEND_MUSIC leave_none_alive.ogg}
        {APPEND_MUSIC vengeful.ogg}

        [message]
            type=TLU_HoRashti
            message= _ "It is not..."
        [/message]
        [message]
            type=TLU_DharmaRashti
            message= _ "...OVER YET!!!"
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-leader-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Rashti? You... you’re alive?! Both of you?"
        [/message]
        [message]
            type=TLU_HoRashti
            message= _ "We have been split, and us halves are now independent, but we must unite in order to restore the balance of the Abyss."
        [/message]
        [message]
            type=TLU_DharmaRashti
            message= _ "NEVER! I won’t let myself be enslaved again! Now I am finally free and... I AM COMING FOR YOU, MEHIR!"
        [/message]
        [message]
            speaker=Mehir
            message= _ "*gulp*"
        [/message]
        [message]
            type=TLU_HoRashti
            message= _ "I will never allow you to harm our Master!"
        [/message]
        {BADASS_MODE_CHANGE (
            [delay]
                time=1000
            [/delay]
            [message]
                type=TLU_DharmaRashti
                message= _ "HAHAHAHAHAAHAHAHA, you actually believed what I said?! Your expression is absolutely priceless!"
            [/message]
            [message]
                type=Mehir
                message= _ "You have a rather... twisted sense of humor."
            [/message]
            [message]
                type=TLU_DharmaRashti
                message= _ "Heh, what can I say, being free from my blue half is quite pleasant. She kept imposing rules upon rules on me. No cussing out members of the High Council, no collateral damage from fireballs, no tortuing enemies unless strictly necessary, blah blah blah. Now I can finally do whatever I please!"
            [/message]
            [message]
                type=TLU_HoRashti
                message= _ "Look Dharma'rashti, we must unite. The whole Abyss is at stake!"
            [/message]
            [message]
                type=TLU_DharmaRashti
                message= _ "NEVER!!!"
            [/message]
            [message]
                id=Mehir
                image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "Listen to your other half! You must do this!"
            [/message]
            [message]
                type=TLU_DharmaRashti
                message= _ "This is personal, Mehir. Stay away from our fight if you don't want your men to get killed!"
            [/message]

            #rashti attacks Mehir's units only in retaliation
            [modify_ai]
                side=7
                action=add
                path=aspect[attacks].facet[]
                [facet]
                    invalidate_on_gamestate_change=yes
                    [filter_own]
                    [/filter_own]
                    [filter_enemy]
                        [not]
                            side=1,5,6
                        [/not]
                    [/filter_enemy]
                [/facet]
            [/modify_ai]
        ) (
            [message]
                type=TLU_DharmaRashti
                message= _ "JUST TRY AND STOP ME, I DARE YOU!!!"
            [/message]
        )}

        [message]
            id=Mehir
            image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "We must weaken Dharma’Rashti, so that Ho’Rashti can seize her and unite!"
        [/message]
        [objectives]
            side=1
            [objective]
                description= _ "Defeat the invaders"
                condition=win
            [/objective]
            [objective]
                description= _ "Ho'rashti eliminates Dharma’Rashti"
                condition=win
            [/objective]
            [objective]
                description= _ "Dharma'rashti eliminates Ho’Rashti"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Mehir"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Atiros"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Dedylos"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
            note= _ "Both of Rashti's halves are unkillable (are fully healed when reaching 0 hitpoints), so trying to kill Dharm'rashti is not going to work."
        [/objectives]
        #making Dedylos' men not try to kill DharmaRashti, and instead target the bats/orbs, and protect side 1 units/HoRashti
        [modify_side]
            side=5,6
            [ai]
                #only target the bats/orbs:
                [aspect]
                    id=attacks
                    [facet]
                        invalidate_on_gamestate_change=yes
                        [filter_own]
                            side=5
                        [/filter_own]
                        [filter_enemy]
                            [not]
                                type=TLU_DharmaRashti
                            [/not]
                        [/filter_enemy]
                    [/facet]
                [/aspect]
                #try to protect Mehir's units from DharmaRashti:
                [goal]
                    name=protect_unit
                    [criteria]
                        side=1,8
                    [/criteria]
                    value=10
                    protect_radius=5
                [/goal]
            [/ai]
        [/modify_side]
        #making Almathis's bats/orbs not care as much about villages, and try to delay HoRashti
        [modify_side]
            side=2
            [ai]
                aggression=1
                village_value=-99 #doesn't seem to work
                [goal]
                    name=target
                    [criteria]
                        type=TLU_HoRashti
                    [/criteria]
                    value=999
                [/goal]
            [/ai]
        [/modify_side]
        {VARIABLE reinforcement_turns 1}
    [/event]

    #Almathis spawns orbs when standing on top of the tower
    [event]
        name=side 2 turn
        first_time_only=no
        [if]
            [have_unit]
                type=TLU_DharmaRashti
            [/have_unit]
            [and]
                [have_unit]
                    id=Master
                [/have_unit]
            [/and]
            [then]
                [switch]
                    variable=reinforcement_turns
                    [case]
                        value=1
                        {FAKE_UNIT_MOVE 27 24 7 19 2 (EoMa_Dark_Observer) ()}
                        {UNIT 2 (EoMa_Dark_Observer) (24) (19) ()}
                        {FAKE_UNIT_MOVE 27 23 7 20 2 (Dread Bat) ()}
                        {UNIT 2 (Dread Bat) (23) (20) ()}
#ifdef NORMAL
                        {FAKE_UNIT_MOVE 27 23 7 21 2 (Dread Bat) ()}
                        {UNIT 2 (Dread Bat) (23) (21) ()}
#endif
#ifdef HARD
                        {FAKE_UNIT_MOVE 27 23 7 21 2 (EoMa_Dark_Observer) ()}
                        {UNIT 2 (EoMa_Dark_Observer) (23) (22) ()}
#endif
                    [/case]
                    [case]
                        value=3
                        {FAKE_UNIT_MOVE 27 24 7 19 2 (Dread Bat) ()}
                        {UNIT 2 (Dread Bat) (24) (19) ()}
                        {FAKE_UNIT_MOVE 27 23 7 20 2 (EoMa_Dark_Observer) ()}
                        {UNIT 2 (EoMa_Dark_Observer) (23) (20) ()}
#ifdef NORMAL
                        {FAKE_UNIT_MOVE 27 23 7 21 2 (EoMa_Dark_Observer) ()}
                        {UNIT 2 (EoMa_Dark_Observer) (23) (21) ()}
#endif
#ifdef HARD
                        {FAKE_UNIT_MOVE 27 23 7 21 2 (Dread Bat) ()}
                        {UNIT 2 (Dread Bat) (23) (22) ()}
#endif
                    [/case]
                    [case]
                        value=5
                        {FAKE_UNIT_MOVE 27 24 7 19 2 (EoMa_Storm_Sphere) ()}
                        {UNIT 2 (EoMa_Storm_Sphere) (24) (19) ()}
                        {FAKE_UNIT_MOVE 27 23 7 20 2 (Dread Bat) ()}
                        {UNIT 2 (Dread Bat) (23) (20) ()}
#ifdef NORMAL
                        {FAKE_UNIT_MOVE 27 23 7 21 2 (EoMa_Dark_Observer) ()}
                        {UNIT 2 (EoMa_Dark_Observer) (23) (21) ()}
#endif
#ifdef HARD
                        {FAKE_UNIT_MOVE 27 23 7 21 2 (Dread Bat) ()}
                        {UNIT 2 (Dread Bat) (23) (22) ()}
#endif
                    [/case]
                    [case]
                        value=7
                        {FAKE_UNIT_MOVE 27 24 7 19 2 (EoMa_Storm_Sphere) ()}
                        {UNIT 2 (EoMa_Storm_Sphere) (24) (19) ()}
                        {FAKE_UNIT_MOVE 27 23 7 20 2 (Dread Bat) ()}
                        {UNIT 2 (Dread Bat) (23) (20) ()}
#ifdef NORMAL
                        {FAKE_UNIT_MOVE 27 23 7 21 2 (Dread Bat) ()}
                        {UNIT 2 (EoMa_Dark_Observer) (23) (21) ()}
#endif
#ifdef HARD
                        {FAKE_UNIT_MOVE 27 23 7 21 2 (EoMa_Dark_Observer) ()}
                        {UNIT 2 (Dread Bat) (23) (22) ()}
#endif
                    [/case]
                [/switch]
                {VARIABLE_OP reinforcement_turns add 1}
            [/then]
        [/if]
    [/event]

    #one of Rashti halves finally beats the second half
    [event]
        name=pre unified

        [message]
            type=TLU_DharmaRashti
            message= _ "Argh, you win..."
        [/message]
        [message]
            type=TLU_HoRashti
            message= _ "As strong as our mutural animosity may have been, we can't live without one another. We are two sides of the same coin. You are still dear to me... sister."
        [/message]
        [message]
            type=TLU_DharmaRashti
            message= _ "Hmph, fine, I'll tolerate your presence longer... for now."
        [/message]
    [/event]

    #True Rashti is born
    [event]
        name=unified

        [message]
            type=TLU_True_Rashti
            message= _ "Finally, after all the eternal struggle between my two egos, I am whole!"
        [/message]
        [message]
            speaker=Master
            message= _ "Amazing. I have split her in half, and not only she's still alive, but seems to have gone through some sort of... metamorphosis? Nevermind, it’s time to kill you for the second ti..."
        [/message]
        [lock_view]
        [/lock_view]

        [fire_event]
            name=gate4
        [/fire_event]

        [sound]
            name=explosion.ogg
        [/sound]
        [message]
            speaker=Master
            message= _ "What is the meaning of this?!"
        [/message]
        [store_unit]
            [filter]
                type=TLU_True_Rashti
            [/filter]
            variable=truerashtivar
            kill=yes
        [/store_unit]
        {VARIABLE truerashtivar.id Rashti}
        {SCROLL_TO ($truerashtivar.x) ($truerashtivar.y)}
        [delay]
            time=500
        [/delay]
        [message]
            speaker=Master
            message= _ "Seems I am about to get killed by this bi..."
        [/message]
        {FAKE_SCENERY_ANIM scenery/rev-a 4 25 4 100}
        [sound]
            name=explosion.ogg
        [/sound]
        {PLACE_HALO "scenery/rev-a-5.png" 25 4}
        [kill]
            id=Master
            animate=no
        [/kill]
        [redraw]
        [/redraw]
        [delay]
            time=1000
        [/delay]
        {FAKE_SCENERY_ANIM scenery/rev-b 10 25 4 50}
        {PLACE_HALO "scenery/rev-b-10.png" 25 4}

        {SCROLL_TO 25 8}
        [sound]
            name=explosion.ogg
        [/sound]
        [delay]
            time=250
        [/delay]
        {SCROLL_TO 25 11}
        [sound]
            name=explosion.ogg
        [/sound]
        [delay]
            time=250
        [/delay]
        {SCROLL_TO 25 14}
        [sound]
            name=explosion.ogg
        [/sound]
        [delay]
            time=500
        [/delay]
        {SCROLL_TO 25 17}
        [sound]
            name=explosion.ogg
        [/sound]
        [delay]
            time=250
        [/delay]
        [sound]
            name=explosion.ogg
        [/sound]
        {FAKE_SCENERY_ANIM scenery/rev-c 8 19 16 100}
        {PLACE_HALO "scenery/rev-c-8.png" 19 16}
        [unstore_unit]
            variable=truerashtivar
            x,y=22,16
        [/unstore_unit]
        [delay]
            time=500
        [/delay]
        {MOVE_UNIT id=Rashti 19 20}
        [message]
            speaker=narrator
            caption=_"Almathis"
            image="portraits/almathis-lastbreath.png"
            message= _ "*coughs blood* Heh, I must admit, I am grateful to you. Most of our *cough* army is dead thanks to your help."
        [/message]
        [message]
            speaker=Rashti
            message= _ "Seems you've completely lost your mind, warlock. Time to send you to the dark gods you love talking about so much, good luck explaining your failure to them!"
        [/message]
        [message]
            speaker=narrator
            caption=_"Almathis"
            image="portraits/almathis-lastbreath.png"
            message= _ "Haha, very well *cough*, do it!... <i>*to himself* As gullible as my troops, believing all the drivel I spouted with those zealous speeches...</i>"
        [/message]

        {SCROLL_TO 19 13}
        {SCROLL_TO 19 13}
        [sound]
            name=explosion.ogg
        [/sound]

        {REMOVE_IMAGE 19 9}
        [fire_event]
            name=gate3
        [/fire_event]

        {EARTHQUAKE (
            {REMOVE_IMAGE 19 16}
        )}

        [message]
            speaker=Mehir
            message= _ "Ra..Rashti... What happened?"
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                type=TLU_True_Rashti
                message= _ "I have finally achieved badassery...err I mean harmony of course. This is my final form."
            [/message]
        ) (
            [message]
                speaker=Rashti
                image="portraits/truerashti-noncombat.png"
                message= _ "I have finally achieved harmony. Two egos have become one. This is my final form."
            [/message]
        )}
        [if]
            [have_unit]
                side=2,3,4
            [/have_unit]
            [then]
                [message]
                    speaker=Dedylos
                    message= _ "I understand you have a lot to discuss, but the remnants of the Tharis army haven't given up yet. It would be a good idea to deal with them first, and save the sentiments for later."
                [/message]
                [objectives]
                    side=1
                    [objective]
                        description= _ "Kill the remaining enemies"
                        condition=win
                    [/objective]
                    [objective]
                        description= _ "Death of Mehir"
                        condition=lose
                    [/objective]
                    [objective]
                        description= _ "Death of Atiros"
                        condition=lose
                    [/objective]
                    [objective]
                        description= _ "Death of Dedylos"
                        condition=lose
                    [/objective]
                [/objectives]
            [/then]
            [else]
                [endlevel]
                    result=victory
                    carryover_report=yes
                    {NEW_GOLD_CARRYOVER 40}
                    bonus=no
                [/endlevel]
            [/else]
        [/if]
    [/event]

    #victory
    [event]
        name=victory
        {TLU_SMOOTH_REPLACE_MUSIC exploration.ogg 3000 0}
        [message]
            speaker=Atiros
            message= _ "We defeated the invaders! Anthi, WE DID IT!!!"
        [/message]
        [message]
            speaker=Anthi
            message= _ "Atiros, I sent you with nothing, and you returned with victory. May the Sun bestow you with infinite light."
        [/message]
        [message]
            speaker=Atiros
            message= _ "Thank our legendary brothers from the Great Desert. This is Mehir, our rescuer!"
        [/message]
        [message]
            speaker=Anthi
            message= _ "Welcome to Kharos, Mehir, descendant of our fathers."
        [/message]
        [message]
            speaker=Mehir
            message= _ "So you must be Anthi, the Highest Priestess of Light?"
        [/message]
        [message]
            speaker=Anthi
            message=_ "Indeed. I'd like to invite you as my guest, Mehir, but alas, the entrance to the city is obstructed again. Would it be possible to fix the damage in a magical manner?"
        [/message]
        [message]
            speaker=Mehir
            message= _ "Why, yes! My wonderful, <span font-weight='bold'>united</span> Rashti can get it right hands down. And it will allow me to get the news of our triumph off the ground. The High Council will be delighted! <span font-style='italic'>*to himself* for Rashti being finally at one with herself.</span>"
        [/message]
        {CLEAR_VARIABLE bat_event_triggered}
        {CLEAR_VARIABLE reinforcement_turns}
        {CLEAR_VARIABLE truerashtivar}
    [/event]

    #all enemies defeated = victory
    [event]
        name=die
        first_time_only=no
        [filter]
            side=2,3,4
        [/filter]
        [if]
            [have_unit]
                side=2,3,4
            [/have_unit]
            [else]
                [endlevel]
                    result=victory
                    carryover_report=yes
                    {NEW_GOLD_CARRYOVER 40}
                    bonus=no
                [/endlevel]
            [/else]
        [/if]
    [/event]

    #side 3 leader last breath
    [event]
        name=last_breath
        [filter]
            side=3
            canrecruit=yes
        [/filter]
        [message]
            side=3
            canrecruit=yes
            message=_"In war, there is no good and evil, only the dead and the alive..."
        [/message]
    [/event]

    #side 3 leader last breath
    [event]
        name=last_breath
        [filter]
            side=4
            canrecruit=yes
        [/filter]
        [message]
            side=4
            canrecruit=yes
            message=_"One is only truly defeated when he accepts defeat..."
        [/message]
    [/event]

    #jinni advice
    [event]
        name=recall,post advance
        first_time_only=yes
        [filter]
            type=EoMa_Wonderful_Jinn,EoMa_Mystical_Jinn
        [/filter]

        [if]
            [have_unit]
                type=TLU_Rashti
            [/have_unit]
            [then]
                [if]
                    [have_unit]
                        id=$unit.id
                        type=EoMa_Wonderful_Jinn
                    [/have_unit]
                    [then]
                        [message]
                            speaker=Mehir
                            message= _ "Wonderful Jinni! Give me some advice!"
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=Mehir
                            message= _ "Mystical Jinni! Give me some advice!"
                        [/message]
                    [/else]
                [/if]

                [message]
                    speaker=unit
                    message= _ "I believe it is best to hold the enemy forces at the bridge, and slowly thin their ranks. Afterwards, we must eliminate the enemy leader as quickly as we can."
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "Very well. Anything else?"
                [/message]
                [message]
                    speaker=unit
                    message= _ "Yes. I'm not sure if it is of any importance, but lately I've been having visions about Rashti..."
                [/message]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "I hope you're not fantasizing about her again... So, what about her?"
                [/message]
                [message]
                    speaker=unit
                    message= _ "In my visions, I saw her attempt to fight the self-proclaimed Master of Darkness, but there was something strange about their duel..."
                [/message]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Speak sense, Nomolas damn it!"
                [/message]
                [message]
                    speaker=unit
                    message= _ "My master, you see, for some reason I could not foresee the outcome of their fight. It felt as if at that very point ...time completely stopped. I suspect that he has the ability to mess with the flow of time, preventing me from accessing the future. He may be far more of a threat than we thought..."
                [/message]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Wonderful, I finally get a Jinni capable of foreseeing the future, and yet he says he cannot help me. *sigh* Let's just proceed with the battle and hope for the best. I got a bad feeling about this..."
                [/message]
            [/then]
        [/if]
    [/event]

    #time over
    [event]
        name=time over
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    #debug events
    [event]
        name=testing

        [kill]
            type=EoMa_Chaos_Hydra
        [/kill]

        {VARIABLE badass_mode_unlocked yes}

        {MODIFY_UNIT id=Rashti moves 30}

        [fire_event]
            name=last_breath

            [primary_unit]
                id=Master
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=nogold

        [modify_side]
            side=2
            income=0
            gold=0
        [/modify_side]
        [modify_side]
            side=3
            income=0
            gold=0
        [/modify_side]
        [modify_side]
            side=4
            income=0
            gold=0
        [/modify_side]
        [modify_side]
            side=5
            income=0
            gold=0
        [/modify_side]
    [/event]

    [event]
        name=gate1
        first_time_only=no

        {SCROLL_TO 19 13}
        {ANIMHACK gate1 19 14 se}
        {UNIT 4 (TLU_animhack) 19 14 (facing,variation=se,gate1)}
    [/event]

    [event]
        name=gate2
        first_time_only=no

        {SCROLL_TO 19 5}
        {ANIMHACK gate3 17 1 s}
        [kill]
            x=17,18,19,20,21,17,18,19,20,21,17,18,19,20,21,17,18,19,20,21,17,18,19,20,21
            y=2,2,2,2,2,3,3,3,3,3,4,4,4,4,4,5,5,5,5,5,6,6,6,6,6
            animate=no
        [/kill]
        [terrain]
            x,y=1,1
            terrain=Xv^Yyyz
            layer=both
        [/terrain]
        [terrain]
            terrain=Rp^Xo
            x=19,19,17,20
            y=15,16,16,16
        [/terrain]
        [kill]
            type=TLU_animhack
            animate=no
        [/kill]
        {PLACE_HALO "scenery/gate-top.png" 19 9}
    [/event]

    [event]
        name=gate3
        first_time_only=no

        {SCROLL_TO 19 13}
        {REMOVE_IMAGE 19 9}
        [terrain]
            x,y=1,1
            terrain=Xv^Yyyz
            layer=both
        [/terrain]
        {ANIMHACK gate4 19 7 s}
        [kill]
            x=16-22,21,23,18,20
            y=13-18,18,18,12,12
            animate=no
        [/kill]
        [terrain]
            x,y=1,1
            terrain=Xv^Yyzz
            layer=both
        [/terrain]
        {PLACE_HALO "scenery/gate-top2.png" 19 10}
        [kill]
            type=TLU_animhack
            animate=no
        [/kill]
        [terrain]
            terrain=Rp^Xo
            x=16,17,18,22,16,17,18,19,20,21,22,16,17,18,19,20,21,22,16,17,18,19,20,21,22,23
            y=14,14,14,14,15,15,15,15,15,15,15,16,16,16,16,16,16,16,17,17,17,17,17,17,17,18
        [/terrain]
        [terrain]
            terrain=Hh
            x=16-22
            y=17-18
        [/terrain]
    [/event]

    [event]
        #reverse
        name=gate4
        first_time_only=no

        {SCROLL_TO 19 13}
        [terrain]
            terrain=Rp
            x=16,17,18,22,16,17,18,19,20,21,22,16,17,18,19,20,21,22,16,17,18,19,20,21,22
            y=14,14,14,14,15,15,15,15,15,15,15,16,16,16,16,16,16,16,17,17,17,17,17,17,17
        [/terrain]
        [terrain]
            terrain=Rp
            x=16-22
            y=17-18
        [/terrain]
        {EARTHQUAKE ()}
        {REMOVE_IMAGE 19 9}
        {REMOVE_IMAGE 19 10}
        [terrain]
            x,y=1,1
            terrain=Xv^Yyyz
            layer=both
        [/terrain]

        ## {ANIMHACK gate4reverse 19 13 s}
        {ANIMHACK gate4reverse 19 7 s}
        {PLACE_HALO "scenery/gate-top.png" 19 9}
    [/event]

    [event]
        name=gate5
        first_time_only=no

        [terrain]
            x,y=1,1
            terrain=Xv^Yyyz
            layer=both
        [/terrain]

        {FAKE_SCENERY_ANIM scenery/rev-a 4 25 4 100}

        {PLACE_HALO "scenery/rev-a-5.png" 25 4}

        [delay]
            time=1000
        [/delay]

        {FAKE_SCENERY_ANIM scenery/rev-b 10 25 4 50}
        {PLACE_HALO "scenery/rev-b-10.png" 25 4}

        {FAKE_SCENERY_ANIM scenery/rev-c 8 19 16 100}
    [/event]

    [event]
        name=climb2
        first_time_only=no

        {FAKE_SCENERY_ANIM scenery/climb-a 14 19 16 75}
        {PLACE_HALO "scenery/climb-a-14.png" 19 16}
        {SCROLL_TO 19 11}
        {REMOVE_IMAGE 19 16}
        {FAKE_SCENERY_ANIM scenery/climb-b 16 19 11 75}
        {PLACE_HALO "scenery/climb-b-16.png" 19 11}
        {SCROLL_TO 19 7}
        {REMOVE_IMAGE 19 11}
        {FAKE_SCENERY_ANIM scenery/climb-c 8 19 7 75}
        {PLACE_HALO "scenery/climb-c-8.png" 19 7}
        {SCROLL_TO 22 7}
        {REMOVE_IMAGE 19 7}
        [animate_path]
            x=-1175,200,600,1100
            y=200,-60,-60,200
            hex_x,hex_y=13,6
            image=anim/climb-d.png
            frames=20
            frame_length=75
            interpolation=bspline
            linger=yes
        [/animate_path]
    [/event]

    [event]
        name=gate
        first_time_only=no

        [fire_event]
            name=gate1
        [/fire_event]
        [fire_event]
            name=gate2
        [/fire_event]
        [fire_event]
            name=gate3
        [/fire_event]
    [/event]

    {SUMMONER_UNLOCK}
    {ITEM_APPLIER}
    {COLLAR_EVENT}
    {DEATH_MEHIR}
    {DEATH_RASHTI}
    {DEATH_ATIROS}
    {DEATH_DEDYLOS}
    {TLU_S17_TERRAIN}
[/scenario]
