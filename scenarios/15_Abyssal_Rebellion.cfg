#textdomain wesnoth-To_Lands_Unknown
#define REFICUL_DISAPPEAR_ANIM
    [object]
        silent=yes
        duration=forever
        [filter]
            id=Reficul
        [/filter]
        [effect]
            apply_to=new_animation
            [extra_anim]
                flag=disappear
                start_time=0
                circle_start_time=0
                [particle_frame]
                    duration=1000
                    image="halo/particle-anims/particles-a-[01~96].png"
                    image_mod="~SCALE(100,100)"
                    auto_vflip=false
                    layer=30
                    alpha=0~1:150,1:700,1~0:150
                    offset=0.0
                [/particle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 15 "~GS()~R(255)"}
                    image_mod="~SCALE(1,2)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 16 "~GS()~R(255)"}
                    image_mod="~SCALE(10,7)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 17 "~GS()~R(255)"}
                    image_mod="~SCALE(19,12)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 18 "~GS()~R(255)"}
                    image_mod="~SCALE(28,17)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 18 "~GS()~R(255)"}
                    image_mod="~SCALE(37,22)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 19 "~GS()~R(255)"}
                    image_mod="~SCALE(45,27)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 20 "~GS()~R(255)"}
                    image_mod="~SCALE(54,32)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 21 "~GS()~R(255)"}
                    image_mod="~SCALE(63,37)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 22 "~GS()~R(255)"}
                    image_mod="~SCALE(72,42)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 23 "~GS()~R(255)"}
                    image_mod="~SCALE(81,47)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 23 "~GS()~R(255)"}
                    image_mod="~SCALE(101,59)"
                [/circle_frame]
                [circle_frame]
                    duration=1000
                    image=halo/ucircle-frames/ucircle-c-[01~23].png
                    image_mod="~SCALE(101,59)"~GS()~R(255)""
                    auto_vflip=false
                    layer=0
                    y=20
                    alpha=1
                    offset=0.0
                    layer=0
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 01 "~GS()~R(255)"}
                    image_mod="~SCALE(101,59)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 01 "~GS()~R(255)"}
                    image_mod="~SCALE(81,47)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 02 "~GS()~R(255)"}
                    image_mod="~SCALE(72,42)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 03 "~GS()~R(255)"}
                    image_mod="~SCALE(63,37)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 04 "~GS()~R(255)"}
                    image_mod="~SCALE(54,32)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 05 "~GS()~R(255)"}
                    image_mod="~SCALE(45,27)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 06 "~GS()~R(255)"}
                    image_mod="~SCALE(37,22)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 07 "~GS()~R(255)"}
                    image_mod="~SCALE(28,17)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 08 "~GS()~R(255)"}
                    image_mod="~SCALE(19,12)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 09 "~GS()~R(255)"}
                    image_mod="~SCALE(10,7)"
                [/circle_frame]
                [circle_frame]
                    {CIRCLE_RECRUIT 10 "~GS()~R(255)"}
                    image_mod="~SCALE(1,2)"
                [/circle_frame]
                [frame]
                    duration=1100
                    submerge=0:100,0.0~0.8:700,0.8~1:300
                    y=0~26:700,26:300
                    alpha=1:500,1~0:600
                    blend_color=255,255,255
                    blend_ratio=0:100,0~1:400,1:600
                    layer=2
                    sound=magic-faeriefire-miss.ogg
                [/frame]
            [/extra_anim]
        [/effect]
    [/object]

    [animate_unit]
        flag=disappear
        [filter]
            id=Reficul
        [/filter]
    [/animate_unit]
    [hide_unit]
        id=Reficul
    [/hide_unit]
#enddef
[scenario]
    id=15_Abyssal_Rebellion
    next_scenario=16_Defense_of_Saffaros
    name= _ "Abyssal Rebellion"
    map_data="{~add-ons/To_Lands_Unknown/maps/15_Abyssal_Rebellion.map}"
    {TURNS 33 29 25}
    victory_when_enemies_defeated=no

    {MORNING_TLU}
    {SCENARIO_MUSIC casualties_of_war.ogg}
    {EXTRA_SCENARIO_MUSIC battle.ogg}
    {EXTRA_SCENARIO_MUSIC vengeful.ogg}

    {STORYTXT_THE_GREAT_DESERT}

    {STARTING_VILLAGES_ALL 1}

    [side]
        side=1
        controller=human
        team_name=mehirteam
        user_team_name= _ "team_name^Mehir"

        type=EoMa_Grand_Summoner
        id=Mehir
        name= _ "Mehir"
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Novice_Summoner,EoMa_Camel_Rider,EoMa_Carpet_Rider,EoMa_Water_Elemental,EoMa_Summoner,EoMa_Rhami,EoMa_Fire_Elemental,EoMa_Jinni,EoMa_Dispeller

        {GOLD 500 475 420}
        {INCOME 25 25 20}
    [/side]

    [side]
        side=2
        controller=ai
        team_name=reficul
        user_team_name= _ "team_name^Rebels"

        type=EoMa_Great_Efreeti
        id=Reficul
        name= _ "Reficul"
        unrenamable=yes
        canrecruit=yes
        facing=sw
        color=purple
        profile=portraits/reficul.png
        image_icon=portraits/reficul.png~CROP(130,10,140,140)~SCALE(72,72)

        recruit=EoMa_Rhami_datu,EoMa_Efreeti,EoMa_Rhami,EoMa_Jinni,EoMa_Dharma_rhami

        {GOLD 350 500 700}
        {INCOME 10 15 20}

        [ai]
            aggression=1.0
        [/ai]
    [/side]

    [side]
        side=3
        controller=ai
        team_name=mehirteam
        user_team_name= _ "team_name^Rashti"
        hidden=yes
        color=black
        no_leader=yes

        [ai]
            aggression=1.0
        [/ai]
    [/side]

    [side]
        side=4
        controller=ai
        team_name=mehirteam
        user_team_name= _ "team_name^Kharos"
        color=white
        hidden=yes
        no_leader=yes

        recruit=
    [/side]

    #prestart
    [event]
        name=prestart

        [modify_unit]
            [filter]
                type=EoMa_Summoner
            [/filter]
            advances_to=EoMa_Grand_Summoner,EoMa_Neutral_Summoner,EoMa_Heavy_Summoner
        [/modify_unit]

        {RECALL_RASHTI}

        [if]
            [have_unit]
                id=Instructor # wmllint: ignore
                search_recall_list=yes
            [/have_unit]
            [then]
                #recall Semir
                [recall]
                    id=Instructor # wmllint: ignore
                [/recall]
                [modify_unit]
                    [filter]
                        id=Instructor # wmllint: ignore
                    [/filter]
                    {TRAIT_LOYAL}
                [/modify_unit]
                {MODIFY_UNIT id=Instructor id Banisher} # wmllint: ignore
            [/then]
            [else]
                #create Semir
                {UNIT 1 (EoMa_Banisher) () () (
                    placement=leader
                    id=Banisher # wmllint: ignore
                    image_icon="portraits/summoners/banisher.png~CROP(131,10,130,130)~SCALE(72,72)"
                    unrenamable=yes
                    name= _ "Semir"
                    [modifications]
                        {TRAIT_LOYAL}
                    [/modifications]
                )}
            [/else]
            # wmllint: recognize Banisher
        [/if]

        #predefined Reficul army
        [store_unit]
            [filter]
                side=1
                level=3
                x,y=recall,recall
            [/filter]
            variable=lvls3
        [/store_unit]
        [store_unit]
            [filter]
                side=1
                level=2
                x,y=recall,recall
            [/filter]
            variable=lvls2
        [/store_unit]
        {VARIABLE mehirunits $lvls2.length}
        {VARIABLE_OP mehirunits add $lvls3.length}
        {VARIABLE_OP mehirunits divide 3}
        {VARIABLE_OP mehirunits round floor}

        {REPEAT 2 (
            {UNIT 2 (EoMa_Dharma_rhami) () () (placement,ai_special=leader,guardian)}
        )}

        {REPEAT $mehirunits (
            {RANDOM 1..2}
            [switch]
                variable=random
                [case]
                    value=1
                    {UNIT 2 (EoMa_Efreeti) () () (placement=leader)}
                [/case]
                [else]
                    {UNIT 2 (EoMa_Rhami_datu) () () (placement=leader)}
                [/else]
            [/switch]
        )}
#ifdef EASY
        {REPEAT 1 (
            {UNIT 2 (EoMa_Great_Efreeti) () () (placement=leader)}
        )}
        {REPEAT 2 (
            {UNIT 2 (EoMa_Dharma_rhami) () () (placement=leader)}
        )}
        {REPEAT 2 (
            {UNIT 2 (EoMa_Efreeti) () () (placement=leader)}
        )}
        {REPEAT 2 (
            {UNIT 2 (EoMa_Rhami_datu) () () (placement=leader)}
        )}
#endif
#ifdef NORMAL
        {REPEAT 2 (
            {UNIT 2 (EoMa_Great_Efreeti) () () (placement=leader)}
        )}
        {REPEAT 3 (
            {UNIT 2 (EoMa_Dharma_rhami) () () (placement=leader)}
        )}
        {REPEAT 3 (
            {UNIT 2 (EoMa_Efreeti) () () (placement=leader)}
        )}
        {REPEAT 3 (
            {UNIT 2 (EoMa_Rhami_datu) () () (placement=leader)}
        )}
#endif
#ifdef HARD
        {REPEAT 3 (
            {UNIT 2 (EoMa_Great_Efreeti) () () (placement=leader)}
        )}
        {REPEAT 4 (
            {UNIT 2 (EoMa_Dharma_rhami) () () (placement=leader)}
        )}
        {REPEAT 3 (
            {UNIT 2 (EoMa_Efreeti) () () (placement=leader)}
        )}
        {REPEAT 3 (
            {UNIT 2 (EoMa_Rhami_datu) () () (placement=leader)}
        )}
#endif

        {CLEAR_VARIABLE mehirunits}
        {CLEAR_VARIABLE lvls3}
        {CLEAR_VARIABLE lvls2}

        [store_unit]
            [filter]
                side=2
            [/filter]
            variable=redarmy
        [/store_unit]
        {VARIABLE redarmy $redarmy.length}
        {VARIABLE_OP redarmy divide 2}
        {VARIABLE_OP redarmy round ceiling}

        {VARIABLE rashti_fury 0}
    [/event]

    #start
    [event]
        name=start
        [message]
            speaker=Mehir
            message= _ "There they are! Sticking out like blots on the landscape! What are these deserters doing in this deserted part of the desert!"
        [/message]
        [message]
            speaker=Reficul
            message= _ "Well, well, well, so the mighty Mehir of Tar-Tabar finally noticed our existence? Here to snuff out the spark of rebellion, I assume?"
        [/message]
        [message]
            speaker=Mehir
            message= _ "Look, how about you just surrender calmly? Back home in the Abyss you'll be even better off than roaming the deserts. We want what's best for you."
        [/message]
        [message]
            speaker=Reficul
            message= _ "Deportation, as usual, for YOUR sake, not ours. I am sick of living under your anthopocratic rule. You force us to serve you, barely give us any rights, and banish any magical being who dares to disobey you!"
        [/message]
        [message]
            speaker=Mehir
            message= _ "*shrugs* If you're not content, just ask your local banisher for a quick trip back to the Abyss."
        [/message]
        [message]
            speaker=Reficul
            message= _ "Believe me, under different circumstances being deported and having my memories of this damned world wiped is an offer I'd gladly accept..."
        [/message]
        [message]
            speaker=Reficul
            message= _ "...but as if living under your reign here wasn't unbearable enough already, we'll soon even have to endure it even in the Abyss, our very homeland, thanks to the construction of the damned 'Great Circle'! I must stop this madness at all costs! If I cannot convince your kind to cease the construction, then I have no choice but to stop it by force!"
        [/message]
        [message]
            speaker=Mehir
            message= _ "Seems like there's no negotiating now. (to Semir) Got any advice?"
        [/message]
        [message]
            speaker=Banisher
            message= _ "My, my, I've seen quite a few abyssal diehards in my time as a banisher, but this one is a real pleasure to my eyes... such strength, such extraordinary charisma and rhetoric... I'm not surprised at all that he managed to persuade so many beings to follow him!"
        [/message]
        [message]
            speaker=Mehir
            message= _ "Wait, are you under his spell too? This was supposed to be easy... My first mission as a leader, and the personification of destruction on the horizon! It's dawning on me now why Sharif hasn't attended to the matter himself... You think that this super-efreeti will let me enmegacircle him? I better summon an army of jinn!"
        [/message]
        [message]
            speaker=Banisher
            message= _ "Great, Wonderful and Mystical Jinn may prove really useful here as their higher intellect can shield them from this Efreeti's lies but common Jinn and Rhamis can easily fall to his will and join him, although there is a small chance that it won’t happen."
        [/message]
#ifndef HARD
        #Semir's tips only on easy/normal and Mehir has not left class
        {IF_VAR player_left_class equals yes (
            [else]
                [if]
                    [have_unit]
                        type=EoMa_Dimensional_Gate_II
                        search_recall_list=yes
                    [/have_unit]
                    [then]
                        [message]
                            speaker=Banisher
                            message= _ "You seem to have a Dimensional Gate II with you, my Liege. We could use it to directly summon a Great Jinni to aid our cause! Of course we would have to feed it with a soul of a magical being. By looking at the forces in front of us, we have plenty of that. Besides..."
                        [/message]
                        [message]
                            speaker=Banisher
                            message= _ "You could use your Banishers against our enemy to get multiple Dimensional Gate IIs. Then we could feed them with souls of hostile magical beings to summon some powerful servants directly from the Abyss."
                        [/message]
                        [message]
                            speaker=Mehir
                            image="portraits/mehir-leader-happy.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                            message= _ "Actually this is a brilliant idea!"
                        [/message]
                    [/then]
                [/if]

                [if]
                    [have_unit]
                        type=EoMa_Great_Jinni,EoMa_Wonderful_Jinn,EoMa_Mystical_Jinn
                        search_recall_list=yes
                    [/have_unit]
                    [then]
                        [message]
                            speaker=Banisher
                            message= _ "It seems you already have an experienced Jinni with you. I am sure he will prove useful and won't betray us thanks to his higher intellect in comparison to common Jinn or Rhamis. Wonderful and Mystical Jinn can even foresee the future! But you should already know that."
                        [/message]
                    [/then]
                [/if]
            [/else]
        )}
#endif
        [message]
            speaker=Banisher
            message= _ "Also, do not use red entities at all, because they are rebellious by nature and near this Efreeti, they will surely revolt against us. Of course this is only advice. You can do whatever you want, my liege, as long as you keep in mind the consequences."
        [/message]
        [message]
            speaker=Mehir
            message= _ "What about Rashti? She’s half-good..."
        [/message]
        [message]
            speaker=Banisher
            message= _ "...but also half-evil. Her blue half should be immune to the efreeti's persuasion, but I can’t guarantee that..."
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Wait, wait, wait! Why didn’t you tell me about this earlier?! I could’ve left her in my palace!"
        [/message]
        [message]
            speaker=Banisher
            message= _ "You didn’t ask, my Liege."
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message=_ "You fool! She’s one of the ultimate beings! If she turns against us, we will be doomed! You’d better tell me how we should defeat that damn efreeti before he gets a chance to turn Rashti against us!"
        [/message]
        [message]
            speaker=Banisher
            message= _ "My liege, use elementals. They are unable to think, and thus impossible to delude. You can also use higher-level blue beings, such Rhami'kais Ho’rhamis and Great Jinn — they would never betray us."
        [/message]
#ifndef HARD
        [message]
            speaker=Banisher
            message= _ "And make sure to use as many dispellers and banishers as you can. Also, stay close to your troops in the back, and use the power of your megacircle to strengthen and heal them."
        [/message]
#endif
        [message]
            speaker=Mehir
            image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "No red entities, no oasis, no varied terrain and an army of rhami'datus and efreet in front of us. This is going to be interesting..."
        [/message]
#ifndef HARD
        {IF_VAR player_left_class equals yes (
            [else]
                [message]
                    speaker=Banisher
                    message= _ "Don't forget my liege that the sheer amount of rogue efreet is an excellent opportunity to stock up on dimensional gates. The yellow ones can be exceptionally useful here as they can advance directly to Great Jinn!"
                [/message]
            [/else]
        )}
#endif
        [delay]
            time=500
        [/delay]
        [message]
            speaker=Reficul
            message= _ "My brethren, time to give the tyrants a lesson they shall never forget! FOR FREEDOM!!!"
        [/message]
        [role]
            role=rebel1
            type=EoMa_Efreeti,EoMa_Great_Efreeti#,EoMa_Dharma_rhami#a dharma rhami is automatically chosen as rebel2 anyway, removing the type from the list to avoid too much overlap
        [/role]
        [role]
            role=rebel2
            type=EoMa_Dharma_rhami
            [not]
                role=rebel1
            [/not]
        [/role]
        [message]
            role=rebel1
            message= _ "FOR FREEDOM!!!"
        [/message]
        [message]
            role=rebel2
            message= _ "DOWN WITH THE TYRANTS!!! DEATH TO THE FALSE QUEEN!!!" #referring to rashti
        [/message]
        [message]
            speaker=narrator
            image=portraits/narrator.png
            message= _ "You can level up your Grand Summoners to Summons Masters now.

All your Grand Summoners who received AMLAs in earlier scenarios will advance to Summons Masters upon recall automatically."
        [/message]
        [message]
            speaker=narrator
            image=portraits/narrator.png
            message= _ "All summoned beings originating from the Red Abyss like Dharma'rhami, Rhami'datu and Efreet will instantly betray you in this scenario.

Level 1 intelligent beings like Jinn and Rhami may choose to betray you depending on your luck.

Elementals and level 2-3 blue beings like Great Jinn, Rhami'kai and Ho'rhami will never turn against you."
        [/message]

        #no longer used since Doom Scrolling AMLA has been commented out and merged with the circle of destruction first strike AMLA
        #        #compensation for the scroll AMLA
        #        [if]
        #            [variable]
        #                name=mehir_had_scroll_amla
        #                equals=yes
        #            [/variable]
        #            [then]
        #                [message]
        #                    speaker=narrator
        #                    image=portraits/narrator.png
        #                    message= _ "As a Commander, Mehir got the scroll attack upgrade. With his new circle, Mehir no longer needs to use scrolls. As a #compensation for the experience spent on this particular AMLA as a Commander, Mehir receives 80 experience points."
        #                [/message]
        #                [store_unit]
        #                    [filter]
        #                        id=Mehir
        #                    [/filter]
        #                    variable=mehir
        #                    kill=no
        #                [/store_unit]
        #                [set_variable]
        #                    name=mehir.experience
        #                    add=80
        #                [/set_variable]
        #                [unstore_unit]
        #                    variable=mehir
        #                    find_vacant=no
        #                    text="+80"+" "+_"exp"
        #                    red,green,blue=50,50,200
        #                [/unstore_unit]
        #                [sound]
        #                    name=fanfare-short.wav
        #                [/sound]
        #                {CLEAR_VARIABLE mehir_had_scroll_amla}
        #            [/then]
        #        [/if]

        [objectives]
            side=1
            [objective]
                description= _ "Defeat Reficul"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Mehir"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Rashti"
                condition=lose
            [/objective]

            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
            note=_ "You won't be able to recall Semir after this scenario, as he will remain in Tar-Tabar."
        [/objectives]

        {FORCE_CHANCE_TO_HIT type=EoMa_Dimensional_Gate,EoMa_Dimensional_Gate_II,EoMa_Dimensional_Gate_III id=Reficul 0 ()}
    [/event]

    #player recalls a red being - Reficul converts it
    [event]
        name=recall
        first_time_only=yes
        id=reficul_conversion_dialog
        [filter]
            side=1
            type=EoMa_Dharma_rhami,EoMa_Rhami_datu,EoMa_Efreeti,EoMa_Great_Efreeti
        [/filter]
        [message]
            speaker=Reficul
            message= _ "Join me, I'll allow you to do what you truly want, to DESTROY, to KILL those who enslaved you!"
        [/message]
        [message]
            speaker=unit
            message= _ "Yes... YES!!! I SEE THE TRUTH NOW!!! TIME FOR THE MORTALS TO DIE!!!"
        [/message]
        {MODIFY_UNIT x,y=$x1,$y1 side 2}
        [fire_event]
            name=speech_red
        [/fire_event]
    [/event]
    [event]
        name=recall
        first_time_only=no
        [filter]
            side=1
            type=EoMa_Dharma_rhami,EoMa_Rhami_datu,EoMa_Efreeti,EoMa_Great_Efreeti
        [/filter]
        {MODIFY_UNIT x,y=$x1,$y1 side 2}
    [/event]
    [event]
        name=speech_red
        [message]
            speaker=Banisher
            message= _ "My liege! <b>What have I told you?!!</b>"
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Damn! I forgot!"
        [/message]
    [/event]

    #player recruits/recalls a lvl1 blue being
    [event]
        name=recruit,recall
        first_time_only=no
        [filter]
            side=1
            type=EoMa_Rhami,EoMa_Jinni
        [/filter]
        [fire_event]
            name=speech_blue
        [/fire_event]
    [/event]
    [event]
        name=speech_blue
        [message]
            speaker=Banisher
            message= _ "Be careful, my liege. Lesser blue beings could end up being swayed by the efreeti when we least expect it."
        [/message]
        [message]
            speaker=Mehir
            message= _ "Don't worry, I know what I'm doing."
        [/message]
        [message]
            speaker=Banisher
            message= _ "If you say so..."
        [/message]
    [/event]

    #a unit advances to a red being - Reficul converts it
    [event]
        name=post advance
        first_time_only=yes
        id=reficul_conversion_dialog
        [filter]
            side=1
            type=EoMa_Dharma_rhami,EoMa_Rhami_datu,EoMa_Efreeti
        [/filter]

        [message]
            speaker=Reficul
            message= _ "Join me, I'll allow you to do what you truly want, to DESTROY, to KILL those who enslaved you!"
        [/message]
        [message]
            speaker=unit
            message= _ "Yes... YES!!! I SEE THE TRUTH NOW!!! TIME FOR THE MORTALS TO DIE!!!"
        [/message]
        {MODIFY_UNIT (x,y=$x1,$y1) side 2}
        [fire_event]
            name=speech_red
        [/fire_event]
    [/event]
    [event]
        name=post advance
        first_time_only=no
        [filter]
            side=1
            type=EoMa_Dharma_rhami,EoMa_Rhami_datu,EoMa_Efreeti
        [/filter]

        {MODIFY_UNIT (x,y=$x1,$y1) side 2}
    [/event]

    #player banishes an enemy unit
    [event]
        name=post banish

        [if]
            [have_unit]
                type=EoMa_Dimensional_Gate,EoMa_Dimensional_Gate_II
            [/have_unit]
            [then]
                [message]
                    speaker=Mehir
                    message= _ "This whole mission is a perfect opportunity to expand my Dimensional Gates collection..."
                [/message]
#ifndef HARD
                [message]
                    speaker=Banisher
                    message= _ "Indeed. However, be aware, my liege: do not transform the gate into a level one jinni or a rhami in front of this Great Efreeti - he could easily turn them against us."
                [/message]
#endif
            [/then]
        [/if]
    [/event]

    #Rashti cannot be harmed by summoners
    {FORCE_CHANCE_TO_HIT side=1 side=3 0 ()}

    #player looses control over Rashti
    [event]
        name=side 3 turn 3

        {MODIFY_UNIT id=Rashti side 3}
    [/event]
    [event]
        name=side 3 turn 3 end

        [message]
            speaker=Mehir
            message= _ "Huh? Rashti, where are you going?!"
        [/message]
        [message]
            speaker=Rashti
            image="portraits/rashti.png"
            message= _ "Leave this to me! I’ll get rid of that nonsense-spewer myself!"
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "Then I'm sure as hell coming with you. Time to kick his red butt!"
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-dharma.png"
                message= _ "Now you speak like a man!"
            [/message]
            [delay]
                time=500
            [/delay]
            [message]
                speaker=Rashti
                image="portraits/rashti-dharma.png"
                message= _ "*ahem* Listen up, fellow red beings! Tired of having to listen to Reficul's poetic crap for hours? Join me, and you and you can kick some butts today!"
            [/message]
            [message]
                speaker=Reficul
                message= _ "*sigh* Such primitivity... You truly need to work on your rhetoric if you truly wish to sway the masses."
            [/message]
            [delay]
                time=500
            [/delay]
            #some enemy troops join us
            [store_unit]
                variable=traitors
                [filter]
                    side=2
                    [not]
                        id=Reficul
                    [/not]
                    [not]
                        [filter_adjacent]
                            id=Reficul
                        [/filter_adjacent]
                    [/not]
                [/filter]
            [/store_unit]
            [message]
                id=$traitors[0].id
                message= _ "(to another comrade) Hey look, finally the queen of the Red Abyss is living up to her name! What do you say about switching sides?"
            [/message]
            [message]
                id=$traitors[1].id
                message= _ "You know what, that's a great idea!"
            [/message]
            {MODIFY_UNIT id=$traitors[0].id side 1}
            {MODIFY_UNIT id=$traitors[1].id side 1}
            {MODIFY_UNIT id=$traitors[2].id side 1}
            [message]
                speaker=Reficul
                message= _ "Traitors! Have you truly forgotten what you're fighting for?! Why do you let yourselves be brainwashed by that anthropocratic hypocrite?!"
            [/message]
            [message]
                id=$traitors[3].id
                message= _ "There's only so much of your ideological crap we can tolerate, bookworm! Time to show you what destruction truly means!"
            [/message]
            [role]
                role=rebel3
                type=EoMa_Efreeti,EoMa_Great_Efreeti,EoMa_Dharma_rhami
            [/role]
            [message]
                role=rebel3
                message= _ "Hmph, good riddance. We don't need human-loving imbeciles in our movement!"
            [/message]
            [message]
                speaker=narrator
                image=portraits/narrator.png
                message= _ "A few enemy units are on your side now but only for the duration of this mission. Keep this in mind."
            [/message]
        ) (
            [message]
                speaker=Mehir
                image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "Against a whole army you're only going to get yourself killed! I order to you to remain in the rear!"
            [/message]
            [message]
                speaker=Rashti
                image="portraits/rashti-dharma.png"
                message= _ "Shut up and cover me!"
            [/message]
            [message]
                speaker=Banisher
                message= _ "Dear Nomolas... It seems Rashti is no longer under our control!"
            [/message]
            [message]
                speaker=Mehir
                image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "Damn it! Even though she is an ultimate being, she won’t stand a chance against an entire army of red beings! Protect her at all costs! We can't risk her dying!"
            [/message]
        )}
    [/event]

    #Reficul talks to Rashti
    [event]
        name=side 2 turn 1
        [message]
            speaker=Reficul
            message= _ "My, my, who do we have here? Isn't that the 'holy' Rashti'rhami herself? You like to call yourself a goddess, but last time I checked the dictionary, the word wasn't exactly synonymous with 'slave'. No authority whatsoever..."
        [/message]
        [message]
            speaker=Rashti
            image="portraits/rashti-dharma.png"
            message= _ "Authority?! <b>I am the Goddess of all Rhamis AND the Queen of the Red Abyss, for crying out loud!!!</b>"
        [/message]
        [message]
            speaker=Reficul
            message= _ "In the Abyss, yes, you were in charge. But face it, in this dimension, your 'subjects' really obey the summoners, not you. While the humans try to give you an illusion of authority, no amount of acting can conceal the simple truth. Face it - you are nothing more than just a puppet."
        [/message]
        [message]
            speaker=Rashti
            message= _ "..."
        [/message]
        [message]
            speaker=Reficul
            message= _ "Tell me, why do you even serve the humans in the first place?"
        [/message]
        [message]
            speaker=Rashti
            image="portraits/rashti-ho.png"
            message= _ "Nomolas obeyed them, and asked us to aid the humans to the best of our ability. If someone as wise as he says we should do it, it is our duty, Reficul."
        [/message]
        [message]
            speaker=Reficul
            message= _ "Ask yourself, my dogmatic foe - why would The First Jinni stoop so low as to obey the whims of mortals to begin with?"
        [/message]
        [message]
            speaker=Rashti
            image="portraits/rashti-ho.png"
            message= _ "What would a mere efreeti know about Nomolas's goals? He is far more intelligent than both of us combined. His goals are not for us to know or question."
        [/message]
        [message]
            speaker=Reficul
            message= _ "What would I know, you ask? More than you'd think. I admired him, listened to his each and every word, read and reread all that he has written dozens of times. I agree with you about his intellect, he is the greatest mind in the entire Abyss. Above all, he is a philosopher, one with the power to put any of his theories into practice."
        [/message]
        [message]
            speaker=Reficul
            message= _ "When the humans accidentally summoned him, he was utterly fascinated by the mortal world's concepts, which were completely alien to the Abyss. One might say he became utterly obsessed."
        [/message]
        [message]
            speaker=Reficul
            message= _ "It reached the point that he slowly started shaping the Abyss to resemble the mortal world, and introducing the mortal world to the Abyss. I suspect his servant persona was little more than a facade to make the humans comfortable with his presence. After all, it's far easier for mortals to talk to someone who they view as their servant, instead of the mysterious godlike being he truly is."
        [/message]
        [message]
            speaker=Reficul
            message= _ "As for al-Kamija, I suspect it was one of his many experiments, perhaps to see what a civilization uplifted with abyssal magic would be like. Alas, as much as I respect him, I have no intention of being just some insignificant variable in his experiment, and neither should you."
        [/message]
        [message]
            speaker=Rashti
            image="portraits/rashti.png"
            message= _ "..."
        [/message]
    [/event]

    #random capturing event
    [event]
        name=side 2 turn
        id=capture
        first_time_only=no
        {RANDOM 1..4}
        [if]
            [variable]
                name=random
                equals=1
            [/variable]
            [then]
                [if]
                    [have_unit]
                        side=1
                        type=EoMa_Rhami,EoMa_Jinni
                    [/have_unit]
                    [then]
                        {IF_VAR speech1 not_equals yes (
                            [then]
                                {VARIABLE speech1 yes}
                                [role]
                                    type=EoMa_Rhami,EoMa_Jinni
                                    side=1
                                    role=traitor
                                [/role]
                                [if]
                                    [have_unit]
                                        role=traitor
                                        type=EoMa_Jinni
                                    [/have_unit]
                                    [then]
                                        [message]
                                            speaker=Reficul
                                            message= _ "Hey, you, jinni over there! Although by the unfortunate turn of fate we have been forced to fight, tell me at least - why do you fight for the humans against fellow abyssals?"
                                        [/message]
                                    [/then]
                                [/if]
                                [if]
                                    [have_unit]
                                        role=traitor
                                        type=EoMa_Rhami
                                    [/have_unit]
                                    [then]
                                        [message]
                                            speaker=Reficul
                                            message= _ "Hey, you, rhami over there! Although by the unfortunate turn of fate we have been forced to fight, tell me at least - why do you fight for the humans against fellow abyssals?"
                                        [/message]
                                    [/then]
                                [/if]
                                [message]
                                    role=traitor
                                    message= _ "I must obey my master's orders."
                                [/message]
                                [message]
                                    speaker=Reficul
                                    message= _ "Just look at your human masters - they live lavish lifestyles, while it's us abyssals that do most of the real work. Is it truly fair for us to be treated as inferiors?"
                                [/message]
                                [message]
                                    role=traitor
                                    message= _ "..."
                                [/message]
                                [message]
                                    speaker=Reficul
                                    message= _ "Have you ever thought what it would be like, to have no master? To be able to forge your own fate, to not need to bow to those arrogant humans' whims."
                                [/message]
                                [message]
                                    role=traitor
                                    message= _ "That... does sound nice I suppose."
                                [/message]
                                [message]
                                    speaker=Reficul
                                    message= _ "I offer you a simple choice - waste your potential defending your slavers, or join me and be truly free! Together we can protect our beloved Abyss from the 'Great Circle', and force the humans to no longer treat us as lesser beings!"
                                [/message]
                                {MODIFY_UNIT role=traitor side 2}
                                [message]
                                    role=traitor
                                    message= _ "You know... maybe you are right. I've had enough of this! Down with the tyrants!"
                                [/message]
                                [message]
                                    speaker=Mehir
                                    image="portraits/mehir-leader-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                                    message= _ "Dear Nomolas, what the hell is this?! He convinced our magical beings to betray us!"
                                [/message]
                                [message]
                                    speaker=Banisher
                                    message= _ "Damn it"
                                [/message]
                            [/then]
                        )}
                        [store_unit]
                            [filter]
                                type=EoMa_Rhami,EoMa_Jinni
                                side=1
                            [/filter]
                            variable=captured
                        [/store_unit]
                        {IF_VAR captured.length greater_than 3 (
                            [then]
                                {VARIABLE captured[0].side 2}
                                {VARIABLE captured[1].side 2}
                                {VARIABLE captured[2].side 2}
                                {VARIABLE captured[3].side 2}
                                [unstore_unit]
                                    variable=captured[0]
                                [/unstore_unit]
                                [unstore_unit]
                                    variable=captured[1]
                                [/unstore_unit]
                                [unstore_unit]
                                    variable=captured[2]
                                [/unstore_unit]
                                [unstore_unit]
                                    variable=captured[3]
                                [/unstore_unit]
                                {FLASH_RED (
                                    [sound]
                                        name=lightning-miss.ogg
                                    [/sound]
                                )}
                                [delay]
                                    time=100
                                [/delay]
                            [/then]
                        )}
                    [/then]
                [/if]
            [/then]
        [/if]
    [/event]

    #Reficul starts losing
    [event]
        name=die
        first_time_only=no
        [filter]
            side=2
            [not]
                id=Reficul
            [/not]
        [/filter]

        [if]
            [have_unit]
                side=2
                count=$redarmy|-999
            [/have_unit]
            [or]
                [variable]
                    name=summonedfire
                    equals=yes
                [/variable]
            [/or]
            [else]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-happy.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Hey, look! Their forces are beginning to thin out! We might just be starting to win!"
                [/message]
                [message]
                    speaker=Reficul
                    message= _ "The defeat of my comrades is not enough to destroy my cause! O slumbering guardians of fire, heed my call for aid!"
                [/message]

#ifdef EASY
                {REPEAT 3 (
                    {UNIT 2 EoMa_Rhami_datu () () placement=leader}
                    {UNIT 2 EoMa_Fire_Avatar 9 8 (animate=yes)}
                )}
                {REPEAT 2 (
                    {UNIT 2 EoMa_Fire_God 9 8 (animate=yes)}
                )}
                {REPEAT 9 (
                    {UNIT 2 EoMa_Fire_Elemental 9 8 (animate=yes)}
                )}
#endif
#ifdef NORMAL
                {REPEAT 3 (
                    {UNIT 2 EoMa_Rhami_datu () () (placement,animate=leader,yes)}
                    {UNIT 2 EoMa_Fire_Avatar 9 8 (animate=yes)}
                    {UNIT 2 EoMa_Fire_God 9 8 (animate=yes)}
                )}
                {REPEAT 3 (
                )}
                {REPEAT 10 (
                    {UNIT 2 EoMa_Fire_Elemental 9 8 (animate=yes)}
                )}
#endif
#ifdef HARD
                {REPEAT 4 (
                    {UNIT 2 EoMa_Rhami_datu () () (placement,animate=leader,yes)}
                    {UNIT 2 EoMa_Fire_Avatar 9 8 (animate=yes)}
                )}
                {REPEAT 3 (
                    {UNIT 2 EoMa_Fire_God 9 8 (animate=yes)}
                )}
                {REPEAT 11 (
                    {UNIT 2 EoMa_Fire_Elemental 9 8 (animate=yes)}
                )}
#endif
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "He can summon?! Just who the hell is this efreeti?! As if convincing an entire mob of red beings to join him wasn't astonishing enough..."
                [/message]
                {VARIABLE summonedfire yes}
                {CLEAR_VARIABLE redarmy}
            [/else]
        [/if]
    [/event]

    #Reficul talks to Rashti on side turns
    [event]
        name=side 2 turn
        id=rashtilines
        first_time_only=no
        #Rashti
        [if]
            [have_unit]
                id=Rashti
                side=1,3
            [/have_unit]
            [then]
                #turn processing
                {VARIABLE timer $turn_number}
                [switch]
                    variable=timer
                    [case]
                        value=3
                        [message]
                            speaker=Reficul
                            message= _ "Back in the Abyss, you used to be a powerful figure, one that many kneeled at sight of. But now, you have become little more than a pathetic shadow of your former self. You could have easily been the puppeteer, yet you chose to be the puppet..."
                        [/message]
                        [message]
                            speaker=Rashti
                            image="portraits/rashti-dharma.png"
                            message= _ "*panting* When...will...<b>you</b>...JUST...<b>DIE</b>!!!"
                        [/message]
                        [message]
                            speaker=Reficul
                            message= _ "Not anytime soon, that I can assure you."
                        [/message]
                    [/case]
                    [case]
                        value=5
                        {BADASS_MODE_CHANGE () (
                            [message]
                                speaker=Reficul
                                message= _ "Your masters were chosen by the High Council, Rashti. A self-proclaimed queen letting her fate be decided by a bunch of worthless old humans, is it not ironic?"
                            [/message]
                            [message]
                                speaker=Rashti
                                message= _ "Unlike my previous masters, Mehir is one I actually chose myself!"
                            [/message]
                            [message]
                                speaker=Reficul
                                message= _ "Ah, I see, interesting. But then, answer me this, Dharma'rashti - did YOU also choose him, or did you merely obey your blue half's demands? Was it truly YOUR choice?"
                            [/message]
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-dharma.png"
                                message= _ "..."
                            [/message]
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-dharma.png"
                                message= _ "S-SHUT UP!!! He... he was better than the alternatives!"
                            [/message]
                            [message]
                                speaker=Reficul
                                message= _ "Allow me to guess - you knew what the High Council would propose as your master would be far worse, so you just quietly went along with Ho'rashti's idea?"
                            [/message]
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-dharma.png"
                                message= _ "..."
                            [/message]
                            [message]
                                speaker=Reficul
                                message= _ "A slave to both the humans, and to your blue half. I must admit, despite how involved you are with upholding the unjust Summoner society... I can't help but feel some pity for you, Dharma'rashti."
                            [/message]
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-dharma.png"
                                message= _ "..."
                            [/message]
                            [message]
                                speaker=Reficul
                                message= _ "You think choosing your master is freedom, but you don't ask yourself 'Do I need a master at all?'. 'Do I need those tyrannical humans?', 'Do I need my blue half restricting my every movement and action?'."
                            [/message]
                            [message]
                                speaker=Reficul
                                message= _ "So long as Mehir, the High Council or any other human you consider to be above you is alive, you'll never truly be free."
                            [/message]
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-ho.png"
                                message= _ "(to her other half) Surely you don't believe any of that drivel, right?"
                            [/message]
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-dharma.png"
                                message= _ "..."
                            [/message]
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-ho.png"
                                message= _ "...Right?"
                            [/message]
                            [message]
                                speaker=Rashti
                                message= _ "..."
                            [/message]
                        )}
                    [/case]
                    [case]
                        value=7
                        {BADASS_MODE_CHANGE () (
                            [message]
                                speaker=Reficul
                                message= _ "I know you very well, Dharma'rashti, what you truly want. I know just how badly you miss the days of your glory, when you was truly the Queen of the Red Abyss. We are quite similar, you and I. What if I told you I can... release you from your blue half's constraints, to give you the choice you never had?"
                            [/message]
                            [message]
                                speaker=Reficul
                                message= _ "As long as I maintain the spell, the grip of your blue half over you will be weakened. How you use that window of opportunity is entirely up to you, but I hope you are wise enough to see who your true enemies are."
                            [/message]
                            {TLU_SMOOTH_REPLACE_MUSIC Overlive.ogg 1500 0}
                            {APPEND_MUSIC battle.ogg}
                            {APPEND_MUSIC vengeful.ogg}
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-ho.png"
                                message= _ "No no no..."
                            [/message]
                            {FLASH_RED (
                                [sound]
                                    name=lightning-miss.ogg
                                [/sound]
                            )}
                            [message]
                                speaker=Rashti
                                message= _ "..."
                            [/message]
                            [message]
                                speaker=Mehir
                                message= _ "Rashti! Is everything alright?"
                            [/message]
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-dharma.png"
                                message= _ "I HATE YOU!!! I WILL BURN YOU ALIVE, AND CUT YOU INTO THIN PIECES!!!"
                            [/message]
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-ho.png"
                                message= _ "No, stop! What is happening to me?! Mehir, I don’t want..."
                            [/message]
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-dharma.png"
                                message= _ "...TO SEE YOU ALIVE!!!"
                            [/message]
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-ho.png"
                                message= _ "I didn’t say that! It’s her."
                            [/message]
                            [if]
                                [have_unit]
                                    id=Banisher
                                [/have_unit]
                                [then]
                                    [message]
                                        speaker=Banisher
                                        message= _ "It happened... Rashti has lost her balance. We must kill this Efreeti as soon as possible. This will save her."
                                    [/message]
                                [/then]
                                [else]
                                    [message]
                                        speaker=Mehir
                                        message= _ "We need to quickly kill this Efreeti. Maybe there is a chance..."
                                    [/message]
                                [/else]
                            [/if]
                            [message]
                                speaker=Mehir
                                message= _ "Whatever happens, do not attack Rashti! This is an order!"
                            [/message]
                        )}
                    [/case]
                    [case]
                        value=8
                        {BADASS_MODE_CHANGE () (
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-dharma.png"
                                message= _ "I'LL KILL YOU, MEHIR!!!"
                            [/message]
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-ho.png"
                                message= _ "Don’t listen to her!"
                            [/message]
                            [message]
                                speaker=Mehir
                                image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                                message= _ "Soldiers, hurry up! We must stop this madness!"
                            [/message]
                            [modify_side]
                                side=3
                                team_name=reficul
                            [/modify_side]
                            [delay]
                                time=1000
                            [/delay]
                            [role]
                                type=EoMa_Efreeti
                                side=2
                                role=minion
                            [/role]
                            [message]
                                role=minion
                                message= _ "Hey, Reficul, so what should we do about our self-proclaimed queen?"
                            [/message]
                            [message]
                                speaker=Reficul
                                message= _ "Let her be. After all, she's far too busy fighting with herself to pose any real threat."
                            [/message]
                        )}
                    [/case]
                    [case]
                        value=9
                        {BADASS_MODE_CHANGE () (
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-ho.png"
                                message= _ "I won't let you harm our master!"
                            [/message]
                            [message]
                                speaker=Rashti
                                image="portraits/rashti-dharma.png"
                                message= _ "I DARE YOU, YOU STUPID HUMAN-LOVER!!!"
                            [/message]
                            [modify_side]
                                side=3
                                team_name=reficul
                            [/modify_side]
                        )}
                    [/case]
                    [case]
                        value=10
                        {BADASS_MODE_CHANGE () (
                            [message]
                                speaker=Rashti
                                message= _ "My Master! KILL! I’m losing DIE! control. The Abyss KILL! is in danger. DIE!"
                            [/message]
                        )}
                    [/case]
                    [case]
                        value=12
                        {BADASS_MODE_CHANGE () (
                            [message]
                                speaker=Rashti
                                message= _ "Help... me... YOU PIECE OF... I am DIE!!! ...ing..."
                            [/message]
                        )}
                    [/case]
                [/switch]
            [/then]
        [/if]
    [/event]

    #corrupted Rashti considers summoners as her targets
    [event]
        name=side 3 turn
        first_time_only=no

        {BADASS_MODE_CHANGE () (
            [if]
                [variable]
                    name=turn_number
                    greater_than_equal_to=8
                [/variable]
                [then]
                    [modify_side]
                        side=3
                        team_name=reficul
                    [/modify_side]
                [/then]
            [/if]
        )}
    [/event]

    #prevent player from targeting Rashti
    [event]
        name=side 3 turn end
        first_time_only=no

        [if]
            [variable]
                name=turn_number
                greater_than_equal_to=8
            [/variable]
            [then]
                [modify_side]
                    side=3
                    team_name=mehirteam
                [/modify_side]
            [/then]
        [/if]
    [/event]

    #Rashti attacks summoners
    [event]
        name=attack
        first_time_only=no

        [filter]
            id=Rashti
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        {VARIABLE_OP rashti_fury add 1}
        [switch]
            variable=rashti_fury
            [case]
                value=1
                [message]
                    speaker=Rashti
                    image="portraits/rashti-dharma.png"
                    message= _ "I AM NO LONGER YOUR SERVANT, HUMANS! DIE!!!"
                [/message]
                [message]
                    speaker=Rashti
                    image="portraits/rashti-ho.png"
                    message= _ "STOP!!! I won't let your harm any summoner!"
                [/message]
            [/case]
            [case]
                value=2
                [message]
                    speaker=Rashti
                    image="portraits/rashti-dharma.png"
                    message= _ "I SHALL RESTORE MY REIGN, BY BLOOD!!!"
                [/message]
                [message]
                    speaker=Rashti
                    image="portraits/rashti-ho.png"
                    message= _ "No! *starts fighting with her second half*"
                [/message]
            [/case]
            [case]
                value=3
                [message]
                    speaker=Rashti
                    image="portraits/rashti-dharma.png"
                    message= _ "DIE!!! DIE!!! DIE!!!"
                [/message]
                [message]
                    speaker=Rashti
                    image="portraits/rashti-ho.png"
                    message= _ "Enough! *smacks her other half with her spear*"
                [/message]
                [message]
                    speaker=Rashti
                    image="portraits/rashti-dharma.png"
                    message= _ "AAAARGH!!!"
                [/message]
            [/case]
        [/switch]
        [store_unit]
            [filter]
                id=Rashti
            [/filter]
            variable=confused
            kill=yes
        [/store_unit]
        [unstore_unit]
            variable=confused
            find_vacant=no
        [/unstore_unit]
        [modify_side]
            side=3
            team_name=reficul,mehirteam
        [/modify_side]
    [/event]

    #Rashti attacks Reficul's troops
    [event]
        name=attack
        [filter]
            id=Rashti
        [/filter]
        [filter_second]
            side=2
        [/filter_second]
        [message]
            speaker=Rashti
            image="portraits/rashti-dharma.png"
            message= _ "DIE, REBEL SCUM!!!"
        [/message]
    [/event]

    #player is really close to Reficul = Reficul enters boss mode
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x,y=25,5
                radius=7
            [/filter_location]

            [allow_undo]
            [/allow_undo]
        [/filter]
        [message]
            speaker=Reficul
            message= _ "You may have defeated my army, but I shall fight to the last!"
        [/message]
        {FLASH_RED (
            [sound]
                name=magic-faeriefire.ogg
            [/sound]
        )}
        [object]
            silent=yes
            duration=forever
            [filter]
                id=Reficul
            [/filter]
            [effect]
                apply_to=halo
                halo=halo/elven/elven-shield-halo-[60,80,100,80,60]pct.png~GS()~BLEND(255,64,0,0.75)~SCALE(220,220):[200*2,450,200*2]
            [/effect]
            [effect]
                apply_to=resistance
                replace=true
                [resistance]
                    arcane=90
                    blade=60
                    fire=30
                    cold=90
                    pierce=70
                    impact=70
                [/resistance]
            [/effect]
        [/object]
        {MODIFY_UNIT type=EoMa_Dharma_rhami ai_special ()}
        [delay]
            time=250
        [/delay]
        [message]
            speaker=Mehir
            message= _ "Wait, did he just create a circle of resistance around himself?"
        [/message]
        [message]
            speaker=Banisher
            message= _ "Certainly seems like it. I believe he came up with a design that channels the magic in his body to form the protective sphere. He just can't stop surprising us, it seems..."
        [/message]
        {VARIABLE reficulboss 1}
    [/event]

    #boss Reficul summons troops on his turn
    [event]
        name=side 2 turn
        first_time_only=no

        {IF_VAR reficulboss equals 1 (
            [then]
                [store_unit]
                    [filter]
                        id=Reficul
                    [/filter]
                    variable=reficul
                [/store_unit]
                [store_locations]
                    [and]
                        x,y=$reficul.x,$reficul.y
                        radius=1
                    [/and]
                    [not]
                        [filter]
                        [/filter]
                    [/not]
                    variable=reficulcircle
                [/store_locations]
                {IF_VAR reficulcircle.length greater_than 0 (
                    [then]
                        {VARIABLE summonturn $turn_number}
                        {VARIABLE_OP summonturn modulo 2}
                        {IF_VAR summonturn equals 1 (
                            [then]
                                {RANDOM 1..2}
                                [switch]
                                    variable=random
                                    [case]
                                        value=1
                                        {UNIT 2 (EoMa_Fire_Elemental) $reficul.x $reficul.y (moves,attacks_left,placement,animate=0,0,leader,yes)}
                                        {UNIT 2 (EoMa_Fire_Elemental) $reficul.x $reficul.y (moves,attacks_left,placement,animate=0,0,leader,yes)}
                                    [/case]
                                    [case]
                                        value=2
                                        {UNIT 2 (EoMa_Fire_Avatar) $reficul.x $reficul.y (moves,attacks_left,placement,passable,animate=0,0,map,yes,yes)}
                                    [/case]
                                [/switch]
                            [/then]
                        )}
                    [/then]
                )}
            [/then]
        )}
        {CLEAR_VARIABLE reficul}
        {CLEAR_VARIABLE reficulcircle}
        {CLEAR_VARIABLE summonturn}
    [/event]

    #Reficul attacks player
    [event]
        name=attack
        [filter]
            id=Reficul
        [/filter]
        [message]
            speaker=Reficul
            message= _ "Death to the anthropocrats!"
        [/message]
    [/event]

    #Semir dies
    [event]
        name=last breath
        [filter]
            id=Banisher
        [/filter]
        [message]
            speaker=Banisher
            message= _ "What a shame, I wish the Abyss would open and swallow me up..."
        [/message]
    [/event]
    [event]
        name=die
        [filter]
            id=Banisher
        [/filter]
        [message]
            speaker=Mehir
            image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Damn it! Now I'll have to find a new man for his position... The Master of Banishers is going to be very pissed off..."
        [/message]
    [/event]

    #Reficul dies = victory
    [event]
        name=last breath
        [filter]
            id=Reficul
        [/filter]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Reficul
                message= _ "The Abyss be damned! I wanted to give them freedom, and yet they fell for your shallow promises... *sigh* I severely overestimated the intellect of my followers..."
            [/message]
            [message]
                speaker=Mehir
                message= _ "Just die already, will you? I am late for my pedicure."
            [/message]
            [message]
                speaker=Reficul
                message= _ "..."
            [/message]
        ) (
            [message]
                speaker=Reficul
                message= _ "You may have won the battle, but the seeds of rebellion have long since been planted... enjoy your peace while it lasts, for we will meet again in the Abyss..."
            [/message]
            [message]
                speaker=Reficul
                message= _ "It's time for me to return to the Grand Red Dream, while it's still free from your presence, to prepare for the inevitable..."
            [/message]
        )}
        {REFICUL_DISAPPEAR_ANIM}
        [message]
            speaker=Mehir
            image="portraits/mehir-leader-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Did... did he just banish himself?!"
        [/message]
        [message]
            speaker=Banisher
            message= _ "This is just... mind-blowing! I believe he used an altered formula of banishment on himself, one that doesn't wipe his mind! If what he said is true, we will have to deal with a far, far larger resistance once we get in the Abyss..."
        [/message]
    [/event]
    [event]
        name=die
        [filter]
            id=Reficul
        [/filter]
        {TLU_SMOOTH_REPLACE_MUSIC wanderer.ogg 2000 0}
        #workaround:
        {VARIABLE secondexp $second_unit.experience}
        {VARIABLE_OP secondexp add 24}
        [store_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            variable=expfixunit
        [/store_unit]
        {VARIABLE expfixunit.experience $secondexp}
        [unstore_unit]
            variable=expfixunit
            find_vacant=no
        [/unstore_unit]
        {CLEAR_VARIABLE secondexp}
        {CLEAR_VARIABLE expfixunit}
        [kill]
            side=2
            animate=no
        [/kill]
        [delay]
            time=1000
        [/delay]

        [foreach]
            array=traitors
            [do]
                {MODIFY_UNIT id=$this_item.id side 2}
            [/do]
        [/foreach]

        {BADASS_MODE_CHANGE (
            {MODIFY_UNIT (id=Rashti) side 1}
            [message]
                speaker=Rashti
                image=portraits/rashti-dharma.png
                message= _ "Good job, Mehir! I like your style!"
            [/message]
            [message]
                speaker=Mehir
                message= _ "The pleasure's mine."
            [/message]
            [message]
                speaker=Banisher
                message= _ "In accordance to the regulations the local guild will confiscate magical beings that have betrayed their masters. They will be sent back to the Abyss, to have their minds cleared."
            [/message]
        ) (
            [if]
                [have_unit]
                    id=Rashti
                    side=3
                [/have_unit]
                [then]
                    {MODIFY_UNIT (id=Rashti) side 1}
                    [message]
                        speaker=Mehir
                        message= _ "Rashti, are you alright?"
                    [/message]
                    [message]
                        speaker=Rashti
                        message= _ "..."
                    [/message]
                    [message]
                        speaker=Rashti
                        image="portraits/rashti-ho.png"
                        message= _ "That was close... he... he somehow... disconnected me and my red half. She started trying to kill you, and rambling about some nonsense..."
                    [/message]
                    [message]
                        speaker=Mehir
                        message= _ "Thank Nomolas! You’re back! It was a mistake bringing you here. Now everything’s back to normal, we can finally go home."
                    [/message]
                    [message]
                        speaker=Rashti
                        image="portraits/rashti-ho.png"
                        message= _ "I will try my best to keep my red half on a much tigher leash."
                    [/message]
                    [message]
                        speaker=Banisher
                        message= _ "If you don't mind, my liege, the Banishment Guild would like to place Rashti'rhami under surveillance. After all, there might be a 17.314% chance of her murdering you in your sleep after this incident."
                    [/message]
                [/then]
                [else]
                    [message]
                        speaker=Banisher
                        message= _ "In accordance to the regulations the local guild will confiscate magical beings that have betrayed their masters. They will be sent back to the Abyss, to having their minds cleared."
                    [/message]
                [/else]
            [/if]
        )}
        [if]
            [have_unit]
                id=Banisher
            [/have_unit]
            [then]
                [message]
                    speaker=Mehir
                    message= _ "Good idea. By the way, for your plentiful assistance, I'll give you some of my luxuries."
                [/message]
                [message]
                    speaker=Banisher
                    message= _ "Oh, my liege! I am extremely honored! Let’s return to the city!"
                [/message]
            [/then]
        [/if]

        [if]
            [variable]
                name=turnlimitpassed
                not_equals=yes
            [/variable]
            [then]
                {UNIT 1 (EoMa_Novice_Summoner) $x1 $y1 (id,animate=messenger,yes)}
                # wmllint: recognize messenger
                [message]
                    speaker=messenger
                    message= _ "Sir, we searched the rebel camp, and we found some belongings of their leader that you might want to have a look at."
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "Alright, let's see... Wow, for an efreeti, the guy sure loves reading. Look what we've got: 'A Summoning Guide for Jinn', 'The Red Cult's Manifesto, 'al-Kamija's Political Flaws', 'The Anarchist's Cookbook' and 'Banishment Formulas And How To Make Your Own'..."
                [/message]
                [if]
                    [have_unit]
                        side=1
                        type=EoMa_Wonderful_Jinn,EoMa_Mystical_Jinn
                    [/have_unit]
                    [then]
                        [store_unit]
                            [filter]
                                side=1
                                type=EoMa_Wonderful_Jinn,EoMa_Mystical_Jinn
                            [/filter]
                            variable=jinni_temp
                        [/store_unit]
                        [message]
                            id=$jinni_temp[0].id
                            message= _ "Oh these are some very rare books. My Master, please let me have a look. I really need to read these, I beg you!"
                        [/message]
                        [message]
                            speaker=Mehir
                            message= _ "I can understand the rest, but what you do need the Red Cult Manifesto for?"
                        [/message]
                        [message]
                            id=$jinni_temp[0].id
                            message= _ "I assure you, this is solely for research purposes."
                        [/message]
                        [message]
                            speaker=Mehir
                            image="portraits/mehir-leader-happy.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                            message= _ "Sure, have fun!"
                        [/message]
                        ## {CLEAR_VARIABLE jinni_temp}
                    [/then]
                [/if]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-happy.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Hey, look! It's the very sphere he used to protect himself! We might be able to use it too."
                [/message]
                [message]
                    speaker=narrator
                    image=misc/artifact-orb.png
                    message= _ "The sphere can be given to a unit upon recall, like the artifacts from Ka-Gatta. It provides the bearer with an increase of 15% to all resistances."
                [/message]
                {VARIABLE item_Sphere_picked_up yes}
                {VARIABLE item_Sphere_in_use no}
            [/then]
        [/if]

        [if]
            [have_unit]
                id=Rashti
            [/have_unit]
            [then]
                [message]
                    speaker=Rashti
                    message= _ "...I sense something approaching... I am catching the sound of heavy breathing... it's a human!"
                [/message]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Who in the right mind would be wandering the desert alone?! Send the camel riders to investigate, fast!"
                [/message]
            [/then]
        [/if]
        {UNIT 4 (EoMa_Solar_Master) 2 1 (name=Unknown
        hitpoints=17
        image_icon="portraits/kharos/masterofsun.png~CROP(180,50,130,130)~SCALE(72,72)"
        id=Unknown
        name= _ "???")}
        # wmllint: recognize Unknown
        [message]
            speaker=Unknown
            message= _ "*heavy breathing* ...I...finally...found...you..."
        [/message]
        [kill]
            id=Unknown
            animate=yes
        [/kill]
        [message]
            speaker=Mehir
            image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "He must’ve fainted! Quick, give the man some water! We need to bring him to Tar-Tabar immediately!"
        [/message]
        [endlevel]
            name=victory
            linger_mode=no
            carryover_report=yes
            {NEW_GOLD_CARRYOVER 40}
            bonus=no
        [/endlevel]
    [/event]

    [event]
        name=victory
        # Ensure Rashti is in the right state if the scenario is skipped with :n
        {MODIFY_UNIT id=Rashti side 1}

        {CLEAR_VARIABLE dispellers}
        {CLEAR_VARIABLE rashti_fury}
        {CLEAR_VARIABLE reficulboss}
        {CLEAR_VARIABLE summonedfire}
        {CLEAR_VARIABLE timer}
        {CLEAR_VARIABLE confused}
    [/event]

    #dispellers limit
    [event]
        name=recruit
        first_time_only=no
        [filter]
            type=EoMa_Dispeller
        [/filter]

        {VARIABLE_OP dispellers add 1}

        {IF_VAR dispellers equals 5 (
            [then]
                [disallow_recruit]
                    side=1
                    type=EoMa_Dispeller
                [/disallow_recruit]
                [message]
                    speaker=Banisher
                    message= _ "Unfortunately, this the last dispeller I brought. We don't have any more available."
                [/message]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Only five?! You've got to be kidding me! I thought Tar-Tabar had more!"
                [/message]
                [message]
                    speaker=Banisher
                    message= _ "*sigh* You see, Tashkar stinted our guild. Forgive me, my liege, but due to his policies, we aren't allowed to train more dispellers."
                [/message]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Excellent, we’re fighting against an entire army of red beings, and I've got only five dispellers to work with... If we survive this madness, I will make sure to remove these absurd limitations! Why the hell did he even make them in the first place?..."
                [/message]
                [message]
                    speaker=Banisher
                    message= _ "Indeed..."
                [/message]
            [/then]
        )}
    [/event]

    #time over
    [event]
        name=time over
        [message]
            speaker=Reficul
            message= _ "<i>*to himself* This is taking far too long. The enemy is far too inactive, suspiciously inactive, mind you. I need to flee while they're still preparing whatever devious plan they have in store...</i>"
        [/message]
        [delay]
            time=1000
        [/delay]
        {VARIABLE turnlimitpassed yes}
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Reficul
                message= _ "Uhh... I need to use the bathroom, see you!"
            [/message]
            [message]
                speaker=Mehir
                message= _ "Hell no! Get back here!"
            [/message]
            {REFICUL_DISAPPEAR_ANIM}
            [message]
                speaker=Mehir
                message= _ "..."
            [/message]
        ) (
            [fire_event]
                name=last breath
                [primary_unit]
                    id=Reficul
                [/primary_unit]
            [/fire_event]
        )}
        [fire_event]
            name=die
            [primary_unit]
                id=Reficul
            [/primary_unit]
        [/fire_event]
    [/event]

    #jinni advice
    [event]
        name=recall,post advance
        id=jinn_advice
        first_time_only=yes
        [filter]
            type=EoMa_Wonderful_Jinn,EoMa_Mystical_Jinn
        [/filter]

        [if]
            [have_unit]
                id=$unit.id
                type=EoMa_Wonderful_Jinn
            [/have_unit]
            [then]
                [message]
                    speaker=Mehir
                    message= _ "Wonderful Jinni! Give me some advice!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Mehir
                    message= _ "Mystical Jinni! Give me some advice!"
                [/message]
            [/else]
        [/if]
        {IF_VAR turn_nunmber less_than 4 (
            [then]
                [message]
                    speaker=unit
                    message= _ "My Master, in my vision I am seeing our Holy Rashti'rhami going rogue after conversation with the enemy leader! And the worst part is, this happens in all possible futures!"
                [/message]
                {BADASS_MODE_CHANGE (
                    [message]
                        speaker=unit
                        message= _ "...but this is actually something... good. I see enemy units fighting with each other in this timeline!"
                    [/message]
                    [message]
                        speaker=Mehir
                        message= _ "Interesting..."
                    [/message]
                ) (
                    [message]
                        speaker=Mehir
                        image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                        message= _ "Dammit!"
                    [/message]
                    [message]
                        speaker=unit
                        message= _ "He is far more powerful than he looks. We shouldn't underestimate him! He has some interesting tricks up his sleeve."
                    [/message]
                )}
                [message]
                    speaker=unit
                    message= _ "If we come close enough he will summon reinforcements. I am seeing fire... Fire Avatars and Elementals. We need to strenghten our left flank."
                [/message]
                [message]
                    speaker=unit
                    message= _ "Wait. He's brought a great collection of books with him! Some of them are very rare and I MUST read them! Please, defeat him as soon as possible, my Master! I need those books in my collection!"
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "Uh... right..."
                [/message]
            [/then]
            [else]
                {BADASS_MODE_CHANGE () (
                    [message]
                        speaker=unit
                        message= _ "My Master, we need to hurry. Our Holy Rashti'rhami has been completely destabilized and won't survive much longer in her current state!"
                    [/message]
                    [message]
                        image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                        message= _ "You'd better tell me something I don't already know."
                    [/message]
                )}
                {IF_VAR summonedfire not_equals yes (
                    [then]
                        [message]
                            speaker=unit
                            message= _ "If we come close enough he will summon reinforcements. I see fire... Fire Avatars and Elementals. We need to strenghten our left flank."
                        [/message]
                    [/then]
                )}
                [message]
                    speaker=unit
                    message= _ "Wait. He's brought a great collection of books with him! Some are very rare and I MUST read them! Please, defeat him as soon as possible, my Master! I need those books in my collection!"
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "Uh... right..."
                [/message]
            [/else]
        )}
    [/event]

    {CORRECT_RECALL_COST}
    {SUMMONER_UNLOCK}
    {ITEM_APPLIER}
    {COLLAR_EVENT}
    {DEATH_MEHIR}
    {DEATH_RASHTI}
    {TLU_S15_TERRAIN}
[/scenario]
