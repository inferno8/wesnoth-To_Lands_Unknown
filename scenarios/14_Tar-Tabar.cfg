#textdomain wesnoth-To_Lands_Unknown
[scenario]
    id=14_Tar-Tabar
    next_scenario=15_Abyssal_Rebellion

    name= _ "Tar-Tabar"
    map_data="{~add-ons/To_Lands_Unknown/maps/14_Tar-Tabar.map}"
    turns=-1
    victory_when_enemies_defeated=no

    {MORNING_TLU}

    {SCENARIO_MUSIC traveling_minstrels.ogg}

    {STORYTXT_TAR_TABAR}

    [side]
        side=1
        controller=human
        team_name=mehirteam
        user_team_name= _ "team_name^Mehir"

        type=EoMa_Grand_Summoner
        id=Mehir
        name= _ "Mehir"
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Novice_Summoner,EoMa_Camel_Rider,EoMa_Carpet_Rider,EoMa_Water_Elemental

        gold=15
        income=-2
    [/side]

    [side]
        side=2
        controller=ai
        team_name=mehirteam
        user_team_name= _ "team_name^Instructor"
        color=blue

        id=Instructor
        name= _ "Semir"
        image_icon=portraits/summoners/banisher.png~CROP(131,10,130,130)~SCALE(72,72)
        type=EoMa_Banisher
        unrenamable=yes
        canrecruit=yes
        facing=se

        recruit=

        gold=0
        income=-2

        [ai]
        [/ai]
    [/side]

    [side]
        side=3
        controller=ai
        team_name=enemy
        user_team_name= _ "team_name^Enemy"
        no_leader=yes
        color=black
        hidden=yes

        gold=0
        income=-2
    [/side]

    {FORCE_CHANCE_TO_HIT side_number=1 side=3 100 ()}

    #prestart
    [event]
        name=prestart

        [recall]
            id=Rashti
            x,y=12,5
        [/recall]
        [store_unit]
            [filter]
                id=Rashti
            [/filter]
            variable=rashtivar
        [/store_unit]
        {MODIFY_UNIT id=Rashti facing se}
        {MODIFY_UNIT id=Rashti moves 0}
        {MODIFY_UNIT id=Rashti max_moves 0}
        {MODIFY_UNIT id=Rashti attacks_left 0}
        {MODIFY_UNIT id=Rashti profile "portraits/rashti-noncombat.png"}
        {MODIFY_UNIT id=Mehir facing sw}
        {MODIFY_UNIT id=Rashti side 2}

        [if]
            [variable]
                name=item_Staff_picked_up
                not_equals=yes
            [/variable]
            [then]
                [object]
                    name= _ "Banishment Staff"
                    duration=forever
                    silent=yes
                    [filter]
                        id=Instructor
                    [/filter]
                    [effect]
                        apply_to=attack
                        name=banishment
                        [set_specials]
                            mode=append
                            {WEAPON_SPECIAL_EOMA_ALWAYSHITS}
                        [/set_specials]
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=staff
                        set_icon=attacks/staff-magic.png
                        increase_damage=2
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=frozen gate
                        increase_damage=2
                    [/effect]
                    [effect]
                        apply_to=overlay
                        add="misc/blank-hex.png~BLIT(misc/artifact-icon-staff.png,$unit.variables.artifact_count,0)"
                    [/effect]
                [/object]
                [store_unit]
                    [filter]
                        id=Instructor
                    [/filter]
                    variable=unit
                [/store_unit]
                [set_variables]
                    name=unit.modifications.trait
                    mode=append

                    [value]
                        id=staffbanisher
                        name= _ "banishment staff"
                        description= _ "This unit is holding a powerful staff which once belonged to the first Master of Banishers.

Effects:
- the banishment attack never misses
- the staff/frozen gate attacks deal +2 damage 
- increases magical resistances by 10%"
                    [/value]
                [/set_variables]
                {VARIABLE_OP unit.variables.artifact_count add 10}
                [unstore_unit]
                    variable=unit
                    find_vacant=no
                [/unstore_unit]
            [/then]
        [/if]
    [/event]

    #turn 1
    [event]
        name=turn 1
        [message]
            speaker=Instructor
            message= _ "Welcome, my liege. I am the leader of Tar-Tabar's branch of the Banishers' Guild and your new instructor. As you requested, I am going to teach you about the personal megacirle, the procedure of banishing magical beings, and explain some details about Dimensional Gates. Shall I begin?"
        [/message]
        [message]
            speaker=Mehir
            message= _ "Why yes indeed, I'm looking forward to learning more about my newly obtained magical arsenal."
        [/message]
        [message]
            speaker=Instructor
            message= _ "Ah, yes, the personal Megacircle - one of the most advanced magical circles ever designed. Those things cost a king's fortune to make, but are certainly worth it. Only the most powerful Summoners in our society can afford such a miracle."
        [/message]
        [message]
            speaker=Mehir
            message= _ "So, could you explain its capabilities to me in-detail?"
        [/message]
        [message]
            speaker=Instructor
            message= _ "There are plenty, but for now I'll mainly stick to those related to combat, as you seem to be quite a warmonger. Anyway, when you became a commander you received your first personal circle. The megacircle you own right now is far more powerful. It can still summon elementals like your old one could, but requiring far less resources to do so. It's maintanence cost is very low - the circle repairs itself automatically, so the wear-off is extremely miniscule."
        [/message]
        [message]
            speaker=Instructor
            message= _ "The circle also emits energies that heal you and your nearby comrades, as well as improve their reflexes and combat efficiency. Now you won't need to bother with water elementals when wounded."
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-leader-happy.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Neat! And what about its offensive capabilities?"
        [/message]
        [message]
            speaker=Instructor
            message= _ "Oh ho ho, Those are tremendous... not only does it have magically-guided weapons linked to it, but it's capable of performing the so-called 'Incantation of Power', one of the most devastating combat spells ever invented."
        [/message]
        [message]
            speaker=Mehir
            message= _ "The very name of this spell certainly makes quite an impression. How exactly does it work, though?"
        [/message]
        [message]
            speaker=Instructor
            message= _ "The megacircle accesses an energy-dense part of the Abyss and then opens a short-lasting gate to it, resulting in a concentrated ejection of abyssal energies into our world. And best of all, there's no known way of protection from this beauty."
        [/message]
        [message]
            speaker=Mehir
            message= _ "The way you described this certainly makes me want to see it in action. I hope it is as great as you put it..."
        [/message]
        [message]
            speaker=Instructor
            message= _ "Fair enough. How about summoning an elemental to act as our training dummy of sorts?"
        [/message]
        [message]
            speaker=narrator
            image=portraits/narrator.png
            message= _ "Right click an empty hex adjacent to Mehir and then pick a unit you wish to summon."
        [/message]
        [disallow_end_turn]
        [/disallow_end_turn]
        [store_unit]
            [filter]
                id=Mehir
            [/filter]
            variable=mehirvar
        [/store_unit]
        [set_variable]
            name=summon_event2
            value=yes
        [/set_variable]
        [fire_event]
            name=forcesummonoptions
        [/fire_event]
        [objectives]
            side=1
            [objective]
                description= _ "Summon something"
                condition=win
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=100
            [/gold_carryover]
            [note]
                description= _ "Right click Mehir for help"
            [/note]
        [/objectives]
    [/event]

    #summoned an elemental
    [event]
        name=post summon
        first_time_only=no

        [if]
            [variable]
                name=summon_event2
                equals=yes
            [/variable]
            [and]
                [variable]
                    name=summon_event1
                    equals=yes
                [/variable]
            [/and]
            [else]
                #bugfix:
                [if]
                    [variable]
                        name=line_check
                        not_equals=yes
                    [/variable]
                    [then]
                        [message]
                            speaker=Instructor
                            message= _ "And now imagine destroying this elemental... with a tower of yellow light surging from the floor! The megacircle will do the rest."
                        [/message]
                        [set_variable]
                            name=line_check
                            value=yes
                        [/set_variable]
                    [/then]
                [/if]

#define FILTER_TAR
    type=EoMa_Air_Elemental,EoMa_Earth_Elemental,EoMa_Fire_Elemental,EoMa_Water_Elemental
    [not]
        x,y=recall,recall
    [/not]
#enddef
                {MODIFY_UNIT id=Mehir attacks_left 1}
                {MODIFY_UNIT ({FILTER_TAR}) side 3}
                {MODIFY_UNIT ({FILTER_TAR}) attack[0].number 0}
                [objectives]
                    side=1
                    [objective]
                        description= _ "Destroy your elemental"
                        condition=win
                    [/objective]
                    [gold_carryover]
                        bonus=no
                        carryover_percentage=100
                    [/gold_carryover]
                [/objectives]
                [set_variable]
                    name=summon_event1
                    value=yes
                [/set_variable]
            [/else]
            [then]
                [fire_event]
                    name=dg_event
                [/fire_event]
            [/then]
        [/if]
    [/event]

    #elemental destroyed
    [event]
        name=die

        [filter]
            {FILTER_TAR}
        [/filter]
        [filter_second]
            id=Mehir
        [/filter_second]

        [kill]
            id=$unit.id
            animate=no
        [/kill]

        [message]
            speaker=Mehir
            image="portraits/mehir-leader-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Whoa, that was something!... Wait, did you hear that?"
        [/message]

        [lock_view]
        [/lock_view]

        {ANIMHACK jaffarbath1 $x1 $y1 se}
        {PLACE_IMAGE "scenery/jaffarrubble2.png" $x1| $y1|}

        {BADASS_MODE_CHANGE (
            [unit]
                type=TLU_animhack
                side=2
                x=$x1
                y=$y1
                facing=se
                placement,overwrite=map,yes
            [/unit]

            [animate_unit]
                flag=jaffarbath2
                [filter]
                    type=TLU_animhack
                [/filter]
            [/animate_unit]

            [unit]
                id=Jaffar
                type=TLU_Jaffar
                variation=jaffarbath
                name= _ "Jaffar"
                side=2
                x=$x1
                y=$y1
                facing=se
                placement,overwrite=map,yes
            [/unit]
        ) (
            {ANIMHACK jaffarbath1 $x1 $y1 se}
        )}
        {QUAKE ()} #for extra dramatic effect
        [unlock_view]
        [/unlock_view]

        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                image="portraits/mehir-leader-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "What the... Jaffar? Is that you?!"
            [/message]
            [message]
                speaker=Jaffar
                message= _ "Somebody, shut the door! It's drafty in here! My bathwater will cool- ...Mehir?! Is that you?! What are YOU doing here?"
            [/message]
            [message]
                speaker=Mehir
                message= _ "Well, in case you missed the news, you should kind of be aware that I am in charge here now."
            [/message]
            [message]
                speaker=Jaffar
                message= _ "Dear Nomolas! To think that half a year ago you were little more than a mere officer under my command! And neither did I expect to meet you while bathing..."
            [/message]
            [message]
                speaker=Mehir
                message= _"Heh, what can I say, fate works in mysterious ways."
            [/message]
            [message]
                speaker=Rashti
                message= _ "Of all the things that can be summoned, bathers are not the first thing one would imagine."
            [/message]
            [message]
                speaker=Mehir
                message= _ "Indeed... So Jaffar, weren't you supposed to be in Sud-Affar, guarding the Great Circle?"
            [/message]
            [message]
                speaker=Jaffar
                message= _ "I was, but I resigned. Being nearly boiled to death by a bunch of humanoid lizards is the stuff of nightmares, you know! I needed to change place, so I was, indeed toying with the idea of paying you a visit."
            [/message]
            [message]
                speaker=Mehir
                message= _ "Good timing. You see, I lack a deputy. Say, would you like to assume this office? You've certainly got experience with the job, considering you used to work under Sharif, and besides, your wackiness got me on the way up the career ladder."
            [/message]
            [message]
                speaker=Jaffar
                message= _ "I need some time to consider it... Alright then. On thorough reflection, Tar-Tabar is a far better alternative to being anywhere near those damn lizards. I accept the offer."
            [/message]
            [message]
                speaker=Instructor
                message= _ "Pardon, but shall I proceed with my lecture?"
            [/message]
            [message]
                speaker=Mehir
                message= _ "Oh, right, I totally forgot about that. But what about Jaffar?"
            [/message]
            [message]
                speaker=Jaffar
                message= _ "It's fine. Take your time, I still haven't finished my bath, so just pretend like I never fell from the ceiling..."
            [/message]
            [message]
                speaker=Mehir
                message= _ "Sure, we'll all try... (to Semir) You may continue, guildmaster."
            [/message]
        ) (
            [message]
                speaker=Mehir
                image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "Damn it, I've just accidentally damaged my palace. That's gonna be expensive to fix..."
            [/message]
        )}
        [message]
            speaker=Instructor
            message= _ "As you have witnessed, my liege, the 'Incantation of Power' is quite powerful, and telling you to cast it indoors wasn't exactly my brightest idea. My sincere apologies."
        [/message]
        [message]
            speaker=Instructor
            message= _ "That's all I have to say about the megacircle. Let's move on to my favorite topic: Banishment."
        [/message]
        [message]
            speaker=Mehir
            message= _ "I already had some dispellers under my command. Mind that I am holding my prestigious position not least because of vast experience!"
        [/message]
        [message]
            speaker=Instructor
            message= _ "*ahem* As you should be aware, magical beings originating from the Red Abyss can be quite rebellious, unpredictable and destruction-loving."
        [/message]
        [message]
            speaker=Mehir
            message= _ "Yeah, I certainly got quite the taste of Red Abyss back in Ka-Gatta... I was sure as hell lucky that Rashti closed the portal in time..."
        [/message]
        [message]
            speaker=Instructor
            message= _ "Indeed. Anyway, centuries ago when the Red Cult rebelled against our nation, red beings were their main weapon of war. Back then, the art of banishment had to be developed to be able to defeat the hordes of efreeti and dharma'rhamis. Nowadays Dispellers and Banishers mainly deal with individual red beings occasionally rebelling, as large-scale organized rebellions are uncommon."
        [/message]
        [message]
            speaker=Instructor
            message= _ "After the Red Cult was defeated, circles capable of summoning red abysmal beings directly have been made illegal to prevent further rebellions of such scope, but there are still many red beings serving our people. They are considered mostly stable, due to being transformed from lesser blue beings."
        [/message]
        [message]
            speaker=Instructor
            message= _ "Anyway, where was I? Magical beings banished from this world return to the Abyss via small Dimensional Gates, which they leave behind. Such a gate remains open and operational after a successful banishment and even gains sentience. In some ways, they are similar to elementals."
        [/message]
        {IF_VAR player_banished_creature equals yes (
            [then]
                [message]
                    speaker=Mehir
                    message= _ "Hmmm..."
                    [option]
                        message= _ "I've seen those Dimensional Gates in action, but please continue."
                        [command]
                            [fire_event]
                                name=tutorial
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        message= _ "I already know all of this. There is no need for explanation."
                        [command]
                            [message]
                                speaker=Instructor
                                message= _ "Oh, I see. In this case if you have any more questions, you know where to find me, my liege."
                            [/message]
                            {VARIABLE player_left_class yes}
                            [fire_event]
                                name=ending
                            [/fire_event]
                        [/command]
                    [/option]
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-happy.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Nice! I would like to see one!"
                [/message]
                [fire_event]
                    name=tutorial
                [/fire_event]
            [/else]
        )}
    [/event]

    [event]
        name=tutorial
        
        [message]
            speaker=Instructor
            message= _ "Fair enough. I am going to summon a red being now to demonstrate the banishment process."
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Waaaait a minute, you said it is illegal to summon one directly!"
        [/message]
        [message]
            speaker=Instructor
            message= _ "Oh, did I? Well... as long as I intend to immediately banish the efreeti, it doesn't matter... right?"
        [/message]
        [message]
            speaker=Instructor
            message= _ "...right...?"
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Jaffar
                message= _ "Mehir, just let him summon the damn thing, will you? At least it's a change of pace from being boiled to death and falling from the ceiling..."
            [/message]
        ) (
        )}
        [message]
            speaker=Mehir
            message= _ "Fair enough, I'll turn a blind eye to the illegal summoning for the sake of trying banishment. Guildmaster, you may proceed."
        [/message]
        {FLASH_RED (
            {UNIT 2 EoMa_Efreet () () (placement,animate=leader,yes)}
        )}
        {MODIFY_UNIT type=EoMa_Efreet side 3}
        [message]
			type=EoMa_Efreet
			message= _ "So this is the world of mortals? Time for some destruction... Wait a minute, IS THAT A BANISHER?! AAAAAAH!"
		[/message]
        [message]
            speaker=Instructor
            message= _ "Well, time to send this fellow back where he belongs!"
        [/message]
        {MODIFY_UNIT id=Instructor side 1}
        {MODIFY_UNIT id=Instructor attack[1].number 0}
        {MODIFY_UNIT id=Instructor attack[2].number 0}
        [objectives]
            side=1
            [objective]
                description= _ "Semir banishes the efreeti"
                condition=win
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=100
            [/gold_carryover]
        [/objectives]
    [/event]

    #Efreeti banished
    [event]
        name=post banish

        [message]
            speaker=Mehir
            image="portraits/mehir-leader-happy.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Heh, been some time since I saw the process of banishment up-close!"
        [/message]
        [message]
            speaker=Instructor
            message= _ "Indeed, it's quite a sight. Anyway, you now have control over the resulting gate."
        [/message]
        {IF_VAR player_advanced_dg equals yes (
            [then]
                [message]
                    speaker=Mehir
                    message= _ "Quite fascinating..."
                    [option]
                        message= _ "...maybe I'll learn something more about them. Please continue."
                        [command]
                            [fire_event]
                                name=tutorial2
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        message= _ "...but I already know how these things work."
                        [command]
                            [message]
                                speaker=Instructor
                                message= _ "Oh, I see. In this case if you have any more questions, you know where to find me, my liege."
                            [/message]
                            {VARIABLE player_left_class yes}
                            [fire_event]
                                name=ending
                            [/fire_event]
                        [/command]
                    [/option]
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Mehir
                    message= _ "Quite fascinating... I guess the next logical step would be an in-depth explanation about it..."
                [/message]
                [fire_event]
                    name=tutorial2
                [/fire_event]
            [/else]
        )}
        
    [/event]

    [event]
        name=tutorial2
        
        [message]
            speaker=Instructor
            message= _ "*ahem* The Dimensional Gate can transform itself into an abyssmal being of its master's choice, in exchange for a living being's soul..."
        [/message]
        {IF_VAR player_advanced_dg equals yes (
            [then]
                [message]
                    speaker=Mehir
                    message= _ "As a matter of fact during my booming career I ordered one of my Dimensional Gates to consume a soul of a hostile being, so I already know everything about their practical uses."
                [/message]
                [message]
                    speaker=Instructor
                    message= _ "You seem to be more experienced than I imagined, my liege. Then you will certainly agree with me that the 'soul catching' is a hefty but fair price for their abilities."
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "Since we have that one Dimensional Gate already present here, it would be a good idea to transform it into something more useful. But I need a spare soul to make that happen. I guess I'll just summon another elemental to act as a training dummy..."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Yikes!"
                [/message]
                [message]
                    speaker=Instructor
                    message= _ "Indeed, the usage of Dimensional Gates may be considered immoral by some. But if the soul belongs to an enemy or animal at the end of its life, then this is an opportunity to still make some use of out them, albeit a rather unsettling one."
                [/message]
                [message]
                    speaker=Instructor
                    message= _ "Though do not forget that the dimensional gates have many interesting properties, including being a sentient, mobile portal. The 'soul catching' is a hefty but fair price for their abilities."
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "It would be quite interesting to see such a transformation take place. So we need a spare soul to make this happen, right?"
                [/message]
                {BADASS_MODE_CHANGE (
                    [message]
                        speaker=Rashti
                        image="portraits/rashti-dharma.png"
                        message= _ "*looks at Jaffar*"
                    [/message]
                    [message]
                        speaker=Jaffar
                        message= _ "Hey, why are you looking at me? I'm too young to die!"
                    [/message]
                ) (
                    [message]
                        speaker=Rashti
                        image="portraits/rashti-dharma.png"
                        message= _ "*looks at Semir*"
                    [/message]
                )}
                [message]
                    speaker=Instructor
                    message= _ "Dear Nomolas! No need to resort to such barbarism, my liege! I forgot to mention that we can just as easily sacrifice a magical being for the same effect."
                [/message]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Why didn't you say so before?! Anyway, I guess I'll just summon another elemental to act as a training dummy..."
                [/message]
            [/else]
        )}

        {MODIFY_UNIT id=Mehir moves $mehirvar.max_moves}
        [objectives]
            side=1
            [objective]
                description= _ "Summon something"
                condition=win
                [gold_carryover]
                    bonus=no
                    carryover_percentage=100
                [/gold_carryover]
            [/objective]
            [note]
                description= _ "Right click Mehir for help"
            [/note]
        [/objectives]
    [/event]

    #summoned the second elemental
    [event]
        name=dg_event

        {IF_VAR player_advanced_dg equals yes (
            [then]
                [message]
                    speaker=Instructor
                    message= _ "Good, now use your Dimensional Gate to destroy your elemental. When this happens..."
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "...I will be able to choose which magical being I want to summon from this gate. Yeah, yeah, I know all of that."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Instructor
                    message= _ "Good, now use your Dimensional Gate to destroy your elemental. When this happens, the channel between dimensions will solidify and you will be able to choose which magical being you want to summon from this gate. The gate will then close itself and disappear."
                [/message]
                [message]
                    speaker=Instructor
                    message= _ "You can use it to summon all sorts of powerful magical beings: elemental avatars, rhami'kais, great jinn, you name it!"
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "Wait, do you mean I am allowed to summon Jinn now?"
                [/message]
                [message]
                    speaker=Instructor
                    message= _ "Of course! You are the leader of Tar-Tabar for crying out loud! Who can forbid you from doing this?"
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "Right, I haven't really got used to the title yet. I guess I won't need to pay independent jinn to tell my future anymore..."
                [/message]
            [/else]
        )}
        
        [message]
            speaker=Mehir
            message= _ "Anyway, time to see what I can get out of this yellow gate..."
        [/message]

        {MODIFY_UNIT type=EoMa_Dimensional_Gate_II attacks_left 1}
        {MODIFY_UNIT type=EoMa_Dimensional_Gate_II moves 6}
        {MODIFY_UNIT ({FILTER_TAR}) hitpoints 1}
        {MODIFY_UNIT ({FILTER_TAR}) side 3}
        {MODIFY_UNIT ({FILTER_TAR}) attack[0].number 0}
        [objectives]
            side=1
            [objective]
                description= _ "Destroy your elemental with the Dimensional Gate II"
                condition=win
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=100
            [/gold_carryover]
        [/objectives]
    [/event]

    #Dimensional Gate consumes the elemental
    [event]
        name=post gate
        {IF_VAR player_advanced_dg equals yes (
            [then]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-happy.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Aaand... done!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-happy.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Nice! This almost makes me want to create a dimensional gate collection..."
                [/message]
            [/else]
        )}
        [delay]
            time=500
        [/delay]
        [message]
            speaker=Mehir
            message= _ "I do wonder, though, is it possible to banish a very powerful abysmal being? Like, say, an elemental god or Dharma'rhami?"
        [/message]
        [message]
            speaker=Instructor
            message= _ "These are too powerful to be banished, even for professionals like myself. Only the Master of Banishers from al-Kamija is or, more accurately, was capable of doing such a thing. Unfortunately he has grown fat over the years, and is now unable to even move by himself, not to mention banish..."
        [/message]
        [message]
            speaker=Instructor
            message= _ "So at the moment, the only way to get rid of them is to completely destroy their bodies. That is precisely what the 'frozen gate' spells are for."
        [/message]
        [message]
            speaker=Mehir
            message= _ "I'll keep that in mind. Thanks for explaining all of this to me."
        [/message]
        [message]
            speaker=Instructor
            message= _ "You're welcome. I get paid for this after all. Do you have any questions left, my liege?"
        [/message]
        [message]
            speaker=Mehir
            message= _ "Yes, I wonder: what happens if one tries to banish a dimensional gate?"
        [/message]
        [message]
            speaker=Instructor
            message= _ "That's a pretty interesting question. It's been years since anyone brought it up, to be honest. Anyway, 'banishing' a Dimensional Gate II simply turns it into a blue Dimensional Gate, while doing so to a normal Dimensional Gate that doesn't belong to you makes it disappear, and reappear as loyal to you. This might make for a decent prank, but there isn't any other use for it that I can imagine."
        [/message]
        [message]
            speaker=Mehir
            message= _ "And how exactly did you make such an... unusual discovery?"
        [/message]
        [message]
            speaker=Instructor
            message= _ "Ah, I learned this when observing one of my dispeller students. He's a bit, uhh... weird, to be honest, so, after banishing an elemental, he decided to try banishing the gate, and it reappeared! This awakened my curiosity, and so I decided to try the same approach on one of my Dimensional Gate IIs, just for fun."
        [/message]
        [message]
            speaker=Mehir
            message= _ "Heh, nice... And now, the last question: since you said that the Master of Banishers from al-Kamija could banish elemental gods and other powerful abyssal beings, does this mean that the existence of Dimensional Gate IIIs isn't merely one of the rumors spread at the bazaar?"
        [/message]
        [message]
            speaker=Instructor
            message= _ "It certainly isn't, my liege. The Master of Banisher has an entire collection of such dimensional gates in his mansion, though he doesn't show them to anyone, being paranoid about their irreplaceability, due to his... inability of banishment. Thus it will most likely remain as a mystery for now as to how those gates look."
        [/message]
        [message]
            speaker=Instructor
            message= _ "Anything else, my liege?"
        [/message]
        [message]
            speaker=Mehir
            message= _ "No, that's all I wanted to know right now."
        [/message]
        [fire_event]
            name=ending
        [/fire_event]
    [/event]

    [event]
        name=ending

        {BADASS_MODE_CHANGE (
            [message]
                speaker=Jaffar
                message= _ "At last! The bathwater is cold now. I need a towel, garbs, sandals, a divan, some dainties and a water pipe. Some delicious fig wine would be welcome too... Will my gorgeous cast iron lion paw feet tub remain here?"
            [/message]
            [message]
                speaker=Mehir
                message= _ "Servants! Carry my deputy Jaffar in his bathtub to the chambers he is entitled to."
            [/message]
            [store_unit]
                [filter]
                    id=Jaffar
                [/filter]
                variable=jaffarloc
                kill=no
            [/store_unit]
            {UNIT 2 (TLU_animhack) 25 12 (variation=servants)}
            [move_unit]
                type=TLU_animhack
                to_x=$jaffarloc.x
                to_y=$jaffarloc.y
                check_passability=no
            [/move_unit]
            [unstore_unit]
                variable=jaffarloc
                find_vacant=no
            [/unstore_unit]
            [kill]
                type=TLU_animhack
                animate=no
            [/kill]
            [kill]
                id=Jaffar
                animate=no
            [/kill]
            {UNIT 2 (TLU_animhack) $jaffarloc.x $jaffarloc.y (variation=servants_bath
            id=Jaffar
            name=_"Jaffar")}
            {CLEAR_VARIABLE jaffarloc}
            [move_unit]
                id=Jaffar
                to_x=25
                to_y=12
                check_passability=no
            [/move_unit]
            [kill]
                type=TLU_animhack
                animate=no
            [/kill]
            [message]
                speaker=Mehir
                message= _ "By the way, I will organize a celebration for Jaffar's inauguration, and you're all invited. There will be lots of food, drinks, music and dancing! Oh, and don't forget to tell Jaffar himself to show up."
            [/message]
        ) (
            [message]
                speaker=Instructor
                message= _ "Now, there is one thing left to do: as the leader of Tar-Tabar, you should appoint your deputy..."
            [/message]

            [unit]
                type=EoMa_Grand_Summoner
                id=Jaffar
                name= _ "Jaffar"
                profile=portraits/jaffar.png
                image_icon="portraits/jaffar.png~CROP(150,60,130,130)~SCALE(72,72)"
                unrenamable=yes
                side=2
                x=25
                y=11
                facing=se
                placement,overwrite=map,yes
                [modifications]
                    [object]
                        [effect]
                            apply_to=image_mod
                            add="RC(magenta>green)"
                        [/effect]
                    [/object]
                [/modifications]
            [/unit]

            [move_unit]
                id=Jaffar
                to_x=19
                to_y=9
            [/move_unit]

            [message]
                speaker=Jaffar
                image=portraits/jaffar-angry.png
                message= _ "Ah, there you are! Which of you thought it was a good idea to use an incantation of power INDOORS?! I was on my way to take a bath, and then I see a beam of light and the floor breaks in front of my eyes! As if I wasn't traumatized from the lizards enough already..."
            [/message]
            [message]
                speaker=Mehir
                message= _ "*looks at Semir*"
            [/message]
            [message]
                speaker=Rashti
                message= _ "*looks at Semir*"
            [/message]
            [message]
                speaker=Instructor
                message= _ "Uhh... I will neither confirm nor deny."
            [/message]
            [message]
                speaker=Jaffar
                message= _ "Hmph, damn banishers..."
            [/message]
            [delay]
                time=1000
            [/delay]
            [message]
                speaker=Mehir
                message= _ "So, to change the topic... Jaffar, weren't you supposed to be in Sud-Affar, guarding the Great Circle?"
            [/message]
            [message]
                speaker=Jaffar
                message= _ "I was, but I resigned. Being nearly boiled to death by a bunch of humanoid lizards is the stuff of nightmares, you know! I needed to change place, so I was, indeed toying with the idea of paying you a visit."
            [/message]
            [message]
                speaker=Mehir
                message= _ "Good timing. You see, I lack a deputy. Say, would you like to assume this office? You've certainly got experience with the job, considering you used to work under Sharif, and besides, your wackiness got me on the way up the career ladder."
            [/message]
            [message]
                speaker=Jaffar
                message= _ "I need some time to consider it... Alright then. On thorough reflection, Tar-Tabar is a far better alternative to being anywhere near those damn lizards. I accept the offer."
            [/message]
            [message]
                speaker=Mehir
                message= _ "Very well, I will organize a celebration for your inauguration. There will be lots of food, drinks, music and dancing!"
            [/message]
        )}
        [message]
            speaker=Instructor
            message= _ "Ah, I won't miss that! We can converse of the philosophies of jinn for hours!"
        [/message]
        [message]
            speaker=Rashti
            message= _ "You do realize that you've spent most of your time on nothing but entertainment almost every day since your appointment, right?"
        [/message]
        [message]
            speaker=Mehir
            message= _ "Oh, come on, can't I just have some fun?"
        [/message]
        [message]
            speaker=Rashti
            message= _ "*sigh* Maybe choosing you as my master wasn't such a good idea..."
        [/message]
        [store_unit]
            [filter]
                id=Mehir
            [/filter]
            variable=mehirloc
        [/store_unit]
        [unstore_unit]
            variable=mehirvar
            find_vacant=no
            x,y=$mehirloc.x,$mehirloc.y
        [/unstore_unit]
        [endlevel]
            result=victory
            carryover_report=no
            {NEW_GOLD_CARRYOVER 100}
            bonus=no
        [/endlevel]
    [/event]

    #Mehir moves Dimensional Gate around for no reason
    [event]
        name=moveto
        first_time_only=no
        [allow_undo]
        [/allow_undo]
        [if]
            [have_unit]
                type=EoMa_Dimensional_Gate_II
                [not]
                    [filter_adjacent]
                        side=3
                        adjacent=n,ne,nw,s,se,sw
                    [/filter_adjacent]
                [/not]
            [/have_unit]
            [then]
                [set_variable]
                    name=dgmoves
                    add=1
                [/set_variable]
            [/then]
        [/if]
        [if]
            [variable]
                name=dgmoves
                equals=2
            [/variable]
            [and]
                [have_unit]
                    type=EoMa_Dimensional_Gate_II
                    [not]
                        [filter_adjacent]
                            side=3
                            adjacent=n,ne,nw,s,se,sw
                        [/filter_adjacent]
                    [/not]
                [/have_unit]
            [/and]
            [then]
                [message]
                    speaker=Instructor
                    message= _ "Uhh... my liege, I am not entirely sure this is the best time for messing around with dimensional gates."
                [/message]
            [/then]
        [/if]
        [if]
            [variable]
                name=dgmoves
                equals=4
            [/variable]
            [and]
                [have_unit]
                    type=EoMa_Dimensional_Gate_II
                    [not]
                        [filter_adjacent]
                            side=3
                            adjacent=n,ne,nw,s,se,sw
                        [/filter_adjacent]
                    [/not]
                [/have_unit]
            [/and]
            [then]
                [message]
                    speaker=Rashti
                    message= _ "It's not that hard to get a new gate, so why not just use this one properly?"
                [/message]
            [/then]
        [/if]
        [if]
            [variable]
                name=dgmoves
                equals=6
            [/variable]
            [and]
                [have_unit]
                    type=EoMa_Dimensional_Gate_II
                    [not]
                        [filter_adjacent]
                            side=3
                            adjacent=n,ne,nw,s,se,sw
                        [/filter_adjacent]
                    [/not]
                [/have_unit]
            [/and]
            [then]
                {BADASS_MODE_CHANGE (
                    [message]
                        speaker=Jaffar
                        message= _ "*sigh* Some people have a hard time understanding the simplest things... Get a move on, Mehir! Shall I give you a piece of my mind?"
                    [/message]
                ) (
                )}
            [/then]
        [/if]
        [if]
            [variable]
                name=dgmoves
                equals=8
            [/variable]
            [and]
                [have_unit]
                    type=EoMa_Dimensional_Gate_II
                    [not]
                        [filter_adjacent]
                            side=3
                            adjacent=n,ne,nw,s,se,sw
                        [/filter_adjacent]
                    [/not]
                [/have_unit]
            [/and]
            [then]
                {BADASS_MODE_CHANGE (
                    [message]
                        speaker=Jaffar
                        message= _ "Looks like this is going nowhere... o holy Rashti'rhami, could Your Majesty please do something about it?"
                    [/message]
                ) (
                    [message]
                        speaker=Instructor
                        message= _ "Looks like this is going nowhere... o holy Rashti'rhami, could Your Majesty please do something about it?"
                    [/message]
                )}
                [message]
                    speaker=Rashti
                    message= _ "Sure... alright, here goes nothing..."
                [/message]
                [set_variable]
                    name=dgmoves
                    add=1
                [/set_variable]
                [store_unit]
                    [filter]
                        type=EoMa_Dimensional_Gate_II
                    [/filter]
                    variable=dg
                    kill=no
                [/store_unit]
                {MOVE_UNIT id=Rashti $dg.x $dg.y}
                [message]
                    speaker=Rashti
                    image=portraits/rashti-dharma.png
                    message= _ "RRRRAAAARRRGGGGHHHH!!!"
                [/message]
                {REPEAT 4 (
                    [store_unit]
                        [filter]
                            id=Rashti
                        [/filter]
                        variable=rashtishout
                        kill=no
                    [/store_unit]
                    [unstore_unit]
                        variable=rashtishout
                        {COLOR_HARM}
                        text= _ "DIE!!!"
                        find_vacant=no
                    [/unstore_unit]
                    [harm_unit]
                        [filter]
                            type=EoMa_Dimensional_Gate_II
                        [/filter]
                        [filter_second]
                            id=Rashti
                        [/filter_second]
                        [primary_attack]
                            name=fireball
                        [/primary_attack]
                        amount=12
                        damage_type=fire
                        experience=no
                        fire_event=no
                        animate=yes
                    [/harm_unit]
                )}
                {MOVE_UNIT id=Rashti 12 5}
                {MODIFY_UNIT id=Rashti facing se}
                {BADASS_MODE_CHANGE (
                    [message]
                        speaker=Jaffar
                        message= _ "Much better!"
                    [/message]
                ) (
                    [message]
                        speaker=Instructor
                        message= _ "Much better!"
                    [/message]
                )}
                [message]
                    speaker=Rashti
                    message= _ "You're welcome."
                [/message]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Hey! I've just grown attached to this thing, you know!"
                [/message]
                {BADASS_MODE_CHANGE (
                    [message]
                        speaker=Jaffar
                        message= _ "That's exactly the issue."
                    [/message]
                ) (
                )}
                [message]
                    speaker=Instructor
                    message= _ "*ahem* Anyway, I'll need another gate to continue, and that means..."
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "Another illegally summoned Efreeti?"
                [/message]
                [message]
                    speaker=Instructor
                    message= _ "Indeed, my liege."
                [/message]
                {FLASH_RED (
                    {UNIT 2 EoMa_Efreet () () (placement,animate=leader,yes)}
                )}
                {MODIFY_UNIT type=EoMa_Efreet side 3}
                [harm_unit]
                    [filter]
                        type=EoMa_Efreet
                    [/filter]
                    [filter_second]
                        id=Instructor
                    [/filter_second]
                    [primary_attack]
                        name=banishment
                    [/primary_attack]
                    amount=14
                    damage_type=arcane
                    experience=no
                    fire_event=yes
                    animate=yes
                [/harm_unit]
                [store_unit]
                    [filter]
                        type=EoMa_Efreet
                    [/filter]
                    variable=banishefreeti
                    kill=no
                [/store_unit]
                {BANISH_ANIM $banishefreeti.x $banishefreeti.y}
                [object]
                    silent=yes
                    take_only_once=no
                    [effect]
                        apply_to=type
                        name=EoMa_Dimensional_Gate_II
                    [/effect]
                    [filter]
                        type=EoMa_Efreet
                    [/filter]
                [/object]
                [store_unit]
                    [filter]
                        type=EoMa_Dimensional_Gate_II
                    [/filter]
                    variable=dg
                    kill=yes
                [/store_unit]
                {VARIABLE dg.attacks_left 1}
                {VARIABLE dg.moves 1}
                {VARIABLE dg.side $unit.side}
                [unstore_unit]
                    variable=dg
                    find_vacant=no
                [/unstore_unit]
                [message]
                    speaker=Instructor
                    message= _ "Alright, here's another gate for you. Just use it properly this time, and don't take too long. After all, your men can create many gates later on, so no need to grow attached to a specific one."
                [/message]
            [/then]
        [/if]

        {MODIFY_UNIT id=Mehir moves $mehirvar.max_moves}
        {MODIFY_UNIT id=Instructor moves 6}
        {MODIFY_UNIT type=EoMa_Dimensional_Gate_II moves 6}
    [/event]

    #Mehir tries to use wrong attacks
    [event]
        name=attack
        first_time_only=no
        [filter]
            id=Mehir
        [/filter]
        [filter_attack]
            [not]
                name=incantation of power
            [/not]
        [/filter_attack]

        {MODIFY_UNIT ({FILTER_TAR}) side 1}

        [message]
            speaker=Instructor
            message= _ "You have to use the incantation of power."
        [/message]
    [/event]
    [event]
        name=attack end
        first_time_only=no
        [filter]
            id=Mehir
        [/filter]
        [filter_attack]
            [not]
                name=incantation of power
            [/not]
        [/filter_attack]

        {MODIFY_UNIT ({FILTER_TAR}) side 3}
        {MODIFY_UNIT id=Mehir attacks_left 1}
    [/event]
    #Banisher tries to use wrong attacks
    [event]
        name=attack
        first_time_only=no
        [filter_attack]
            name=staff,frozen gate
        [/filter_attack]

        {MODIFY_UNIT type=EoMa_Efreet side 1}

        [message]
            speaker=Instructor
            message= _ "You should use the banishment attack instead of the others. Against beings like efreeti, it is far more effective."
        [/message]
    [/event]
    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            name=staff,frozen gate
        [/filter_attack]

        {MODIFY_UNIT type=EoMa_Efreet side 3}
        {MODIFY_UNIT id=Instructor attacks_left 1}
    [/event]

#define RASHTISELECT_MESSAGE VAR FILTER MESSAGE
    [if]
        [variable]
            name={VAR}
            {FILTER}
        [/variable]
        [then]
            [message]
                speaker=Rashti
                message={MESSAGE}
            [/message]
        [/then]
    [/if]
#enddef

    #player selects Rashti
    [event]
        name=select
        first_time_only=no
        [filter]
            id=Rashti
        [/filter]
        {RASHTISELECT_MESSAGE rashti_selects less_than=1 _"..."}
        {RASHTISELECT_MESSAGE rashti_selects equals=1 _"What do you want?"}
        {RASHTISELECT_MESSAGE rashti_selects equals=2 _"Nothing? Then why did you start talking to me?"}
        {RASHTISELECT_MESSAGE rashti_selects equals=3 _"Aren't you supposed to be having a lesson right now?"}
        {RASHTISELECT_MESSAGE rashti_selects equals=4 _"I don't see the point."}
        {RASHTISELECT_MESSAGE rashti_selects equals=5 _"Is this supposed to be a joke?"}
        {RASHTISELECT_MESSAGE rashti_selects equals=6 _"It's certainly not a funny one."}
        {RASHTISELECT_MESSAGE rashti_selects equals=7 _"..."}
        {RASHTISELECT_MESSAGE rashti_selects equals=8 _"Don't forget I'm not the only one you're boring to death."}
        {RASHTISELECT_MESSAGE rashti_selects equals=9 _"*yawn*"}
        {RASHTISELECT_MESSAGE rashti_selects equals=10 _"..."}
        {RASHTISELECT_MESSAGE rashti_selects equals=11 _"Ahem."}
        {RASHTISELECT_MESSAGE rashti_selects equals=12 _"You're not going to annoy me forever, are you?"}
        {RASHTISELECT_MESSAGE rashti_selects equals=13 _"Nevermind."}
        {RASHTISELECT_MESSAGE rashti_selects equals=14 _"..."}
        {RASHTISELECT_MESSAGE rashti_selects equals=15 _"What? Do you think you'll get some kind of easter egg for clicking me enough times? That's... unlikely."}
        {RASHTISELECT_MESSAGE rashti_selects equals=16 _"*whistles*"}
        [if]
            [variable]
                name=rashti_selects
                equals=17
            [/variable]
            [then]
                [message]
                    speaker=Rashti
                    image="portraits/rashti-ho.png"
                    message=_"In case you're wondering, no, I'm not your girlfriend."
                [/message]
                [message]
                    speaker=Rashti
                    image="portraits/rashti-dharma.png"
                    message=_"...yet. *teehee*"
                [/message]
                [message]
                    speaker=Rashti
                    image="portraits/rashti-ho.png"
                    message=_"..."
                [/message]
            [/then]
        [/if]
        {RASHTISELECT_MESSAGE rashti_selects equals=18 _"..."}
        {RASHTISELECT_MESSAGE rashti_selects equals=19 _"I'm running out of ideas..."}
        {RASHTISELECT_MESSAGE rashti_selects greater_than=19 _"..."}

        {BADASS_MODE_CHANGE (
            {IF_VAR rashti_selects greater_than 19 (
                [then]
                    [delay]
                        time=500
                    [/delay]

                    [message]
                        speaker=Instructor
                        message=_"Did you really have to poke Rashti'rhami 20 times?"
                    [/message]
                    [delay]
                        time=500
                    [/delay]
                    [message]
                        speaker=Mehir
                        message=_"*puts on sunglasses* Yes."
                    [/message]
                    [message]
                        speaker=Instructor
                        message=_"Wha...?! Those things haven't even been invented yet!"
                    [/message]
                    [message]
                        speaker=Mehir
                        message=_"Does it look like I care?"
                    [/message]
                    [message]
                        speaker=Instructor
                        message=_"I suppose not. Not like you had any respect for the fourth wall anyway, fixing the damn thing is quite expensive..."
                    [/message]
                [/then]
            )}
        ) (
        )}
        {VARIABLE_OP rashti_selects add 1}
    [/event]

    #Mehir decided to look at the city
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            id=Mehir
            x=7,8,14,15,16
            y=3,3,4,5,5
        [/filter]
        [message]
            speaker=Mehir
            message=_"What a nice view of the city..."
        [/message]
    [/event]

    #Mehir tries to leave the area
    [event]
        name=enter hex
        first_time_only=no
        [filter]
            id=Mehir
            x=19,20,21,22,23,24,25
            y=12,11,11,10,10,9,9
        [/filter]
        [message]
            speaker=Instructor
            message=_"My liege, are you leaving?"
        [/message]
        [if]
            [variable]
                name=badass_mode_active
                equals=yes
            [/variable]
            [then]
                [message]
                    speaker=Mehir
                    message=_"Deal with it."
                [/message]
                {VARIABLE player_left_class yes}
                {MOVE_UNIT x,y=$x1,$y1 25 12}
                [unstore_unit]
                    variable=mehirvar
                    find_vacant=no
                    x,y=25,12
                [/unstore_unit]
                [object]
                    silent=yes
                    duration=forever
                    [filter]
                        id=Mehir
                    [/filter]
                    [effect]
                        apply_to=variation
                        name=badass
                    [/effect]
                [/object]
                {MODIFY_UNIT id=Mehir profile "portraits/mehir-leader.png~BLIT(misc/sunglasses.png)"}
                [kill]
                    id=Rashti
                    animate=no
                    fire_event=no
                [/kill]

                [endlevel]
                    result=victory
                    carryover_report=no
                    {NEW_GOLD_CARRYOVER 100}
                    bonus=no
                [/endlevel]
            [/then]
            [else]
                [message]
                    speaker=Mehir
                    message=_"Nah, I'd rather stay here for now."
                [/message]
                {MOVE_UNIT x,y=$x1,$y1 16 8}
            [/else]
        [/if]
    [/event]

    #victory
    [event]
        name=victory

        {CLEAR_VARIABLE mehirloc}
        [unstore_unit]
            variable=rashtivar
            find_vacant=no
        [/unstore_unit]
        {MODIFY_UNIT id=Rashti moves 6}
        {MODIFY_UNIT id=Rashti max_moves 6}
        {MODIFY_UNIT id=Rashti attacks_left 1}
        {MODIFY_UNIT id=Instructor side 2}
        {MODIFY_UNIT id=Rashti profile "portraits/rashti.png"}
        [allow_end_turn]
        [/allow_end_turn]
        {CLEAR_VARIABLE mehirvar}
        {CLEAR_VARIABLE rashtivar}
        {CLEAR_VARIABLE summon_event1}
        {CLEAR_VARIABLE summon_event2}
        {CLEAR_VARIABLE line_check}

        #carry Semir to the next scenario
        {MODIFY_UNIT id=Instructor side 1}
    [/event]

    {CORRECT_RECALL_COST}
    {ITEM_APPLIER}
    {SUMMONER_LOCK}
    {DEATH_MEHIR}
    {TLU_S14_TERRAIN}
[/scenario]
