#textdomain wesnoth-To_Lands_Unknown

#define TRAPS_MESSAGE
    [if]
        [variable]
            name=traps
            equals=0
        [/variable]
        [then]
            [if]
                [have_unit]
                    race=eoma_summoner
                    x,y=$x1,$y1
                [/have_unit]
                [then]
                    [message]
                        speaker=unit
                        message= _ "Oh no. It’s a trap!"
                    [/message]
                [/then]
                [else]
                    [if]
                        [have_unit]
                            type_adv_tree=EoMa_Rhami,EoMa_Jinn
                            x,y=$x1,$y1
                        [/have_unit]
                        [then]
                            [message]
                                speaker=unit
                                message= _ "I am trapped, my master."
                            [/message]
                        [/then]
                    [/if]
                [/else]
            [/if]
            [message]
                speaker=Mehir
                message= _ "I’m sure there is a release mechanism somewhere. Search all tunnels and recesses you find."
            [/message]
        [/then]
        [else]
            [if]
                [variable]
                    name=traps
                    equals=1
                [/variable]
                [then]
                    [if]
                        [have_unit]
                            race=eoma_summoner
                            x,y=$x1,$y1
                        [/have_unit]
                        [then]
                            [message]
                                speaker=unit
                                message= _ "I am trapped!"
                            [/message]
                        [/then]
                    [/if]
                    [message]
                        speaker=Mehir
                        message= _ "Again? Continue searching until you find the right one. I wonder what these bars were meant to enhedge..."
                    [/message]
                [/then]
                [else]
                    [if]
                        [have_unit]
                            race=eoma_summoner
                            x,y=$x1,$y1
                        [/have_unit]
                        [then]
                            [message]
                                speaker=unit
                                message= _ "Oops..."
                            [/message]
                        [/then]
                    [/if]
                    [message]
                        speaker=Mehir
                        message= _ "Do you hear that?"
                    [/message]

                    [fire_event]
                        name=amulet
                    [/fire_event]
                [/else]
            [/if]
        [/else]
    [/if]
#enddef
#define GRAVE X Y IMAGE MESSAGE EXTRA
    [event]
        name=prestart
        {PLACE_IMAGE {IMAGE} {X} {Y}}
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y={X},{Y}
            side=1
        [/filter]
        [message]
            speaker=narrator
            image={IMAGE}
            caption=_ "Monolith"
            message={MESSAGE}
        [/message]
    [/event]
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            x,y={X},{Y}
            side=1
        [/filter]
        {EXTRA}
    [/event]
#enddef
[scenario]
    id=08_Ka-gatta
    next_scenario=09_Goddess_of_All_Rhamis

    name= _ "Ka-gatta"
    map_data="{~add-ons/To_Lands_Unknown/maps/08_Ka-gatta.map}"
    {TURNS 60 56 52}
    victory_when_enemies_defeated=no

    [time]
        id=underground_kagatta
        name= _ "Lit caverns"
        image=misc/time-schedules/schedule-underground-illum.png
        lawful_bonus=0
    [/time]
    #time area for dark corners:
    [time_area]
        x=1-5,6,6,7,7,8,8,8,8,9,9,10,11,12
        y=1-45,1-39,41-45,1-19,25-39,1-7,17-20,33,25-26,1-7,34,1-2,1-3,1-3
        [time]
            id=underground_kagatta_dark
            name= _ "Caverns"
            image=misc/time-schedules/schedule-underground.png
            lawful_bonus=-15
        [/time]
    [/time_area]

    {SCENARIO_MUSIC weight_of_revenge.ogg}
    {EXTRA_SCENARIO_MUSIC Exploration_T.ogg}
    {EXTRA_SCENARIO_MUSIC underground.ogg}

    {STORYTXT_KA_GATTA}

    [side]
        side=1
        controller=human
        team_name=mehirteam
        user_team_name= _ "team_name^Mehir"

        type=EoMa_Grand_Summoner
        id=Mehir
        name= _ "Mehir"
        unrenamable=yes
        canrecruit=yes
        shroud=yes
        shroud_data="{~add-ons/To_Lands_Unknown/maps/08_Ka-gatta.shroud}"

        recruit=EoMa_Novice_Summoner,EoMa_Novice_Summoner,EoMa_Camel_Rider,EoMa_Carpet_Rider,EoMa_Water_Elemental,EoMa_Summoner,EoMa_Rhami,EoMa_Fire_Elemental

        {GOLD 300 250 180}
        {INCOME 16 12 10}
        village_support=4
        village_income=2
    [/side]

    [side]
        side=2
        controller=ai
        team_name=bats
        user_team_name= _ "team_name^Cave Creatures"
        no_leader=yes
        color=black
        hidden=yes

        [ai]
            aggression=0.25
            caution=1.0
            grouping=defensive
        [/ai]
        gold=0
        income=10

        {UNIT 2 (Giant Spider) 3 26 (ai_special=guardian)}
        {UNIT 2 (Giant Spider) 4 22 (ai_special=guardian)}
        {UNIT 2 (Giant Spider) 2 6 (ai_special=guardian)}
        {UNIT 2 (Giant Spider) 10 2 (ai_special=guardian)}
    [/side]

    [side]
        side=3
        controller=ai
        team_name=bats
        user_team_name= _ "team_name^Guardians"
        no_leader=yes
        color=brown
        hidden=yes

        [ai]
            aggression=1.0
            grouping=defensive
            [avoid]
                x=19,8,8,24,3,3,24,41,1,9
                y=33,19,18,20,29,21,6,13,7,4
            [/avoid]
        [/ai]
        gold=0
        income=10
        {UNIT 3 (EoMa_HoRhami) 4 14 (
            ai_special,id=guardian,SpearGuardian
            #making the spear guardian a bit of a boss:
            [modifications]
                [trait]
                    id=spearguardian
                    name= _ "spear guardian"
                    description= _ "This unit is blessed by the artifact it's guarding: the spear of the first Rhami'Kai."
                    [effect]
                        apply_to=attack
                        {QUANTITY increase_damage 10% 15% 25%}
                    [/effect]
                    [effect]
                        apply_to=hitpoints
                        {QUANTITY increase 5 10 10}
                        {QUANTITY increase_total 5 10 10}
                    [/effect]
                    [effect]
                        apply_to=resistance
                        [resistance]
                            arcane=-10
                            fire=-10
                            cold=-10
                        [/resistance]
                    [/effect]
                [/trait]
            [/modifications]
        )}
    [/side]

    {STARTING_VILLAGES 1 5}

#define GUARDIANS_MACRO
    terrain=U*
    x=1-25
    y=2-30

    [not]
        x=19,8,8,24,3,3,24,41,1,9
        y=33,19,18,20,29,21,6,13,7,4
    [/not]

    [not]
        [filter]
        [/filter]
    [/not]

    [not]
        [and]
            x,y=3,29
            radius=5
        [/and]
    [/not]

    [not]
        [and]
            x,y=8,18
            radius=3
        [/and]
    [/not]

    [not]
        [filter_adjacent_location]
            [filter]
            [/filter]
        [/filter_adjacent_location]
    [/not]
#enddef

    #prestart - setup guardians
    [event]
        name=prestart
        {VARIABLE numb_earth1 10}
        {VARIABLE numb_earth2 5}
        {VARIABLE numb_earth3 2}
        {QUANTITY numb_earth1 4 7 10}
        {SCATTER_UNITS $numb_earth1 "EoMa_Earth_Elemental" 3 ({GUARDIANS_MACRO}) (
            side=3
            ai_special=guardian
        )}
        {QUANTITY numb_earth2 2 4 6}
        {SCATTER_UNITS $numb_earth2 "EoMa_Earth_Avatar" 5 ({GUARDIANS_MACRO}) (
            side=3
            ai_special=guardian
        )}
        {QUANTITY numb_earth3 1 2 3}
        {SCATTER_UNITS $numb_earth3 "EoMa_Earth_God" 10 ({GUARDIANS_MACRO}) (
            side=3
            ai_special=guardian
        )}
        {CLEAR_VARIABLE numb_earth1}
        {CLEAR_VARIABLE numb_earth2}
        {CLEAR_VARIABLE numb_earth3}

        [kill]
            [and]
                x,y=recall,recall
            [/and]
            [or]
                race=lizard
            [/or]
            [or]
                race=eoma_salamander
            [/or]
        [/kill]
        [micro_ai]
            side=3
            ai_type=lurkers
            action=add

            [filter]
                type=EoMa_Earth_Elemental,EoMa_Earth_Avatar,EoMa_Earth_God
            [/filter]
            [filter_location]
            [/filter_location]
            [filter_location_wander]
            [/filter_location_wander]
        [/micro_ai]
        [micro_ai]
            side=2
            ai_type=lurkers
            action=add

            [filter]
                type=Vampire Bat,Blood Bat,Giant Spider
            [/filter]
            [filter_location]
            [/filter_location]
            [filter_location_wander]
            [/filter_location_wander]
        [/micro_ai]
        [micro_ai]
            side=3
            ai_type=return_guardian
            action=add
            [filter]
                id=SpearGuardian
            [/filter]

            id=spearguardian
            return_x,return_y=4,14
        [/micro_ai]
    [/event]

    {GRAVE 10 36 "statues/clean/statue-banisher.png" _"Here lies Ibrahim, the founder of the school of banishment, and the first Master of Banishers. May he rest in peace." ()}
    {GRAVE 12 20 "statues/clean/statue-summonerIV.png" _"Here lies Samir, summoner of the mighty Rashti'rhami, and her first master. May he rest in peace." (
        {IF_VAR ghost_defeated equals yes (
            [then]
                [message]
                    speaker=Mehir
                    message= _ "Seems his rest was far from peaceful, considering we've just fought the man's ghost."
                [/message]
            [/then]
        )}
    )}
    {GRAVE 9 13 "statues/clean/statue-elder.png" _"Here lies Khayyat, an unmatched enchanter, and inventor of the megacircle. Alas, he met an untimely end. May he rest in peace." ()}
    {GRAVE 17 24 "statues/ancient/statue-elder.png" _"*this statue is damaged to the point that the inscription on it has become illegible.*" (
        [message]
            speaker=Mehir
            message= _ "Well, this piece of art certainly seen better days..."
        [/message]
    )}
    {GRAVE 15 37 "scenery/monolith4.png~FL(horiz)" _"*crude text, likely written by some adventurer* <span font-style='italic' font-weight='bold'>I warn you, don't go further! You'll only find your demise there! Do not touch the...</span> *the writing ends with a blood stain*" (
        [message]
            speaker=Mehir
            message= _ "Looks like this fellow died before being able to finish his warning. Yikes!"
        [/message]
    )}
    [item]
        halo="statues/clean/statue-horhami-big.png"
        x,y=15,22
    [/item]

    {FORCE_CHANCE_TO_HIT side=2 id=SpearGuardian 30 ()} #to prevent her from just easily being killed by bats (yep, that actually happened)

    #start
    [event]
        name=start
        {VARIABLE traps 0}

        {PLACE_IMAGE "items/gohere.png" 19 1}
        [message]
            speaker=Mehir
            message= _ "So this is our old homeland... It gives me the creeps..."
        [/message]
        [message]
            speaker=Mehir
            message= _ "I can see skeletons scattered near the entrance. They seem to be quite old, clearly not belonging to Tashkar’s expedition. They must have been unfortunate adventurers seeking treasures..."
        [/message]
        [message]
            speaker=Mehir
            message= _ "As far as I can see, there are no traces of Tashkar or his troops around here. They must have been in too much of a hurry to explore the place. Nevertheless, we should make a thorough search. Maybe we will find some clues or treasures. The skeletons may be worth looting too..."
        [/message]
        [message]
            speaker=narrator
            image=portraits/narrator.png
            message= _ "Note: Mehir has become a Grand Summoner. He can now recruit a wider range of units and, as explained in the previous scenario, is capable of summoning basic elementals."
        [/message]
        [objectives]
            side=1

            [objective]
                description= _ "Move to the next chamber"
                condition=win
            [/objective]
            [objective]
                description= _ "(optional) Search the caves for treasure"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Mehir"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
            note= _ "-You can get a bit of extra gold by looting the skeletons lying on the ground.
-Explore as much as possible. The items found in this scenario will be quite useful later on."
        [/objectives]
    [/event]

    #turn 2 - a scout returns
    [event]
        name=turn 2
        [unit]
            id=scout
            type=EoMa_Carpet_Rider
            generate_name=yes
            random_traits=yes
            experience=7
            side=1
            x=17
            y=34
            facing=sw
        [/unit]
        {MOVE_UNIT id=scout 11 40}
        [message]
            speaker=scout
            message= _ "Sir, I've scouted the area. These caves are infested with rogue elementals, and are home for dangerous creatures like bats and giant spiders. It would be reasonable to proceed with caution..."
        [/message]
        [message]
            speaker=Mehir
            message= _ "I'll keep that in mind, thanks."
        [/message]
        [modify_side]
            side=2
            hidden=no
        [/modify_side]
        [modify_side]
            side=3
            hidden=no
        [/modify_side]
        {MOVE_UNIT id=scout 8 42}
        [kill]
            id=scout
            animate=no
        [/kill]
    [/event]

#define BONES_GOLD X Y
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            x,y={X},{Y}
            side=1
        [/filter]
        {RANDOM 5..25}
        [gold]
            side=1
            amount=$random
        [/gold]
        [object]
            [filter]
                x,y={X},{Y}
            [/filter]
            description= _ "Found some gold:"+" "+"$random"
        [/object]
        {CLEAR_VARIABLE random}
    [/event]
#enddef

    #levers
    {PLACE_IMAGE "items/lever-off.png" 10 2}
    {PLACE_IMAGE "items/lever-off.png" 6 13}
    {PLACE_IMAGE "items/lever-off.png" 6 25}

    #bones
    {PLACE_IMAGE "items/bones.png" 19 34}
    {BONES_GOLD 19 34}
    {PLACE_IMAGE "items/bones.png" 9 45}
    {BONES_GOLD 9 45}
    {PLACE_IMAGE "items/bones.png" 9 44}
    {BONES_GOLD 9 44}
    {PLACE_IMAGE "items/bones.png" 11 44}
    {BONES_GOLD 11 44}
    {PLACE_IMAGE "items/bones.png" 8 43}
    {BONES_GOLD 8 43}
    {PLACE_IMAGE "items/bones.png" 12 39}
    {BONES_GOLD 12 39}
    {PLACE_IMAGE "items/bones.png" 16 39}
    {BONES_GOLD 16 39}
    #keeps:
    {BONES_GOLD 14 26}
    {BONES_GOLD 14 16}
    {BONES_GOLD 14 5}

    #wake bats
    [event]
        name=attack end
        first_time_only=yes

        [fire_event]
            name=bats
        [/fire_event]
    [/event]
    [event]
        name=bats
        first_time_only=yes

        #number of bats depends on difficulty level
        {VARIABLE numb_bats 30}
        {QUANTITY numb_bats 20 30 38}
        {SCATTER_UNITS $numb_bats "Vampire Bat,Blood Bat,Dread Bat" 3 (
            terrain=Qxu
            x=1-25
            y=2-40

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=2
            #bats behaviour depends on difficulty level
            #on easy set guardian status; rest as normal
            {QUANTITY ai_special guardian guardian ()}
        )}
        #removing bats that spawn in the top-left corner which they can't escape from
        [kill]
            side=2
            [filter_location]
                x=1-9
                y=1-3
            [/filter_location]
        [/kill]
        [modify_side]
            side=3
            team_name=guards
            user_team_name= _ "Guardians"
        [/modify_side]

        [message]
            speaker=Mehir
            image="portraits/mehir-commander-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "We’ve awoken BATS!"
        [/message]
    [/event]

    ####
    #Artifacts
    ####

    #Mystic Scimitar
#define SCIMITAR_GLOW OPACITY
    halo/fire1-halo.png~SCALE(80,80)~GS()~BLEND(0,64,255,0.3)~CS(0,64,255)~O({OPACITY}%):75
#enddef
    [item]
        x,y=19,33
        halo="{SCIMITAR_GLOW 90},{SCIMITAR_GLOW 87},{SCIMITAR_GLOW 84},{SCIMITAR_GLOW 81},{SCIMITAR_GLOW 78},{SCIMITAR_GLOW 75},{SCIMITAR_GLOW 72},{SCIMITAR_GLOW 69},{SCIMITAR_GLOW 66},{SCIMITAR_GLOW 63},{SCIMITAR_GLOW 60},{SCIMITAR_GLOW 63},{SCIMITAR_GLOW 66},{SCIMITAR_GLOW 69},{SCIMITAR_GLOW 72},{SCIMITAR_GLOW 75},{SCIMITAR_GLOW 78},{SCIMITAR_GLOW 81},{SCIMITAR_GLOW 87},{SCIMITAR_GLOW 90}"
    [/item]
    {TLU_PICKUPPABLE_ITEM2 mscimitar 19 33 (type=EoMa_Novice_Summoner,EoMa_Summoner,EoMa_Grand_Summoner,EoMa_Summons_Master,EoMa_Heavy_Summoner,EoMa_Neutral_Summoner,TLU_Mehir_Commander,EoMa_Neutral_Summoner,EoMa_Grand_Summoner_lock) "items/scimitar.png" "misc/artifact-scimitar.png" ({DESCR_SCIMITAR}) _"scimitar^Take it" _"scimitar^Leave it" _"Only a summoner can use this item!" (
        [object]
            name= _ "Ancient Scimitar"
            image="items/scimitar.png"
            duration=forever
            description= _ "Scimitar damage increased by 100%, and the weapon becomes magical (always 70% chance to hit)"
            [then]
            [/then]
            [effect]
                apply_to=attack
                name=scimitar,magical scimitar
                remove_specials=magical
            [/effect]
            [effect]
                apply_to=attack
                name=scimitar,magical scimitar
                set_description= _ "ancient scimitar"
                set_icon=attacks/scimitar2.png
                duration=forever
                [set_specials]
                    mode=append
                    {WEAPON_SPECIAL_MAGICAL}
                [/set_specials]
                increase_damage=100%
            [/effect]
            [effect]
                apply_to=overlay
                add="misc/blank-hex.png~BLIT(misc/artifact-icon-scimitar.png,$unit.variables.artifact_count,0)"
            [/effect]
        [/object]
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            variable=unit
        [/store_unit]
        [set_variables]
            name=unit.modifications.trait
            mode=append

            [value]
                id=mscimitar
                name= _ "ancient scimitar"
                description= _ "This unit holds a powerful scimitar.
Effects:
Scimitar damage increased by 100%, and the weapon becomes magical (always 70% chance to hit)"
            [/value]
        [/set_variables]
        {VARIABLE_OP unit.variables.artifact_count add 10}
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
        {REMOVE_IMAGE 19 33}
        {EARTHQUAKE ()}
        {UNIT 3 (EoMa_DharmaRhami) 20 32 random_traits=yes}
        {UNIT 3 (EoMa_HoRhami) 19 32 random_traits=yes}
        [message]
            type=EoMa_HoRhami
            [not]
                id=SpearGuardian
            [/not]
            message= _ "Those who dare touch the scimitar..."
        [/message]
        [message]
            type=EoMa_DharmaRhami
            message= _ "...MUST DIE!!!"
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "Err... can't we negotiate? There's no need for violence!"
            [/message]
            [message]
                type=EoMa_HoRhami
                [not]
                    id=SpearGuardian
                [/not]
                message= _ "Have we not made our point clear enough, mortal? When we want someone dead, there will be no negotiations!"
            [/message]
            [message]
                speaker=Mehir
                message= _ "Damn it! I guess we have no choice now. Men, defensive formation!"
            [/message]
        ) ()}
    )}

    #Golden Carpet
    {TLU_PICKUPPABLE_ITEM GCarpet 8 19 (type=EoMa_Carpet_Rider,EoMa_Carpet_Master) "items/carpet.png" "misc/artifact-carpet.png" ({DESCR_CARPET}) _"carpet^Take it" _"carpet^Leave it" _"Only the carpet rider can use this item!" (
        [object]
            name= _ "Golden Carpet"
            image=items/carpet.png
            duration=forever
            description= _ "Advances the unit (unless the unit is already at maximum level)
Speed increases by 50%"
            [filter]
                x,y=8,19
                type=EoMa_Carpet_Rider,EoMa_Carpet_Master
            [/filter]
            [effect]
                apply_to=movement
                increase=50%
            [/effect]
            [effect]
                apply_to=overlay
                add="misc/blank-hex.png~BLIT(misc/artifact-icon-carpet.png,$unit.variables.artifact_count,0)"
            [/effect]
            [then]
                {ADVANCE_UNIT x,y=$x1,$y1 ""}
            [/then]
        [/object]
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            variable=unit
        [/store_unit]
        [set_variables]
            name=unit.modifications.trait
            mode=append

            [value]
                id=gcarpet
                name= _ "golden carpet"
                description= _ "This unit flies on the ancient Golden Carpet.

Effects:
Speed increases by 50%"
            [/value]
        [/set_variables]
        {VARIABLE_OP unit.variables.artifact_count add 10}
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
    )}

    #Chest
    [item]
        image=items/chest.png
        x,y=8,18
    [/item]
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            x,y=8,18
            side=1
        [/filter]
        [message]
            race=eoma_summoner
            x,y=8,18
            message= _ "I’ve found a chest full of gold!"
        [/message]
        #new line:
        [message]
            type_adv_tree=EoMa_Rhami,EoMa_Jinn
            x,y=8,18
            message= _ "My liege, I’ve found a chest full of gold!"
        [/message]
        [object]
            [filter]
                x,y=8,18
            [/filter]
            description= _ "300 gold"
        [/object]
        [gold]
            side=1
            amount=300
        [/gold]
        {REMOVE_IMAGE 8 18}
    [/event]

    #Ring of regeneration
#define RING_GLOW OPACITY
    halo/fire1-halo.png~SCALE(80,80)~SCALE(24,24)~GS()~BLEND(255,0,0,0.4)~CS(250,0,0)~O({OPACITY}%):75
#enddef
    [item]
        x,y=24,20
        halo="{RING_GLOW 90},{RING_GLOW 87},{RING_GLOW 84},{RING_GLOW 81},{RING_GLOW 78},{RING_GLOW 75},{RING_GLOW 72},{RING_GLOW 69},{RING_GLOW 66},{RING_GLOW 63},{RING_GLOW 60},{RING_GLOW 63},{RING_GLOW 66},{RING_GLOW 69},{RING_GLOW 72},{RING_GLOW 75},{RING_GLOW 78},{RING_GLOW 81},{RING_GLOW 87},{RING_GLOW 90}"
    [/item]
    {TLU_PICKUPPABLE_ITEM regenring 24 20 (race=eoma_summoner) "items/ring-red.png" "misc/artifact-ring.png" ({DESCR_RING}) _"ring^Take it" _"ring^Leave it" _"Only a human can use this item!" (
        [object]
            name= _ "Ring of Regeneration"
            image=items/ring-red.png
            duration=forever
            description= _ "This ring will heal the bearer by 8 hitpoints each turn."
            [filter]
                race=eoma_summoner
                x,y=24,20
            [/filter]
            [then]
            [/then]
            [effect]
                apply_to=new_ability
                [abilities]
                    {ABILITY_EOMA_REGENERATES}
                [/abilities]
            [/effect]
            [effect]
                apply_to=overlay
                add="misc/blank-hex.png~BLIT(misc/artifact-icon-regenring.png,$unit.variables.artifact_count,0)"
            [/effect]
        [/object]
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            variable=unit
        [/store_unit]
        [set_variables]
            name=unit.modifications.trait
            mode=append

            [value]
                id=regenring
                name= _ "ring of regeneration"
                description= _ "This unit wears the Ring of Regeneration.

Effects:
Grants the regeneration ability"
            [/value]
        [/set_variables]
        {VARIABLE_OP unit.variables.artifact_count add 10}
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
        {REMOVE_IMAGE 24 20}
    )}

    #Desert Cloak
    {TLU_PICKUPPABLE_ITEM DCloak 3 29 (type=EoMa_Camel_Rider,EoMa_Heavy_Camel_Rider,EoMa_Camel_Master) "items/cloak.png" "misc/artifact-cloak.png" ({DESCR_CLOAK}) _"cloak^Take it" _"cloak^Leave it" _"Only a camel rider (or his advancements) can use this item!" (
        [object]
            name= _ "Desert Cloak"
            image=items/cloak.png
            duration=forever
            description= _ "Advances the unit (unless the unit is already at maximum level)
Grants 50% fire resistance"
            [filter]
                x,y=3,29
                type=EoMa_Camel_Rider,EoMa_Heavy_Camel_Rider,EoMa_Camel_Master
            [/filter]
            [effect]
                apply_to=resistance
                replace=true
                [resistance]
                    fire=50
                [/resistance]
            [/effect]
            [effect]
                apply_to=overlay
                add="misc/blank-hex.png~BLIT(misc/artifact-icon-cloak.png,$unit.variables.artifact_count,0)"
            [/effect]
            [then]
                {ADVANCE_UNIT x,y=$x1,$y1 ""}
            [/then]
        [/object]
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            variable=unit
        [/store_unit]
        [set_variables]
            name=unit.modifications.trait
            mode=append

            [value]
                id=dcloak
                name= _ "desert cloak"
                description= _ "This unit wears the famous Desert Cloak of ancients.

Effects:
Grants 50% fire resistance"
            [/value]
        [/set_variables]
        {VARIABLE_OP unit.variables.artifact_count add 10}
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
    )}

    #Cap of Power
#define CAP_GLOW OPACITY
    halo/fire1-halo.png~SCALE(42,42)~GS()~BLEND(0,64,255,0.3)~CS(0,64,255)~O({OPACITY}%):75
#enddef
    [item]
        x,y=3,21
        halo="{CAP_GLOW 90},{CAP_GLOW 87},{CAP_GLOW 84},{CAP_GLOW 81},{CAP_GLOW 78},{CAP_GLOW 75},{CAP_GLOW 72},{CAP_GLOW 69},{CAP_GLOW 66},{CAP_GLOW 63},{CAP_GLOW 60},{CAP_GLOW 63},{CAP_GLOW 66},{CAP_GLOW 69},{CAP_GLOW 72},{CAP_GLOW 75},{CAP_GLOW 78},{CAP_GLOW 81},{CAP_GLOW 87},{CAP_GLOW 90}"
    [/item]
    {TLU_PICKUPPABLE_ITEM2 Cap 3 21 (type=EoMa_Novice_Summoner,EoMa_Summoner,EoMa_Grand_Summoner,EoMa_Summons_Master,TLU_Mehir_Commander,EoMa_Heavy_Summoner,EoMa_Neutral_Summoner) "items/cap.png" "misc/artifact-cap.png" ({DESCR_CAP}) _"cap^Take it" _"cap^Leave it" _"Only a summoner can use this item!" (
        [object]
            name= _ "Cap of Power"
            image=items/cap.png
            duration=forever
            description= _ "Increases magical power by 20%
Decreases experience points needed for advancement by 25%"
            [effect]
                apply_to=attack
                name=scroll
                increase_damage=20%
            [/effect]
            [effect]
                apply_to=attack
                name=magic arrow
                increase_damage=20%
            [/effect]
            [effect]
                apply_to=attack
                name=circle of destruction
                increase_damage=20%
            [/effect]
            [effect]
                apply_to=attack
                name=ema
                increase_damage=20%
            [/effect]
            [effect]
                apply_to=attack
                name=circlebalance
                increase_damage=20%
            [/effect]
            [effect]
                apply_to=attack
                name=incantation of power
                increase_damage=20%
            [/effect]
            [effect]
                apply_to=max_experience
                increase=-25%
            [/effect]
            [effect]
                apply_to=overlay
                add="misc/blank-hex.png~BLIT(misc/artifact-icon-cap.png,$unit.variables.artifact_count,0)"
            [/effect]
        [/object]
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            variable=unit
        [/store_unit]
        [set_variables]
            name=unit.modifications.trait
            mode=append

            [value]
                id=capofpower
                name= _ "cap of power"
                description= _ "This unit wears a magical cap, which enhances its magical power.

Effects:
Increases magical power by 20%
Decreases experience points needed for advancement by 25%"
            [/value]
        [/set_variables]
        {VARIABLE_OP unit.variables.artifact_count add 10}
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
        {REMOVE_IMAGE 3 21}
        [if]
            [have_unit]
                id=Mehir
                trait=capofpower
            [/have_unit]
            [then]
                {VARIABLE portrait_cap misc/portrait-cap.png}
            [/then]
        [/if]
        [fire_event]
            name=portraits
        [/fire_event]
    )}

    #Ghost Boss
    [event]
        name=moveto

        [filter]
            side=1
            [filter_location]
                x,y=9,22
                radius=6
            [/filter_location]
        [/filter]

        {UNIT 3 (TLU_Summons_Master_Ghost) 9 22 (
            id=Ghost
            name=_"Samir"
        )}

        [message]
            speaker=Ghost
            message= _ "Who... who is here? Where am I?"
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "A ghost? That's something new..."
            [/message]
        ) (
            [message]
                speaker=Mehir
                image="portraits/mehir-commander-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "EEEEEK! A GHOST!!!"
            [/message]
        )}
        [message]
            speaker=Ghost
            message= _ "Rashti, is that you? Do you remember me, your first master? So many centuries have passed..."
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "Listen grandpa, I don't know who are you talking to but you'd better rest."
            [/message]
        ) (
            [message]
                speaker=Mehir
                image="portraits/mehir-commander-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "Wh..what? Err... I think he might be lost in his memories of mortal life..."
            [/message]
        )}
        [message]
            speaker=Ghost
            message= _ "Who are these people with you? Why are you fading away? Rashti? RASHTI?! Wait... you are not Rashti... She is here but not with you. You took her from me! You... YOU!!! DIE!!!"
        [/message]
#ifdef NORMAL
        {UNIT 3 (EoMa_RhamiKai) 10 21 (moves,attacks_left,placement,animate,facing=0,0,map_pass,yes,se)}
        {UNIT 3 (EoMa_RhamiDatu) 8 22 (moves,attacks_left,placement,animate,facing=0,0,map_pass,yes,ne)}
#endif
#ifdef HARD
        {UNIT 3 (EoMa_RhamiKai) 10 21 (moves,attacks_left,placement,animate,facing=0,0,map_pass,yes,se)}
        {UNIT 3 (EoMa_RhamiDatu) 8 22 (moves,attacks_left,placement,animate,facing=0,0,map_pass,yes,ne)}
#endif
        [message]
            speaker=Mehir
            message= _ "I guess we pissed him off. He must be one of those ancient summoners the Instructor told me about in Sud-Affar..."
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "Another maniac... It's time to make him rest in peace ...for good this time."
            [/message]
        ) (
            [message]
                speaker=Mehir
                message= _ "We have to put him down somehow. I wonder how this can be done. He is dead already... Maybe we can destroy the circle with magic?"
            [/message]
        )}
    [/event]

    #Ghost summoning action
    [event]
        name=side 3 turn
        first_time_only=no

        [if]
            [have_unit]
                id=Ghost
            [/have_unit]
            [then]
                [store_unit]
                    [filter]
                        id=Ghost
                    [/filter]
                    variable=ghost
                [/store_unit]
                [store_locations]
                    [and]
                        x,y=$ghost.x,$ghost.y
                        radius=1
                    [/and]
                    [not]
                        [filter]
                        [/filter]
                    [/not]
                    variable=ghostcircle
                [/store_locations]
                {IF_VAR ghostcircle.length greater_than 0 (
                    [then]
                        {VARIABLE summonturn $turn_number}
                        {VARIABLE_OP summonturn modulo 2}
                        {IF_VAR summonturn equals 1 (
                            [then]
                                {RANDOM 1..4}
                                [switch]
                                    variable=random
                                    [case]
                                        value=1
                                        {UNIT 3 (EoMa_Fire_Avatar) $ghost.x $ghost.y (moves,attacks_left,placement,passable,animate=0,0,map,yes,yes)}
                                    [/case]
                                    [case]
                                        value=2
                                        {UNIT 3 (EoMa_RhamiDatu) $ghost.x $ghost.y (moves,attacks_left,placement,passable,animate=0,0,map,yes,yes)}
                                    [/case]
                                    [case]
                                        value=3
                                        {UNIT 3 (EoMa_RhamiKai) $ghost.x $ghost.y (moves,attacks_left,placement,passable,animate=0,0,map,yes,yes)}
                                    [/case]
                                    [case]
                                        value=4
                                        {UNIT 3 (EoMa_Air_Avatar) $ghost.x $ghost.y (moves,attacks_left,placement,passable,animate=0,0,map,yes,yes)}
                                    [/case]
                                [/switch]
                            [/then]
                        )}
                    [/then]
                )}
            [/then]
        [/if]
        {CLEAR_VARIABLE ghost}
        {CLEAR_VARIABLE ghostcircle}
        {CLEAR_VARIABLE summonturn}
    [/event]

    #Ghost defeated
    [event]
        name=last breath

        [filter]
            id=Ghost
        [/filter]

        [message]
            speaker=Ghost
            message= _ "Now I see it... She has chosen you. Treat her well... She is the Golden Lady..."
        [/message]
        {VARIABLE ghost_defeated yes}
        [if]
            [have_unit]
                side=3
                [not]
                    id=Ghost
                [/not]
                [not]
                    id=SpearGuardian
                [/not]
                [not]
                    type=EoMa_Earth_Avatar,EoMa_Earth_Elemental,EoMa_Earth_God
                [/not]
            [/have_unit]
            [then]
                [message]
                    speaker=Ghost
                    message= _ "My magical servants, you may return to the Abyss! Farewell, stranger, and thank you for releasing me from this prison..."
                [/message]

                [store_unit]
                    [filter]
                        side=3
                        [not]
                            id=Ghost
                        [/not]
                        [not]
                            id=SpearGuardian
                        [/not]
                        [not]
                            type=EoMa_Earth_Avatar,EoMa_Earth_Elemental,EoMa_Earth_God
                        [/not]
                    [/filter]
                    variable=servants
                [/store_unit]

                [foreach]
                    array=servants
                    [do]
                        [animate_unit]
                            flag=banished
                            [filter]
                                id=$this_item.id
                            [/filter]
                        [/animate_unit]
                        [object]
                            silent=yes
                            take_only_once=no
                            [effect]
                                apply_to=type
                                name=EoMa_Dimensional_Gate_II
                            [/effect]
                            [filter]
                                id=$this_item.id
                            [/filter]
                        [/object]
                        [kill]
                            id=$this_item.id
                            animate=yes
                        [/kill]
                    [/do]
                [/foreach]

                {CLEAR_VARIABLE servants}
            [/then]
            [else]
                [message]
                    speaker=Ghost
                    message= _ "Farewell, stranger, and thank you for releasing me from this prison..."
                [/message]
            [/else]
        [/if]
    [/event]
    [event]
        name=die

        [filter]
            id=Ghost
        [/filter]

        [message]
            speaker=Mehir
            message= _ "That was very weird, but he's gone now! Phew! I wonder what he meant, though..."
        [/message]
    [/event]

    #Cuirras
#define CUIRASS_GLOW OPACITY
    halo/fire1-halo.png~SCALE(80,80)~GS()~BLEND(255,255,255,0.2)~O({OPACITY}%):75
#enddef
    [item]
        x,y=24,6
        halo="{CUIRASS_GLOW 90},{CUIRASS_GLOW 87},{CUIRASS_GLOW 84},{CUIRASS_GLOW 81},{CUIRASS_GLOW 78},{CUIRASS_GLOW 75},{CUIRASS_GLOW 72},{CUIRASS_GLOW 69},{CUIRASS_GLOW 66},{CUIRASS_GLOW 63},{CUIRASS_GLOW 60},{CUIRASS_GLOW 63},{CUIRASS_GLOW 66},{CUIRASS_GLOW 69},{CUIRASS_GLOW 72},{CUIRASS_GLOW 75},{CUIRASS_GLOW 78},{CUIRASS_GLOW 81},{CUIRASS_GLOW 87},{CUIRASS_GLOW 90}"
    [/item]
    {TLU_PICKUPPABLE_ITEM2 Cuirras 24 6 race=eoma_summoner "items/armor.png" "misc/artifact-armor.png" ({DESCR_ARMOR}) _"armor^Take it" _"armor^Leave it" _"Only humans can use this item!" (
        [object]
            name= _ "Cuirass of the Ancients"
            image=items/armor.png
            duration=forever
            description= _ "Increases physical resistances by 25%
Increases fire and cold resistances by 20%
Decreases arcane resistance by 15%"
            [effect]
                apply_to=resistance
                [resistance]
                    blade=-25
                    pierce=-25
                    impact=-25
                    fire=-20
                    cold=-20
                    arcane=15
                [/resistance]
            [/effect]
            [effect]
                apply_to=overlay
                add="misc/blank-hex.png~BLIT(misc/artifact-icon-armor.png,$unit.variables.artifact_count,0)"
            [/effect]
            [then]
                {REMOVE_IMAGE 24 6}
                {QUAKE ("silence.ogg")}
                [if]
                    [have_unit]
                        id=Mehir
                        x,y=24,6
                    [/have_unit]
                    [then]
                        {VARIABLE portrait_armor misc/portrait-armor-commander.png}
                        {MODIFY_UNIT id=Mehir profile "portraits/mehir-commander.png~BLIT($portrait_cap,0,0)~BLIT($portrait_armor,0,0)"}#force portrait change inside [object]
                    [/then]
                [/if]
                [message]
                    speaker=unit
                    message= _ "The ground is shaking..."
                [/message]
                {VARIABLE fall 99}
            [/then]
        [/object]
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            variable=unit
        [/store_unit]
        [set_variables]
            name=unit.modifications.trait
            mode=append

            [value]
                id=cota
                name= _ "ancient cuirass"
                description= _ "This unit is wearing a powerful armor, which grants additional physical resistance, but also increases susceptibility to arcane damage.

Effects:
Increases physical resistances by 25%
Increases fire and cold resistances by 20%
Decreases arcane resistance by 15%"
            [/value]
        [/set_variables]
        {VARIABLE_OP unit.variables.artifact_count add 10}
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
        [fire_event]
            name=portraits
        [/fire_event]
    )}

    #Spear
    {TLU_PICKUPPABLE_ITEM Spear 4 13 (type=EoMa_Rhami,EoMa_RhamiKai,EoMa_HoRhami) "items/spear-rhami.png" "misc/artifact-spear.png"  ({DESCR_SPEAR}) _"spear^Take it" _"spear^Leave it" _"Only a Rhami or Rhami’kai can use this item!" (
        [object]
            name= _ "Spear of the Rhami"
            image=items/spear-rhami.png
            duration=forever
            description= _ "Advances the unit (unless the unit is already at maximum level)
Increases the attack by 25%
Increases magical resistances by 10%"
            [filter]
                x,y=4,13
                type=EoMa_Rhami,EoMa_RhamiKai,EoMa_HoRhami
            [/filter]
            [effect]
                apply_to=attack
                name=trident
                increase_damage=25%
            [/effect]
            [effect]
                apply_to=attack
                name=trident2
                increase_damage=25%
            [/effect]
            [effect]
                apply_to=resistance
                [resistance]
                    arcane=-10
                    fire=-10
                    cold=-10
                [/resistance]
            [/effect]
            [effect]
                apply_to=overlay
                add="misc/blank-hex.png~BLIT(misc/artifact-icon-spear.png,$unit.variables.artifact_count,0)"
            [/effect]
        [/object]
        [if]
            [have_unit]
                x,y=4,13
                type=EoMa_Rhami
            [/have_unit]
            [then]
                {ADVANCE_UNIT x,y=$x1,$y1 "EoMa_RhamiKai"}
            [/then]
            [else]
                [if]
                    [have_unit]
                        x,y=4,13
                        type=EoMa_RhamiKai
                    [/have_unit]
                    [then]
                        {ADVANCE_UNIT x,y=$x1,$y1 "EoMa_HoRhami"}
                    [/then]
                [/if]
            [/else]
        [/if]
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            variable=unit
        [/store_unit]
        [set_variables]
            name=unit.modifications.trait
            mode=append

            [value]
                id=spearrhami
                name= _ "spear of rhami"
                description= _ "This unit is holding a powerful spear of abysmal origin.

Effects:
Increases the attack by 20%"
            [/value]
        [/set_variables]
        {VARIABLE_OP unit.variables.artifact_count add 10}
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
    )}

    #Spear Guardian attacks
    [event]
        name=attack end
        [filter]
            id=SpearGuardian
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Mehir
            message= _ "Creature! Why are you attacking us?! Don't you see we are Summoners? Who is your master? Answer me, now!"
        [/message]
        [message]
            speaker=SpearGuardian
            message= _ "I bow before no man. The only being I serve is the the Holy Rashti'rhami - the goddess of all Rhamis. It was her who, 392 years ago, ordered me to protect the Spear of the First Rhami'kai. There are only two ways I can be released from this post - either by her order, or by being defeated in battle. And if to achieve the latter I have to attack every treasure hunter that steps foot in this place, so be it."
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "Hmmm.... (lies) We were looking for you. You see, I am a messenger sent by Rashti herself. She ordered me to... err.. find you and release you from your post. Yes, she was too busy to do this in person. After all, being the queen of the Abyss, she has more important matters to attend to than looking for another dusty guardian in a forgotten cave."
            [/message]
            [message]
                speaker=Mehir
                message= _ "So here I am. By the order of Rashti'rhami herself, you are relieved!"
            [/message]
            [message]
                speaker=SpearGuardian
                message= _ "(with excitement in her voice) Really? Thank you so much! Since I am free now, can I join you?"
            [/message]
            [message]
                speaker=Mehir
                message= _ "Yeah, why not? By the way, could you do something about those elemental guardians? They've been quite an annoyance so far."
            [/message]
            {MODIFY_UNIT id=SpearGuardian side 1}
            [message]
                speaker=SpearGuardian
                message= _ "They will not attack you when I am on your side."
            [/message]
            [modify_side]
                side=3
                team_name=mehirteam
            [/modify_side]
            [message]
                speaker=Mehir
                message= _ "Nice! Could you also convince them to join us? A few Earth Gods would certainly come in handy..."
            [/message]
            [message]
                speaker=SpearGuardian
                message= _  "I am sorry, but they do not obey me. They were ordered to protect this place forever, and aren't mentally capable of taking orders from those other than their masters."
            [/message]
            [message]
                speaker=Mehir
                message= _ "I see. At least we can count on you, hehe..."
            [/message]
        ) (
            [message]
                speaker=SpearGuardian
                message= _ "To give you a reason to fulfill my demand, if you defeat me, you shall prove yourselves worthy of wielding this sacred relic of our kind."
            [/message]
            [message]
                speaker=Mehir
                message= _ "Alright men, you heard her. Time to earn ourselves a legendary spear!"
            [/message]
        )}
    [/event]
    [event]
        name=last breath
        [filter]
            id=SpearGuardian
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=SpearGuardian
            message= _ "She was right, you are worthy..."
        [/message]
    [/event]

    #collar
    [item]
        x,y=1,7
        halo="{CAP_GLOW 90},{CAP_GLOW 87},{CAP_GLOW 84},{CAP_GLOW 81},{CAP_GLOW 78},{CAP_GLOW 75},{CAP_GLOW 72},{CAP_GLOW 69},{CAP_GLOW 66},{CAP_GLOW 63},{CAP_GLOW 60},{CAP_GLOW 63},{CAP_GLOW 66},{CAP_GLOW 69},{CAP_GLOW 72},{CAP_GLOW 75},{CAP_GLOW 78},{CAP_GLOW 81},{CAP_GLOW 87},{CAP_GLOW 90}"
    [/item]
    {TLU_PICKUPPABLE_ITEM Collar 1 7 (race=eoma_magical) "items/collar.png" "misc/artifact-collar.png" ({DESCR_COLLAR}) _"collar^Take it" _"collar^Leave it" _"Only a magical entity can use this item!" (
        [object]
            name= _ "Collar of Recall"
            image=items/collar.png
            duration=forever
            description= _ "The unit is recalled back to the leader when dies
After each recall the unit becomes stronger
The unit can be recalled only 3 times. After that it dies for sure."
            [filter]
                x,y=1,7
                race=eoma_magical
            [/filter]
            [effect]
                apply_to=overlay
                add="misc/blank-hex.png~BLIT(misc/artifact-icon-collar.png,$unit.variables.artifact_count,0)"
            [/effect]
            [effect]
                apply_to=new_animation
                [animation]
                    apply_to=flash

                    [frame]
                        duration=400
                    [/frame]
                    [flash_frame]
                        duration=400
                        image="projectiles/secrethit.png"
                        alpha=1.0~0.0:400
                        y=-3
                        layer=99
                    [/flash_frame]
                [/animation]
            [/effect]
            [then]
            [/then]
        [/object]
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            variable=unit
        [/store_unit]
        [set_variables]
            name=unit.modifications.trait
            mode=append

            [value]
                id=collar
                name= _ "collar"
                description= _ "After death the unit is recalled back to the leader. Activates only 3 times."
            [/value]
        [/set_variables]
        {VARIABLE unit.status.collar yes}
        {VARIABLE unit.status.firstrecall yes}
        {VARIABLE unit.status.secondrecall yes}
        {VARIABLE unit.status.thirdrecall yes}
        {VARIABLE collar_slot $unit.variables.artifact_count}
        {VARIABLE_OP unit.variables.artifact_count add 10}
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
        [unit_overlay]
            id=$unit.id
            image="misc/blank-hex.png~BLIT(misc/artifact-icon-collar3.png,$collar_slot,0)"
        [/unit_overlay]
        {REMOVE_IMAGE 1 7}
    )}

    #amulet
#define AMULET_GLOW_FIRE OPACITY
    halo/fire1-halo.png~SCALE(50,50)~GS()~BLEND(255,64,0,0.5)~CS(255,64,0)~O({OPACITY}%):75
#enddef
#define AMULET_GLOW_AIR OPACITY
    halo/fire1-halo.png~SCALE(50,50)~GS()~BLEND(255,255,255,0.1)~O({OPACITY}%):75
#enddef
#define AMULET_GLOW_WATER OPACITY
    halo/fire1-halo.png~SCALE(50,50)~GS()~BLEND(0,64,255,0.3)~CS(0,64,255)~O({OPACITY}%):75
#enddef
#define AMULET_GLOW_EARTH OPACITY
    halo/fire1-halo.png~SCALE(50,50)~GS()~BLEND(139,69,19,0.5)~CS(139,69,19)~O({OPACITY}%):75
#enddef
    [item]
        x,y=9,4
        halo="{AMULET_GLOW_FIRE 60},{AMULET_GLOW_FIRE 63},{AMULET_GLOW_FIRE 66},{AMULET_GLOW_FIRE 69},{AMULET_GLOW_FIRE 72},{AMULET_GLOW_FIRE 75},{AMULET_GLOW_FIRE 78},{AMULET_GLOW_FIRE 81},{AMULET_GLOW_FIRE 87},{AMULET_GLOW_FIRE 90},{AMULET_GLOW_FIRE 87},{AMULET_GLOW_FIRE 84},{AMULET_GLOW_FIRE 81},{AMULET_GLOW_FIRE 78},{AMULET_GLOW_FIRE 75},{AMULET_GLOW_FIRE 72},{AMULET_GLOW_FIRE 69},{AMULET_GLOW_FIRE 66},{AMULET_GLOW_FIRE 63},{AMULET_GLOW_AIR 60},{AMULET_GLOW_AIR 63},{AMULET_GLOW_AIR 66},{AMULET_GLOW_AIR 69},{AMULET_GLOW_AIR 72},{AMULET_GLOW_AIR 75},{AMULET_GLOW_AIR 78},{AMULET_GLOW_AIR 81},{AMULET_GLOW_AIR 87},{AMULET_GLOW_AIR 90},{AMULET_GLOW_AIR 87},{AMULET_GLOW_AIR 84},{AMULET_GLOW_AIR 81},{AMULET_GLOW_AIR 78},{AMULET_GLOW_AIR 75},{AMULET_GLOW_AIR 72},{AMULET_GLOW_AIR 69},{AMULET_GLOW_AIR 66},{AMULET_GLOW_AIR 63},{AMULET_GLOW_WATER 60},{AMULET_GLOW_WATER 63},{AMULET_GLOW_WATER 66},{AMULET_GLOW_WATER 69},{AMULET_GLOW_WATER 72},{AMULET_GLOW_WATER 75},{AMULET_GLOW_WATER 78},{AMULET_GLOW_WATER 81},{AMULET_GLOW_WATER 87},{AMULET_GLOW_WATER 90},{AMULET_GLOW_WATER 87},{AMULET_GLOW_WATER 84},{AMULET_GLOW_WATER 81},{AMULET_GLOW_WATER 78},{AMULET_GLOW_WATER 75},{AMULET_GLOW_WATER 72},{AMULET_GLOW_WATER 69},{AMULET_GLOW_WATER 66},{AMULET_GLOW_WATER 63},{AMULET_GLOW_EARTH 60},{AMULET_GLOW_EARTH 63},{AMULET_GLOW_EARTH 66},{AMULET_GLOW_EARTH 69},{AMULET_GLOW_EARTH 72},{AMULET_GLOW_EARTH 75},{AMULET_GLOW_EARTH 78},{AMULET_GLOW_EARTH 81},{AMULET_GLOW_EARTH 87},{AMULET_GLOW_EARTH 90},{AMULET_GLOW_EARTH 87},{AMULET_GLOW_EARTH 84},{AMULET_GLOW_EARTH 81},{AMULET_GLOW_EARTH 78},{AMULET_GLOW_EARTH 75},{AMULET_GLOW_EARTH 72},{AMULET_GLOW_EARTH 69},{AMULET_GLOW_EARTH 66},{AMULET_GLOW_EARTH 63}"
    [/item]
    {TLU_PICKUPPABLE_ITEM Amulet_Elem 9 4 (type=EoMa_Water_Elemental,EoMa_Fire_Elemental,EoMa_Air_Elemental,EoMa_Earth_Elemental,EoMa_Water_Avatar,EoMa_Fire_Avatar,EoMa_Air_Avatar,EoMa_Earth_Avatar,EoMa_Water_God,EoMa_Fire_God,EoMa_Air_God,EoMa_Earth_God) "items/necklace.png" "misc/artifact-amulet.png" ({DESCR_AMULET}) _"amulet^Take it" _"amulet^Leave it" _"Only the elemental entity can use this item!" (
        [object]
            name= _ "Amulet of Metamorph"
            image=items/necklace.png
            duration=forever
            description= _ "The elemental unit can turn into another elemental (use right-click on the unit to activate)"
            [filter]
                x,y=9,4
                type=EoMa_Water_Elemental,EoMa_Fire_Elemental,EoMa_Air_Elemental,EoMa_Earth_Elemental,EoMa_Water_Avatar,EoMa_Fire_Avatar,EoMa_Air_Avatar,EoMa_Earth_Avatar,EoMa_Water_God,EoMa_Fire_God,EoMa_Air_God,EoMa_Earth_God
            [/filter]
            [effect]
                apply_to=new_ability
                [abilities]
                    {ABILITY_AMULET_METAMORPH}
                [/abilities]
            [/effect]
            [effect]
                apply_to=overlay
                add="misc/blank-hex.png~BLIT(misc/artifact-icon-amulet.png,$unit.variables.artifact_count,0)"
            [/effect]
            [then]
                [store_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    variable=modified
                [/store_unit]
                {VARIABLE modified.status.amulet_elem yes}
                {VARIABLE_OP unit.variables.artifact_count add 10}
                [unstore_unit]
                    variable=modified
                    find_vacant=no
                [/unstore_unit]
                {REMOVE_IMAGE 9 4}
                {CLEAR_VARIABLE modified}
                {METAMORPH_ALL}
            [/then]
        [/object]
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            variable=unit
        [/store_unit]
        [set_variables]
            name=unit.modifications.trait
            mode=append

            [value]
                id=metamorph
                name= _ "metamorph"
                description= _ "This elemental wears the Amulet of Metamorph.

Effects:
The elemental unit can turn into another elemental (use right-click on the unit to activate).
The unit becomes loyal."
            [/value]
        [/set_variables]
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
        {MAKE_LOYAL_NORMAL $unit.id}
    )}
    #Banishment
    {TLU_PICKUPPABLE_ITEM Staff 12 35 (type=EoMa_Novice_Summoner,EoMa_Dispeller,EoMa_Banisher) "items/staff-magic.png" "misc/artifact-staff.png" ({DESCR_STAFF}) _"staff^Take it" _"staff^Leave it" _"Only a Novice Summoner, Dispeller or Banisher can use this item!" (
        [object]
            name= _ "Banishment Staff"
            image=items/staff.png
            duration=forever
            description= _ "- Advances the unit (unless the unit is already at maximum level)
- the banishment attack never misses
- the staff/frozen gate attacks deal +2 damage 
- increases magical resistances by 10%"
            [filter]
                x,y=12,35
                type=EoMa_Novice_Summoner,EoMa_Dispeller,EoMa_Banisher
            [/filter]
            [effect]
                apply_to=attack
                name=banishment
                [set_specials]
                    mode=append
                    {WEAPON_SPECIAL_EOMA_ALWAYSHITS}
                [/set_specials]
            [/effect]
            [effect]
                apply_to=attack
                name=staff
                set_icon=attacks/staff-magic.png
                increase_damage=2
            [/effect]
            [effect]
                apply_to=attack
                name=frozen gate
                increase_damage=2
            [/effect]
            [effect]
                apply_to=overlay
                add="misc/blank-hex.png~BLIT(misc/artifact-icon-staff.png,$unit.variables.artifact_count,0)"
            [/effect]
        [/object]
        [if]
            [have_unit]
                x,y=12,35
                type=EoMa_Novice_Summoner
            [/have_unit]
            [then]
                {ADVANCE_UNIT x,y=$x1,$y1 "EoMa_Dispeller"}
            [/then]
            [else]
                [if]
                    [have_unit]
                        x,y=12,35
                        type=EoMa_Dispeller
                    [/have_unit]
                    [then]
                        {ADVANCE_UNIT x,y=$x1,$y1 "EoMa_Banisher"}
                    [/then]
                [/if]
            [/else]
        [/if]
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]
            variable=unit
        [/store_unit]
        [set_variables]
            name=unit.modifications.trait
            mode=append

            [value]
                id=staffbanisher
                name= _ "banishment staff"
                description= _ "This unit is holding a powerful staff which once belonging to the first Master of Banishers.

Effects:
- the banishment attack never misses
- the staff/frozen gate attacks deal +2 damage 
- increases magical resistances by 10%"
            [/value]
        [/set_variables]
        {VARIABLE_OP unit.variables.artifact_count add 10}
        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
    )}

    #Access amulet
    #Location 1
    [event]
        name=moveto
        [filter]
            x,y=10,2
            side=1
        [/filter]
        [message]
            race=eoma_summoner
            x,y=$x1,$y1
            message= _ "Sir, there's some kind of lever here..."
        [/message]
        [message]
            type=EoMa_Rhami,EoMa_RhamiDatu,EoMa_RhamiKai,EoMa_HoRhami,EoMa_DharmaRhami
            x,y=$x1,$y1
            message= _ "Master, I found some kind of lever..."
        [/message]
        {REMOVE_IMAGE 10 2}
        {PLACE_IMAGE "items/lever-on.png" 10 2}
        [sound]
            name=explosion.ogg
        [/sound]
        [terrain]
            terrain=Uu^Xy/
            x,y=11,3
            layer=overlay
        [/terrain]
        [redraw]
        [/redraw]

        {TRAPS_MESSAGE}

        {VARIABLE_OP traps add 1}
    [/event]
    #Location 2
    [event]
        name=moveto
        [filter]
            x,y=6,13
            side=1
        [/filter]
        [message]
            race=eoma_summoner
            x,y=$x1,$y1
            message= _ "There's some kind of lever here, sir..."
        [/message]
        [message]
            type=EoMa_Rhami,EoMa_RhamiDatu,EoMa_RhamiKai,EoMa_HoRhami,EoMa_DharmaRhami
            x,y=$x1,$y1
            message= _ "Master, I found some kind of lever..."
        [/message]
        {REMOVE_IMAGE 6 13}
        {PLACE_IMAGE "items/lever-on.png" 6 13}
        [sound]
            name=explosion.ogg
        [/sound]
        [terrain]
            terrain=Uu^Xy\
            x=8,9,10
            y=13,14,14
            layer=overlay
        [/terrain]
        [redraw]
        [/redraw]

        {TRAPS_MESSAGE}

        {VARIABLE_OP traps add 1}
    [/event]
    #Location 3
    [event]
        name=moveto
        [filter]
            x,y=6,25
            side=1
        [/filter]
        [message]
            race=eoma_summoner
            x,y=$x1,$y1
            message= _ "Sir, there's some kind of lever here..."
        [/message]
        [message]
            type=EoMa_Rhami,EoMa_RhamiDatu,EoMa_RhamiKai,EoMa_HoRhami,EoMa_DharmaRhami
            x,y=$x1,$y1
            message= _ "Master, I found some kind of lever..."
        [/message]
        {REMOVE_IMAGE 6 25}
        {PLACE_IMAGE "items/lever-on.png" 6 25}
        [sound]
            name=explosion.ogg
        [/sound]
        [terrain]
            terrain=Uu^Xy/
            x=6,7,8
            y=26,26,25
            layer=overlay
        [/terrain]
        [redraw]
        [/redraw]

        {TRAPS_MESSAGE}

        {VARIABLE_OP traps add 1}
    [/event]
    #Reveal Amulet Location
    [event]
        name=amulet
        [terrain]
            terrain=Rr
            x=9
            y=4-5
        [/terrain]
        [terrain]
            x,y=10,5
            terrain=Rr
        [/terrain]

        {SCROLL_TO 11 3}
        [sound]
            name=explosion.ogg
        [/sound]
        [terrain]
            terrain=Uu^
            x,y=11,3
            layer=overlay
        [/terrain]
        [redraw]
        [/redraw]
        [delay]
            time=500
        [/delay]

        {SCROLL_TO 9 14}
        [sound]
            name=explosion.ogg
        [/sound]
        [terrain]
            terrain=Uu^
            x=8,9,10
            y=13,14,14
            layer=overlay
        [/terrain]
        [redraw]
        [/redraw]
        [delay]
            time=500
        [/delay]

        {SCROLL_TO 6 25}
        [sound]
            name=explosion.ogg
        [/sound]
        [terrain]
            terrain=Uu^
            x=6,7,8
            y=26,26,25
            layer=overlay
        [/terrain]
        [redraw]
        [/redraw]
        [delay]
            time=500
        [/delay]

        [terrain]
            x,y=11,6
            terrain=Rr
        [/terrain]
        [sound]
            name=rumble.ogg
        [/sound]
        [delay]
            time=500
        [/delay]
        [message]
            speaker=Mehir
            message= _ "We unlocked them! Maybe we should check the tunnels located near those levers? I heard some kind of quakes nearby. Maybe these levers do more than just closing gates..."
        [/message]
    [/event]

    #Mehir leaves the caves = victory
    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Mehir
            x,y=19,1
        [/filter]
        [message]
            speaker=Mehir
            message= _ "It seems Tashkar and his troops left this area. Still, I wonder what was the point of his whole expedition..."
        [/message]
        {CLEAR_VARIABLE chasm}
        {CLEAR_VARIABLE chasmax}
        {CLEAR_VARIABLE hole}
        {CLEAR_VARIABLE ghost_defeated}
        {CLEAR_VARIABLE fall}
        {CLEAR_VARIABLE numb_bats}
        {CLEAR_VARIABLE traps}
        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 40}
            bonus=no
            carryover_report=yes
        [/endlevel]
    [/event]

    #stone bridges collapse
    [event]
        name=new turn
        first_time_only=no

        [if]
            [variable]
                name=fall
                greater_than=0
            [/variable]
            [then]
                [switch]
                    variable=fall
                    [case]
                        value=1
                        {EARTHQUAKE (
                            {SCROLL_TO 24 10}
                            [terrain]
                                terrain=Qxu
                                x,y=24,10
                            [/terrain]
                            [kill]
                                x,y=24,10
                                [not]
                                    type=Vampire Bat,Blood Bat,Dread Bat,EoMa_Carpet_Rider,EoMa_Carpet_Master,EoMa_Jinn,EoMa_Great_Jinn,EoMa_Efreet
                                [/not]
                                animate=no
                                fire_event=yes
                            [/kill]
                            [fire_event]
                                name=bats
                            [/fire_event]
                            {VARIABLE fall 2}
                        )}
                    [/case]
                    [case]
                        value=2
                        {EARTHQUAKE (
                            {SCROLL_TO 23 9}
                            [terrain]
                                terrain=Qxu
                                x,y=23,9
                            [/terrain]
                            [kill]
                                x,y=23,9
                                [not]
                                    type=Vampire Bat,Blood Bat,Dread Bat,EoMa_Carpet_Rider,EoMa_Carpet_Master,EoMa_Jinn,EoMa_Great_Jinn,EoMa_Efreet
                                [/not]
                                animate=no
                                fire_event=yes
                            [/kill]
                            {VARIABLE fall 3}
                        )}
                    [/case]
                    [case]
                        value=3
                        {EARTHQUAKE (
                            {SCROLL_TO 21 6}
                            [terrain]
                                terrain=Qxu
                                x,y=21,6
                            [/terrain]
                            [kill]
                                x,y=21,6
                                [not]
                                    type=Vampire Bat,Blood Bat,Dread Bat,EoMa_Carpet_Rider,EoMa_Carpet_Master,EoMa_Jinn,EoMa_Great_Jinn,EoMa_Efreet
                                [/not]
                                animate=no
                                fire_event=yes
                            [/kill]
                            {VARIABLE fall 4}
                        )}
                    [/case]
                    [case]
                        value=4
                        {EARTHQUAKE (
                            {SCROLL_TO 23 5}
                            [terrain]
                                terrain=Qxu
                                x,y=23,5
                            [/terrain]
                            [kill]
                                x,y=23,5
                                [not]
                                    type=Vampire Bat,Blood Bat,Dread Bat,EoMa_Carpet_Rider,EoMa_Carpet_Master,EoMa_Jinn,EoMa_Great_Jinn,EoMa_Efreet
                                [/not]
                                animate=no
                                fire_event=yes
                            [/kill]
                            [terrain]
                                terrain=Qxu
                                x,y=24,4
                            [/terrain]
                            [kill]
                                x,y=24,4
                                [not]
                                    type=Vampire Bat,Blood Bat,Dread Bat,EoMa_Carpet_Rider,EoMa_Carpet_Master,EoMa_Jinn,EoMa_Great_Jinn,EoMa_Efreet
                                [/not]
                                animate=no
                                fire_event=yes
                            [/kill]
                            {VARIABLE fall 5}
                        )}
                    [/case]
                    [case]
                        value=5
                        {EARTHQUAKE (
                            {SCROLL_TO 24 2}
                            [terrain]
                                terrain=Qxu
                                x,y=24,2
                            [/terrain]
                            [kill]
                                x,y=24,2
                                [not]
                                    type=Vampire Bat,Blood Bat,Dread Bat,EoMa_Carpet_Rider,EoMa_Carpet_Master,EoMa_Jinn,EoMa_Great_Jinn,EoMa_Efreet
                                [/not]
                                animate=no
                                fire_event=yes
                            [/kill]
                            {VARIABLE fall 6}
                        )}
                    [/case]
                    [case]
                        value=6
                        {EARTHQUAKE (
                            {SCROLL_TO 23 2}
                            [terrain]
                                terrain=Qxu
                                x,y=23,2
                            [/terrain]
                            [kill]
                                x,y=23,2
                                [not]
                                    type=Vampire Bat,Blood Bat,Dread Bat,EoMa_Carpet_Rider,EoMa_Carpet_Master,EoMa_Jinn,EoMa_Great_Jinn,EoMa_Efreet
                                [/not]
                                animate=no
                                fire_event=yes
                            [/kill]
                            [terrain]
                                terrain=Qxu
                                x,y=22,2
                            [/terrain]
                            [kill]
                                x,y=22,2
                                [not]
                                    type=Vampire Bat,Blood Bat,Dread Bat,EoMa_Carpet_Rider,EoMa_Carpet_Master,EoMa_Jinn,EoMa_Great_Jinn,EoMa_Efreet
                                [/not]
                                animate=no
                                fire_event=yes
                            [/kill]
                            {VARIABLE fall 7}
                        )}
                    [/case]
                    [case]
                        value=7
                        {EARTHQUAKE (
                            {SCROLL_TO 21 4}
                            [terrain]
                                terrain=Qxu
                                x,y=21,4
                            [/terrain]
                            [kill]
                                x,y=21,4
                                [not]
                                    type=Vampire Bat,Blood Bat,Dread Bat,EoMa_Carpet_Rider,EoMa_Carpet_Master,EoMa_Jinn,EoMa_Great_Jinn,EoMa_Efreet
                                [/not]
                                animate=no
                                fire_event=yes
                            [/kill]
                            {CLEAR_VARIABLE fall}
                        )}
                    [/case]
                    [case]
                        value=99
                        {VARIABLE fall 1}
                    [/case]
                [/switch]
            [/then]
        [/if]
    [/event]

    #Earth Elementals move - Mehir makes a remark
    [event]
        name=moveto
        first_time_only=yes
        [filter]
            type=EoMa_Earth_Avatar,EoMa_Earth_Elemental,EoMa_Earth_God
            side=3
            x,y=1-999,1-999
        [/filter]
        {SCROLL_TO $x1 $y1}
        [message]
            speaker=Mehir
            message= _ "These must be the ancient guardians of this place. They were awakened by Tashkar, but why? This is not good. But the worst thing is, they won't listen to us. I fear we will have to fight our way through..."
        [/message]
    [/event]

    #prevent player from stealing the Spear
    [event]
        name=enter hex
        first_time_only=no
        [filter]
            x=3,4,5
            y=14,14,14
            side=1
        [/filter]
        [if]
            [have_unit]
                id=SpearGuardian
                [filter_side]
                    [enemy_of]
                        side=1
                    [/enemy_of]
                [/filter_side]
            [/have_unit]
            [then]
                {MOVE_UNIT id=SpearGuardian 4 13}
            [/then]
        [/if]
    [/event]

    #player banishes an elemental
    [event]
        name=post banish

        [message]
            speaker=narrator
            image=portraits/narrator.png
            message= _ "You have managed to acquire a 'Dimensional Gate'. These special units can be transformed into real magical beings by consuming souls of living creatures. You will learn more about the usage of Dimensional Gates later in the story.

NOTE: When used right, a Dimensional Gate may be used to summon a Jinni, but Mehir has not been experienced enough to own such powerful unit yet. Feel free to summon other beings though or you can stack these gates for later use."
        [/message]
    [/event]

    #time over
    [event]
        name=time over
        {QUAKE rumble.ogg}
        [delay]
            time=1000
        [/delay]
        [message]
            speaker=Mehir
            image="portraits/mehir-commander-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Aaaaah! The caves are collapsing!"
        [/message]
        [delay]
            time=150
        [/delay]
        {QUAKE explosion.ogg}
        [delay]
            time=150
        [/delay]
        {QUAKE explosion.ogg}
        [delay]
            time=150
        [/delay]
        {QUAKE explosion.ogg}
        {FADE_STEP -32 5}
        {QUAKE explosion.ogg}
        {FADE_STEP -84 5}
        {QUAKE explosion.ogg}
        {FADE_STEP -128 10}
        {QUAKE explosion.ogg}
        {FADE_STEP -160 10}
        {QUAKE explosion.ogg}
        [harm_unit]
            [filter]
            [/filter]
            amount=1000
            fire_event=no
            animate=no
        [/harm_unit]
        {FADE_STEP -200 10}
        {QUAKE explosion.ogg}
        {QUAKE ()}
        {FADE_STEP -256 50}
        {QUAKE explosion.ogg}
        {QUAKE ()}
        {FADE_STEP -380 50}
        {QUAKE explosion.ogg}
        {QUAKE explosion.ogg}
        {FADE_STEP -512 5}
    [/event]

    #DEBUG
    [event]
        name=test
        first_time_only=no

        [remove_event]
            id=bats
        [/remove_event]
        [kill]
            side=2,3
            fire_event=no
            animate=no
        [/kill]
        {MODIFY_UNIT id=Mehir moves 99}
        ## [fire_event]
        ## name=amulet
        ## [/fire_event]
    [/event]
    [event]
        name=test2
        first_time_only=no

        [message]
            speaker=Mehir
            message= _ "Test"
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-commander-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Test"
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-commander-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Test"
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-commander-happy.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Test"
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "Test Badass"
            [/message]
        ) ()}
    [/event]

    {ITEM_APPLIER}
    {SUMMONER_LOCK}
    {JINN_LOCK}
    {COLLAR_EVENT}
    {DEATH_MEHIR}
    {TLU_S08_TERRAIN}
[/scenario]
