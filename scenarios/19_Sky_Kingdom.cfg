#textdomain wesnoth-To_Lands_Unknown
[scenario]
    id=19_Sky_Kingdom
    next_scenario=20_Enlightenment
    name= _ "Sky Kingdom"
    map_data="{~add-ons/To_Lands_Unknown/maps/19_Sky_Kingdom.map}"
    {TURNS 45 35 32}
    victory_when_enemies_defeated=no

    {SCENARIO_MUSIC breaking_the_chains.ogg}
    {EXTRA_SCENARIO_MUSIC traveling_minstrels.ogg}
    {EXTRA_SCENARIO_MUSIC wanderer.ogg}
    {MORNING}

    {STORYTXT_THE_LAST_SUMMONER}

    [side]
        side=1
        controller=human
        team_name=mehirteam
        user_team_name= _ "team_name^Mehir"

        type=TLU_Mehir_Leader
        id=Mehir
        name= _ "Mehir"
        unrenamable=yes
        canrecruit=yes
        profile=portraits/mehir-leader.png

        {GOLD 550 450 350}
        {INCOME 15 10 5}
        village_support=6

        recruit=EoMa_Water_Elemental,EoMa_Fire_Elemental,EoMa_Water_Avatar,EoMa_Fire_Avatar,EoMa_Rhami,EoMa_RhamiDatu,EoMa_RhamiKai,EoMa_Jinn
    [/side]

    [side]
        side=2
        controller=ai
        team_name=mages
        user_team_name= _ "team_name^Master of Water"

        type=EoMa_Master_of_Water
        id=MasterWater
        name= _ "Aquaticus"
        image_icon=portraits/sky_kingdom/masterofwater.png~CROP(130,20,130,130)~SCALE(72,72)
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Mage_of_Air,EoMa_Subversive_Mage,EoMa_Elementalist,EoMa_Golem,EoMa_Mu,EoMa_Hidden_Face,EoMa_Mage_of_Water,EoMa_Black_Mage,EoMa_Mystic_Warrior,EoMa_Golem_Boss

        {GOLD 120 175 250}
        {INCOME -1 0 1}
        village_gold=0

        [ai]
        [/ai]

        {UNIT 2 (EoMa_Golden_Mage) 48 18 (ai_special,upkeep,facing=guardian,loyal,sw)}
    [/side]

    [side]
        side=3
        controller=ai
        team_name=mages
        user_team_name= _ "team_name^Mage"

        type=EoMa_Mastermage
        id=Mastermage
        name= _ "Arcanus"
        image_icon=portraits/sky_kingdom/mastermage.png~CROP(165,20,130,130)~SCALE(72,72)
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Mage_of_Air,EoMa_Battlemage,EoMa_Subversive_Mage,EoMa_Golem,EoMa_Mu,EoMa_Hidden_Face,EoMa_War_Mage,EoMa_Sorcerer,EoMa_Mystic_Warrior,EoMa_Cosmic_Eye

        {GOLD 140 225 300}
        {INCOME -1 -0 1}
        village_gold=0

        [ai]
            passive_leader=yes
        [/ai]

        {UNIT 3 (EoMa_Golden_Mage) 31 29 (ai_special,upkeep,facing=guardian,loyal,sw)}
        {UNIT 3 (EoMa_Golden_Mage) 13 20 (ai_special,upkeep,facing=guardian,loyal,sw)}
    [/side]

    [side]
        side=4
        controller=ai
        team_name=mages
        user_team_name= _ "team_name^Master of Fire"

        type=EoMa_Master_of_Fire
        id=MasterFire
        name= _ "Ignis"
        unrenamable=yes
        canrecruit=yes

        recruit=EoMa_Mage_of_Air,EoMa_Battlemage,EoMa_Mu,EoMa_Hidden_Face,EoMa_Mage_of_Fire,EoMa_Mystic_Warrior,EoMa_Cosmic_Eye

        {GOLD 100 150 200}
        {INCOME 0 1 2}
        village_gold=0

        [ai]
        [/ai]

        {UNIT 4 (EoMa_Golden_Mage) 19 8 (ai_special,upkeep,facing=guardian,loyal,sw)}
    [/side]

    {RASHTI_SIDES 5 6}

    #statue of guru:
    [item]
        image="statues/clean/statue-guru.png~FL(horiz)"
        x,y=45,32
    [/item]

    #prestart
    [event]
        name=prestart

        {VARIABLE skykingdom yes}
        {SCATTER_UNITS 7 "EoMa_Sorcerer,EoMa_Mystic_Warrior,EoMa_Elementalist,EoMa_Battle_Eye,EoMa_Battlemage" 3 (
            terrain=Gg

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=2
            generate_name=yes
            random_traits=yes

            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        )}
        {SCATTER_UNITS 7 "EoMa_Sorcerer,EoMa_Mystic_Warrior,EoMa_Elementalist,EoMa_Battle_Eye,EoMa_Battlemage" 3 (
            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=3
            generate_name=yes
            random_traits=yes

            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        )}
        {SCATTER_UNITS 7 "EoMa_Sorcerer,EoMa_Mystic_Warrior,EoMa_Elementalist,EoMa_Battle_Eye,EoMa_Battlemage" 3 (
            terrain=Gg

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=4
            generate_name=yes
            random_traits=yes

            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        )}
        [kill]
            side=2,3,4
            [not]
                type=EoMa_Magical_Eye,EoMa_Battle_Eye,EoMa_Cosmic_Eye
            [/not]
            [filter_location]
                terrain=Qxu
            [/filter_location]
            animate=no
        [/kill]
        {PLACE_HALO "scenery/white.png" 7 30}

        [kill]
            id=Atiros
        [/kill]
        [store_unit]
            [filter]
                side=1
                x,y=recall,recall
            [/filter]
            variable=landing
        [/store_unit]
        {VARIABLE counter 0}
        [disallow_recruit]
            side=1
            type=EoMa_Novice_Summoner,EoMa_Summoner,EoMa_Dispeller,EoMa_Carpet_Rider,EoMa_Camel_Rider
        [/disallow_recruit]

        #predefined Sky Kingdom army
        [store_unit]
            [filter]
                side=1
                level=3,4
                x,y=recall,recall
            [/filter]
            variable=lvls3
        [/store_unit]
        {SCATTER_UNITS $lvls3.length "EoMa_Cosmic_Eye" 3 (
            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
            [not]
                [and]
                    x,y=7,36
                    radius=15
                [/and]
            [/not]
        ) (
            side=3
            ai_special=guardian

            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        )}
        {CLEAR_VARIABLE lvls3}

#define PORTAL X1 Y1 X2 Y2
    [tunnel]
        [filter]
        [/filter]
        [source]
            x,y={X1},{Y1}
        [/source]
        [target]
            x,y={X2},{Y2}
        [/target]
    [/tunnel]
#enddef

        #yellow1-yellow2
        {PORTAL 17 32 39 35}
        {PORTAL 18 32 40 35}
        {PORTAL 17 33 39 36}
        {PORTAL 16 32 38 35}

        #blue1-blue2
        {PORTAL 49 18 13 25}

        #white1-white2
        {PORTAL 35 30 9 22}
        {PORTAL 35 31 9 23}

        #orange1-orange2
        {PORTAL 21 8 31 13}
    [/event]

    #start
    [event]
        name=start
        {FADE_STEP 225 50}
        {REMOVE_IMAGE 7 30}
        {FADE_STEP 192 5}
        {FADE_STEP 160 5}
        {FADE_STEP 128 5}
        {FADE_STEP 96 5}
        {FADE_STEP 64 5}
        {FADE_STEP 32 5}
        {FADE_STEP 0 5}
        {RECALL_RASHTI}

        [message]
            speaker=Mehir
            image="portraits/mehir-leader-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Unbelievable! I've got to enter heaven to get down into the Abyss."
        [/message]
        [message]
            speaker=Mastermage
            message= _ "Oh, a Summoner. Interesting... What are you doing here? Your countrymen are in the Abyss for a good few days."
        [/message]
        [message]
            speaker=Mehir
            message= _ "Well, I am here because of that matter. I didn’t quite manage to join them on time. The Kharosians said you know how to get people there without circles. I hope you will offer me your aid."
        [/message]
        {UNIT 3 (EoMa_Shadowmage) () () (id,placement=Agent,leader)}
        [message]
            speaker=Agent
            message= _ "It’s him."
        [/message]
        [message]
            speaker=MasterWater
            message= _ "Well, well, Arcanus, look who we got here - Mehir himself — the leader of Tar-Tabar, defender of Kharos?"
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "Yeah. Seems like my fame reaches even the highest altitudes... If you want to get an autograph, you'll have to wait, though, as I need to finish my business here first."
            [/message]
        ) (
            [message]
                speaker=Mehir
                message= _ "Indeed, as well as the official representative of the High Abysmal Council!"
            [/message]
        )}
        [delay]
            time=500
        [/delay]
        [message]
            speaker=Mehir
            image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Wait a minute... you look an awful lot like the men who broke into our catacombs in Ka-Gatta!"
        [/message]

        [message]
            speaker=Mastermage
            message= _ "Oh, you mean the research party led by Aerius, our flying cartographer? We do not hold responsibility for the collateral damage he may have inflicted. No need to blame us for his actions. Anyway, our Guru knows how to help you. He is in the monumental Palace of Omniscience, but first you must prove yourself worthy of visiting him."
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "A challenge, you say? It just so happens that I have some experience in such activities. So, what do you propose? A drinking contest, perhaps?... <i>*to himself* Speaking of which, I wonder what happened to that poor drunk cyclops from the canyon...</i>"
            [/message]
            [message]
                speaker=Mastermage
                message= _ "No, I'd rather avoid alcohol for the foreseeable future. It has a quite a negative impact on my complexion, and I need to look attractive, you know? Anyway, I initially intended the challenge to be you fighting your way through the place to reach the Palace, but I've changed my mind."
            [/message]
            [message]
                speaker=Mastermage
                message= _ "You have quite an unusual companioness with you. She seems to be quite a powerful abyssal being, thus would like to test her abilities by three tests. One involving physical strength, the second measuring her potential of channeling magic, and the last one addressing intellectual skills, as well as understanding of science."
            [/message]
            [message]
                speaker=Mastermage
                message= _ "If she can pass all three, you will be granted an audience with the Guru. Otherwise, you will have to face our opposition as I originally planned. What do you say?"
            [/message]
            [message]
                speaker=Mehir
                message= _ "Interesting... Rashti, what do you think?"
            [/message]
            [message]
                speaker=Rashti
                image="portraits/truerashti-noncombat.png"
                message= _ "The task does seem within my capabilities. Very well, I accept."
            [/message]
        ) (
            [message]
                speaker=Mehir
                message= _ "And how exactly are you gonna have me prove my worthiness?"
            [/message]
            [message]
                speaker=MasterWater
                message= _ "Provide us with a little... entertainment."
            [/message]
            [message]
                speaker=Mehir
                image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "Who do you take me for, some court jester? I didn't come halfway across the known world just to be a spectacle for some arrogant mage!"
            [/message]
            [message]
                speaker=Mastermage
                message= _ "You might have got the wrong idea, we challenge you to a contest! Demonstrate your combat prowess by fighting your way through the palace! The last summoners against the magi of the Sky Kingdom! Defeat means for you a stay with us here in heaven - a privilege many a man would gladly die for. What say you to that?"
            [/message]
            [message]
                speaker=Mehir
                message= _ "Does Guru authorize the abuse of his visitors? Presenting myself as the slayer of his underlings would hardly serve my cause. Is this bloodshed truly necessary?"
            [/message]
            [message]
                speaker=Rashti
                message= _ "If the mages want bloodshed, I would be more than happy to give it to them."
            [/message]
            [message]
                speaker=Mastermage
                message= _ "Pfff... don't worry about us, summoner. We have created this place... as well as its rules. But if your soldiers die, well, you will be the one to blame. Do you accept this challenge, Summoner?"
            [/message]
        )}
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mastermage
                message= _ "Excellent! Mehir, gather your people; the contest shall begin soon."
            [/message]
            [fire_event]
                name=contest1
            [/fire_event]
        ) (
            [message]
                speaker=Mehir
                message= _ "Seems like I don't have much of a choice. I must see this Guru of yours, even if I have turn this place into burning rubble along the way."
            [/message]
            [message]
                speaker=Mastermage
                message= _ "Excellent! He is waiting for you inside. Good luck, summoner, you'll need it."
            [/message]
            {TLU_SMOOTH_REPLACE_MUSIC Adventure_Theme.ogg 1500 0}
        )}
        #Mastermage portals
        {FAKE_SCENERY_ANIM scenery/portal 4 20 24 100}
        {PLACE_IMAGE "scenery/portal-small.png" 19 24}
        {PLACE_IMAGE "scenery/portal-small.png" 19 25}
        {PLACE_IMAGE "scenery/portal-small.png" 20 23}
        {PLACE_IMAGE "scenery/portal-small.png" 20 25}
        {PLACE_IMAGE "scenery/portal-small.png" 21 24}
        {PLACE_IMAGE "scenery/portal-small.png" 21 25}
        [item]
            halo=halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(90%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(80%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(70%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(60%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(70%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(80%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(90%):150
            x,y=20,24
        [/item]
        #Master of water portals
        {BADASS_MODE_CHANGE () (
            {PLACE_IMAGE "scenery/portal-small.png" 48 27}
            {PLACE_IMAGE "scenery/portal-small.png" 48 28}
            {PLACE_IMAGE "scenery/portal-small.png" 49 27}
            {PLACE_IMAGE "scenery/portal-small.png" 49 29}
            {PLACE_IMAGE "scenery/portal-small.png" 50 27}
            {PLACE_IMAGE "scenery/portal-small.png" 50 28}
            [item]
                halo="halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(90%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(80%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(70%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(60%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(70%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(80%):150,halo/fire-aura.png~SCALE(320,320)~GS()~CS(0,64,255)~O(90%):150"
                x,y=49,28
            [/item]
        )}
        #Master of fire portals
        {PLACE_IMAGE "scenery/portal-small.png" 11 11}
        {PLACE_IMAGE "scenery/portal-small.png" 12 10}
        {PLACE_IMAGE "scenery/portal-small.png" 12 11}
        {PLACE_IMAGE "scenery/portal-small.png" 14 10}
        {PLACE_IMAGE "scenery/portal-small.png" 14 11}
        {PLACE_IMAGE "scenery/portal-small.png" 15 11}
        [item]
            halo=halo/fire-aura.png~SCALE(400,320)~GS()~CS(0,64,255)~O(90%):150,halo/fire-aura.png~SCALE(400,320)~GS()~CS(0,64,255)~O(80%):150,halo/fire-aura.png~SCALE(400,320)~GS()~CS(0,64,255)~O(70%):150,halo/fire-aura.png~SCALE(400,320)~GS()~CS(0,64,255)~O(60%):150,halo/fire-aura.png~SCALE(400,320)~GS()~CS(0,64,255)~O(70%):150,halo/fire-aura.png~SCALE(400,320)~GS()~CS(0,64,255)~O(80%):150,halo/fire-aura.png~SCALE(400,320)~GS()~CS(0,64,255)~O(90%):150
            x,y=13,11
        [/item]

        {BADASS_MODE_CHANGE () (
            {PLACE_IMAGE "items/gohere.png" 31 8}
            {HIGHLIGHT_IMAGE 31 8 "items/gohere.png" ()}
            {SCROLL_TO 7 36}

            [message]
                speaker=Mehir
                message= _ "Rashti, are you ready for this?"
            [/message]
            [message]
                speaker=Rashti
                image="portraits/truerashti-noncombat.png"
                message= _ "I am always ready for anything, Mehir. Why do you ask?"
            [/message]
            [message]
                speaker=Mehir
                message= _ "I just feel responsible for you after what happened... I can hardly bear the thought of losing you again."
            [/message]
            [message]
                speaker=Rashti
                image="portraits/truerashti-noncombat.png"
                message= _ "That's nice of you, but I am immortal now. Don't worry about me, you're the one who needs protection."
            [/message]
            [message]
                speaker=Rashti
                message= _ "Believe me, I trust the magi even less than you do, but for now we'll have to play along with their weird idea, and hope for the best..."
            [/message]

            [message]
                speaker=narrator
                image=portraits/narrator.png
                message= _ "Your troops will automatically arrive in groups to your starting location once per turn. To have more control over this process, seize one of enemy keeps and recall troops of your choosing from there."
            [/message]
            [message]
                speaker=narrator
                image=portraits/narrator.png
                message= _ "Use teleporting circles to move your troops across the map (they work similarly to the 'teleport' ability). Teleporting circles of the same color are connected with each other."
            [/message]
        )}

        {VARIABLE magi_death 0}

        [micro_ai]
            side=2
            ai_type=simple_attack
            action=add
            ca_score=110000
        [/micro_ai]
        [micro_ai]
            side=3
            ai_type=simple_attack
            action=add
            ca_score=110000
            [filter]
                [not]
                    id=Mastermage
                [/not]
            [/filter]
        [/micro_ai]
        [micro_ai]
            side=4
            ai_type=simple_attack
            action=add
            ca_score=110000
        [/micro_ai]

        {BADASS_MODE_CHANGE () (
            [if]
                [have_unit]
                    type=EoMa_Dimensional_Gate,EoMa_Dimensional_Gate_II
                    search_recall_list=yes
                [/have_unit]
                [then]
                    [message]
                        speaker=narrator
                        image=portraits/narrator.png
                        message= _ "After this scenario, leveling up Dimensional Gates will cost you a fee. Keep that in mind."
                    [/message]
                [/then]
            [/if]

            [objectives]
                side=1
                [objective]
                    description= _ "Move Mehir to the Palace of Omniscience"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Death of Mehir"
                    condition=lose
                [/objective]

                {TURNS_RUN_OUT}
                [gold_carryover]
                    bonus=no
                    carryover_percentage=5
                [/gold_carryover]
                note= _ "Each captured village will provide support for two Level 3 units during this scenario."
            [/objectives]
        )}
    [/event]

#define TROOPS_LANDING NUMBER X Y
    {REPEAT {NUMBER} (
        [if]
            [variable]
                name=counter
                less_than_equal_to=$landing.length
            [/variable]
            [then]
                [if]
                    [have_unit]
                        level=2,3,4
                        x,y=recall,recall
                    [/have_unit]
                    [then]
                        [recall]
                            side=1
                            x,y={X},{Y}
                            fire_event=yes
                            [not]
                                level=0
                                [or]
                                    level=1
                                [/or]
                            [/not]
                            show=no
                        [/recall]
                    [/then]
                    [else]
                        [recall]
                            side=1
                            x,y={X},{Y}
                            fire_event=yes
                            show=no
                        [/recall]
                    [/else]
                [/if]
                {VARIABLE_OP counter add 1}
            [/then]
        [/if]
    )}
#enddef

    #prevent losses for badass turn 1
    {FORCE_CHANCE_TO_HIT side=2,3,4 side=1 25 (
        [variable]
            name=turn_number
            less_than=2
        [/variable]
        [and]
            [variable]
                name=badass_mode_active
                equals=yes
            [/variable]
        [/and]
    )}
    {FORCE_CHANCE_TO_HIT side=2,3,4 id=Rashti,Mehir 20 (
        [variable]
            name=turn_number
            less_than=2
        [/variable]
        [and]
            [variable]
                name=badass_mode_active
                equals=yes
            [/variable]
        [/and]
    )}

    #badass - contest 1
    [event]
        name=contest1

        #part 1
        {FADE_TO_BLACK}
        [delay]
            time=1000
        [/delay]
        [kill]
            x,y=16,26
            animate=no
        [/kill]
        [kill]
            x,y=34,27
            animate=no
        [/kill]
        {TELEPORT_UNIT id=Mehir 20 27}
        {TELEPORT_UNIT id=Rashti 15 26}
        {UNIT 3 (EoMa_Um) 15 25 (id=Um)}
        {UNIT 3 (EoMa_Golem) 18 24 (id=golem1)}
        {UNIT 3 (EoMa_Golem) 18 25 (id=golem2)}

        #mehir's troops landing
        {TROOPS_LANDING 3 25 28}
        {TROOPS_LANDING 3 44 32}
        {TROOPS_LANDING 2 26 24}
        {TROOPS_LANDING 2 16 17}

        {TROOPS_LANDING 3 25 28}
        {TROOPS_LANDING 3 44 32}
        {TROOPS_LANDING 2 26 24}
        {TROOPS_LANDING 2 16 17}

        {FADE_IN}

        [message]
            speaker=Mastermage
            message= _ "The first task involves measuring physical strength - something earthbounds seem to like."
        [/message]
        [message]
            speaker=Mastermage
            message= _ "The sport I chose was golem tossing. The one who throws the golem the furthest, wins the first part of the competition. To make this a fair fight, you will compete with one of our strongest creations - an Um! Ready the golems!"
        [/message]
        {MOVE_UNIT id=golem1 16 24}
        {MODIFY_UNIT id=Um facing ne}
        [object]
            silent=yes
            duration=forever
            [filter]
                id=Um
            [/filter]
            [effect]
                apply_to=new_animation
                [extra_anim]
                    flag=golem
                    [frame]
                        image="units/skykingdom-warriors/[mysticmu,mysticmu-attack-1,mysticmu-attack-2,mysticmu-attack-1,mysticmu].png:[50,200*2,100,50]"
                        offset=0~0.6:250,0.6~0:250
                    [/frame]
                    [frame]
                        image="units/skykingdom-warriors/mysticmu.png:2000"
                        offset=0.0
                    [/frame]
                    [victim_frame]
                        image="units/skykingdom-golems/golem.png:250"
                        image_mod=~RC(magenta>green)
                        offset=1.0
                    [/victim_frame]
                    [victim_frame]
                        image="units/skykingdom-golems/golem.png:3000"
                        image_mod=~RC(magenta>green)
                        offset=1.0~3.0
                        directional_y=0~-800
                        alpha=1.0~0.0
                    [/victim_frame]
                    sound_start_time=250
                    [sound_frame]
                        sound=explosion.ogg
                    [/sound_frame]
                [/extra_anim]
            [/effect]
        [/object]
        [delay]
            time=200
        [/delay]
        [kill]
            id=golem1
        [/kill]
        [animate_unit]
            flag=golem
            [filter]
                id=Um
            [/filter]
        [/animate_unit]
        {SCROLL_TO 34 27}
        {ANIMHACK golemfall-ground 34 27 ne}

        [message]
            race=human
            message= _ "What an excellent throw! Great job!"
        [/message]
        [message]
            speaker=Mastermage
            message= _ "Heh, good luck beating that..."
        [/message]
        [message]
            race=eoma_summoner
            [not]
                id=Mehir
            [/not]
            message= _ "Go Rashti, go! You can do this! We believe in you!"
        [/message]
        [message]
            speaker=Rashti
            message= _ "(to the master mage) Watch and learn, airhead..."
        [/message]

        {MOVE_UNIT id=golem2 16 25}
        {MODIFY_UNIT id=Rashti facing ne}

        [object]
            silent=yes
            duration=forever
            [filter]
                id=Rashti
            [/filter]
            [effect]
                apply_to=new_animation
                [extra_anim]
                    flag=golem
                    [frame]
                        image="units/truerashti.png:500"
                        offset=0~0.6:250,0.6~0:250
                    [/frame]
                    [frame]
                        image="units/truerashti.png:2000"
                        offset=0.0
                    [/frame]
                    [victim_frame]
                        image="units/skykingdom-golems/golem.png:250"
                        image_mod=~RC(magenta>green)
                        offset=1.0
                    [/victim_frame]
                    [victim_frame]
                        image="units/skykingdom-golems/golem.png:2500"
                        image_mod=~RC(magenta>green)
                        offset=1.0~3.0
                        directional_y=0~-800
                        alpha=1.0~0.0
                    [/victim_frame]
                    sound_start_time=250
                    [sound_frame]
                        sound=explosion.ogg
                    [/sound_frame]
                [/extra_anim]
            [/effect]
        [/object]
        [delay]
            time=200
        [/delay]
        [kill]
            id=golem2
        [/kill]
        [animate_unit]
            flag=golem
            [filter]
                id=Rashti
            [/filter]
        [/animate_unit]

        [message]
            race=human
            [not]
                id=MasterWater,Mastermage
            [/not]
            message= _ "Wow! Master, did you see that? The golem is entering the stratosphere!"
        [/message]
        [message]
            speaker=Mastermage
            message= _ "Wh- What?!!!"
        [/message]
        [delay]
            time=1000
        [/delay]
        [message]
            race=human
            [not]
                id=MasterWater,Mastermage
            [/not]
            message= _ "It... it's falling down! Take cover!!!"
        [/message]

        {SCROLL_TO 49 28}
        {ANIMHACK golemfall-ground2 49 28 ne}
        [fire_event]
            name=crater
        [/fire_event]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Mastermage
            message= _ "..."
        [/message]
        [message]
            speaker=Mastermage
            message= _ "You... won this part..."
        [/message]
        [fire_event]
            name=contest2
        [/fire_event]
    [/event]

    #badass - contest 2
    [event]
        name=contest2

        #part 2

        {FADE_TO_BLACK}

        [put_to_recall_list]
            side=1
            [filter_location]
                x,y=16,17
                radius=1
            [/filter_location]
        [/put_to_recall_list]

        {TROOPS_LANDING 2 12 20}

        [kill]
            x=20,17,17,18,19,18,19
            y=17,16,19,18,18,16,17
        [/kill]

        {TELEPORT_UNIT id=Rashti 17 19}
        {MODIFY_UNIT id=Rashti facing ne}
        {UNIT 3 (TLU_Magic_Mirror) 20 17 (id,facing=mirror,sw)}
        {SCROLL_TO 20 17}

        {FADE_IN}

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Mastermage
            message= _ "The second part of the competition is about measuring magical powers one posses. This will involve the usage of a magical mirror - a unique piece of furniture capable of withstanding very powerful spells and even deflecting some of them."
        [/message]
        [message]
            speaker=Mastermage
            message= _ "A competitor needs to shatter such a mirror from a distance using his or her magical skills in order to win this part. Again, to make this a fair fight, you will compete against one of our strongest spellcasters - Ignis, a Master of Fire!"
        [/message]
        {MOVE_UNIT id=MasterFire 17 16}
        [message]
            race=emoa_summoner
            [not]
                id=Mehir
            [/not]
            message= _ "Wow, this guy is really hot... I mean the temperature around him of course."
        [/message]
        [message]
            speaker=Mehir
            message= _ "This is going to be easy. You won't believe how powerful Rashti can be. Trust me, I know what I am talking about."
        [/message]
        [message]
            speaker=Mastermage
            message= _ "We shall see about that. Competitors, you may proceed."
        [/message]

        [object]
            silent=yes
            duration=forever
            [filter]
                id=MasterFire
            [/filter]
            [effect]
                apply_to=new_animation
                [extra_anim]
                    flag=mirror
                    [frame]
                        image="units/skykingdom-elementalists/master-of-fire1.png:20"
                    [/frame]
                    [frame]
                        image="units/skykingdom-elementalists/master-of-fire[-defend1,-defend2,-defend3,2].png:[60*3,30]"
                        sound=fire.wav
                    [/frame]
                    [missile_frame]
                        image="projectiles/fireball-nw.png:500"
                        offset=0.0~3.0
                    [/missile_frame]
                    [missile_frame]
                        halo="projectiles/fireball-impact-[1~16].png:50"
                        offset=3.0
                        auto_vflip=false
                        sound=explosion.ogg
                    [/missile_frame]
                    missile2_start_time=250
                    [missile2_frame]
                        image="misc/blank-hex.png:1"
                    [/missile2_frame]
                    [missile2_frame]
                        image="projectiles/fireball-nw.png:500"
                        offset=0.0~3.0
                    [/missile2_frame]
                    [missile2_frame]
                        halo="projectiles/fireball-impact-[1~16].png~SCALE(150,225):50"
                        auto_vflip=false
                        offset=3.0
                        x=-20
                        y=20
                        sound=explosion.ogg
                    [/missile2_frame]
                    missile3_start_time=500
                    [missile3_frame]
                        image="misc/blank-hex.png:1"
                    [/missile3_frame]
                    [missile3_frame]
                        image="projectiles/fireball-nw.png:500"
                        offset=0.0~3.0
                    [/missile3_frame]
                    [missile3_frame]
                        halo="projectiles/fireball-impact-[1~16].png~SCALE(150,225):50"
                        auto_vflip=false
                        offset=3.0
                        x=20
                        sound=explosion.ogg
                    [/missile3_frame]
                [/extra_anim]
            [/effect]
        [/object]
        [delay]
            time=200
        [/delay]
        [animate_unit]
            flag=mirror
            [filter]
                id=MasterFire
            [/filter]
        [/animate_unit]

        [harm_unit]
            [filter]
                id=mirror
            [/filter]
            amount=99
            animate=yes
            delay=0
        [/harm_unit]

        [message]
            race=human
            [not]
                id=MasterWater,Mastermage
            [/not]
            message= _ "That's it! Excellent shot!"
        [/message]

        {UNIT 3 (TLU_Magic_Mirror) 20 17 (id,facing,animate=mirror,sw,yes)}

        [message]
            id=Rashti
            message= _ "Nice, but what do you say about... THIS?"
        [/message]

        [object]
            silent=yes
            duration=forever
            [filter]
                id=Rashti
            [/filter]
            [effect]
                apply_to=new_animation
                [extra_anim]
                    flag=mirror
                    start_time=-400
                    missile_start_time=-250
                    {RASHTICIRCLE "~GS()~CS(0,96,255)" 450}

                    [frame]
                        duration=650
                        image="units/truerashti-n.png"
                        blend_ratio=0~0.4:250,0.5~0:300
                        blend_color=0,96,255
                        halo="halo/mystic-magic[1~5,5~1].png~GS()~CS(0,96,255):[50*4,200,50*5]"
                    [/frame]

                    missile_start_time=-500
                    [missile_frame]
                        image_diagonal="projectiles/icemissile-ne-[1~7].png:[250,150*2,50*4]"
                        halo=halo/elven/ice-halo[1~5,1,2,6~9].png:[100*4,50*7]
                        halo_x,halo_y=0,0
                        offset=0.0~3.0
                    [/missile_frame]
                    [missile_frame]
                        image_diagonal="projectiles/icemissile-ne-[1~7].png:[250,150*2,50*4]"
                        halo=halo/elven/ice-halo[1~5,1,2,6~9].png:[100*4,50*7]
                        halo_x,halo_y=0,0
                        offset=3.0~0.0
                        directional_y=0~-216
                        halo_y=0~-216
                    [/missile_frame]

                    sound_start_time=0
                    [sound_frame]
                        sound=magic-faeriefire-miss.ogg
                        duration=250
                    [/sound_frame]
                    [sound_frame]
                        sound=magic-faeriefire-miss.ogg
                        duration=500
                    [/sound_frame]
                    [sound_frame]
                        sound=magic-faeriefire.ogg
                    [/sound_frame]
                [/extra_anim]
            [/effect]
        [/object]
        [delay]
            time=200
        [/delay]
        [animate_unit]
            flag=mirror
            [filter]
                id=Rashti
            [/filter]
        [/animate_unit]

        {FLASH_WHITE (
            [sound]
                name=magic-dark-big.ogg
            [/sound]
            {PLACE_IMAGE "units/master-of-fire-frozen.png" 17 16}
            [kill]
                id=MasterFire
                animate=no
            [/kill]
            [redraw]
            [/redraw]
        )}
        [delay]
            time=500
        [/delay]
        [message]
            race=human
            [not]
                id=MasterWater,Mastermage
            [/not]
            message= _ "S-She has frozen our Master of Fire, and he's still burning! What kind of madness is this?!"
        [/message]
        [message]
            speaker=Mastermage
            message= _ "Hmpf... But you do realize that the mirror is still intact, right? Thus, you have failed."
        [/message]

        {SCROLL_TO 20 17}
        [delay]
            time=200
        [/delay]
        [object]
            silent=yes
            duration=forever
            [filter]
                id=mirror
            [/filter]
            [effect]
                apply_to=variation
                name=damaged1
            [/effect]
        [/object]
        [sound]
            name=glass-shattering-small1.ogg
        [/sound]
        [redraw]
        [/redraw]
        [delay]
            time=1000
        [/delay]
        [message]
            race=eoma_summoner
            [not]
                id=Mehir
            [/not]
            message= _ "Hey, look! The mirror is cracking!"
        [/message]
        {SCROLL_TO 20 17}
        [delay]
            time=200
        [/delay]
        [object]
            silent=yes
            duration=forever
            [filter]
                id=mirror
            [/filter]
            [effect]
                apply_to=variation
                name=damaged2
            [/effect]
        [/object]
        [sound]
            name=glass-shattering-small2.ogg
        [/sound]
        [redraw]
        [/redraw]
        [delay]
            time=1500
        [/delay]
        {FLASH_WHITE (
            [sound]
                name=glass-shattering-big.ogg
            [/sound]
            [kill]
                id=mirror
                animate=no
            [/kill]
        )}
        [delay]
            time=1000
        [/delay]
        [message]
            race=emoa_summoner
            [not]
                id=Mehir
            [/not]
            message= _ "YES! It's completely destroyed! Hurray!"
        [/message]
        [message]
            speaker=Mastermage
            message= _ "You may be good at brute-forcing your way out of situation, but I wonder whether you can pass the last part of the competition..."
        [/message]
        [fire_event]
            name=contest3
        [/fire_event]
    [/event]

    #badass - contest 3
    [event]
        name=contest3

        {FADE_TO_BLACK}

        {TELEPORT_UNIT id=Mehir 20 27}
        {TELEPORT_UNIT id=Rashti 15 26}

        {FADE_IN}

        {SUNGLASSES_OFF (
            [message]
                speaker=Mastermage
                message= _ "*ahem* It is finally time for the last test of your abilities. You have proven yourself to be superior in terms of physical strength and magical power, but what truly matters the most is one's intellect. Are you capable of solving one of the most demanding questions of all time?"
            [/message]
            [message]
                speaker=Mastermage
                message= _ "Our ancestors devoted millennia to find the answer for one such question. Because you are quite a unique guest, a being from a different dimension, we are quite curious to see if you can solve it faster. Are you ready to hear it and provide us with the answer in less than 24 hours?"
            [/message]
            [message]
                speaker=Rashti
                image="portraits/truerashti-noncombat.png"
                message= _ "I... accept."
            [/message]
            [message]
                speaker=Mastermage
                message= _ "Very well. If you figure out the answer, you will get to see the Guru. If not, you will have to deal with us first. So..."
            [/message]
            [message]
                speaker=Mastermage
                message= _ "...what is the meaning of life, the universe, and everything?"
            [/message]
            [message]
                speaker=Rashti
                image="portraits/truerashti-noncombat.png"
                message= _ "..."
            [/message]
            [message]
                speaker=Mehir
                message= _ "Man, this is a really difficult question! Do you think you even have a chance here, Rashti?"
            [/message]
            [delay]
                time=2000
            [/delay]
            [message]
                speaker=Mehir
                message= _ "Uh, Rashti? Are you alright?"
            [/message]
            [message]
                speaker=Rashti
                image="portraits/truerashti-noncombat.png"
                message= _ "*freezes in place*"
            [/message]
            [delay]
                time=1000
            [/delay]
            [message]
                speaker=Mehir
                message= _ "Damn it! She is not responding. I think we've got a problem..."
            [/message]
            [delay]
                time=1000
            [/delay]
            [message]
                speaker=Rashti
                image="portraits/truerashti-noncombat.png"
                message= _ "<span font-style='italic'>*to herself* Some chase after 36, others 69, the more enlightened pursue 63, but their true goal is 41...</span>"
                #note:
                #36 - ASCII for $ symbol, here representing wealth
                #69 - not ASCII-related, but the meaning should be fairly obvious
                #63 - ASCII for ? symbol, here representing knowledge/pursuit of it
                #41 - ASCII symbol for ) symbol, often used as a smile, here representing happiness
            [/message]
            [delay]
                time=1000
            [/delay]
            [message]
                speaker=Rashti
                image="portraits/truerashti-noncombat.png"
                message= _ "I thought about it, and I believe I have an answer."
            [/message]
            [message]
                speaker=Mehir
                message= _ "You are back! Geez, I almost though we lost you for a moment!"
            [/message]
            [message]
                speaker=Rashti
                image="portraits/truerashti-noncombat.png"
                message= _ "*ahem* The answer is 41"
            [/message]
            [message]
                speaker=Mastermage
                message= _ "Alas, as close as your answer was, it was still incorrect. The correct answer is 42."
                #note: this is a reference to Hitchhiker's Guide to the Galaxy. Also, fun fact: 42 is the ASCII number for the asterisk symbol, which in code is a wildcard (therefore meaning of life = whatever meaning you give it)
            [/message]
            [message]
                speaker=Mehir
                image="portraits/mehir-leader-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "41? 42? How in the world is a two-digit number supposed to be an answer to such an important question?!"
            [/message]
            [message]
                speaker=Mastermage
                message= _ "Such things are beyond your uneducated mind to understand. Anyway, I am sorry to say that, but you have failed at the third part of the competition, and thus you will have to fight your way to the palace. (To his men) Kill them!"
            [/message]
            {TLU_SMOOTH_REPLACE_MUSIC Adventure_Theme.ogg 1500 0}
            [message]
                speaker=Mehir
                image="portraits/mehir-leader-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "Wait, what?!"
            [/message]
            [message]
                speaker=Rashti
                message= _ "Behind his veil of intellectual superiority, this 'Arcanus' seems hardly different from Aerius - just another arrogant bloodthirsty brute... I can only hope that Guru will be different..."
            [/message]
        )}
        [end_turn]
        [/end_turn]
    [/event]

    #badass - turn 2 show objectives
    [event]
        name=turn 2

        {BADASS_MODE_CHANGE (
            [if]
                [have_unit]
                    type=EoMa_Dimensional_Gate,EoMa_Dimensional_Gate_II
                    search_recall_list=yes
                [/have_unit]
                [then]
                    [message]
                        speaker=narrator
                        image=portraits/narrator.png
                        message= _ "After this scenario, leveling up Dimensional Gates will cost you a fee. Keep that in mind."
                    [/message]
                [/then]
            [/if]

            {PLACE_IMAGE "items/gohere.png" 31 8}
            {HIGHLIGHT_IMAGE 31 8 "items/gohere.png" ()}

            [objectives]
                side=1
                [objective]
                    description= _ "Move Mehir to the Palace of Omniscience"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Death of Mehir"
                    condition=lose
                [/objective]

                {TURNS_RUN_OUT}
                [gold_carryover]
                    bonus=no
                    carryover_percentage=5
                [/gold_carryover]
                note= _ "Each captured village will provide support for two Level 3 units during this scenario."
            [/objectives]
        ) ()}
    [/event]

    #auto recall
    [event]
        name=new turn
        first_time_only=no

        [if]
            [variable]
                name=turn_number
                equals=1
            [/variable]
            [else]
                [if]
                    [have_unit]
                        side=1
                        x,y=recall,recall
                        search_recall_list=yes
                    [/have_unit]
                    [then]
                        {REVERSE_SCENERY_ANIM scenery/circle-magmagar 5 7 36 2}
                        {PLACE_HALO "scenery/circle-magmagar-1.png" 7 36}
                        {REPEAT 4 (
                            [if]
                                [have_unit]
                                    level=4
                                    x,y=recall,recall
                                    search_recall_list=yes
                                [/have_unit]
                                [then]
                                    [recall]
                                        side=1
                                        level=4
                                        x,y=7,36
                                        fire_event=yes
                                    [/recall]
                                [/then]
                                [else]
                                    [if]
                                        [have_unit]
                                            level=3
                                            x,y=recall,recall
                                            search_recall_list=yes
                                        [/have_unit]
                                        [then]
                                            [recall]
                                                side=1
                                                level=3
                                                x,y=7,36
                                                fire_event=yes
                                            [/recall]
                                        [/then]
                                        [else]
                                            [if]
                                                [have_unit]
                                                    level=2
                                                    x,y=recall,recall
                                                    search_recall_list=yes
                                                [/have_unit]
                                                [then]
                                                    [recall]
                                                        side=1
                                                        level=2
                                                        x,y=7,36
                                                        fire_event=yes
                                                    [/recall]
                                                [/then]
                                                [else]
                                                    [if]
                                                        [have_unit]
                                                            level=1
                                                            x,y=recall,recall
                                                            search_recall_list=yes
                                                        [/have_unit]
                                                        [then]
                                                            [recall]
                                                                side=1
                                                                level=1
                                                                x,y=7,36
                                                                fire_event=yes
                                                            [/recall]
                                                        [/then]
                                                        [else]
                                                            [recall]
                                                                side=1
                                                                level=0
                                                                x,y=7,36
                                                                fire_event=yes
                                                            [/recall]
                                                        [/else]
                                                    [/if]
                                                [/else]
                                            [/if]
                                        [/else]
                                    [/if]
                                [/else]
                            [/if]
                        )}
                        {FAKE_SCENERY_ANIM scenery/circle-magmagar 5 7 36 2}
                    [/then]
                [/if]
            [/else]
        [/if]
    [/event]

    #teleports
#define TELEPORT_MACRO OLD_X OLD_Y NEW_X NEW_Y
    [event]
        name=moveto
        first_time_only=no

        [filter]
            x,y={OLD_X},{OLD_Y}
        [/filter]

        [if]
            [have_unit]
                x,y={NEW_X},{NEW_Y}
            [/have_unit]
            [else]
                [sound]
                    name=magic-faeriefire.ogg
                [/sound]
                {TELEPORT_TILE {OLD_X} {OLD_Y} {NEW_X} {NEW_Y}}
                {FAKE_SCENERY_ANIM scenery/transfer 5 {OLD_X} {OLD_Y} 100}
                {SCROLL_TO {NEW_X} {NEW_Y}}
            [/else]
        [/if]
    [/event]
#enddef
#define TELEPORTER X1 Y1 X2 Y2
    {TELEPORT_MACRO {X1} {Y1} {X2} {Y2}}
    {TELEPORT_MACRO {X2} {Y2} {X1} {Y1}}
#enddef

    #Mehir enters the Palace = victory
    [event]
        name=moveto
        first_time_only=no

        [filter]
            id=Mehir
            x,y=31,8
        [/filter]
        [message]
            speaker=Mehir
            message= _ "May I find the solution inside..."
        [/message]

        {CLEAR_VARIABLE magi_death}
        {CLEAR_VARIABLE skykingdom}
        {CLEAR_VARIABLE landing}
        {CLEAR_VARIABLE counter}

        [endlevel]
            result=victory
            {NEW_GOLD_CARRYOVER 5}
            bonus=no
            carryover_report=yes
            linger_mode=no
        [/endlevel]
    [/event]

    #player kills one of sky kingdom people
    [event]
        name=die
        first_time_only=no

        [filter]
            race=human
            [or]
                type=EoMa_Master_of_Fire
            [/or]
        [/filter]

        {ANIMHACK magi $x1 $y1 se}
        [if]
            [variable]
                name=magi_death
                equals=0
            [/variable]
            [then]
                [message]
                    speaker=Mehir
                    message= _ "Huh? He just disappeared!"
                [/message]
                [message]
                    speaker=Rashti
                    message= _ "Not exactly. I sense his soul materializing on one of the islands on the horizon. Something must have teleported him there. This place is full of strange energies."
                [/message]
                [message]
                    speaker=Mastermage
                    message= _ "As you can see, you cannot kill us here — only slow us down."
                [/message]
                {BADASS_MODE_CHANGE (
                    [message]
                        speaker=Rashti
                        message= _ "Keep talking with that annoying voice and I'll find a way. You saw how I thrown a golem into the stratosphere. I could just throw another one wherever your soul is revived."
                    [/message]
                    [message]
                        speaker=Mastermage
                        message= _ "*gulp*"
                    [/message]
                ) (
                    [message]
                        speaker=Mehir
                        message= _ "I knew you were able to do powerful things like controlling powers of nature, but this... is unbelievable!"
                    [/message]
                )}
                {VARIABLE magi_death 1}
            [/then]
        [/if]
    [/event]

    #player defeats Mastermage
    [event]
        name=last breath

        [filter]
            id=Mastermage
        [/filter]

        [message]
            speaker=Mastermage
            message= _ "*smirks* Beaten at my own game... Seems like Guru was right to invest so heavily in getting you here. Anyway, my time here is over, so I better go."
        [/message]
    [/event]

    #player defeats Master of Water
    [event]
        name=last breath

        [filter]
            id=MasterWater
        [/filter]

        [message]
            speaker=MasterWater
            message= _ "Well, seems I have to go now. Playing along with Arcanus' games was getting boring anyway."
        [/message]
    [/event]

    #progressive enemy income
    [event]
        name=new turn
        first_time_only=no

#define MAGI_INCOME_ADD SIDE ADD
    [store_side]
        side={SIDE}
        variable=currentside
    [/store_side]
    {VARIABLE_OP currentside.income add {ADD}}
    [if]
        {VARIABLE_CONDITIONAL currentside.income greater_than 30}
        [else]
            [modify_side]
                side={SIDE}
                income=$currentside.income
            [/modify_side]
        [/else]
    [/if]
    {CLEAR_VARIABLE currentside}
#enddef
        {MAGI_INCOME_ADD 2 1}
        {MAGI_INCOME_ADD 3 1}
        {MAGI_INCOME_ADD 4 1}
    [/event]

    #jinni advice
    [event]
        name=recall,post advance
        id=jinn_advice
        first_time_only=yes
        [filter]
            type=EoMa_Wonderful_Jinn,EoMa_Mystical_Jinn
        [/filter]

        {BADASS_MODE_CHANGE () (
            [if]
                [have_unit]
                    id=$unit.id
                    type=EoMa_Wonderful_Jinn
                [/have_unit]
                [then]
                    [message]
                        speaker=Mehir
                        message= _ "Wonderful Jinni! Give me some advice!"
                    [/message]
                [/then]
                [else]
                    [message]
                        speaker=Mehir
                        message= _ "Mystical Jinni! Give me some advice!"
                    [/message]
                [/else]
            [/if]
            [message]
                speaker=unit
                message= _ "My Master, our enemies are in remote locations connected with teleports. We should take control of these structures as soon as possible and use flying units to weaken their forces."
            [/message]
            [message]
                speaker=unit
                message= _ "The enemy will try to slow us down till their reinforcements arrive. Use your experienced summoners to summon flying units like Jinn and Air Elementals. They are of utmost importance here, as we can't recruit yet."
            [/message]
        )}
    [/event]

    #player troops are getting closer to the palace
    [event]
        name=enter hex
        [filter]
            side=1
            [filter_location]
                x,y=21,8
                radius=3
            [/filter_location]

            [allow_undo]
            [/allow_undo]
        [/filter]
        [message]
            speaker=Mehir
            message= _ "The entrance to the palace looks suspiciously empty. We should probably proceed with caution..."
        [/message]
    [/event]

    #player is super close to the palace = spawn guardians
    [event]
        name=enter hex
        [filter]
            side=1
            [filter_location]
                x,y=31,8
                radius=5
            [/filter_location]

            [allow_undo]
            [/allow_undo]
        [/filter]

        {ANIMHACK magi 31 9 se}
        {UNIT 2 EoMa_Sky_Guardian 31 9 (placement,passable,generate_name=map,yes,yes)}
#ifdef EASY
        {UNIT 2 EoMa_Battle_Eye 29 9 (placement,passable,animate=map,yes,yes)}
        {UNIT 2 EoMa_Battle_Eye 33 9 (placement,passable,animate=map,yes,yes)}
        {UNIT 2 EoMa_Magical_Eye 30 8 (placement,passable,animate=map,yes,yes)}
        {UNIT 2 EoMa_Magical_Eye 32 8 (placement,passable,animate=map,yes,yes)}
#endif
#ifdef NORMAL
        {UNIT 2 EoMa_Battle_Eye 29 9 (placement,passable,animate=map,yes,yes)}
        {UNIT 2 EoMa_Battle_Eye 33 9 (placement,passable,animate=map,yes,yes)}
        {UNIT 2 EoMa_Battle_Eye 30 8 (placement,passable,animate=map,yes,yes)}
        {UNIT 2 EoMa_Battle_Eye 32 8 (placement,passable,animate=map,yes,yes)}
#endif
#ifdef HARD
        {UNIT 2 EoMa_Cosmic_Eye 29 9 (placement,passable,animate=map,yes,yes)}
        {UNIT 2 EoMa_Cosmic_Eye 33 9 (placement,passable,animate=map,yes,yes)}
        {UNIT 2 EoMa_Battle_Eye 30 8 (placement,passable,animate=map,yes,yes)}
        {UNIT 2 EoMa_Battle_Eye 32 8 (placement,passable,animate=map,yes,yes)}
#endif
    [/event]

    #prevent magi from pushing towards teleports
#define FILTER_TELEPORT_LOCATION X1 Y1 X2 Y2
    [not]
        x,y={X1},{Y1}
    [/not]
    [not]
        x,y={X2},{Y2}
    [/not]
#enddef
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=2,3,4
            [not]
                type=EoMa_Battle_Eye,EoMa_Mage_of_Air,EoMa_Shadowmage,EoMa_Sky_Guardian,EoMa_Cosmic_Eye
            [/not]
            [filter_location]
                {FILTER_TELEPORT_LOCATION 17 32 39 35}
                {FILTER_TELEPORT_LOCATION 18 32 40 35}
                {FILTER_TELEPORT_LOCATION 17 33 39 36}
                {FILTER_TELEPORT_LOCATION 16 32 38 35}
                {FILTER_TELEPORT_LOCATION 49 18 13 25}
                {FILTER_TELEPORT_LOCATION 35 30 9 22}
                {FILTER_TELEPORT_LOCATION 35 31 9 23}
                {FILTER_TELEPORT_LOCATION 21 8 31 13}
            [/filter_location]
        [/filter]
    [/event]

    #teleport animation applier
    [event]
        name=recruit,recall,attack end,post summon
        id=apply_teleport_anim
        first_time_only=no

        [filter]
            [not]
                ability=teleport
                [or]
                    type=EoMa_Wonderful_Jinn
                [/or]
            [/not]
        [/filter]

        [object]
            silent=yes
            duration=forever
            [filter]
                x,y=$x1,$y1
            [/filter]
            [effect]
                apply_to=new_animation
                [animation]
                    apply_to=pre_teleport

                    start_time=-1200

                    teleport_sparkle_1_start_time=-1200
                    teleport_sparkle_2_start_time=-1000
                    teleport_sparkle_3_start_time=-800

                    [teleport_sparkle_1_frame]
                        duration=800
                        halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
                        halo_x=-10
                        halo_y=30~-30
                    [/teleport_sparkle_1_frame]
                    [teleport_sparkle_2_frame]
                        duration=800
                        halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
                        halo_x=0
                        halo_y=40~-40
                    [/teleport_sparkle_2_frame]
                    [teleport_sparkle_3_frame]
                        duration=800
                        halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
                        halo_x=10
                        halo_y=30~-30
                    [/teleport_sparkle_3_frame]

                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-0.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-1.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-2.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-3.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-4.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-5.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-6.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-7.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-8.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-9.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=200
                        image="misc/blank-hex.png"
                    [/frame]
                [/animation]
                [animation]
                    apply_to=post_teleport
                    start_time=-1200

                    teleport_sparkle_1_start_time=-1200
                    teleport_sparkle_2_start_time=-1000
                    teleport_sparkle_3_start_time=-800

                    [teleport_sparkle_1_frame]
                        duration=800
                        halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
                        halo_x=10
                        halo_y=-30~30
                    [/teleport_sparkle_1_frame]
                    [teleport_sparkle_2_frame]
                        duration=800
                        halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
                        halo_x=0
                        halo_y=-40~40
                    [/teleport_sparkle_2_frame]
                    [teleport_sparkle_3_frame]
                        duration=800
                        halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
                        halo_x=-10
                        halo_y=-30~30
                    [/teleport_sparkle_3_frame]
                    [frame]
                        duration=200
                        image="misc/blank-hex.png"
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-9.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-8.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-7.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-6.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-5.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-4.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-3.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-2.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-1.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-0.png~SCALE(144,144))
                    [/frame]
                [/animation]
            [/effect]
        [/object]
    [/event]
    [event]
        name=moveto
        id=apply_teleport_anim2
        first_time_only=no

        [filter]
            [not]
                ability=teleport
                [or]
                    type=EoMa_Wonderful_Jinn
                [/or]
            [/not]
        [/filter]
        [allow_undo][/allow_undo]
        [object]
            silent=yes
            duration=forever
            [filter]
                x,y=$x1,$y1
            [/filter]
            [effect]
                apply_to=new_animation
                [animation]
                    apply_to=pre_teleport

                    start_time=-1200

                    teleport_sparkle_1_start_time=-1200
                    teleport_sparkle_2_start_time=-1000
                    teleport_sparkle_3_start_time=-800

                    [teleport_sparkle_1_frame]
                        duration=800
                        halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
                        halo_x=-10
                        halo_y=30~-30
                    [/teleport_sparkle_1_frame]
                    [teleport_sparkle_2_frame]
                        duration=800
                        halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
                        halo_x=0
                        halo_y=40~-40
                    [/teleport_sparkle_2_frame]
                    [teleport_sparkle_3_frame]
                        duration=800
                        halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
                        halo_x=10
                        halo_y=30~-30
                    [/teleport_sparkle_3_frame]

                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-0.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-1.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-2.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-3.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-4.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-5.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-6.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-7.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-8.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-9.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=200
                        image="misc/blank-hex.png"
                    [/frame]
                [/animation]
                [animation]
                    apply_to=post_teleport
                    start_time=-1200

                    teleport_sparkle_1_start_time=-1200
                    teleport_sparkle_2_start_time=-1000
                    teleport_sparkle_3_start_time=-800

                    [teleport_sparkle_1_frame]
                        duration=800
                        halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
                        halo_x=10
                        halo_y=-30~30
                    [/teleport_sparkle_1_frame]
                    [teleport_sparkle_2_frame]
                        duration=800
                        halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
                        halo_x=0
                        halo_y=-40~40
                    [/teleport_sparkle_2_frame]
                    [teleport_sparkle_3_frame]
                        duration=800
                        halo=misc/blank-hex.png:1,halo/teleport-9.png,halo/teleport-8.png,halo/teleport-1.png,halo/teleport-2.png,halo/teleport-3.png,halo/teleport-4.png,halo/teleport-5.png,halo/teleport-6.png,halo/teleport-7.png,halo/teleport-8.png,halo/teleport-9.png,misc/blank-hex.png:1
                        halo_x=-10
                        halo_y=-30~30
                    [/teleport_sparkle_3_frame]
                    [frame]
                        duration=200
                        image="misc/blank-hex.png"
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-9.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-8.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-7.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-6.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-5.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-4.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-3.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-2.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-1.png~SCALE(144,144))
                    [/frame]
                    [frame]
                        duration=100
                        image_mod=~MASK(masks/teleport-mask-0.png~SCALE(144,144))
                    [/frame]
                [/animation]
            [/effect]
        [/object]
    [/event]

    #turn 5 - eyes attack
    [event]
        name=side 2 turn 5
        id=eye_aggro
        first_time_only=yes
        [store_unit]
            [filter]
                type=EoMa_Cosmic_Eye
                [filter_wml]
                    ai_special=guardian
                [/filter_wml]
            [/filter]
            variable=guard_eyes
        [/store_unit]

        [foreach]
            array=guard_eyes
            [do]
                [modify_unit]
                    [filter]
                        id=this_item
                    [/filter]
                    ai_special=none
                [/modify_unit]
            [/do]
        [/foreach]
    [/event]

    [event]
        name=crater
        first_time_only=no

        #47,26
        {FLASH_WHITE (
            {EARTHQUAKE (
                [terrain]
                    x,y=49,28
                    radius=1
                    terrain=Qxu
                [/terrain]
                [terrain]
                    x,y=47,26
                    terrain=Qxu^Yyyz
                    layer=both
                [/terrain]
                [kill]
                    [filter_location]
                        x,y=49,28
                        radius=1
                        animate=no
                    [/filter_location]
                [/kill]
            )}
        )}
        {ANIMHACK magi 49 28 se}
    [/event]

    {SUMMONER_UNLOCK}
    {ITEM_APPLIER}
    {COLLAR_EVENT}
    {DEATH_MEHIR}
    {TLU_S19_TERRAIN}
[/scenario]
