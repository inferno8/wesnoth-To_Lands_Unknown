#textdomain wesnoth-To_Lands_Unknown

#define GUARDIANS_PACK1 TYPE
    {IF_VAR glomin_joins equals yes (
        [else]
            #West
            {UNIT 3 ({TYPE}) 8 3 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE}) 4 6 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE}) 2 9 (animate,placement,passable=yes,map,yes)}
            #East
            {UNIT 3 ({TYPE}) 34 6 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE}) 36 9 (animate,placement,passable=yes,map,yes)}
        [/else]
    )}
#enddef

#define GUARDIANS_PACK2 TYPE TYPE2
    {IF_VAR glomin_joins equals yes (
        [else]
            #West
            {UNIT 3 ({TYPE}) 8 3 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE2}) 9 4 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE}) 4 6 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE2}) 5 7 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE}) 2 9 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE2}) 3 10 (animate,placement,passable=yes,map,yes)}
            #East
            {UNIT 3 ({TYPE}) 34 6 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE2}) 36 9 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE}) 33 7 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE2}) 35 9 (animate,placement,passable=yes,map,yes)}
        [/else]
    )}
#enddef

#define GUARDIANS_PACK3 TYPE TYPE2 TYPE3
    {IF_VAR glomin_joins equals yes (
        [else]
            #West
            {UNIT 3 ({TYPE}) 8 3 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE2}) 9 4 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE3}) 9 5 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE}) 4 6 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE2}) 5 7 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE3}) 6 7 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE}) 2 9 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE2}) 3 10 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE3}) 4 9 (animate,placement,passable=yes,map,yes)}
            #East
            {UNIT 3 ({TYPE}) 34 6 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE2}) 36 9 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE3}) 32 6 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE}) 33 7 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE2}) 35 9 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE3}) 34 9 (animate,placement,passable=yes,map,yes)}
        [/else]
    )}
#enddef

#define GUARDIANS_PACK4 TYPE TYPE2 TYPE3 TYPE4
    {IF_VAR glomin_joins equals yes (
        [else]
            #West
            {UNIT 3 ({TYPE}) 8 3 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE2}) 9 4 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE3}) 9 5 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE4}) 10 4 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE}) 4 6 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE2}) 5 7 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE3}) 6 7 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE4}) 7 7 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE}) 2 9 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE2}) 3 10 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE3}) 4 9 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE4}) 5 10 (animate,placement,passable=yes,map,yes)}
            #East
            {UNIT 3 ({TYPE}) 34 6 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE2}) 36 9 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE3}) 32 6 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE4}) 32 7 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE}) 33 7 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE2}) 35 9 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE3}) 34 9 (animate,placement,passable=yes,map,yes)}
            {UNIT 3 ({TYPE4}) 33 10 (animate,placement,passable=yes,map,yes)}
        [/else]
    )}
#enddef

#define CORNER_DIALOGS
    [switch]
        variable=stages
        [case]
            value=1
            [message]
                speaker=Mehir
                message= _ "Here goes the first one..."
            [/message]
            [message]
                speaker=Mehir
                message= _ "...Shatum hakh tugha..."
            [/message]
            {PLACE_HALO "scenery/circle_corner.png" $x1 $y1}
            [message]
                speaker=narrator
                image=portraits/narrator.png
                message= _ "When standing in the blue orbs, your units recover 12 hitpoints per turn (does not cancel the healing provided by other factors, such as regeneration, rest, etc.)."
            [/message]
        [/case]
        [case]
            value=2
            [message]
                speaker=Mehir
                message= _ "...Kharam biz daha..."
            [/message]
            {PLACE_HALO "scenery/circle_corner.png" $x1 $y1}
            [message]
                speaker=Mehir
                message= _ "Three to go."
            [/message]
        [/case]
        [case]
            value=3
            [message]
                speaker=Mehir
                message= _ "...Tothem abh khavet..."
            [/message]
            {PLACE_HALO "scenery/circle_corner.png" $x1 $y1}
            [message]
                speaker=Mehir
                message= _ "Almost there..."
            [/message]
        [/case]
        [case]
            value=4
            [message]
                speaker=Mehir
                message= _ "...Abun dah hakhet..."
            [/message]
            {PLACE_HALO "scenery/circle_corner.png" $x1 $y1}
            [message]
                speaker=Mehir
                message= _ "Only one more to go."
            [/message]
        [/case]
        [else]
            [message]
                speaker=Mehir
                message= _ "...Abram tiphar AGAR!"
            [/message]
            {PLACE_HALO "scenery/circle_corner.png" $x1 $y1}
            [fire_event]
                name=circle_complete
            [/fire_event]
        [/else]
    [/switch]
#enddef

#define CIRCLE_AREA
    [and]
        x,y=19,10
        radius=3
    [/and]
    [or]
        x,y=16,10
        radius=2
    [/or]
    [or]
        x,y=16,9
        radius=2
    [/or]
    [or]
        x,y=22,10
        radius=2
    [/or]
    [or]
        x,y=22,9
        radius=2
    [/or]
#enddef

#define RUINS_VICTORY_CONDITION
    [not]
        [have_unit]
            race=eoma_summoner
            [not]
                [filter_location]
                    {CIRCLE_AREA}
                [/filter_location]
            [/not]
        [/have_unit]
    [/not]
    [and]
        [have_unit]
            id=Rashti
            [filter_location]
                {CIRCLE_AREA}
            [/filter_location]
        [/have_unit]
    [/and]
    [and]
        [have_unit]
            id=Glomin
            [filter_location]
                {CIRCLE_AREA}
            [/filter_location]
        [/have_unit]
    [/and]
#enddef

[scenario]
    id=23_Ruins
    next_scenario=24_Epilogue
    name= _ "Ruins"
    map_data="{~add-ons/To_Lands_Unknown/maps/23_Ruins.map}"
    turns=-1
    victory_when_enemies_defeated=no

    {SCENARIO_MUSIC underground.ogg}
    {UNDERGROUND}

    [side]
        side=1
        controller=human
        team_name=mehirteam
        user_team_name= _ "team_name^Mehir"
        shroud=yes

        type=TLU_Mehir_Leader
        id=Mehir
        name= _ "Mehir"
        unrenamable=yes
        canrecruit=yes
        profile=portraits/mehir-last.png

        {GOLD 400 350 300}
        {INCOME 10 5 5}

        recruit=EoMa_Novice_Summoner,EoMa_Dispeller,EoMa_Dimensional_Gate,EoMa_Dimensional_Gate_II,EoMa_Jinn,EoMa_Rhami,EoMa_Fire_Elemental,EoMa_Water_Elemental,EoMa_Camel_Rider,EoMa_Carpet_Rider,EoMa_Summoner,EoMa_Great_Jinn,EoMa_Efreet,EoMa_Fire_Avatar,EoMa_Water_Avatar,EoMa_RhamiDatu,EoMa_RhamiKai,EoMa_Air_Elemental,EoMa_Earth_Elemental
    [/side]

    [side]
        side=2
        controller=ai
        team_name=destroyers
        user_team_name= _ "team_name^Unknown"
        no_leader=yes
        color=black

        {GOLD 0 0 0}
        {INCOME 0 0 0}

        [ai]
            aggression=1.0
            caution=0.0
        [/ai]
        hidden=yes
    [/side]

    [side]
        side=3
        controller=ai
        team_name=mehirteam
        user_team_name= _ "team_name^Guardians"
        no_leader=yes
        color=blue
        hidden=yes

        {GOLD 0 0 0}
        {INCOME 0 0 0}

        [ai]
            simple_targeting=yes
            ignore_bad_movement=yes
            aggression=1.0
            caution=0.0
        [/ai]
    [/side]

    [side]
        side=4
        controller=ai
        team_name=mehirteam
        user_team_name= _ "team_name^Magi"
        no_leader=yes
        color=green
        hidden=yes
    [/side]

    {RASHTI_SIDES 5 6}

#define AI_AVOID_GLYPHS SIDE
    [modify_side]
        side={SIDE}
        [ai]
            [avoid]
                x=16,14,19,24,22
                y=7,10,13,10,7
            [/avoid]
        [/ai]
    [/modify_side]
#enddef

#define RECALL_TROOPS_ACTION
    {VARIABLE mehirunits[$a].moves 0}
    [unstore_unit]
        variable=mehirunits[$a]
        x,y=19,22
        find_vacant=yes
        check_passability=yes
    [/unstore_unit]
#enddef

    #prestart
    [event]
        name=prestart

        {VARIABLE turn_limit_ruins 15}
        {VARIABLE dharma_ruins yes}

        {RECALL_RASHTI}

        {IF_VAR destroyers_known equals yes (
            [then]
                [modify_side]
                    side=2
                    user_team_name=_ "Destroyers"
                [/modify_side]
            [/then]
        )}

        [hide_unit]
            id=Mehir
        [/hide_unit]
        [hide_unit]
            id=Rashti
        [/hide_unit]

#define DEBUG_RUINS_CONDITION
    [set_menu_item]
        id=control_circle
        description="Test Circle Area"

        [command]
            [if]
                {RUINS_VICTORY_CONDITION}
                [then]
                    {ERROR "all green"}
                [/then]
                [else]
                    {ERROR "missing units"}
                    [if]
                        [have_unit]
                            race=eoma_summoner
                            [not]
                                [filter_location]
                                    {CIRCLE_AREA}
                                [/filter_location]
                            [/not]
                        [/have_unit]
                        [then]
                            {ERROR "missing summoners"}
                        [/then]
                    [/if]
                    [if]
                        [have_unit]
                            id=Rashti
                            [filter_location]
                                {CIRCLE_AREA}
                            [/filter_location]
                        [/have_unit]
                        [else]
                            {ERROR "missing Rashti"}
                        [/else]
                    [/if]
                    [if]
                        [have_unit]
                            id=Glomin
                            [filter_location]
                                {CIRCLE_AREA}
                            [/filter_location]
                        [/have_unit]
                        [else]
                            {ERROR "missing Glomin"}
                        [/else]
                    [/if]
                [/else]
            [/if]
        [/command]
    [/set_menu_item]
    [set_menu_item]
        id=control_circle2
        description="Show Circle Area"

        [command]
            [remove_shroud]
                side=1
            [/remove_shroud]
            [terrain]
                terrain=Aa
                {CIRCLE_AREA}
            [/terrain]
        [/command]
    [/set_menu_item]
#enddef
        #{DEBUG_RUINS_CONDITION}
    [/event]

    #debug
    [event]
        name=i8debug

        {DEBUG_RUINS_CONDITION}
    [/event]

    #start
    [event]
        name=start

        {COLOR_ADJUST 30 22 12}

        {REPEAT 9 (
            [recall]
                x,y=19,28
                race=eoma_summoner
                level=4,3,2
                find_in=mehirunits
                animate=yes
            [/recall]
            {MOVE_UNIT x,y=19,28 19 23}
        )}
        {CLEAR_VARIABLE mehirunits}

        {MODIFY_UNIT side=1 upkeep loyal}

        {TELEPORT_UNIT id=Mehir 19 28}
        [unhide_unit]
            id=Mehir
        [/unhide_unit]
        {MOVE_UNIT id=Mehir 19 25}

        {TELEPORT_UNIT id=Rashti 19 28}
        [unhide_unit]
            id=Rashti
        [/unhide_unit]
        {MOVE_UNIT id=Rashti 18 25}

        {UNIT 2 (EoMa_Bone_Golem) 18 28 (animate=yes)}
        {UNIT 2 (EoMa_Punisher) 19 28 (animate=yes)}
        {UNIT 2 (EoMa_Legendary_Cyclops) 20 28 (animate=yes)}

        [message]
            speaker=Mehir
            image="portraits/mehir-last-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Damn it! Those abominations are catching up to us!"
        [/message]
        [message]
            speaker=Rashti
            message= _ "Stand back..."
        [/message]

        {MOVE_UNIT id=Mehir 19 25}
        {MOVE_UNIT id=Rashti 19 26}

        {EARTHQUAKE (
            [harm_unit]
                [filter]
                    side=2
                [/filter]
                amount=1000
            [/harm_unit]
            {QUAKE explosion.ogg}
            [terrain]
                x,y=19,28
                radius=2
                terrain=Xv
            [/terrain]
            [place_shroud]
                side=1
                x,y=19,28
                radius=2
            [/place_shroud]
            [remove_shroud]
                side=1
                x,y=19,26
                radius=1
            [/remove_shroud]
            {QUAKE cave-in.ogg}
        )}

        [terrain]
            terrain=Urb
            x,y=19,26
        [/terrain]

        [redraw]
        [/redraw]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Mehir
            message= _ "Good job. Unfortunately, we are trapped here now, but those weird magi gave me a teleportation spell. We’d better find this battery and get out of this freezing hellhole as soon as possible..."
        [/message]

        [remove_shroud]
            side=1
            x,y=19,19
        [/remove_shroud]
        {PLACE_IMAGE "items/gohere.png" 19 19}

        {AI_AVOID_GLYPHS 5}
        {AI_AVOID_GLYPHS 6}
        [objectives]
            side=1
            [objective]
                description= _ "Search the ruins"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Mehir"
                condition=lose
            [/objective]
            {IS_LAST_SCENARIO}
        [/objectives]

        [store_locations]
            variable=keep_new
            [filter]
                id=Mehir
            [/filter]
        [/store_locations]

        [store_unit]
            [filter]
                id=Mehir
            [/filter]
            variable=mehirvar
        [/store_unit]
        [store_unit]
            [filter]
                id=Rashti
            [/filter]
            variable=rashtivar
        [/store_unit]

        [disallow_end_turn]
        [/disallow_end_turn]
    [/event]

    #refill moves on turn 1
    [event]
        name=moveto
        first_time_only=no
        [allow_undo]
        [/allow_undo]

        [filter]
            id=Mehir
        [/filter]

        {IF_VAR turn_number equals 1 (
            [then]
                {MODIFY_UNIT id=Mehir moves $mehirvar.max_moves}
            [/then]
        )}
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [allow_undo]
        [/allow_undo]

        [filter]
            id=Rashti
        [/filter]

        {IF_VAR turn_number equals 1 (
            [then]
                {MODIFY_UNIT id=Rashti moves $rashtivar.max_moves}
            [/then]
        )}
    [/event]

    #make summoned units loyal
    [event]
        name=prerecruit,prerecall,post summon,post advance,post gate
        first_time_only=no

        [filter]
            side=1
        [/filter]

        #summoners counter
        [if]
            [have_unit]
                x,y=$x1,$y1
                race=eoma_summoner
            [/have_unit]
            [then]
                {VARIABLE_OP summoners add 1}
                [if]
                    [variable]
                        name=summoners
                        greater_than=39
                    [/variable]
                    [then]
                        [disallow_recruit]
                            side=1
                            type=EoMa_Novice_Summoner,EoMa_Dispeller,EoMa_Camel_Rider,EoMa_Carpet_Rider,EoMa_Summoner,EoMa_Carpet_Master,EoMa_Heavy_Camel_Rider
                        [/disallow_recruit]
                        [message]
                            speaker=Mehir
                            message= _ "I can’t summon more men; there won’t be enough room for them inside the circle!"
                        [/message]
                    [/then]
                [/if]
            [/then]
        [/if]

        {MODIFY_UNIT side=1 upkeep loyal}
    [/event]

    #summoners counter for the circle area
    [event]
        name=die
        first_time_only=no

        [filter]
            side=1
            race=eoma_summoner
        [/filter]

        {VARIABLE_OP summoners sub 1}

        [if]
            [variable]
                name=summoners
                greater_than=39
            [/variable]
            [else]
                [allow_recruit]
                    side=1
                    type=EoMa_Novice_Summoner,EoMa_Dispeller,EoMa_Camel_Rider,EoMa_Carpet_Rider,EoMa_Summoner,EoMa_Carpet_Master,EoMa_Heavy_Camel_Rider
                [/allow_recruit]
            [/else]
        [/if]

        [if]
            [variable]
                name=cricle_complete
                equals=1
            [/variable]
            [then]
                [fire_event]
                    name=checker
                [/fire_event]
            [/then]
        [/if]
    [/event]

    #gate opened
    [event]
        name=moveto

        [filter]
            side=1
            x,y=19,19
        [/filter]

        [if]
            [have_unit]
                id=Rashti
                x,y=19,19
            [/have_unit]
            [then]
                [message]
                    speaker=Rashti
                    message= _ "I found a gate. Shall I open it?"
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "Sure. What could possibly go wrong?" #sarcasm
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Mehir
                    message= _ "Oh, a gate. Let’s open it."
                [/message]
            [/else]
        [/if]

        {VARIABLE gate_opened yes}
        {REMOVE_IMAGE 19 19}
        {PLACE_HALO "scenery/battery.png" 19 6}
        [remove_shroud]
            side=1
        [/remove_shroud]
        [place_shroud]
            side=1
            [and]
                x,y=19,28
                radius=2
            [/and]
            [not]
                x,y=19,26
            [/not]
        [/place_shroud]

        [terrain]
            x=19,18,20
            y=18,18,18
            terrain=Urb
        [/terrain]

        [message]
            image="portraits/mehir-last-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            speaker=Mehir
            message= _ "Wow..."
        [/message]

        {SCROLL_TO 19 8}

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Mehir
            message= _ "Rashti, you go first."
        [/message]

        {MOVE_UNIT id=Rashti 19 15}
        {MOVE_UNIT id=Mehir 19 16}
        {MOVE_UNIT id=Rashti 18 12}

        [move_unit]
            id=Mehir
            to_x,to_y=19,12
            fire_event=yes
        [/move_unit]

        [store_unit]
            [filter]
                side=1
                [not]
                    canrecruit=yes
                [/not]
                [not]
                    x,y=recall,recall
                [/not]
                [not]
                    id=Rashti
                [/not]
            [/filter]
            variable=early_summoned
        [/store_unit]

        [if]
            [variable]
                name=early_summoned.length
                greater_than=0
            [/variable]
            [then]
                [foreach]
                    array=early_summoned
                    [do]
                        {MOVE_UNIT x,y=$this_item.x,$this_item.y 19 15}
                    [/do]
                [/foreach]
            [/then]
        [/if]

        [message]
            speaker=Mehir
            message= _ "So this must be the battery we‘re looking for... my goodness, this thing is huge..."
        [/message]

        [sound]
            name=fuse.ogg
        [/sound]
        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Mehir
            message= _ "What was that?!"
        [/message]

        #West
        {UNIT 3 (EoMa_Steam_Ulfserker) 8 4 (animate=yes)}

        [role]
            role=machine
            side=3
        [/role]
        [message]
            role=machine
            message= _ "<i>Life signatures detected. Initiating first contact protocols.</i>"
        [/message]
        {MOVE_UNIT type=EoMa_Steam_Ulfserker 15 12}
        [message]
            role=machine
            message= _ "(playing pre-recorded message) Greetings, intelligent organisms. It is certainly quite a pleasure to meet you. This combat model is merely a humble representative of our technologically advanced civilization. May it have the honor of speaking with your leader?"
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-last-happy.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "My, my, this thing speaks our language! And in quite a classy manner too! *smirks*"
        [/message]
        [message]
            speaker=Rashti
            image="portraits/truerashti-noncombat.png"
            message= _ "It doesn't. Your ultimate circle translates its voice for you."
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-last-happy.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Amazing! The Magi really did an incredible job with this. I hope it translates my speech too."
        [/message]
        [message]
            role=machine
            message= _ "(switching to another pre-recorded message) Can you understand our language?"
        [/message]
        [message]
            speaker=Mehir
            message= _ "Yes, *ahem* Alright, so, allow me to introduce myself, I am Mehir, formerly the leader of Tar-Tabar. We are Summoners, a nation hailing from the Great Desert, with al-Kamija being the capital. Although we are clearly far behind from your civilization technologically, we have abysmal beings as servants, who can fulfill each and any of our desires."
        [/message]
        [message]
            role=machine
            message= _ "*recorded message* So, now that we both introduced ourselves, may I inquire the reason of your entry into this bunker?"
        [/message]
        [message]
            speaker=Mehir
            message= _ "Well, I came here for the huge battery in the middle of the room. Hopefully it isn't too important to you, since I AM going to take it."
        [/message]
        {REPLACE_SCENARIO_MUSIC silence.ogg}
        [modify_side]
            side=3
            team_name=guardians
            hidden=no
        [/modify_side]
        [message]
            role=machine
            message= _ "*eyes become red* <i>Hostile intentions detected. Initiating defense protocols. Sending activation signal to other combat models.</i>"
        [/message]
        [sound]
            name=explosion.ogg
        [/sound]
        [delay]
            time=1000
        [/delay]
        {REPLACE_SCENARIO_MUSIC battle-epic.ogg}
        {APPEND_MUSIC siege_of_laurelmor.ogg}
        {APPEND_MUSIC battle-epic.ogg}
        {MIRROR_AI_DIFFICULTY_VARS mirai_temp EoMa_Steam_Berserker EoMa_Steam_Ulfserker EoMa_Steam_Turboserker}

        {UNIT 3 ($mirai_temp) 2 9 (animate=yes)}
#ifdef EASY
        {UNIT 3 ($mirai_temp) 4 6 (animate=yes)}
#endif
#ifdef NORMAL
        {UNIT 3 ($mirai_temp) 4 6 (animate=yes)}
#endif
#ifdef HARD
        {UNIT 3 (EoMa_Perfect_Drone) 4 6 (animate=yes)}
#endif
        {UNIT 3 ($mirai_temp) 8 4 (animate=yes)}
        #East
#ifdef EASY
        {UNIT 3 ($mirai_temp) 34 6 (animate=yes)}
#endif
#ifdef NORMAL
        {UNIT 3 ($mirai_temp) 34 6 (animate=yes)}
#endif
#ifdef HARD
        {UNIT 3 (EoMa_Perfect_Drone) 34 6 (animate=yes)}
#endif
        {UNIT 3 ($mirai_temp) 36 9 (animate=yes)}
        [message]
            speaker=Mehir
            message= _ "That’s... wonderful... We’ve just faced horrors from the worst nightmares and now this..."
        [/message]

        {VARIABLE nextturn $turn_number}
        {VARIABLE circle_turn 0}
        {VARIABLE_OP nextturn add 1}
        [allow_end_turn]
        [/allow_end_turn]
        [end_turn]
        [/end_turn]
    [/event]

    {FORCE_CHANCE_TO_HIT role=machine side=1 30 ()}

    #after berserker attack
    [event]
        name=new turn
        first_time_only=no

        [if]
            [variable]
                name=turn_number
                equals=$nextturn
            [/variable]
            [then]
                [message]
                    speaker=Mehir
                    message= _ "These guardians aren’t joking; there‘s no time to talk. If I remember correctly, the teleportation circle requires five parts of the spell to be casted in this pattern..."
                [/message]
                {HIGHLIGHT_IMAGE 19 13 "items/gohere.png" ()}
                {HIGHLIGHT_IMAGE 24 10 "items/gohere.png" ()}
                {HIGHLIGHT_IMAGE 22 7 "items/gohere.png" ()}
                {HIGHLIGHT_IMAGE 16 7 "items/gohere.png" ()}
                {HIGHLIGHT_IMAGE 14 10 "items/gohere.png" ()}

                {VARIABLE heal_s 0}
                {VARIABLE heal_se 0}
                {VARIABLE heal_sw 0}
                {VARIABLE heal_ne 0}
                {VARIABLE heal_nw 0}

                [message]
                    speaker=narrator
                    image=portraits/narrator.png
                    message= _ "Keep in mind that each time Mehir stands on the position to cast the spell, he will lose all his moves and will be unable to attack. He will still be able to recruit units, though.

The order in which the spells are cast does not matter."
                [/message]
                [message]
                    speaker=narrator
                    image=portraits/narrator.png
                    message= _ "After completing the circle, you will need to gather all your living troops and Rashti inside the circle. You cannot leave your men behind."
                [/message]

                {VARIABLE summoners 1}

                {VARIABLE stages 0}
                [objectives]
                    side=1
                    [objective]
                        description= _ "Create the teleportation circle"
                        condition=win
                    [/objective]
                    [objective]
                        description= _ "Defend your position"
                        condition=win
                    [/objective]
                    [objective]
                        description= _ "Death of Mehir"
                        condition=lose
                    [/objective]
                    {IS_LAST_SCENARIO}
                [/objectives]

                #refresh moving castle
                [store_locations]
                    variable=keep_new
                    [filter]
                        id=Mehir
                    [/filter]
                [/store_locations]
            [/then]
        [/if]
    [/event]

    #PAINTING EVENTS
    #south
    [event]
        name=moveto

        [filter]
            id=Mehir
            x,y=19,13
        [/filter]

        {VARIABLE_OP stages add 1}
        {VARIABLE heal_s 1}
        {REMOVE_IMAGE 19 13}

        {CORNER_DIALOGS}

        {MODIFY_UNIT id=Mehir moves 0}
        {MODIFY_UNIT id=Mehir attacks_left 0}
    [/event]
    #south east
    [event]
        name=moveto

        [filter]
            id=Mehir
            x,y=24,10
        [/filter]

        {VARIABLE_OP stages add 1}
        {VARIABLE heal_se 1}
        {REMOVE_IMAGE 24 10}

        {CORNER_DIALOGS}

        {MODIFY_UNIT id=Mehir moves 0}
        {MODIFY_UNIT id=Mehir attacks_left 0}
    [/event]
    #north east
    [event]
        name=moveto

        [filter]
            id=Mehir
            x,y=22,7
        [/filter]

        {VARIABLE_OP stages add 1}
        {VARIABLE heal_ne 1}
        {REMOVE_IMAGE 22 7}

        {CORNER_DIALOGS}

        {MODIFY_UNIT id=Mehir moves 0}
        {MODIFY_UNIT id=Mehir attacks_left 0}
    [/event]
    #north west
    [event]
        name=moveto

        [filter]
            id=Mehir
            x,y=16,7
        [/filter]

        {VARIABLE_OP stages add 1}
        {VARIABLE heal_nw 1}
        {REMOVE_IMAGE 16 7}

        {CORNER_DIALOGS}

        {MODIFY_UNIT id=Mehir moves 0}
        {MODIFY_UNIT id=Mehir attacks_left 0}
    [/event]
    #south west
    [event]
        name=moveto

        [filter]
            id=Mehir
            x,y=14,10
        [/filter]

        {VARIABLE_OP stages add 1}
        {VARIABLE heal_sw 1}
        {REMOVE_IMAGE 14 10}

        {CORNER_DIALOGS}

        {MODIFY_UNIT id=Mehir moves 0}
        {MODIFY_UNIT id=Mehir attacks_left 0}
    [/event]

    #healing
    [event]
        name=new turn
        first_time_only=no

        [if]
            [variable]
                name=heal_s
                equals=1
            [/variable]
            [then]
                [heal_unit]
                    [filter]
                        x,y=19,13
                    [/filter]
                    amount=12
                    animate=yes
                [/heal_unit]
            [/then]
        [/if]
        [if]
            [variable]
                name=heal_se
                equals=1
            [/variable]
            [then]
                [heal_unit]
                    [filter]
                        x,y=24,10
                    [/filter]
                    amount=12
                    animate=yes
                [/heal_unit]
            [/then]
        [/if]
        [if]
            [variable]
                name=heal_ne
                equals=1
            [/variable]
            [then]
                [heal_unit]
                    [filter]
                        x,y=22,7
                    [/filter]
                    amount=12
                    animate=yes
                [/heal_unit]
            [/then]
        [/if]
        [if]
            [variable]
                name=heal_nw
                equals=1
            [/variable]
            [then]
                [heal_unit]
                    [filter]
                        x,y=16,7
                    [/filter]
                    amount=12
                    animate=yes
                [/heal_unit]
            [/then]
        [/if]
        [if]
            [variable]
                name=heal_sw
                equals=1
            [/variable]
            [then]
                [heal_unit]
                    [filter]
                        x,y=14,10
                    [/filter]
                    amount=12
                    animate=yes
                [/heal_unit]
            [/then]
        [/if]
    [/event]

#define CIRCLE_SOUND SOUND
    [remove_sound_source]
        id=circle
    [/remove_sound_source]

    [sound_source]
        id=circle
        sounds={SOUND}
        delay=0
        chance=100
        x,y=19,10
        loop=-1
    [/sound_source]
#enddef

    #circle painting complete
    [event]
        name=circle_complete

        {PLACE_HALO "scenery/ruins_circle1.png" 19 10}
        {VARIABLE painting_complete yes}
        {CIRCLE_SOUND pitch-low.ogg}

        [volume]
            music=80
        [/volume]

        [message]
            speaker=Mehir
            image="portraits/mehir-last-happy.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "We did it! Now we just have to wait until the circle finishes itself."
        [/message]

        {VARIABLE circle_phase1 $turn_number}
        {VARIABLE circle_phase2 $turn_number}
        {VARIABLE circle_phase3 $turn_number}
        {VARIABLE circle_ready 0}

        {VARIABLE_OP circle_phase1 add 2}
        {VARIABLE_OP circle_phase2 add 4}
        {VARIABLE_OP circle_phase3 add 7}

        {IF_VAR turn_number greater_than 8 (
            [then]
                {VARIABLE turn_limit_ruins $turn_number}
                {VARIABLE_OP turn_limit_ruins add 8}
            [/then]
        )}
        [modify_turns]
            value=$turn_limit_ruins
        [/modify_turns]
        {CLEAR_VARIABLE turn_limit_ruins}

        {IF_VAR turn_number less_than 8 (
            [then]
                [objectives]
                    side=1
                    [objective]
                        description= _ "Wait until the circle finishes itself"
                        condition=win
                    [/objective]
                    [objective]
                        description= _ "Death of Mehir"
                        condition=lose
                    [/objective]
                    {TURNS_RUN_OUT}
                    {IS_LAST_SCENARIO}
                [/objectives]
            [/then]
        )}
    [/event]

    #circle auto-completion process
    [event]
        name=new turn
        first_time_only=no

        {IF_VAR turn_number greater_than 8 (
            [then]
                [fire_event]
                    name=unite
                [/fire_event]
            [/then]
        )}
        {IF_VAR painting_complete boolean_equals yes (
            [then]
                [switch]
                    variable=turn_number
                    [case]
                        value=$circle_phase1

                        {PLACE_HALO "scenery/ruins_circle2.png" 19 10}

                        {CIRCLE_SOUND pitch-medium1.ogg}
                        [volume]
                            music=70
                        [/volume]
                    [/case]
                    [case]
                        value=$circle_phase2

                        {PLACE_HALO "scenery/ruins_circle3.png" 19 10}

                        {CIRCLE_SOUND pitch-medium2.ogg}
                        [volume]
                            music=60
                        [/volume]
                    [/case]
                    [case]
                        value=$circle_phase3

                        {PLACE_HALO "scenery/ruins_circle_glow.png" 19 11}
                        {PLACE_HALO "scenery/ruins_circle_glow.png" 14 8}
                        {PLACE_HALO "scenery/ruins_circle_glow.png" 24 8}
                        {PLACE_HALO "scenery/ruins_circle_glow.png" 16 5}
                        {PLACE_HALO "scenery/ruins_circle_glow.png" 22 5}
                        {CIRCLE_SOUND pitch-high.ogg}
                        [volume]
                            music=50
                        [/volume]
                        {FLASH_BLUE (
                            [sound]
                                name=magic-faeriefire.ogg
                            [/sound]
                        )}

                        [message]
                            speaker=Mehir
                            image="portraits/mehir-last-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                            message= _ "Finally!!! Time to get the hell out of here!"
                        [/message]

                        {VARIABLE circle_ready 1}

                        [if]
                            {RUINS_VICTORY_CONDITION}
                            [then]
                                #has all living troops inside
                                [fire_event]
                                    name=activation
                                [/fire_event]
                            [/then]
                            [else]
                                [message]
                                    speaker=Mehir
                                    message= _ "I must call Rashti, my men and Glomin to me inside the circle before casting the activation spell! Whew, I'd never forgive myself, if someone was left behind."
                                [/message]
                                [objectives]
                                    side=1
                                    [objective]
                                        description= _ "Gather all your human units, Rashti and Glomin inside the circle"
                                        condition=win
                                    [/objective]
                                    [objective]
                                        description= _ "Death of Mehir"
                                        condition=lose
                                    [/objective]
                                    [objective]
                                        description= _ "Death of Glomin (he blows up the battery before dying)"
                                        condition=lose
                                        [show_if]
                                            [have_unit]
                                                id=Glomin
                                            [/have_unit]
                                        [/show_if]
                                    [/objective]
                                    {TURNS_RUN_OUT}
                                    {IS_LAST_SCENARIO}
                                [/objectives]
                            [/else]
                        [/if]
                    [/case]
                [/switch]
            [/then]
        )}
    [/event]

    #Rashti halves unite
    [event]
        name=unite
        first_time_only=no

        [if]
            [have_unit]
                type=TLU_DharmaRashti
            [/have_unit]
            [and]
                [have_unit]
                    id=Glomin
                [/have_unit]
            [/and]
            [then]
                [message]
                    type=TLU_HoRashti
                    message= _ "Sister! Hear the voice of reason! These are the final moments of this last battle. It is not a good time for our quarrels. We MUST join together."
                [/message]
                [message]
                    type=TLU_DharmaRashti
                    message= _ "Maybe you are right... In our true form nothing can oppose us, even these things. I'll join you, for now... but one day I am going to return!"
                [/message]
                [fire_event]
                    name=force unite
                    [primary_unit]
                        type=TLU_DharmaRashti
                    [/primary_unit]
                    [secondary_unit]
                        type=TLU_HoRashti
                    [/secondary_unit]
                [/fire_event]
                {VARIABLE lock_truerashti yes}
                #Rashti's ultimate focus
                [object]
                    name=""
                    image="portraits/truerashti.png~CROP(167,70,78,78)~SCALE(72,72)"
                    duration=scenario
                    description= _ "Rashti's ultimate focus allows her to increase her movement speed by 1. Also, she cannot be destabilized again (this bonus only lasts until the end of the scenario)"
                    [filter]
                        id=Rashti
                    [/filter]
                    [effect]
                        apply_to=movement
                        increase=1
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            [dummy]
                                id=tlu_ulimate_focus
                                name= _ "ultimate focus"
                                description= _ "Rashti's ultimate focus allows her to increase her movement speed by 1. Also, she cannot be destabilized again (this bonus only lasts until the end of the scenario)"
                            [/dummy]
                        [/abilities]
                    [/effect]
                [/object]
                [remove_event]
                    id=rashtitransformations_event
                [/remove_event]
            [/then]
        [/if]
    [/event]

    #Rashti ultimate focus on death event
    [event]
        name=last breath
        first_time_only=no

        [filter]
            type=TLU_True_Rashti
        [/filter]

        {IF_VAR lock_truerashti equals yes (
            [then]
                #heal rashti
                [heal_unit]
                    [filter]
                        type=TLU_True_Rashti
                    [/filter]
                    amount=full
                    animate=no
                    restore_statuses=yes
                [/heal_unit]
                {VARIABLE exp $second_unit.experience}
                {VARIABLE_OP exp add -32}
                [store_unit]
                    [filter]
                        id=$second_unit.id
                    [/filter]
                    variable=noexp
                [/store_unit]
                {VARIABLE noexp.experience $exp}
                [unstore_unit]
                    variable=noexp
                    find_vacant=no
                [/unstore_unit]
                {CLEAR_VARIABLE noexp}
                {CLEAR_VARIABLE exp}
            [/then]
        )}
    [/event]

    #victory condition checker fired from summoner die event and from moveto circle area event
    [event]
        name=checker
        first_time_only=no

        [if]
            {RUINS_VICTORY_CONDITION}
            [then]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-last-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Now everyone is in place. It’s about time we got out of here!"
                [/message]
                [fire_event]
                    name=activation
                [/fire_event]
            [/then]
        [/if]
    [/event]

    #on move to the circle area checker
    [event]
        name=moveto
        first_time_only=no

        [allow_undo]
        [/allow_undo]

        [filter]
            side=1
            [filter_location]
                {CIRCLE_AREA}
            [/filter_location]
        [/filter]

        {IF_VAR circle_ready equals 1 (
            [then]
                [fire_event]
                    name=checker
                [/fire_event]
            [/then]
        )}
    [/event]

    #enemies spawning system
    [event]
        name=side 3 turn end
        first_time_only=no

        [switch]
            variable=turn_number
            [case]
                value=3
#ifdef EASY
                {GUARDIANS_PACK1 EoMa_Steam_Berserker}
                {GUARDIANS_PACK1 EoMa_Steam_Berserker}
                {GUARDIANS_PACK1 EoMa_Drone}
#endif
#ifdef NORMAL
                {GUARDIANS_PACK1 EoMa_Steam_Berserker}
                {GUARDIANS_PACK1 EoMa_Steam_Berserker}
                {GUARDIANS_PACK1 EoMa_Drone}
#endif
#ifdef HARD
                {GUARDIANS_PACK1 EoMa_Steam_Turboserker}
                {GUARDIANS_PACK1 EoMa_Steam_Turboserker}
                {GUARDIANS_PACK1 EoMa_Drone_kamikaze}
#endif
            [/case]
            [case]
                value=4
#ifdef EASY
                {GUARDIANS_PACK1 EoMa_Red_Ulfserker}
                {GUARDIANS_PACK1 EoMa_Drone_kamikaze}
#endif
#ifdef NORMAL
                {GUARDIANS_PACK1 EoMa_Red_Ulfserker}
                {GUARDIANS_PACK1 EoMa_Drone_kamikaze}
#endif
#ifdef HARD
                {GUARDIANS_PACK1 EoMa_Red_Ulfserker}
#endif
            [/case]
            [case]
                value=5
#ifdef EASY
                {GUARDIANS_PACK2 EoMa_Red_Ulfserker EoMa_Steam_Berserker}
#endif
#ifdef NORMAL
                {GUARDIANS_PACK2 EoMa_Red_Ulfserker EoMa_Steam_Berserker}
#endif
#ifdef HARD
#endif
                {GUARDIANS_PACK1 EoMa_Perfect_Drone}
                {GUARDIANS_PACK1 EoMa_Steam_Turboserker}
            [/case]
            [case]
                value=6
                {GUARDIANS_PACK1 EoMa_Steam_Turboserker}
                {GUARDIANS_PACK1 EoMa_Steam_Turboserker}
                {GUARDIANS_PACK1 EoMa_Steam_Turboserker}
                {GUARDIANS_PACK1 EoMa_Drone_kamikaze}
            [/case]
            [case]
                value=7
                {GUARDIANS_PACK2 EoMa_Perfect_Drone EoMa_Steam_Turboserker}
            [/case]
        [/switch]

        #destroyers
        {IF_VAR glomin_joins equals yes (
            [then]
                {VARIABLE destroyers_wave $turn_number}
                {VARIABLE_OP destroyers_wave subtract $destroyers_turn}
                [switch]
                    variable=destroyers_wave
                    [case]
                        value=1
                        {UNIT 2 (EoMa_Abaddon) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Atokpi_General) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Extinct_Cyclops_Mage) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Punisher) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Apocalypse) 22 1 (animate=yes)}
                    [/case]
                    [case]
                        value=2
                        {UNIT 2 (EoMa_Moloch) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Atokpi_General) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Extinct_Cyclops_Mage) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Abaddon) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Apocalypse) 22 1 (animate=yes)}
                    [/case]
                    [case]
                        value=3
                        {UNIT 2 (EoMa_Mara) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Devourer) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Mara) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Devourer) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Mara) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Devourer) 19 27 (animate,placement,passable=yes,map,yes)}
                    [/case]
                    [case]
                        value=4
                        {UNIT 2 (EoMa_Titania) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Atokpi_General) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Legendary_Cyclops) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Punisher) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Bone_Golem) 22 1 (animate=yes)}
                    [/case]
                    [case]
                        value=5
                        {UNIT 2 (EoMa_Atokpi_Samurai) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Cyclops_Skeleton) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Bone_Giant) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Bone_Golem) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Mara) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Cyclops_Skeleton) 19 27 (animate,placement,passable=yes,map,yes)}
                    [/case]
                    [case]
                        value=6
                        {UNIT 2 (EoMa_Obliterator) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Atokpi_Dark) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Pirania_Monstruosa) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Pirania_Monstruosa) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Atokpi_Samurai) 22 1 (animate=yes)}
                    [/case]
                    [case]
                        value=7
                        {UNIT 2 (EoMa_Abaddon) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Atokpi_General) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_DarkApostle) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Mara) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Legendary_Cyclops) 19 27 (animate,placement,passable=yes,map,yes)}
                    [/case]
                    [case]
                        value=8
                        {UNIT 2 (EoMa_Atokpi_Dark) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_DarkApostle) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Atokpi_General) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Moloch) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Nightmare) 22 1 (animate=yes)}
                    [/case]
                    [case]
                        value=9
                        {UNIT 2 (EoMa_Abaddon) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Atokpi_General) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_DarkApostle) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Moloch) 19 27 (animate,placement,passable=yes,map,yes)}
                        {UNIT 2 (EoMa_Extinct_Cyclops_Mage) 19 27 (animate,placement,passable=yes,map,yes)}
                    [/case]
                    [case]
                        value=10
                        {UNIT 2 (EoMa_Atokpi_Dark) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Atokpi_Dark) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_DarkApostle) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Abaddon) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Moloch) 22 1 (animate=yes)}
                        {UNIT 2 (EoMa_Apocalypse) 22 1 (animate=yes)}
                    [/case]
                [/switch]
            [/then]
        )}
    [/event]

    #glomin appears
    [event]
        name=turn 8

        {UNIT 3 (EoMa_Constructor) 4 6 (id,name,upkeep,animate=Glomin,Glomin,loyal,yes
        image_icon="portraits/runemasters/mechanic.png~CROP(150,50,130,130)~SCALE(72,72)"
        {IS_HERO})}

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Glomin
            message= _ "Huh? Where's all that darn noise comin' from? Can't an old dwarf just have some rest fer goodness's sake?! I hadn't slept in days!"
        [/message]
        {SCROLL_TO 19 10}
        [message]
            speaker=Glomin
            message= _ "(looks at the battlefield, eyes wider) My wrench be damned! What is goin' on here?!"
        [/message]
        [message]
            type=EoMa_Steam_Berserker,EoMa_Red_Ulfserker,EoMa_Steam_Turboserker
            message= _ "Reporting: unidentified group invaded bunker, intention: steal battery. Attempts at elimination failed. Their leader can speak our language. Communication possible."
        [/message]
        [message]
            speaker=Glomin
            message= _ "*to Mehir* Hey, you! Finally, someone that ain't one of 'em spawns o' darkness lurking 'round here! But why the hell do ye need my precious battery?!"
        [/message]
        [message]
            speaker=Mehir
            message= _ "You see, well, my troops and I got separated from our nation and our families in the Abyss, so we need the battery's energy to be able to make a portal to it, to follow the rest of my people there. We're trapped in this world for now."
        [/message]
        [message]
            speaker=Glomin
            message= _ "Look mate, tis' beauty powers the steam berserkers and plenty of other essential machinery. She and my burnin' desire to avenge the slaughter of my kind are the only two things keepin' me alive 'ere. If ya take 'er from me, I'm as good as dead."
        [/message]

        [delay]
            time=200
        [/delay]

        [sound]
            name=explosion.ogg
        [/sound]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Mehir
            image="portraits/mehir-last-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "What the..."
        [/message]
        {EARTHQUAKE ({SCROLL_TO 22 1})}

        [message]
            speaker=Mehir
            message= _ "Don’t tell me it’s..."
        [/message]
        [modify_side]
            side=2
            hidden=no
        [/modify_side]

        {UNIT 2 (EoMa_Moloch) 22 1 (animate=yes)}
        [sound]
            name=roar.ogg
        [/sound]
        {UNIT 2 (EoMa_Atokpi_General) 22 1 (animate=yes)}
        {UNIT 2 (EoMa_Extinct_Cyclops_Mage) 22 1 (animate=yes)}
        {UNIT 2 (EoMa_Bone_Giant) 22 1 (animate=yes)}
        {UNIT 2 (EoMa_Apocalypse) 22 1 (animate=yes)}

        [message]
            speaker=Glomin
            message= _ "You...YOU! NOT AGAIN!!!"
        [/message]

        [sound]
            name=roar.ogg
        [/sound]
        {UNIT 2 (EoMa_DarkApostle) 19 27 (animate,placement,passable=yes,map,yes)}
        {UNIT 2 (EoMa_Abaddon) 19 27 (animate,placement,passable=yes,map,yes)}
        {UNIT 2 (EoMa_DarkApostle) 19 27 (animate,placement,passable=yes,map,yes)}
        {UNIT 2 (EoMa_Abaddon) 19 27 (animate,placement,passable=yes,map,yes)}
        {UNIT 2 (EoMa_DarkApostle) 19 27 (animate,placement,passable=yes,map,yes)}
        {UNIT 2 (EoMa_Abaddon) 19 27 (animate,placement,passable=yes,map,yes)}

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Mehir
            image="portraits/mehir-last-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Damn it, they’ve found us!"
        [/message]

        [message]
            speaker=Glomin
            message= _ "Ye brought these abominations 'ere, outsider!!! Now ye doomed us both!!!"
        [/message]

        [end_turn]
        [/end_turn]
    [/event]
    #glomin continues
    [event]
        name=side 3 turn
        first_time_only=no

        [if]
            [have_unit]
                id=Glomin
                side=3
            [/have_unit]
            [then]
                [message]
                    speaker=Glomin
                    message= _ "Argh, bloody hell, stuck 'tween a hammer and an anvil... if the abominations win, we all die, if I let the outsiders take the battery, I have nothing left to keep me alive 'ere and die as well..."
                [/message]

                [message]
                    speaker=Mehir
                    message= _ "Dwarf, whatever is your name, I know that we may be in conflict, but we have to put out our differences aside for now. Otherwise those monsters are going to easily wipe us out while we are busy being at each other's throats."
                [/message]

                [message]
                    speaker=Glomin
                    message= _ "I've little left to lose, human, everyone I knew and loved is long dead, I'm but a dusty relic of tha past with hardly any meanin' in life, might as well blow up the battery and bring the abominations down with me *grabs the remote*"
                [/message]

                [message]
                    speaker=Mehir
                    image="portraits/mehir-last-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "NO!!! WAIT!!!"
                [/message]

                [message]
                    speaker=Glomin
                    message= _ "What could ye possibly offer in return for tha only thing I held dear?"
                [/message]

                [message]
                    speaker=Mehir
                    message= _ "Look, you said you can't give away the battery because you wouldn't be able to survive without it here. What if I bring you with me and have you live with my... let's just say allies."
                [/message]

                [message]
                    speaker=Glomin
                    message= _ "And who are these mysterious 'allies' ye speak of? I still don't fully trust ya."
                [/message]

                [message]
                    speaker=Mehir
                    message= _ "Well... they're basically uhh... arrogant mage scientists."
                [/message]

                [message]
                    speaker=Glomin
                    message= _ "Arrogant scientific magi? Wait... don't tell me... the Magi civilization actually survived the cataclysm?"
                [/message]

                [message]
                    speaker=Mehir
                    message= _ "Well, it's too long to explain, just step onto the platform around the battery, I am preparing a teleportation circle around it, which should teleport us to the Sky Kingdom."
                [/message]

                [message]
                    speaker=Glomin
                    message= _ "Fine, we have a deal, can't be worse than dyin' here. All these millenia of bein' trapped here and constantly hidin' from those horrors 'ave made me a complete wreck! But if ya leave me to die here, I'll blow up battery. I've still got the self-destruct remote, to ensure ye don't dump me here. And I am dead serious, I was seconds away from pressin' it 'fore you convinced me to change my mind."
                [/message]

                [message]
                    speaker=Glomin
                    message= _ "Alas, I'm runnin' out of machines: yer men smashed many beyond repair! Now gimme some hands, we'll make a combined effort to fend 'em off and save my battery!"
                [/message]

                [message]
                    speaker=Glomin
                    message= _ "Anyway, my apologies for not introducin' myself earlier. Name's Glomin, son of Glamthasil. And now, my steam children, time for yer last stand against our mortal enemy! Ignore the others, they are allies!"
                [/message]
                {MODIFY_UNIT id=Glomin side 1}
                {MOVE_UNIT id=Glomin 16 10}
                {MODIFY_UNIT side=3 upkeep loyal}
                {VARIABLE glomin_joins yes}
                {AI_AVOID_GLYPHS 3}
                [modify_side]
                    side=3
                    team_name=mehirteam,rashti
                [/modify_side]
                [micro_ai]
                    side=3
                    ai_type=simple_attack
                    action=add
                    ca_score=110000
                [/micro_ai]

                {FORCE_CHANCE_TO_HIT side=2 side=3 80 ()}
                {FORCE_CHANCE_TO_HIT (
                    side=3
                    [not]
                        type=EoMa_Perfect_Drone,EoMa_Drone_kamikaze
                    [/not]
                ) side=2 30 ()}
                {VARIABLE destroyers_turn $turn_number}

                [message]
                    speaker=Mehir
                    message= _ "We better stay inside the circle. I cannot leave my men, Rashti or Glomin behind. Abysmal beings except Rashti do not matter."
                [/message]
                {BADASS_MODE_CHANGE (
                    [message]
                        type=EoMa_Wonderful_Jinn,EoMa_Mystical_Jinn
                        message= _ "Hey!"
                    [/message]
                ) ()}

                {TLU_SMOOTH_REPLACE_MUSIC In_the_Land_of_Madness.ogg 1500 0}

                [fire_event]
                    name=unite
                [/fire_event]

                [objectives]
                    side=1
                    [objective]
                        description= _ "Wait until the circle finishes itself"
                        condition=win
                        [show_if]
                            [variable]
                                name=painting_complete
                                boolean_equals=yes
                            [/variable]
                        [/show_if]
                    [/objective]
                    [objective]
                        description= _ "Create the teleportation circle"
                        condition=win
                        [show_if]
                            [variable]
                                name=painting_complete
                                boolean_not_equals=yes
                            [/variable]
                        [/show_if]
                    [/objective]
                    [objective]
                        description= _ "Death of Mehir"
                        condition=lose
                    [/objective]
                    [objective]
                        description= _ "Death of Glomin (he blows up the battery before dying)"
                        condition=lose
                    [/objective]
                    {TURNS_RUN_OUT}
                    {IS_LAST_SCENARIO}
                [/objectives]
            [/then]
        [/if]
    [/event]

    #Mehir panics
    [event]
        name=turn 10

        {BADASS_MODE_CHANGE () (
            [message]
                speaker=Mehir
                image="portraits/mehir-last-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "There are more of them!"
            [/message]
            [message]
                speaker=Rashti
                message= _ "Fear not, Mehir. Just don't get yourself killed. There are so many things I want to show you in the Abyss once we get there."
            [/message]
        )}
    [/event]

    #circle activation
    [event]
        name=activation
        [message]
            speaker=Mehir
            image="portraits/mehir-last-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "Nu Kajarr En Hassam!"
        [/message]
        [sound]
            name=magic-faeriefire.ogg
        [/sound]
        {SCROLL_TO 19 10}
        {FADE_STEP 32 5}
        {FADE_STEP 64 5}
        {FADE_STEP 96 5}
        {FADE_STEP 128 5}
        {FADE_STEP 160 5}
        {FADE_STEP 192 5}
        [sound]
            name=magic-faeriefire.ogg
        [/sound]
        {FADE_STEP 255 1000}
        [sound]
            name=magic-faeriefire-miss.ogg
        [/sound]
        [remove_shroud]
            side=1
        [/remove_shroud]
        [kill]
            [filter_location]
                [not]
                    {CIRCLE_AREA}
                [/not]
            [/filter_location]
            animate=no
        [/kill]
        [kill]
            side=2
            animate=no
        [/kill]
        {REMOVE_IMAGE 19 6}
        {REMOVE_IMAGE 19 10}
        {REMOVE_IMAGE 19 11}
        {REMOVE_IMAGE 14 8}
        {REMOVE_IMAGE 24 8}
        {REMOVE_IMAGE 16 5}
        {REMOVE_IMAGE 22 5}

        {REMOVE_IMAGE 16 7}
        {REMOVE_IMAGE 22 7}

        [label]
            terrain=*
            text=""
        [/label]

        [remove_sound_source]
            id=circle
        [/remove_sound_source]
        [volume]
            music=100
        [/volume]
        [sound]
            name=lightning.ogg
        [/sound]

        [replace_map]
            map_file=23_Ruins_1.map
            expand=yes
            shrink=yes
        [/replace_map]
        [replace_schedule]
            {MORNING}
        [/replace_schedule]
        {REPLACE_SCENARIO_MUSIC breaking_the_chains.ogg}

        {UNIT 4 (EoMa_Sorcerer) 24 14 (id=Mage
        name=_"Augurius"
        facing=se)}

        {UNIT 4 (EoMa_Sculptor) 26 12 (id=Historian
        name=_"Antiquarius"
        facing=se)}

        {BADASS_MODE_CHANGE (
            {UNIT 4 (TLU_animhack) 17 15 (variation,facing=golemball,se)}
        ) ()}

        {SCATTER_UNITS 20 "EoMa_Sorcerer,EoMa_Mystic_Warrior,EoMa_Elementalist,EoMa_Battle_Eye,EoMa_Battlemage" 3 (
            terrain=Gg

            [not]
                [filter]
                [/filter]
            [/not]

            [not]
                [filter_adjacent_location]
                    [filter]
                    [/filter]
                [/filter_adjacent_location]
            [/not]
        ) (
            side=4
            generate_name=yes
            random_traits=yes
        )}
        [petrify]
            side=3
        [/petrify]

        {FADE_STEP 255 1000}
        {FADE_STEP 192 5}
        {FADE_STEP 160 5}
        {FADE_STEP 128 5}
        {FADE_STEP 96 5}
        {FADE_STEP 64 5}
        {FADE_STEP 32 5}
        {FADE_STEP 0 5}

        {PLACE_HALO scenery/battery-top.png 19 7}

        [delay]
            time=2000
        [/delay]
        {SCROLL_TO 19 3}
        [delay]
            time=1000
        [/delay]
        {SCROLL_TO 24 14}
        {MODIFY_UNIT id=Mage facing nw}

        {MOVE_UNIT id=Mehir 21 12}
        {MOVE_UNIT id=Rashti 22 10}
        {MOVE_UNIT id=Glomin 18 11}

        [message]
            speaker=Mage
            message= _ "Oh, you have returned. How nice! We are having dinner in a moment. Mind joining us?"
        [/message]
        {BADASS_MODE_CHANGE (
            [message]
                speaker=Mehir
                message= _ "Yeah, why not? I am starving after slaying nightmarish beasts, defeating and allying with an army of mechanical monsters as well as bringing this battery along with parts and one inhabitant of that accursed place. Do you have a menu with you?"
            [/message]
        ) (
            [message]
                speaker=Mehir
                image="portraits/mehir-last-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "I have slain nightmarish beasts, encountered an army of mechanical monsters, brought this damn battery along with parts..."
            [/message]
            [message]
                speaker=Glomin
                message= _ "*cough*"
            [/message]
            [message]
                speaker=Mehir
                image="portraits/mehir-last-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                message= _ "...and one inhabitant of that accursed place back here, and the first thing you do is offer me dinner?!"
            [/message]
        )}
        [message]
            speaker=Mage
            message= _ "Why, of course! Today we are serving a delicious kind of crab from the western cliffs of Kharos. They call it ‘Holy Crab’. And indeed, its taste is simply divine! You will adore it!"
        [/message]
        {IF_VAR enlightenment_book_cookbook equals yes (
            [then]
                [message]
                    speaker=Mehir
                    message= _ "Ah, I've been longing for some crab since I read about it in your library. The battery may be important, but a good meal is even more so. Lead the way!"
                [/message]
                [message]
                    speaker=Mage
                    message= _ "Spoken like a true gourmet! Excellent!"
                [/message]
            [/then]
            [else]
                {BADASS_MODE_CHANGE (
                    [message]
                        speaker=Mehir
                        message= _ "What about the battery?"
                    [/message]
                ) (
                    [message]
                        speaker=Mehir
                        message= _ "..."
                    [/message]
                    [delay]
                        time=1000
                    [/delay]
                    [message]
                        speaker=Mehir
                        message= _ "But... the battery?"
                    [/message]
                )}
                [message]
                    speaker=Mage
                    message= _ "The battery can wait; the crab cannot. Believe me."
                [/message]
                {BADASS_MODE_CHANGE (
                    [message]
                        speaker=Mehir
                        message= _ "Then lead the way!"
                    [/message]
                ) (
                    [message]
                        speaker=Mehir
                        message= _ "*sigh* Fine, I will eat this... crab of yours..."
                    [/message]
                )}
                [message]
                    speaker=Mage
                    message= _ "Excellent!"
                [/message]
            [/else]
        )}

        [message]
            speaker=Glomin
            message= _ "What 'bout me? I ain't gonna to eat that grub!"
        [/message]
        [message]
            speaker=Mage
            message= _ "*looks at Glomin, then at Mehir* You brought a <b>dwarf</b> here?!"
        [/message]
        [message]
            speaker=Mage
            message= _ "What for? You shouldn't have bothered! But yeah, it's still a nice bonus."
        [/message]
        [message]
            speaker=Glomin
            message= _ "“shouldn't have bothered“?! “nice bonus“?! Ye wanna taste me wrench, do ya? I'll smash yer gob straight through yer teeth! Ye can shove that crab right up yer arse!"
        [/message]
        [message]
            speaker=Mage
            message= _ "*shrinks back* Uhh... I mean... Uhh... it's a stroke of luck to be visited by a representative of a dead - err... of a species presumed long extinct! How did you even manage to survive for so long though?"
        [/message]
        [message]
            speaker=Historian
            message= _ "My apologies for my colleague's previous rude remarks. He doesn't appreciate history nearly as much as I do. I am honored to be able to speak to a surviving member of a civilization previously thought to be entirely extinct. Me and my fellow historians will be delighted about this extraordinary chance to research the Runemasters' civilization!"
        [/message]
        [message]
            speaker=Glomin
            message= _ "<i>*to himself* Finally, someone 'ere with some manners...</i>"
        [/message]
        [message]
            speaker=Historian
            message= _ "By the way, how did you manage to survive for so long?"
        [/message]
        [message]
            speaker=Glomin
            message= _ "Hibernatin' for millenia that's how! 'cept waking up every few years to do some repairs and such."
        [/message]
        [message]
            speaker=Mage
            message= _ "*claps his hands* Now, let's treat ourselves to some fine crab meat!"
        [/message]
        {MOVE_UNIT id=Mage 37 18}
        [kill]
            id=Mage
        [/kill]
        [store_unit]
            [filter]
                id=Mage
            [/filter]
            variable=mage
            kill=yes
        [/store_unit]
        [role]
            role=mage
            side=4
            level=1
        [/role]
        [store_unit]
            [filter]
                id=Glomin
            [/filter]
            variable=glomin
        [/store_unit]
        {MOVE_UNIT id=Historian $glomin.x $glomin.y}
        [message]
            speaker=Historian
            message= _ "Follow me, dwarf. We have plenty of history and technology to discuss over some good beer, brewed with fresh, pure rainwater, extracted straight from the clouds..."
        [/message]
        [message]
            speaker=Glomin
            message= _ "I get someone I can chat 'bout technology with, AND booze? Now 'tis is paradise! Fare ye well, Mehir! Hope yer not gonna choke on that crap they're givin' ya, and thanks for the lift!"
        [/message]
        {MOVE_UNIT id=Historian 37 18}
        [kill]
            id=Historian
        [/kill]
        {MOVE_UNIT id=Glomin 37 18}
        [kill]
            id=Glomin
        [/kill]
        {CLEAR_VARIABLE circle_phase1}
        {CLEAR_VARIABLE circle_phase2}
        {CLEAR_VARIABLE circle_phase3}
        {CLEAR_VARIABLE circle_ready}
        {CLEAR_VARIABLE circle_turn}
        {CLEAR_VARIABLE comment_fireelems}
        {CLEAR_VARIABLE destroyers_known}
        {CLEAR_VARIABLE heal_s}
        {CLEAR_VARIABLE heal_se}
        {CLEAR_VARIABLE heal_ne}
        {CLEAR_VARIABLE heal_nw}
        {CLEAR_VARIABLE heal_sw}
        {CLEAR_VARIABLE lock_truerashti}
        {CLEAR_VARIABLE nextturn}
        {CLEAR_VARIABLE stages}
        {CLEAR_VARIABLE mehirvar}
        {CLEAR_VARIABLE early_summoned}
        {CLEAR_VARIABLE castle_new}
        {CLEAR_VARIABLE keep_new}
        {CLEAR_VARIABLE summoners}
        {CLEAR_VARIABLE toohot}
        [endlevel]
            result=victory
            carryover_report=no
            carryover_percentage=0
        [/endlevel]
    [/event]

    #um attacks destroyer
    [event]
        name=attack

        [filter]
            type=EoMa_Um
        [/filter]
        [filter_second]
            side=2
        [/filter_second]
        {IF_VAR destroyers_known not_equals yes (
            [then]
                [message]
                    speaker=unit
                    message= _ "Target acquired. Scanning... Destroyer encountered. Threat level: extremely dangerous. Executing pacification protocols."
                [/message]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-last-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "A 'Destroyer'?! Wait a minute, so the Tharis were worshiping these creatures?! What the hell have I signed up for?!"
                [/message]
                [set_variable]
                    name=destroyers_known
                    value=yes
                [/set_variable]
                [modify_side]
                    side=2
                    user_team_name=_ "Destroyers"
                [/modify_side]
            [/then]
        )}
    [/event]

    #ulfserker attacks summoners
    [event]
        name=attack

        [filter]
            type=EoMa_Steam_Ulfserker
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [message]
            speaker=unit
            message= _ "<i>Initiating combat mode, with berserk behavior active.</i>"
        [/message]
    [/event]
    [event]
        name=attack end

        [filter]
            type=EoMa_Steam_Ulfserker
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Mehir
            message= _ "My goodness! These things are absolutely relentless!"
        [/message]
    [/event]

    #glomin last breath
    [event]
        name=last breath

        [filter]
            id=Glomin
        [/filter]
        [message]
            speaker=Glomin
            message= _ "Argh! So I helped ye, and ya dumped me 'ere?! I got nothin' ta lose anymore. Activate the self-destruc..."
        [/message]
    [/event]

#define BUNKER_EXPLOSION
    [delay]
        time=150
    [/delay]
    {QUAKE explosion.ogg}
    [delay]
        time=150
    [/delay]
    {QUAKE explosion.ogg}
    [delay]
        time=150
    [/delay]
    {QUAKE explosion.ogg}
    {FADE_STEP 32 5}
    {QUAKE explosion.ogg}
    {FADE_STEP 84 5}
    [harm_unit]
        [filter]
        [/filter]
        amount=1000
        fire_event=no
        animate=no
    [/harm_unit]
    {QUAKE explosion.ogg}
    {FADE_STEP 128 10}
    {QUAKE explosion.ogg}
    {FADE_STEP 160 10}
    {QUAKE explosion.ogg}
    {FADE_STEP 200 10}
    {QUAKE explosion.ogg}
    {QUAKE ()}
    {FADE_STEP 256 50}
    {QUAKE explosion.ogg}
    {QUAKE ()}
    {FADE_STEP 512 50}
    {QUAKE explosion.ogg}
    {QUAKE explosion.ogg}
    {FADE_STEP -512 5}
#enddef

    #glomin death sequence
    [event]
        name=die

        [filter]
            id=Glomin
        [/filter]
        [sound]
            name=fuse.ogg
        [/sound]
        [delay]
            time=150
        [/delay]
        [sound]
            name=fuse.ogg
        [/sound]
        [delay]
            time=150
        [/delay]
        [sound]
            name=fuse.ogg
        [/sound]
        [delay]
            time=1000
        [/delay]
        [message]
            speaker=Mehir
            image="portraits/mehir-last-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "<b>We are going to die!</b>"
        [/message]
        {BUNKER_EXPLOSION}
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    #time over
    [event]
        name=time over

        {UNIT 2 (EoMa_DarkApostle) 22 1 (id,animate=apostle,yes)}
        {MOVE_UNIT id=apostle 22 6}
        {UNIT 2 (TLU_animhack) 19 10 (max_hitpoints=45,hitpoints=45)}
        [harm_unit]
            [filter]
                type=TLU_animhack
            [/filter]
            [filter_second]
                id=apostle
            [/filter_second]
            [primary_attack]
                name=wail
            [/primary_attack]
            amount=15
            animate=yes
        [/harm_unit]
        {QUAKE explosion.ogg}
        [harm_unit]
            [filter]
                type=TLU_animhack
            [/filter]
            [filter_second]
                id=apostle
            [/filter_second]
            [primary_attack]
                name=wail
            [/primary_attack]
            amount=15
            animate=yes
        [/harm_unit]
        {QUAKE explosion.ogg}
        [harm_unit]
            [filter]
                type=TLU_animhack
            [/filter]
            [filter_second]
                id=apostle
            [/filter_second]
            [primary_attack]
                name=wail
            [/primary_attack]
            amount=15
            animate=yes
        [/harm_unit]
        {QUAKE explosion.ogg}
        {QUAKE explosion.ogg}
        [sound]
            name=fuse.ogg
        [/sound]
        [delay]
            time=150
        [/delay]
        [sound]
            name=fuse.ogg
        [/sound]
        [delay]
            time=150
        [/delay]
        [sound]
            name=fuse.ogg
        [/sound]
        [delay]
            time=1000
        [/delay]
        [message]
            speaker=Glomin
            message= _ "These abominations are blowin' up the battery!!!"
        [/message]
        [message]
            speaker=Mehir
            image="portraits/mehir-last-shocked.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "<b>Aaaaaah! We are going to die!</b>"
        [/message]
        [delay]
            time=150
        [/delay]
        {BUNKER_EXPLOSION}
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    #jinni advice
    [event]
        name=recall,post advance
        first_time_only=yes
        [filter]
            type=EoMa_Wonderful_Jinn,EoMa_Mystical_Jinn
        [/filter]

        [if]
            [have_unit]
                id=$unit.id
                type=EoMa_Wonderful_Jinn
            [/have_unit]
            [then]
                [message]
                    speaker=Mehir
                    message= _ "Wonderful Jinni! Give me some advice!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Mehir
                    message= _ "Mystical Jinni! Give me some advice!"
                [/message]
            [/else]
        [/if]
        {IF_VAR turn_number less_than 3 (
            [then]
                [message]
                    speaker=unit
                    message= _ "My Master, this place will turn itself into a blazing battlezone in no time!"
                [/message]
                [message]
                    speaker=Mehir
                    image="portraits/mehir-last-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                    message= _ "Your advice is killing me, you know? What else?! Tell me more!"
                [/message]
                [message]
                    speaker=unit
                    message= _ "I am accessing parallel universes..."
                [/message]
                [message]
                    speaker=unit
                    message= _ "..."
                    sound=magic-faeriefire.ogg
                [/message]
                {IF_VAR gate_opened equals yes (
                    [then]
                        [message]
                            speaker=unit
                            message= _ "Strange seemingly sentient humanoid metallic objects keep attacking us from all directions. Heavy losses. But at some point... a small human appears."
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=unit
                            message= _ "In this timeline you will discover the battery in a large hall behind the door. I see strange seemingly sentient humanoid metallic objects attacking us from all directions. This cannot be avoided and happens in most of the possible outcomes after opening the door, and then a small human appears."
                        [/message]
                    [/else]
                )}
                [message]
                    speaker=Mehir
                    message= _ "A small human? Do you mean a child?"
                [/message]
                [message]
                    speaker=unit
                    message= _ "Not really, more like a short elder. Then the enemy finds us and surrounds us from north and south. This is pretty much inevitable as it happens in 99.8% of outcomes involving the appearance of the small human."
                [/message]
                {IF_VAR destroyers_known equals yes (
                    [then]
                        [message]
                            speaker=Mehir
                            message= _ "So we need to hurry up. The Destroyers' skeletal minions are actively looking for us, and I highly doubt that sealing the entrance will hold them off forever. What happens next?"
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=Mehir
                            message= _ "So we need to hurry up. Those abominations are actively looking for us, and I highly doubt that sealing the entrance will hold them off forever. What happens next?"
                        [/message]
                    [/else]
                )}
                [message]
                    speaker=unit
                    message= _ "I see noise. So many factors... Wait... In 6.7% of the outcomes the small human wants to help us."
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "And what if he does not?"
                [/message]
                [message]
                    speaker=unit
                    message= _ "He destroys the battery and blows the whole place up, vaporizing everything in range of about 3017 and a half stone throws. The area turns into a burning wasteland, with first foliage only starting to grow in 324 million years."
                [/message]
                [message]
                    speaker=Mehir
                    message= _ "Well, that didn't make much sense. Looks like I forced you to look too far away in time. Thanks anyway. Let's hope we get lucky..."
                [/message]
            [/then]
            [else]
                {IF_VAR turn_number less_than 8 (
                    [then]
                        [message]
                            speaker=unit
                            message= _ "My Master! A small human will appear quite soon. He will either offer his help or will try to kill us. In most of the possibilities, he will choose the latter option."
                        [/message]
                        [message]
                            speaker=Mehir
                            image="portraits/mehir-last-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
                            message= _ "Excellent! Sounds like I am going to meet another psychopath! Tell me more!"
                        [/message]
                        [message]
                            speaker=unit
                            message= _ "Then the enemy appears from north and south. We are completely surrounded. Heavy losses, and in the 93.6% of the outcomes where the small human doesn't offer his help, we are all going to die. But if the small human decides to help us, the outcome will be much better. Anyway, we have no chance against the enemy unless we hurry up."
                        [/message]
                    [/then]
                    [else]
                        [message]
                            speaker=unit
                            message= _ "My Master! The enemy is going to quickly swarm this place. We really need to hurry up, or we're as good as dead!"
                        [/message]
                    [/else]
                )}
            [/else]
        )}
    [/event]

    #fire elemental limit
    [event]
        name=unit placed,post advance,post metamorph
        first_time_only=yes

        [filter]
            type=EoMa_Fire_God,EoMa_Fire_Avatar,EoMa_Fire_Elemental
        [/filter]

        [message]
            speaker=Mehir
            message= _ "Uh... It's getting hot in here. I should use as few Fire Elementals as possible. It's hard to breath in this place already."
        [/message]
    [/event]

    #lock fire elementals
    [event]
        name=unit placed,post advance,post metamorph
        first_time_only=no

        [filter]
            type=EoMa_Fire_God,EoMa_Fire_Avatar,EoMa_Fire_Elemental
        [/filter]

        [if]
            [have_unit]
                type=EoMa_Fire_God,EoMa_Fire_Avatar,EoMa_Fire_Elemental
                count=3-999
            [/have_unit]
            [then]
                {VARIABLE toohot yes}
                [disallow_recruit]
                    side=1,5
                    type=EoMa_Fire_Avatar,EoMa_Fire_Elemental
                [/disallow_recruit]
                [store_unit]
                    [filter]
                        side=1
                        type=EoMa_Fire_Avatar,EoMa_Fire_Elemental,EoMa_Fire_God
                        x,y=recall,recall
                    [/filter]
                    variable=fire_recall_memo
                    kill=yes
                [/store_unit]
                [fire_event]
                    name=fire_comment
                [/fire_event]
            [/then]
        [/if]
    [/event]

    [event]
        name=try summon EoMa_Fire_Elemental
        first_time_only=no

        [if]
            [have_unit]
                type=EoMa_Fire_God,EoMa_Fire_Avatar,EoMa_Fire_Elemental
                count=3-999
            [/have_unit]
            [then]
                [fire_event]
                    name=fire_comment
                [/fire_event]
                [return][/return]
            [/then]
        [/if]
    [/event]

    #unlock fire elementals
    [event]
        # Listen to last breath rather than die, so that unlocking always
        # happens before possible revivals on a later name=die (e.g. from Collar.)
        name=last breath,pre metamorph
        first_time_only=no

        [filter]
            type=EoMa_Fire_God,EoMa_Fire_Avatar,EoMa_Fire_Elemental
        [/filter]

        [if]
            [have_unit]
                type=EoMa_Fire_God,EoMa_Fire_Avatar,EoMa_Fire_Elemental
                count=4-999
            [/have_unit]
            [else]
                {VARIABLE toohot no}
                [allow_recruit]
                    side=1,5
                    type=EoMa_Fire_Avatar,EoMa_Fire_Elemental
                [/allow_recruit]
                [foreach]
                    array=fire_recall_memo
                    [do]
                        [unstore_unit]
                            variable=this_item
                            x,y=recall,recall
                        [/unstore_unit]
                    [/do]
                [/foreach]
                {CLEAR_VARIABLE fire_recall_memo}
            [/else]
        [/if]
    [/event]

    [event]
        name=fire_comment
        first_time_only=no

        [message]
            speaker=Mehir
            image="portraits/mehir-last-angry.png{TLU_MEHIR_PORTRAIT_ELEMENTS}"
            message= _ "*gasps* I can hardly breathe... One Fire Elemental more and we will suffocate in here. The heat coming from these lava pools is already unbearable. It's getting even warmer than in an open desert! I thought those genius magi implemented a cooling system for my new circle for such situations..."
        [/message]
    [/event]

    #guardians ignore Rashti after split
    [event]
        name=split

        [modify_side]
            side=3
            [ai]
                [aspect]
                    id=attacks
                    [facet]
                        invalidate_on_gamestate_change=yes
                        [filter_own]
                            side=3
                        [/filter_own]
                        [filter_enemy]
                            [not]
                                type=TLU_DharmaRashti,TLU_HoRashti,TLU_True_Rashti
                            [/not]
                        [/filter_enemy]
                    [/facet]
                [/aspect]
            [/ai]
        [/modify_side]
    [/event]

    #fix color
    [event]
        name=unified
        first_time_only=no

        {COLOR_ADJUST 30 22 12}
    [/event]

    {DGATES_PAY2LVL dgcollection heat}
    {I8CUSTOMPLAGUEEVENT}
    {SUMMONER_UNLOCK}
    {ITEM_APPLIER}
    {COLLAR_EVENT}
    {DEATH_MEHIR}
    {TLU_S23_TERRAIN}
[/scenario]
